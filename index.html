<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Tracker Pro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2310b981'/%3E%3Cpath d='M4 20l4-3h16l4 3H4z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M8 17h16l2-5H6l2 5z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M10 12V9h12v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M14 9V6h4v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 20v3h14v-3' fill='none' stroke='white' stroke-width='1.5'/%3E%3C/svg%3E"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2310b981'/%3E%3Cpath d='M4 20l4-3h16l4 3H4z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M8 17h16l2-5H6l2 5z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M10 12V9h12v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M14 9V6h4v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 20v3h14v-3' fill='none' stroke='white' stroke-width='1.5'/%3E%3C/svg%3E"/>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-deep: #0a0d12; --bg-main: #0f1419; --bg-card: #161d27; --bg-card-hover: #1c2532;
            --bg-input: #1a222e; --border: #2a3544; --border-focus: #3d4f66;
            --text: #e8edf5; --text-dim: #8b98a9; --text-muted: #5a6778;
            --primary: #19a974; --primary-glow: rgba(25, 169, 116, 0.2); --sidebar: #0c1015;
            --red: #ff5252; --red-glow: rgba(255, 82, 82, 0.15);
            --amber: #ffb300; --amber-glow: rgba(255, 179, 0, 0.15);
            --green: #4caf50; --green-glow: rgba(76, 175, 80, 0.15);
            --blue: #4fc3f7; --blue-glow: rgba(79, 195, 247, 0.15);
        }
        .light-mode {
            --bg-deep: #f0f2f5; --bg-main: #ffffff; --bg-card: #ffffff; --bg-card-hover: #f5f7fa;
            --bg-input: #f0f2f5; --border: #d1d9e6; --border-focus: #a0aec0;
            --text: #1a202c; --text-dim: #4a5568; --text-muted: #718096;
            --sidebar: #f7fafc;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: var(--text); min-height: 100vh; transition: all 0.3s; }
        .app { display: flex; min-height: 100vh; }

        /* Notification Banner */
        .notif-banner { background: var(--red-glow); border-bottom: 1px solid var(--red); padding: 10px 24px; display: flex; align-items: center; gap: 16px; font-size: 13px; position: fixed; top: 0; left: 200px; right: 0; z-index: 100; }
        .notif-banner.warning { background: var(--amber-glow); border-color: var(--amber); }
        .notif-banner.ok { background: var(--green-glow); border-color: var(--green); display: none; }
        .notif-item { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .notif-item.urgent { color: var(--red); }
        .notif-item.warning { color: var(--amber); }
        .notif-close { margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; }

        /* Sidebar */
        .sidebar { width: 200px; background: var(--sidebar); border-right: 1px solid var(--border); position: fixed; height: 100vh; overflow-y: auto; z-index: 101; }
        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; color: var(--primary); letter-spacing: 1.5px; }
        .logo-sub { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
        .nav-section { padding: 12px 8px 4px; }
        .nav-title { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 1.2px; text-transform: uppercase; padding: 0 8px; margin-bottom: 6px; }
        .nav-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: transparent; border: none; border-radius: 6px; color: var(--text-dim); font-family: inherit; font-size: 12px; cursor: pointer; transition: all 0.15s; margin-bottom: 2px; text-align: left; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .nav-btn.active { background: var(--primary); color: #000; font-weight: 600; }
        .nav-btn svg { width: 16px; height: 16px; flex-shrink: 0; }
        .nav-btn .badge-count { margin-left: auto; background: var(--red); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); position: absolute; bottom: 0; width: 100%; background: var(--sidebar); }
        .version { font-size: 10px; color: var(--text-muted); text-align: center; font-family: 'JetBrains Mono', monospace; }
        .theme-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .theme-toggle button { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .theme-toggle button:hover { background: var(--bg-card-hover); }
        .theme-toggle button.active { background: var(--primary); color: #000; }

        /* Main */
        .main { flex: 1; margin-left: 200px; background: var(--bg-main); min-height: 100vh; padding: 24px; padding-top: 24px; }
        .main.has-banner { padding-top: 60px; }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        .page-header-left { }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .page-sub { font-size: 13px; color: var(--text-muted); }

        /* Search Box */
        .search-box { position: relative; }
        .search-box input { width: 250px; padding: 10px 12px 10px 36px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; font-size: 13px; }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }
        .search-box .shortcut { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }

        /* Cards */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .card-title { font-size: 10px; font-weight: 600; color: var(--primary); letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.15s; }
        .stat:hover { transform: translateY(-2px); }
        .stat::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .stat.urgent::before { background: var(--red); } .stat.urgent { box-shadow: inset 0 0 20px var(--red-glow); }
        .stat.due::before { background: var(--amber); } .stat.due { box-shadow: inset 0 0 20px var(--amber-glow); }
        .stat.total::before { background: var(--green); } .stat.total { box-shadow: inset 0 0 20px var(--green-glow); }
        .stat.missing::before { background: var(--blue); } .stat.missing { box-shadow: inset 0 0 20px var(--blue-glow); }
        .stat-label { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

        /* Charts */
        .charts-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
        .chart-card .card-title { justify-content: center; }
        .pie-chart { position: relative; width: 120px; height: 120px; margin: 0 auto 12px; }
        .pie-chart svg { transform: rotate(-90deg); }
        .pie-chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .pie-chart-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .pie-chart-label { font-size: 10px; color: var(--text-muted); }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; font-size: 11px; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 80px; margin-bottom: 12px; }
        .bar { width: 32px; border-radius: 4px 4px 0 0; transition: height 0.3s; position: relative; }
        .bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-muted); white-space: nowrap; }
        .bar-value { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; }

        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-dim); letter-spacing: 0.4px; text-transform: uppercase; margin-bottom: 4px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 13px; transition: all 0.15s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input.warning { border-color: var(--amber); background: var(--amber-glow); }
        .form-input.danger { border-color: var(--red); background: var(--red-glow); }
        .form-select { cursor: pointer; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border: none; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-card-hover); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-warning { background: var(--amber); color: #000; }
        .btn-sm { padding: 6px 10px; font-size: 11px; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Tables */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 10px 12px; font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--bg-input); }
        .table td { padding: 12px; font-size: 12px; border-bottom: 1px solid var(--border); }
        .table tr:hover td { background: var(--bg-card-hover); }
        .table tr.selected td { background: var(--primary-glow); }

        /* Badges */
        .badge { display: inline-flex; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-urgent { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .badge-mild, .badge-due { background: var(--amber-glow); color: var(--amber); border: 1px solid var(--amber); }
        .badge-ok, .badge-complete, .badge-resolved { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }
        .badge-overdue, .badge-missing { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .badge-info { background: var(--blue-glow); color: var(--blue); border: 1px solid var(--blue); }

        /* Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-2-wide-left { display: grid; grid-template-columns: 350px 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .flex { display: flex; align-items: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .gap-sm { gap: 6px; } .gap-md { gap: 12px; }
        .mt-sm { margin-top: 6px; } .mt-md { margin-top: 12px; } .mb-md { margin-bottom: 12px; }

        /* Ship List */
        .ship-list { }
        .ship-list::-webkit-scrollbar { width: 6px; }
        .ship-list::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
        .ship-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .ship-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.1s; font-size: 12px; }
        .ship-item:hover { background: var(--bg-card-hover); }
        .ship-item.selected { background: var(--primary-glow); border-left: 3px solid var(--primary); }
        .ship-item > span { padding: 0 4px; }
        .ship-item > span:nth-child(1) { width: 55px; flex-shrink: 0; }
        .ship-item > span:nth-child(2) { width: 70px; flex-shrink: 0; margin-left: 8px; }
        .ship-item > span:nth-child(3) { width: 75px; flex-shrink: 0; }
        .ship-item > span:nth-child(4) { width: 90px; flex-shrink: 0; }
        .ship-item > span:nth-child(5) { flex: 1; min-width: 0; text-align: right; }
        .ship-name { font-weight: 600; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .ship-type { font-size: 10px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ship-list-header { display: flex; align-items: center; padding: 8px 12px; background: var(--bg-input); border-bottom: 1px solid var(--border); font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.6px; text-transform: uppercase; position: sticky; top: 0; z-index: 1; }
        .ship-list-header > span { padding: 0 4px; }
        .ship-list-header > span:nth-child(1) { width: 55px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(2) { width: 70px; flex-shrink: 0; margin-left: 8px; }
        .ship-list-header > span:nth-child(3) { width: 75px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(4) { width: 90px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(5) { flex: 1; min-width: 0; text-align: right; }

        /* Dashboard Grid */
        .dash-grid { display: grid; grid-template-columns: 555px 1fr; gap: 20px; }
        .detail-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .section-title { font-size: 10px; font-weight: 600; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }

        /* Quick Actions */
        .quick-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }

        /* Filters */
        .filters { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .filter-btn:hover { background: var(--bg-card-hover); }
        .filter-btn.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 600; }

        /* Check rows */
        .check-row { display: grid; grid-template-columns: 70px 80px 70px 70px 70px 80px 80px; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); gap: 8px; font-size: 12px; }
        .check-row:nth-child(even) { background: var(--bg-input); }
        .check-row .form-input { padding: 6px 8px; font-size: 12px; }
        .check-header { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.6px; text-transform: uppercase; }

        /* Sparkline */
        .sparkline { display: flex; align-items: flex-end; gap: 2px; height: 24px; }
        .sparkline-bar { width: 4px; background: var(--primary); border-radius: 1px; min-height: 2px; }
        .sparkline-bar.warning { background: var(--amber); }
        .sparkline-bar.danger { background: var(--red); }

        /* Checkbox & Radio */
        .checkbox { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; }
        .checkbox input { width: 14px; height: 14px; accent-color: var(--primary); }
        .radio-group { display: flex; gap: 12px; }
        .radio { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; }
        .radio input { width: 14px; height: 14px; accent-color: var(--primary); }
        .radio.urgent { color: var(--red); } .radio.mild { color: var(--amber); } .radio.none { color: var(--green); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-wide { max-width: 700px; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text); }

        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .toast { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; animation: slideIn 0.2s ease; font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        .toast.info { border-left: 3px solid var(--blue); }

        /* Empty & Status */
        .empty { text-align: center; padding: 40px 16px; color: var(--text-muted); font-size: 13px; }
        .status { display: inline-flex; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .status-urgent { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .status-mild { background: var(--amber-glow); color: var(--amber); border: 1px solid var(--amber); }
        .status-ok { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }

        /* Activity Log */
        .activity-log { max-height: 300px; overflow-y: auto; }
        .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 10px; white-space: nowrap; }
        .activity-text { flex: 1; }

        /* Calendar */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-header { text-align: center; font-size: 10px; font-weight: 600; color: var(--text-muted); padding: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 6px; cursor: pointer; background: var(--bg-input); }
        .calendar-day:hover { background: var(--bg-card-hover); }
        .calendar-day.other-month { color: var(--text-muted); }
        .calendar-day.today { border: 2px solid var(--primary); }
        .calendar-day.has-event { background: var(--primary-glow); color: var(--primary); font-weight: 600; }

        /* Tags */
        .tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; font-size: 11px; margin-right: 4px; margin-bottom: 4px; }
        .tag-remove { cursor: pointer; color: var(--text-muted); }
        .tag-remove:hover { color: var(--red); }

        /* Drop Zone */
        .drop-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 40px; text-align: center; color: var(--text-muted); transition: all 0.2s; }
        .drop-zone.active { border-color: var(--primary); background: var(--primary-glow); color: var(--primary); }

        /* Smart Cards */
        .smart-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .smart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; }
        .smart-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .smart-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .smart-card-title { font-size: 10px; font-weight: 600; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }
        .smart-card-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .smart-card-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .smart-card-visual { margin-top: 12px; }
        .smart-card.fleet { border-left: 3px solid var(--green); }
        .smart-card.issues { border-left: 3px solid var(--red); }
        .smart-card.email { border-left: 3px solid var(--amber); }
        .smart-card.docs { border-left: 3px solid var(--blue); }
        .mini-progress { height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .mini-progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .mini-pie { width: 50px; height: 50px; }

        /* Collapsible Sections */
        .collapsible { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; overflow: hidden; }
        .collapsible-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; transition: background 0.15s; }
        .collapsible-header:hover { background: var(--bg-card-hover); }
        .collapsible-title { font-size: 11px; font-weight: 600; color: var(--primary); letter-spacing: 0.8px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
        .collapsible-badge { background: var(--bg-input); padding: 2px 8px; border-radius: 10px; font-size: 10px; color: var(--text-dim); }
        .collapsible-chevron { width: 16px; height: 16px; color: var(--text-muted); transition: transform 0.2s; }
        .collapsible-chevron.open { transform: rotate(180deg); }
        .collapsible-content { padding: 0 16px 16px; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
        .tab { padding: 10px 16px; background: none; border: none; color: var(--text-muted); font-size: 12px; cursor: pointer; position: relative; transition: color 0.15s; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--primary); font-weight: 600; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }
        .tab-content { animation: fadeIn 0.2s ease; }

        /* Simplified Ship List */
        .ship-list-simple { max-height: 500px; overflow-y: auto; }
        .ship-row { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s; }
        .ship-row:hover { background: var(--bg-card-hover); }
        .ship-row.selected { background: var(--primary-glow); border-left: 3px solid var(--primary); padding-left: 13px; }
        .ship-row-name { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 13px; }
        .ship-row-type { font-size: 10px; color: var(--text-muted); }
        .combined-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .combined-badge.issue { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .combined-badge.waiting { background: var(--amber-glow); color: var(--amber); border: 1px solid var(--amber); }
        .combined-badge.inport { background: var(--blue-glow); color: var(--blue); border: 1px solid var(--blue); }
        .combined-badge.online { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }
        .combined-badge.offline { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); }
        .view-btn { padding: 6px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); font-size: 11px; cursor: pointer; transition: all 0.15s; }
        .view-btn:hover { background: var(--primary); color: #000; border-color: var(--primary); }

        /* Reports Dropdown */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-trigger { display: flex; align-items: center; gap: 6px; padding: 10px 14px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .dropdown-trigger:hover { background: var(--bg-card-hover); }
        .dropdown-trigger svg { width: 14px; height: 14px; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 4px; min-width: 180px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); z-index: 100; overflow: hidden; }
        .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; color: var(--text-dim); font-size: 12px; cursor: pointer; transition: all 0.15s; border: none; background: none; width: 100%; text-align: left; }
        .dropdown-item:hover { background: var(--bg-card-hover); color: var(--text); }
        .dropdown-item svg { width: 14px; height: 14px; }

        /* Print Styles */
        @media print {
            .sidebar, .notif-banner, .btn, .nav-btn, .toast-container { display: none !important; }
            .main { margin-left: 0 !important; padding: 20px !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
            body { background: #fff; color: #000; }
            .badge, .status { border: 1px solid #999; }
        }

        /* Responsive */
        @media (max-width: 1400px) { .dash-grid { grid-template-columns: 520px 1fr; } .grid-2-wide-left { grid-template-columns: 300px 1fr; } .smart-cards { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1200px) { .smart-cards { grid-template-columns: repeat(2, 1fr); } .dash-grid { grid-template-columns: 1fr; } .grid-2 { grid-template-columns: 1fr; } .grid-2-wide-left { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 60px; } .sidebar .logo, .sidebar .logo-sub, .sidebar .nav-title, .sidebar .nav-btn span, .sidebar .version, .theme-toggle { display: none; } .sidebar .nav-btn { justify-content: center; padding: 12px; } .main { margin-left: 60px; padding: 16px; } .notif-banner { left: 60px; } .smart-cards { grid-template-columns: 1fr; } .search-box input { width: 150px; } .search-box .shortcut { display: none; } }

        input[type="date"] { color-scheme: dark; }
        .light-mode input[type="date"] { color-scheme: light; }

        /* Loading spinner */
        .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyA2HSftodTHDq3CJbeN7O4i0u4cADawJwI",
    authDomain: "ship-checker.firebaseapp.com",
    projectId: "ship-checker",
    storageBucket: "ship-checker.firebasestorage.app",
    messagingSenderId: "62381002799",
    appId: "1:62381002799:web:7511faee3e301fabeb36da",
    measurementId: "G-T7X4T0EGZK"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Default admin credentials
const DEFAULT_ADMIN = {
    email: 'dbrown@shiptracker.local',
    password: 'admin123',
    displayName: 'dbrown'
};

// Setup default admin on first load
const setupDefaultAdmin = async () => {
    try {
        // Check if default admin exists in userProfiles
        const adminQuery = await db.collection('userProfiles').where('email', '==', DEFAULT_ADMIN.email).get();
        if (adminQuery.empty) {
            // Try to create the user in Firebase Auth
            try {
                const userCred = await auth.createUserWithEmailAndPassword(DEFAULT_ADMIN.email, DEFAULT_ADMIN.password);
                await userCred.user.updateProfile({ displayName: DEFAULT_ADMIN.displayName });
                // Create approved admin profile
                await db.collection('userProfiles').doc(userCred.user.uid).set({
                    uid: userCred.user.uid,
                    email: DEFAULT_ADMIN.email,
                    displayName: DEFAULT_ADMIN.displayName,
                    isAdmin: true,
                    status: 'approved',
                    createdAt: new Date().toISOString()
                });
                console.log('Default admin created: dbrown@shiptracker.local / admin123');
                await auth.signOut();
            } catch (authErr) {
                if (authErr.code === 'auth/email-already-in-use') {
                    // User exists in Auth but not in profiles, sign in to get uid
                    try {
                        const userCred = await auth.signInWithEmailAndPassword(DEFAULT_ADMIN.email, DEFAULT_ADMIN.password);
                        await db.collection('userProfiles').doc(userCred.user.uid).set({
                            uid: userCred.user.uid,
                            email: DEFAULT_ADMIN.email,
                            displayName: DEFAULT_ADMIN.displayName,
                            isAdmin: true,
                            status: 'approved',
                            createdAt: new Date().toISOString()
                        });
                        await auth.signOut();
                    } catch (e) { console.log('Admin setup skipped'); }
                }
            }
        } else {
            // Ensure existing dbrown is admin and approved
            const doc = adminQuery.docs[0];
            if (!doc.data().isAdmin || doc.data().status !== 'approved') {
                await db.collection('userProfiles').doc(doc.id).update({
                    isAdmin: true,
                    status: 'approved'
                });
            }
        }
    } catch (err) {
        console.log('Admin setup error:', err);
    }
};
setupDefaultAdmin();

// Migrate legacy users from old auth system
const migrateLegacyUsers = async () => {
    try {
        // Check for old users in localStorage (common storage locations)
        const legacyKeys = ['users', 'shipTrackerUsers', 'fb_users', 'registeredUsers'];
        let legacyUsers = [];

        for (const key of legacyKeys) {
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (Array.isArray(parsed)) {
                        legacyUsers = [...legacyUsers, ...parsed];
                    }
                } catch (e) {}
            }
        }

        if (legacyUsers.length === 0) return;

        console.log(`Found ${legacyUsers.length} legacy users to migrate`);

        for (const user of legacyUsers) {
            if (!user.email && user.username) {
                // Convert username to email format if needed
                user.email = user.username.includes('@') ? user.username : `${user.username}@shiptracker.local`;
            }
            if (!user.email) continue;

            // Check if already migrated
            const existingProfile = await db.collection('userProfiles').where('email', '==', user.email).get();
            if (!existingProfile.empty) continue;

            try {
                // Try to create Firebase Auth account with their password
                // If password was hashed, use a default and they'll need to reset
                const password = user.plainPassword || user.password || 'changeme123';
                const userCred = await auth.createUserWithEmailAndPassword(user.email, password.length >= 6 ? password : 'changeme123');

                await userCred.user.updateProfile({
                    displayName: user.displayName || user.username || user.email.split('@')[0]
                });

                // Create approved profile (keep their admin status if they had it)
                await db.collection('userProfiles').doc(userCred.user.uid).set({
                    uid: userCred.user.uid,
                    email: user.email,
                    displayName: user.displayName || user.username || user.email.split('@')[0],
                    isAdmin: user.isAdmin || user.role === 'admin' || false,
                    status: 'approved',
                    migratedFrom: 'legacy',
                    createdAt: user.createdAt || new Date().toISOString()
                });

                console.log(`Migrated user: ${user.email}`);
                await auth.signOut();
            } catch (authErr) {
                if (authErr.code === 'auth/email-already-in-use') {
                    // User exists in Auth, just ensure profile exists
                    console.log(`User ${user.email} already in Firebase Auth`);
                } else {
                    console.log(`Could not migrate ${user.email}:`, authErr.message);
                }
            }
        }

        // Mark migration as complete
        localStorage.setItem('legacyMigrationComplete', 'true');
        console.log('Legacy user migration complete');
    } catch (err) {
        console.log('Migration error:', err);
    }
};

// Run migration if not already done
if (!localStorage.getItem('legacyMigrationComplete')) {
    migrateLegacyUsers();
}
</script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// Firebase real-time hook - loads instantly from localStorage, syncs with Firestore
const useFirestore = (collectionName, initialData = []) => {
    const [data, setData] = useState(() => {
        try {
            const saved = localStorage.getItem('fb_' + collectionName);
            if (saved) return JSON.parse(saved);
        } catch {}
        if (initialData.length > 0) {
            localStorage.setItem('fb_' + collectionName, JSON.stringify(initialData));
        }
        return initialData;
    });
    const [loading, setLoading] = useState(false);
    const initialized = useRef(false);

    useEffect(() => {
        const unsubscribe = db.collection(collectionName).onSnapshot((snapshot) => {
            if (!snapshot.empty) {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setData(items);
                localStorage.setItem('fb_' + collectionName, JSON.stringify(items));
            } else if (initialData.length > 0 && !initialized.current) {
                initialized.current = true;
                const batch = db.batch();
                initialData.forEach(item => {
                    const ref = db.collection(collectionName).doc(item.id);
                    batch.set(ref, item);
                });
                batch.commit();
            }
            setLoading(false);
        }, (error) => {
            console.error('Firestore error:', error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [collectionName]);

    const setDataWithSync = useCallback((newDataOrFn) => {
        const newData = typeof newDataOrFn === 'function' ? newDataOrFn(data) : newDataOrFn;
        setData(newData);
        localStorage.setItem('fb_' + collectionName, JSON.stringify(newData));

        const batch = db.batch();
        newData.forEach(item => {
            if (item && item.id) {
                const ref = db.collection(collectionName).doc(item.id);
                batch.set(ref, item);
            }
        });
        const newIds = new Set(newData.map(item => item.id));
        data.forEach(item => {
            if (item && item.id && !newIds.has(item.id)) {
                const ref = db.collection(collectionName).doc(item.id);
                batch.delete(ref);
            }
        });
        batch.commit().catch(err => console.error('Batch write error:', err));
    }, [collectionName, data]);

    return [data, setDataWithSync, loading];
};

const useStorage = (key, init) => {
    const [val, setVal] = useState(() => { try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : init; } catch { return init; } });
    useEffect(() => { localStorage.setItem(key, JSON.stringify(val)); }, [key, val]);
    return [val, setVal];
};

// ===== AUTHENTICATION WITH FIREBASE AUTH =====
function LoginPage({ onLogin }) {
    const [mode, setMode] = useState('login');
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [displayName, setDisplayName] = useState('');
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');
    const [loading, setLoading] = useState(false);

    // Check for legacy user in localStorage
    const findLegacyUser = (emailOrUsername, password) => {
        const legacyKeys = ['users', 'shipTrackerUsers', 'fb_users', 'registeredUsers'];
        for (const key of legacyKeys) {
            try {
                const stored = localStorage.getItem(key);
                if (stored) {
                    const users = JSON.parse(stored);
                    if (Array.isArray(users)) {
                        const user = users.find(u =>
                            (u.email === emailOrUsername || u.username === emailOrUsername) &&
                            (u.password === password || u.plainPassword === password)
                        );
                        if (user) return user;
                    }
                }
            } catch (e) {}
        }
        return null;
    };

    // Migrate legacy user to Firebase Auth
    const migrateLegacyUser = async (legacyUser, password) => {
        const userEmail = legacyUser.email || (legacyUser.username.includes('@') ? legacyUser.username : `${legacyUser.username}@shiptracker.local`);

        try {
            // Create Firebase Auth account
            const userCred = await auth.createUserWithEmailAndPassword(userEmail, password);
            await userCred.user.updateProfile({
                displayName: legacyUser.displayName || legacyUser.username || userEmail.split('@')[0]
            });

            // Create approved profile
            await db.collection('userProfiles').doc(userCred.user.uid).set({
                uid: userCred.user.uid,
                email: userEmail,
                displayName: legacyUser.displayName || legacyUser.username || userEmail.split('@')[0],
                isAdmin: legacyUser.isAdmin || legacyUser.role === 'admin' || false,
                status: 'approved',
                migratedFrom: 'legacy',
                createdAt: legacyUser.createdAt || new Date().toISOString()
            });

            return { success: true, email: userEmail };
        } catch (err) {
            if (err.code === 'auth/email-already-in-use') {
                // Try to sign in instead
                return { success: true, email: userEmail, alreadyExists: true };
            }
            throw err;
        }
    };

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        if (!email.trim() || !password.trim()) {
            setError('Please enter email and password');
            setLoading(false);
            return;
        }

        // Normalize email - add domain if just username
        let loginEmail = email.trim();
        if (!loginEmail.includes('@')) {
            loginEmail = `${loginEmail}@shiptracker.local`;
        }

        try {
            const userCredential = await auth.signInWithEmailAndPassword(loginEmail, password);
            // User profile will be loaded by AuthWrapper's onAuthStateChanged
        } catch (err) {
            console.error('Login error:', err);

            // Check for legacy user if not found in Firebase
            if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                const legacyUser = findLegacyUser(email.trim(), password);
                if (legacyUser) {
                    try {
                        setError('');
                        const result = await migrateLegacyUser(legacyUser, password);
                        // Now try to sign in with the migrated account
                        await auth.signInWithEmailAndPassword(result.email, password);
                        setLoading(false);
                        return;
                    } catch (migrateErr) {
                        console.error('Migration error:', migrateErr);
                        setError('Could not migrate your account. Please register again.');
                        setLoading(false);
                        return;
                    }
                }
            }

            switch (err.code) {
                case 'auth/user-not-found':
                    setError('No account found. Try with just your username (e.g., "dbrown").');
                    break;
                case 'auth/wrong-password':
                    setError('Incorrect password.');
                    break;
                case 'auth/invalid-email':
                    setError('Invalid email address.');
                    break;
                case 'auth/too-many-requests':
                    setError('Too many failed attempts. Please try again later.');
                    break;
                default:
                    setError(err.message);
            }
        }
        setLoading(false);
    };

    const handleRegister = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        setLoading(true);

        if (!email.trim() || !password.trim() || !displayName.trim()) {
            setError('Please fill in all fields');
            setLoading(false);
            return;
        }
        if (password.length < 6) {
            setError('Password must be at least 6 characters');
            setLoading(false);
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);

            // Update display name
            await userCredential.user.updateProfile({
                displayName: displayName.trim()
            });

            // Create user profile in Firestore
            await db.collection('userProfiles').doc(userCredential.user.uid).set({
                uid: userCredential.user.uid,
                email: email,
                displayName: displayName.trim(),
                isAdmin: false,
                status: 'pending',
                createdAt: new Date().toISOString()
            });

            // Sign out - they need admin approval
            await auth.signOut();

            setSuccess('Account created! Please wait for admin approval before logging in.');
            setEmail('');
            setPassword('');
            setDisplayName('');
            setMode('login');
        } catch (err) {
            console.error('Registration error:', err);
            switch (err.code) {
                case 'auth/email-already-in-use':
                    setError('An account with this email already exists.');
                    break;
                case 'auth/invalid-email':
                    setError('Invalid email address.');
                    break;
                case 'auth/weak-password':
                    setError('Password is too weak. Use at least 6 characters.');
                    break;
                default:
                    setError(err.message);
            }
        }
        setLoading(false);
    };

    const handlePasswordReset = async () => {
        if (!email.trim()) {
            setError('Enter your email address first');
            return;
        }
        setLoading(true);
        try {
            await auth.sendPasswordResetEmail(email);
            setSuccess('Password reset email sent! Check your inbox.');
            setError('');
        } catch (err) {
            setError('Could not send reset email. Check your email address.');
        }
        setLoading(false);
    };

    return (
        <div style={{minHeight:'100vh',background:'var(--bg-deep)',display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
            <div style={{width:'100%',maxWidth:'400px'}}>
                <div style={{textAlign:'center',marginBottom:'32px'}}>
                    <svg width="80" height="40" viewBox="0 0 120 60" fill="none" stroke="var(--primary)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{marginBottom:'16px'}}><path d="M10 40l8-5h84l8 5H10z"/><path d="M18 35h84l4-10H14l4 10z"/><path d="M22 25V18h76v7"/><path d="M30 18v-5h8v5"/><path d="M50 18V8h10v10"/><path d="M72 18v-5h8v5"/><path d="M35 40v8h50v-8"/></svg>
                    <div style={{fontFamily:'JetBrains Mono',fontSize:'18px',fontWeight:700,color:'var(--primary)',letterSpacing:'2px'}}>SHIP TRACKER PRO</div>
                    <div style={{fontSize:'12px',color:'var(--text-muted)',marginTop:'4px'}}>Secure Edition</div>
                </div>
                <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'12px',padding:'24px'}}>
                    <div style={{display:'flex',marginBottom:'24px',borderBottom:'1px solid var(--border)'}}>
                        <button onClick={() => { setMode('login'); setError(''); setSuccess(''); }} style={{flex:1,padding:'12px',background:'none',border:'none',color: mode === 'login' ? 'var(--primary)' : 'var(--text-muted)',fontWeight: mode === 'login' ? 600 : 400,cursor:'pointer',borderBottom: mode === 'login' ? '2px solid var(--primary)' : 'none',marginBottom:'-1px'}}>Login</button>
                        <button onClick={() => { setMode('register'); setError(''); setSuccess(''); }} style={{flex:1,padding:'12px',background:'none',border:'none',color: mode === 'register' ? 'var(--primary)' : 'var(--text-muted)',fontWeight: mode === 'register' ? 600 : 400,cursor:'pointer',borderBottom: mode === 'register' ? '2px solid var(--primary)' : 'none',marginBottom:'-1px'}}>Register</button>
                    </div>
                    {error && <div style={{background:'var(--red-glow)',border:'1px solid var(--red)',color:'var(--red)',padding:'12px',borderRadius:'8px',marginBottom:'16px',fontSize:'13px'}}>{error}</div>}
                    {success && <div style={{background:'var(--green-glow)',border:'1px solid var(--green)',color:'var(--green)',padding:'12px',borderRadius:'8px',marginBottom:'16px',fontSize:'13px'}}>{success}</div>}
                    {mode === 'login' ? (
                        <form onSubmit={handleLogin}>
                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Enter email" disabled={loading}/>
                            </div>
                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Enter password" disabled={loading}/>
                            </div>
                            <button type="button" onClick={handlePasswordReset} style={{background:'none',border:'none',color:'var(--primary)',fontSize:'12px',cursor:'pointer',marginBottom:'16px',padding:0}}>Forgot password?</button>
                            <button type="submit" disabled={loading} style={{width:'100%',padding:'14px',background:'var(--primary)',color:'#000',border:'none',borderRadius:'8px',fontSize:'14px',fontWeight:600,cursor:loading?'wait':'pointer',opacity:loading?0.7:1,display:'flex',alignItems:'center',justifyContent:'center',gap:'8px'}}>
                                {loading && <span className="spinner"></span>}
                                {loading ? 'Signing in...' : 'Login'}
                            </button>
                        </form>
                    ) : (
                        <form onSubmit={handleRegister}>
                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Display Name</label>
                                <input type="text" value={displayName} onChange={e => setDisplayName(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Your name" disabled={loading}/>
                            </div>
                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Enter email" disabled={loading}/>
                            </div>
                            <div style={{marginBottom:'24px'}}>
                                <label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Min 6 characters" disabled={loading}/>
                            </div>
                            <button type="submit" disabled={loading} style={{width:'100%',padding:'14px',background:'var(--primary)',color:'#000',border:'none',borderRadius:'8px',fontSize:'14px',fontWeight:600,cursor:loading?'wait':'pointer',opacity:loading?0.7:1,display:'flex',alignItems:'center',justifyContent:'center',gap:'8px'}}>
                                {loading && <span className="spinner"></span>}
                                {loading ? 'Creating account...' : 'Create Account'}
                            </button>
                            <p style={{fontSize:'11px',color:'var(--text-muted)',textAlign:'center',marginTop:'12px'}}>Your account requires admin approval</p>
                        </form>
                    )}
                </div>
                <div style={{marginTop:'16px',padding:'12px',background:'var(--green-glow)',border:'1px solid var(--green)',borderRadius:'8px',fontSize:'11px',color:'var(--green)'}}>
                    <strong>Secure Authentication</strong><br/>
                    Passwords are securely hashed by Firebase Auth. Your credentials are never stored in plain text.
                </div>
            </div>
        </div>
    );
}

function AdminPanel({ onClose }) {
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsubscribe = db.collection('userProfiles').onSnapshot((snapshot) => {
            const userList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setUsers(userList);
            setLoading(false);
        });
        return () => unsubscribe();
    }, []);

    const pending = users.filter(u => u.status === 'pending');
    const approved = users.filter(u => u.status === 'approved');
    const denied = users.filter(u => u.status === 'denied');

    const approve = async (u) => {
        await db.collection('userProfiles').doc(u.id).update({
            status: 'approved',
            approvedAt: new Date().toISOString()
        });
    };

    const deny = async (u) => {
        await db.collection('userProfiles').doc(u.id).update({
            status: 'denied',
            deniedAt: new Date().toISOString()
        });
    };

    const toggleAdmin = async (u) => {
        await db.collection('userProfiles').doc(u.id).update({
            isAdmin: !u.isAdmin
        });
    };

    const del = async (u) => {
        if (confirm(`Delete ${u.displayName || u.email}? This will remove their profile but not their Firebase Auth account.`)) {
            await db.collection('userProfiles').doc(u.id).delete();
        }
    };

    if (loading) {
        return (
            <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'}}>
                <div className="spinner" style={{width:'40px',height:'40px'}}></div>
            </div>
        );
    }

    return (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
            <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'12px',width:'100%',maxWidth:'600px',maxHeight:'80vh',overflow:'auto'}}>
                <div style={{padding:'20px',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center',position:'sticky',top:0,background:'var(--bg-card)',zIndex:1}}>
                    <h2 style={{fontSize:'18px',fontWeight:600}}>Admin Panel</h2>
                    <button onClick={onClose} style={{background:'none',border:'none',color:'var(--text-muted)',fontSize:'24px',cursor:'pointer'}}>x</button>
                </div>
                <div style={{padding:'20px'}}>
                    {pending.length > 0 && (
                        <div style={{marginBottom:'24px'}}>
                            <h3 style={{fontSize:'14px',color:'var(--amber)',marginBottom:'12px'}}>
                                <span style={{background:'var(--amber)',color:'#000',padding:'2px 8px',borderRadius:'10px',fontSize:'12px',marginRight:'8px'}}>{pending.length}</span>
                                Pending Approval
                            </h3>
                            {pending.map(u => (
                                <div key={u.id} style={{background:'var(--amber-glow)',border:'1px solid var(--amber)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                    <div>
                                        <div style={{fontWeight:600}}>{u.displayName || 'No name'}</div>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{u.email}</div>
                                        <div style={{fontSize:'10px',color:'var(--text-muted)'}}>{new Date(u.createdAt).toLocaleString()}</div>
                                    </div>
                                    <div style={{display:'flex',gap:'8px'}}>
                                        <button onClick={() => approve(u)} style={{padding:'6px 12px',background:'var(--green)',color:'#000',border:'none',borderRadius:'6px',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>Approve</button>
                                        <button onClick={() => deny(u)} style={{padding:'6px 12px',background:'var(--red)',color:'#fff',border:'none',borderRadius:'6px',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>Deny</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <div style={{marginBottom:'24px'}}>
                        <h3 style={{fontSize:'14px',color:'var(--green)',marginBottom:'12px'}}>Approved Users ({approved.length})</h3>
                        {approved.map(u => (
                            <div key={u.id} style={{background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <div>
                                    <div style={{fontWeight:600,display:'flex',alignItems:'center',gap:'8px'}}>
                                        {u.displayName || u.email}
                                        {u.isAdmin && <span style={{background:'var(--primary)',color:'#000',padding:'2px 6px',borderRadius:'4px',fontSize:'10px'}}>ADMIN</span>}
                                    </div>
                                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{u.email}</div>
                                </div>
                                <div style={{display:'flex',gap:'8px'}}>
                                    <button onClick={() => toggleAdmin(u)} style={{padding:'6px 12px',background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'6px',fontSize:'11px',cursor:'pointer',color:'var(--text-dim)'}}>
                                        {u.isAdmin ? 'Remove Admin' : 'Make Admin'}
                                    </button>
                                    <button onClick={() => del(u)} style={{padding:'6px 12px',background:'var(--red-glow)',color:'var(--red)',border:'1px solid var(--red)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Delete</button>
                                </div>
                            </div>
                        ))}
                        {approved.length === 0 && <div style={{color:'var(--text-muted)',fontSize:'13px'}}>No approved users yet</div>}
                    </div>

                    {denied.length > 0 && (
                        <div>
                            <h3 style={{fontSize:'14px',color:'var(--red)',marginBottom:'12px'}}>Denied ({denied.length})</h3>
                            {denied.map(u => (
                                <div key={u.id} style={{background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center',opacity:0.7}}>
                                    <div>
                                        <div style={{fontWeight:600}}>{u.displayName || u.email}</div>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{u.email}</div>
                                    </div>
                                    <div style={{display:'flex',gap:'8px'}}>
                                        <button onClick={() => approve(u)} style={{padding:'6px 12px',background:'var(--green-glow)',color:'var(--green)',border:'1px solid var(--green)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Approve</button>
                                        <button onClick={() => del(u)} style={{padding:'6px 12px',background:'var(--red-glow)',color:'var(--red)',border:'1px solid var(--red)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Delete</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

function AuthWrapper() {
    const [authState, setAuthState] = useState('loading'); // 'loading', 'unauthenticated', 'pending', 'authenticated'
    const [currentUser, setCurrentUser] = useState(null);
    const [userProfile, setUserProfile] = useState(null);
    const [showAdmin, setShowAdmin] = useState(false);
    const [pendingCount, setPendingCount] = useState(0);

    useEffect(() => {
        // Listen for auth state changes
        const unsubscribeAuth = auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in, check their profile
                const profileRef = db.collection('userProfiles').doc(user.uid);

                const unsubscribeProfile = profileRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const profile = doc.data();
                        setUserProfile(profile);

                        if (profile.status === 'approved') {
                            setCurrentUser({
                                uid: user.uid,
                                email: user.email,
                                displayName: profile.displayName || user.displayName || user.email,
                                isAdmin: profile.isAdmin || false
                            });
                            setAuthState('authenticated');
                        } else if (profile.status === 'pending') {
                            setAuthState('pending');
                        } else if (profile.status === 'denied') {
                            auth.signOut();
                            setAuthState('unauthenticated');
                        }
                    } else {
                        // No profile exists, create one (for existing Firebase Auth users)
                        profileRef.set({
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName || user.email,
                            isAdmin: false,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                        setAuthState('pending');
                    }
                });

                return () => unsubscribeProfile();
            } else {
                setCurrentUser(null);
                setUserProfile(null);
                setAuthState('unauthenticated');
            }
        });

        // Listen for pending users count (for admin badge)
        const unsubscribePending = db.collection('userProfiles')
            .where('status', '==', 'pending')
            .onSnapshot((snapshot) => {
                setPendingCount(snapshot.size);
            });

        return () => {
            unsubscribeAuth();
            unsubscribePending();
        };
    }, []);

    const logout = async () => {
        await auth.signOut();
        localStorage.removeItem('shipTrackerUser');
    };

    if (authState === 'loading') {
        return (
            <div style={{minHeight:'100vh',background:'var(--bg-deep)',display:'flex',alignItems:'center',justifyContent:'center'}}>
                <div style={{textAlign:'center'}}>
                    <div className="spinner" style={{width:'40px',height:'40px',margin:'0 auto 16px'}}></div>
                    <div style={{color:'var(--text-muted)'}}>Loading...</div>
                </div>
            </div>
        );
    }

    if (authState === 'pending') {
        return (
            <div style={{minHeight:'100vh',background:'var(--bg-deep)',display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
                <div style={{textAlign:'center',maxWidth:'400px'}}>
                    <div style={{fontSize:'48px',marginBottom:'16px'}}></div>
                    <h2 style={{color:'var(--amber)',marginBottom:'16px'}}>Account Pending Approval</h2>
                    <p style={{color:'var(--text-dim)',marginBottom:'24px'}}>Your account has been created but is waiting for admin approval. Please check back later.</p>
                    <button onClick={logout} style={{padding:'12px 24px',background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',cursor:'pointer'}}>Sign Out</button>
                </div>
            </div>
        );
    }

    if (authState === 'authenticated' && currentUser) {
        return (
            <>
                <App
                    currentUser={currentUser}
                    onLogout={logout}
                    isAdmin={currentUser.isAdmin}
                    pendingCount={pendingCount}
                    onOpenAdminPanel={() => setShowAdmin(true)}
                />
                {showAdmin && currentUser.isAdmin && <AdminPanel onClose={() => setShowAdmin(false)}/>}
            </>
        );
    }

    return <LoginPage onLogin={() => {}} />;
}


const defaultShips = [
    { id: 'S001', name: 'CG67', type: 'Full REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:39.997Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S002', name: 'CG70', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T18:00:02.820Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S003', name: 'DDG54', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T00:00:00.000Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '', waitingReply: true },
    { id: 'S004', name: 'DDG56', type: 'Full REAP', location: 'Everett, WA', poc: '', email: '', threat: 'NoIssue', lastContact: null, nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S005', name: 'DDG62', type: 'Full REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:54:46.945Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S006', name: 'DDG63', type: 'Full REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:58:57.236Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S007', name: 'DDG55', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:22.669Z', nextCheck: '2026-01-21', lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S008', name: 'DDG57', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: null, nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S009', name: 'DDG72', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:56:38.578Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S011', name: 'DDG96', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:50.621Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S012', name: 'DDG98', type: 'Mini REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:57.277Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S013', name: 'DDG101', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:21:03.773Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S014', name: 'DDG103', type: 'Mini REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:54:54.225Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S015', name: 'DDG109', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:59:37.220Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S016', name: 'DDG111', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:55:24.866Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
];

const defaultIssues = [
    { id: 'I1768930451445', shipId: 'S007', shipName: 'DDG55', threat: 'Mild', title: 'Systems Offline', category: 'Network/Equipment', details: 'We noticed that both systems have been offline since yesterday. Is SF currently experiencing a power outage or SIPR outage in CSER2?', created: '2026-01-20T17:34:11.445Z', resolved: false },
    { id: 'I1768930471981', shipId: 'S003', shipName: 'DDG54', threat: 'Mild', title: 'CNO till May', category: 'Ship Maintenance', details: 'I am reaching out regarding the (STAR & DATA) Reap PCs. Both systems have appeared to go offline since 12/16.', created: '2026-01-20T17:34:31.981Z', resolved: false },
    { id: 'I1768931474446', shipId: 'S005', shipName: 'DDG62', threat: 'Mild', title: 'REAP PCs Offline', category: 'Network/Equipment', details: 'We have noticed that the REAP STAR & DATA PCs are offline at this time.', created: '2026-01-20T17:51:14.446Z', resolved: false },
    { id: 'I1768931502710', shipId: 'S014', shipName: 'DDG103', threat: 'Mild', title: 'Intermittent Connection', category: 'Network/Equipment', details: 'We are currently experiencing intermittent SHF/EHF which is causing issues seeing the system online.', created: '2026-01-20T17:51:42.710Z', resolved: false },
];

const defaultDailyChecks = [
    { id: 'DC001', shipId: 'S001', date: '2026-01-20', pingAM: '237', pingPM: '237', hdSpace: '1779', statusAM: true, statusPM: true },
    { id: 'DC002', shipId: 'S002', date: '2026-01-20', pingAM: '202', pingPM: '287', hdSpace: '545', statusAM: true, statusPM: true },
    { id: 'DC003', shipId: 'S003', date: '2026-01-20', pingAM: '', pingPM: '', hdSpace: '', statusAM: false, statusPM: false },
    { id: 'DC006', shipId: 'S006', date: '2026-01-20', pingAM: '358', pingPM: '356', hdSpace: '1760', statusAM: true, statusPM: true },
    { id: 'DC009', shipId: 'S009', date: '2026-01-20', pingAM: '195', pingPM: '195', hdSpace: '', statusAM: true, statusPM: true },
    { id: 'DC012', shipId: 'S013', date: '2026-01-20', pingAM: '275', pingPM: '', hdSpace: '', statusAM: true, statusPM: false },
];

const defaultActivityLog = [
    { id: 'A1768932835636', text: 'Marked DDG54 as waiting on reply', time: '2026-01-20T18:13:55.636Z' },
    { id: 'A1768932002820', text: 'Marked CG70 as contacted', time: '2026-01-20T18:00:02.820Z' },
    { id: 'A1768931977220', text: 'Marked DDG109 as contacted', time: '2026-01-20T17:59:37.220Z' },
];

const hullNum = (name) => { const m = name.match(/\d+/); return m ? parseInt(m[0]) : 9999; };
const sortHull = (a, b) => hullNum(a.name) - hullNum(b.name);
const fmtDate = (d) => {
    if (!d) return '';
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [y, m, day] = d.split('-').map(Number);
        return new Date(y, m - 1, day).toLocaleDateString('en-US');
    }
    if (typeof d === 'string' && d.includes('T')) {
        const datePart = d.split('T')[0];
        const [y, m, day] = datePart.split('-').map(Number);
        return new Date(y, m - 1, day).toLocaleDateString('en-US');
    }
    const date = new Date(d);
    return date.toLocaleDateString('en-US');
};
const fmtDateInput = (d) => {
    if (!d) return '';
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) return d;
    if (typeof d === 'string' && d.includes('T')) return d.split('T')[0];
    const date = new Date(d);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
};
const parseLocalDate = (d) => {
    if (!d) return new Date();
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [y, m, day] = d.split('-').map(Number);
        return new Date(y, m - 1, day);
    }
    if (typeof d === 'string' && d.includes('T')) {
        const datePart = d.split('T')[0];
        const [y, m, day] = datePart.split('-').map(Number);
        return new Date(y, m - 1, day);
    }
    return new Date(d);
};
const toDateString = (d) => {
    const date = d instanceof Date ? d : new Date(d);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
};
const fmtTime = (d) => { const now = new Date(), then = new Date(d), diff = (now - then) / 1000; if (diff < 60) return 'Just now'; if (diff < 3600) return `${Math.floor(diff/60)}m ago`; if (diff < 86400) return `${Math.floor(diff/3600)}h ago`; return `${Math.floor(diff/86400)}d ago`; };
const genId = (p) => `${p}${Date.now()}`;

const getEmailStatus = (ship, issues) => {
    if (ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0))) {
        return { status: 'IN PORT', days: 0 };
    }
    if (ship.waitingReply) return { status: 'WAITING', days: 0 };
    const si = issues.filter(i => i.shipId === ship.id && !i.resolved);
    const urg = si.some(i => i.threat === 'Urgent') ? 2 : si.some(i => i.threat === 'Mild') ? 1 : 0;
    if (!ship.lastContact) return { status: 'OVERDUE', days: 999 };
    const lc = new Date(ship.lastContact), due = new Date(lc);
    if (urg === 2) due.setDate(due.getDate() + 1);
    else if (urg === 1) due.setDate(due.getDate() + 3);
    else due.setDate(due.getDate() + 14);
    const today = new Date(); today.setHours(0,0,0,0); due.setHours(0,0,0,0);
    const diff = Math.floor((today - due) / 86400000);
    if (diff > 0) return { status: 'OVERDUE', days: diff };
    if (diff === 0) return { status: 'DUE', days: 0 };
    return { status: 'OK', days: diff };
};

const Icon = ({ name }) => {
    const paths = {
        dashboard: <><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></>,
        checks: <><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></>,
        add: <><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></>,
        issues: <><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4M12 17h.01"/></>,
        inventory: <><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></>,
        installs: <><path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4 22-7z"/></>,
        parts: <><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></>,
        email: <><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></>,
        settings: <><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></>,
        search: <><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></>,
        close: <><path d="M18 6L6 18M6 6l12 12"/></>,
        check: <><path d="M20 6L9 17l-5-5"/></>,
        edit: <><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
        trash: <><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></>,
        plus: <><path d="M12 5v14M5 12h14"/></>,
        download: <><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></>,
        upload: <><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></>,
        user: <><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        ship: <><path d="M1 16h22l-2-4H3l-2 4z"/><path d="M3 12h18v-2H3v2z"/><path d="M5 10V8h14v2"/><path d="M7 8V6h2v2"/><path d="M11 8V4h2v4"/><path d="M15 8V6h2v2"/><path d="M19 12l2 1v2l-2 1"/><path d="M6 16v2h12v-2"/></>,
        destroyer: <><path d="M2 17l3-2h14l3 2H2z" fill="none"/><path d="M5 15h14l1-3H4l1 3z" fill="none"/><path d="M6 12V9h12v3" fill="none"/><path d="M8 9V7h2v2" fill="none"/><path d="M11 9V5h2v4" fill="none"/><path d="M14 9V7h2v2" fill="none"/><path d="M19 13l2 1.5v2L19 18" fill="none"/><path d="M3 13l-2 1.5v2L3 18" fill="none"/><path d="M7 17v2h10v-2" fill="none"/></>,
        alert: <><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></>,
        info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></>,
        copy: <><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></>,
        print: <><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>,
        report: <><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8M16 17H8M10 9H8"/></>,
    };
    return <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{paths[name]}</svg>;
};

const Toast = ({ toasts, remove }) => (
    <div className="toast-container">
        {toasts.map(t => (
            <div key={t.id} className={`toast toast-${t.type}`} onClick={() => remove(t.id)}>
                {t.message}
            </div>
        ))}
    </div>
);

const DonutChart = ({ value, total, max, color, label, sublabel }) => {
    const maxVal = total || max || 1;
    const pct = maxVal > 0 ? (value / maxVal) * 100 : 0;
    const circumference = 2 * Math.PI * 45;
    const offset = circumference - (pct / 100) * circumference;
    return (
        <div className="pie-chart">
            <svg width="120" height="120" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" strokeWidth="10"/>
                <circle cx="50" cy="50" r="45" fill="none" stroke={color} strokeWidth="10" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round"/>
            </svg>
            <div className="pie-chart-center">
                <div className="pie-chart-value">{value}</div>
                <div className="pie-chart-label">{label}</div>
                {sublabel && <div style={{fontSize:'10px',color:'var(--text-muted)'}}>{sublabel}</div>}
            </div>
        </div>
    );
};

const PieChart = ({ data, colors, value, max, color, label }) => {
    if (data && Array.isArray(data)) {
        const total = data.reduce((a, b) => a + b, 0) || 1;
        const circumference = 2 * Math.PI * 45;
        let offset = 0;
        return (
            <div className="pie-chart">
                <svg width="120" height="120" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" strokeWidth="10"/>
                    {data.map((val, i) => {
                        const pct = (val / total) * circumference;
                        const segment = (
                            <circle key={i} cx="50" cy="50" r="45" fill="none" stroke={colors?.[i] || 'var(--primary)'} strokeWidth="10"
                                strokeDasharray={`${pct} ${circumference - pct}`}
                                strokeDashoffset={-offset}
                                style={{transform: 'rotate(-90deg)', transformOrigin: 'center'}}/>
                        );
                        offset += pct;
                        return segment;
                    })}
                </svg>
                <div className="pie-chart-center">
                    <div className="pie-chart-value">{total}</div>
                    <div className="pie-chart-label">Total</div>
                </div>
            </div>
        );
    }
    return <DonutChart value={value} max={max} color={color} label={label} />;
};

// Mini Pie for Smart Cards
const MiniPie = ({ data, colors }) => {
    const total = data.reduce((a, b) => a + b, 0) || 1;
    const circumference = 2 * Math.PI * 18;
    let offset = 0;
    return (
        <svg width="50" height="50" viewBox="0 0 50 50" className="mini-pie">
            <circle cx="25" cy="25" r="18" fill="none" stroke="var(--border)" strokeWidth="6"/>
            {data.map((val, i) => {
                const pct = (val / total) * circumference;
                const segment = (
                    <circle key={i} cx="25" cy="25" r="18" fill="none" stroke={colors?.[i] || 'var(--primary)'} strokeWidth="6"
                        strokeDasharray={`${pct} ${circumference - pct}`}
                        strokeDashoffset={-offset}
                        style={{transform: 'rotate(-90deg)', transformOrigin: 'center'}}/>
                );
                offset += pct;
                return segment;
            })}
        </svg>
    );
};

// Smart Card Component
const SmartCard = ({ title, value, subtitle, type, progress, pieData, pieColors, onClick }) => (
    <div className={`smart-card ${type}`} onClick={onClick}>
        <div className="smart-card-header">
            <div>
                <div className="smart-card-title">{title}</div>
                <div className="smart-card-value">{value}</div>
                {subtitle && <div className="smart-card-sub">{subtitle}</div>}
            </div>
            {pieData && <MiniPie data={pieData} colors={pieColors} />}
        </div>
        {progress !== undefined && (
            <div className="smart-card-visual">
                <div className="mini-progress">
                    <div className="mini-progress-fill" style={{
                        width: `${Math.min(100, progress)}%`,
                        background: type === 'fleet' ? 'var(--green)' : type === 'issues' ? 'var(--red)' : type === 'email' ? 'var(--amber)' : 'var(--blue)'
                    }}/>
                </div>
            </div>
        )}
    </div>
);

// Collapsible Section Component
const CollapsibleSection = ({ title, badge, defaultOpen, storageKey, children }) => {
    const [isOpen, setIsOpen] = useState(() => {
        if (storageKey) {
            const saved = localStorage.getItem(`collapse_${storageKey}`);
            return saved !== null ? saved === 'true' : defaultOpen;
        }
        return defaultOpen;
    });

    const toggle = () => {
        const newState = !isOpen;
        setIsOpen(newState);
        if (storageKey) localStorage.setItem(`collapse_${storageKey}`, String(newState));
    };

    return (
        <div className="collapsible">
            <div className="collapsible-header" onClick={toggle}>
                <div className="collapsible-title">
                    {title}
                    {badge !== undefined && <span className="collapsible-badge">{badge}</span>}
                </div>
                <svg className={`collapsible-chevron ${isOpen ? 'open' : ''}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </div>
            {isOpen && <div className="collapsible-content">{children}</div>}
        </div>
    );
};

// Tabbed Modal Component
const TabbedModal = ({ open, onClose, title, tabs, activeTab, setActiveTab, children }) => {
    useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
        if (open) window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [open, onClose]);

    if (!open) return null;

    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className="modal modal-wide" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <div className="modal-title">{title}</div>
                    <button className="modal-close" onClick={onClose}><Icon name="close"/></button>
                </div>
                <div className="tabs">
                    {tabs.map(tab => (
                        <button key={tab.id} className={`tab ${activeTab === tab.id ? 'active' : ''}`} onClick={() => setActiveTab(tab.id)}>
                            {tab.label}
                        </button>
                    ))}
                </div>
                <div className="tab-content">{children}</div>
            </div>
        </div>
    );
};

// Reports Dropdown Component
const ReportsDropdown = ({ onCopy, onDownload, onPrint }) => {
    const [isOpen, setIsOpen] = useState(false);
    const ref = useRef(null);

    useEffect(() => {
        const handleClickOutside = (e) => { if (ref.current && !ref.current.contains(e.target)) setIsOpen(false); };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div className="dropdown" ref={ref}>
            <button className="dropdown-trigger" onClick={() => setIsOpen(!isOpen)}>
                <Icon name="report"/>
                Reports
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6"/></svg>
            </button>
            {isOpen && (
                <div className="dropdown-menu">
                    <button className="dropdown-item" onClick={() => { onCopy(); setIsOpen(false); }}>
                        <Icon name="copy"/> Copy to Clipboard
                    </button>
                    <button className="dropdown-item" onClick={() => { onDownload(); setIsOpen(false); }}>
                        <Icon name="download"/> Download .txt
                    </button>
                    <button className="dropdown-item" onClick={() => { onPrint(); setIsOpen(false); }}>
                        <Icon name="print"/> Print View
                    </button>
                </div>
            )}
        </div>
    );
};

// Get combined status for ship
const getCombinedStatus = (ship, issues) => {
    const shipIssues = issues.filter(i => i.shipId === ship.id && !i.resolved);
    const hasUrgent = shipIssues.some(i => i.threat === 'Urgent');
    const hasMild = shipIssues.some(i => i.threat === 'Mild');

    if (hasUrgent) return { type: 'issue', label: 'URGENT', count: shipIssues.length };
    if (hasMild) return { type: 'issue', label: 'ISSUE', count: shipIssues.length };
    if (ship.waitingReply) return { type: 'waiting', label: 'WAITING' };
    if (ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0))) {
        return { type: 'inport', label: 'IN PORT' };
    }
    if (ship.lastContact) {
        const lc = new Date(ship.lastContact);
        const daysSince = Math.floor((new Date() - lc) / 86400000);
        if (daysSince <= 14) return { type: 'online', label: 'ONLINE' };
    }
    return { type: 'offline', label: 'OFFLINE' };
};

const Modal = ({ title, onClose, children, wide, open }) => {
    useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
        if (open) window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [open, onClose]);

    if (!open) return null;

    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className={`modal ${wide ? 'modal-wide' : ''}`} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <div className="modal-title">{title}</div>
                    <button className="modal-close" onClick={onClose}><Icon name="close"/></button>
                </div>
                <div className="modal-body">{children}</div>
            </div>
        </div>
    );
};

// Note: The rest of the App component and other page components remain the same as before.
// They are included in part 2 for brevity. The key changes are:
// 1. Replaced insecure hashPassword with Firebase Auth
// 2. Updated LoginPage to use Firebase Auth methods
// 3. Updated AuthWrapper to use Firebase Auth state
// 4. Updated AdminPanel to work with userProfiles collection
// 5. Added loading states and better error handling

function App({ currentUser, onLogout, isAdmin, pendingCount, onOpenAdminPanel }) {
    const [page, setPage] = useState(() => {
        const saved = localStorage.getItem('currentPage');
        return saved ? parseInt(saved) : 0;
    });

    useEffect(() => {
        localStorage.setItem('currentPage', page.toString());
    }, [page]);

    const [ships, setShips, shipsLoading] = useFirestore('ships', defaultShips);
    const [issues, setIssues] = useFirestore('issues', defaultIssues);
    const [dailyChecks, setDailyChecks] = useFirestore('dailyChecks', defaultDailyChecks);
    const [installs, setInstalls] = useFirestore('installs', []);
    const [parts, setParts] = useFirestore('parts', []);
    const [activityLog, setActivityLog] = useFirestore('activityLog', defaultActivityLog);
    const [suggestions, setSuggestions] = useFirestore('suggestions', []);
    const [onlineUsers, setOnlineUsers] = useFirestore('onlineUsers', []);

    const [toasts, setToasts] = useState([]);
    const [editingShip, setEditingShip] = useState(null);
    const [darkMode, setDarkMode] = useStorage('darkMode', true);
    const [backupSettings, setBackupSettings] = useStorage('backupSettings', { lastBackup: null, reminderDays: 3, autoBackupEnabled: true });
    const [globalSearch, setGlobalSearch] = useState('');
    const [showBanner, setShowBanner] = useState(true);
    const [feedbackModal, setFeedbackModal] = useState(false);
    const [feedbackText, setFeedbackText] = useState('');
    const [feedbackType, setFeedbackType] = useState('idea');
    const [showOnlineTooltip, setShowOnlineTooltip] = useState(false);
    const searchRef = useRef(null);

    // Dashboard state
    const [selectedShip, setSelectedShip] = useState(null);
    const [filter, setFilter] = useState('all');
    const [statusModal, setStatusModal] = useState({ open: false, ship: null, tab: 'email' });
    const [issuesModal, setIssuesModal] = useState({ open: false, ship: null, tab: 'add' });
    const [emailModal, setEmailModal] = useState({ open: false, ship: null, tab: 'history' });
    const [newIssue, setNewIssue] = useState({ title: '', category: 'Network/Equipment', threat: 'Mild', details: '' });
    const [inPortDate, setInPortDate] = useState('');
    const [manualLogText, setManualLogText] = useState('');

    useEffect(() => {
        if (!currentUser) return;
        const updatePresence = () => {
            const now = Date.now();
            setOnlineUsers(prev => {
                const active = prev.filter(u => now - u.lastSeen < 120000 && u.username !== currentUser.displayName);
                return [...active, { username: currentUser.displayName, lastSeen: now }];
            });
        };
        updatePresence();
        const interval = setInterval(updatePresence, 30000);
        return () => {
            clearInterval(interval);
            setOnlineUsers(prev => prev.filter(u => u.username !== currentUser.displayName));
        };
    }, [currentUser]);

    const activeUsers = useMemo(() => {
        const now = Date.now();
        return onlineUsers.filter(u => now - u.lastSeen < 120000);
    }, [onlineUsers]);

    const toast = (msg, type = 'info') => { const id = Date.now(); setToasts(t => [...t, { id, message: msg, type }]); setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 3000); };
    const logActivity = (text, details = null) => { setActivityLog(prev => [{ id: genId('A'), text, details, user: currentUser?.displayName || 'Unknown', time: new Date().toISOString() }, ...prev.slice(0, 199)]); };

    const submitFeedback = () => {
        if (!feedbackText.trim()) { toast('Please enter your suggestion', 'error'); return; }
        setSuggestions(prev => [...prev, {
            id: genId('FB'),
            type: feedbackType,
            text: feedbackText,
            user: currentUser?.displayName || 'Anonymous',
            created: new Date().toISOString(),
            status: 'new'
        }]);
        toast('Thanks for your feedback!', 'success');
        setFeedbackText('');
        setFeedbackModal(false);
    };

    const downloadBackup = useCallback((silent = false) => {
        const data = { ships, issues, dailyChecks, installs, parts, activityLog, exportDate: new Date().toISOString(), version: '3.2' };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `ShipTracker_Backup_${toDateString(new Date())}.json`; a.click();
        setBackupSettings(prev => ({ ...prev, lastBackup: new Date().toISOString() }));
        if (!silent) toast('Backup downloaded!', 'success');
    }, [ships, issues, dailyChecks, installs, parts, activityLog]);

    useEffect(() => {
        if (!backupSettings.autoBackupEnabled) return;
        const lastBackup = backupSettings.lastBackup ? new Date(backupSettings.lastBackup) : null;
        const daysSince = lastBackup ? (new Date() - lastBackup) / (1000 * 60 * 60 * 24) : 999;
        if (daysSince >= backupSettings.reminderDays) {
            setTimeout(() => { downloadBackup(true); toast('Auto-backup saved to Downloads', 'info'); }, 1500);
        }
    }, []);

    useEffect(() => {
        const handler = (e) => {
            if (e.key === '/' && !e.ctrlKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault(); searchRef.current?.focus();
            }
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); toast('Data auto-saves to browser', 'info'); }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
    }, []);

    useEffect(() => { document.body.classList.toggle('light-mode', !darkMode); }, [darkMode]);

    const urgentIssues = useMemo(() => issues.filter(i => i.threat === 'Urgent' && !i.resolved).length, [issues]);
    const overdueShips = useMemo(() => ships.filter(s => getEmailStatus(s, issues).status === 'OVERDUE').length, [ships, issues]);

    const navItems = [
        { id: 0, label: 'Dashboard', icon: 'dashboard' },
        { id: 1, label: 'Daily Checks', icon: 'checks' },
        { id: 2, label: 'Add Ship', icon: 'add' },
        { id: 4, label: 'Inventory', icon: 'inventory' },
        { id: 5, label: 'Trips', icon: 'installs' },
        { id: 6, label: 'Parts', icon: 'parts' },
        { id: 7, label: 'Email Status', icon: 'email', badge: overdueShips },
        { id: 8, label: 'Data / Import', icon: 'settings' },
        ...(isAdmin ? [{ id: 10, label: 'Suggestions', icon: 'issues', badge: suggestions.filter(s => s.status === 'new').length }] : []),
    ];
    const sections = [{ title: 'Overview', items: [0, 1] }, { title: 'Ships', items: [2] }, { title: 'Equipment', items: [4, 5, 6] }, { title: 'Comms', items: [7] }, { title: 'System', items: isAdmin ? [8, 10] : [8] }];

    // Computed values for smart cards
    const fleetStats = useMemo(() => {
        const online = ships.filter(s => {
            const status = getCombinedStatus(s, issues);
            return status.type === 'online' || status.type === 'inport';
        }).length;
        return { online, total: ships.length };
    }, [ships, issues]);

    const issueStats = useMemo(() => {
        const open = issues.filter(i => !i.resolved);
        const urgent = open.filter(i => i.threat === 'Urgent').length;
        const mild = open.filter(i => i.threat === 'Mild').length;
        return { total: open.length, urgent, mild };
    }, [issues]);

    const emailStats = useMemo(() => {
        let overdue = 0, due = 0, ok = 0;
        ships.forEach(s => {
            const status = getEmailStatus(s, issues).status;
            if (status === 'OVERDUE') overdue++;
            else if (status === 'DUE') due++;
            else ok++;
        });
        return { overdue, due, ok };
    }, [ships, issues]);

    const docStats = useMemo(() => {
        const complete = ships.filter(s => s.ciscoRouter && s.hdd && s.crna1).length;
        return { complete, total: ships.length };
    }, [ships]);

    // Filtered ships
    const filteredShips = useMemo(() => {
        let result = [...ships].sort(sortHull);
        if (filter === 'issues') result = result.filter(s => issues.some(i => i.shipId === s.id && !i.resolved));
        else if (filter === 'overdue') result = result.filter(s => getEmailStatus(s, issues).status === 'OVERDUE');
        else if (filter === 'waiting') result = result.filter(s => s.waitingReply);
        else if (filter === 'inport') result = result.filter(s => s.inPort);
        if (globalSearch) {
            const q = globalSearch.toLowerCase();
            result = result.filter(s => s.name.toLowerCase().includes(q) || s.location?.toLowerCase().includes(q));
        }
        return result;
    }, [ships, issues, filter, globalSearch]);

    // Ship actions
    const markContacted = (ship) => {
        setShips(prev => prev.map(s => s.id === ship.id ? { ...s, lastContact: new Date().toISOString(), waitingReply: false, contactedBy: currentUser?.displayName } : s));
        logActivity(`Marked ${ship.name} as contacted`);
        toast(`${ship.name} marked as contacted`, 'success');
        setStatusModal({ open: false, ship: null, tab: 'email' });
    };

    const setInPort = (ship) => {
        if (!inPortDate) { toast('Please select a date', 'error'); return; }
        setShips(prev => prev.map(s => s.id === ship.id ? { ...s, inPort: true, inPortUntil: inPortDate } : s));
        logActivity(`Marked ${ship.name} as in port until ${fmtDate(inPortDate)}`);
        toast(`${ship.name} marked as in port`, 'success');
        setInPortDate('');
        setStatusModal({ open: false, ship: null, tab: 'email' });
    };

    const clearStatus = (ship) => {
        setShips(prev => prev.map(s => s.id === ship.id ? { ...s, waitingReply: false, inPort: false, inPortUntil: null } : s));
        logActivity(`Cleared status for ${ship.name}`);
        toast(`Status cleared for ${ship.name}`, 'success');
        setStatusModal({ open: false, ship: null, tab: 'email' });
    };

    const addIssue = (ship) => {
        if (!newIssue.title.trim()) { toast('Please enter an issue title', 'error'); return; }
        const issue = { id: genId('I'), shipId: ship.id, shipName: ship.name, ...newIssue, created: new Date().toISOString(), resolved: false };
        setIssues(prev => [...prev, issue]);
        setShips(prev => prev.map(s => s.id === ship.id ? { ...s, threat: newIssue.threat } : s));
        logActivity(`Added issue "${newIssue.title}" to ${ship.name}`);
        toast('Issue added', 'success');
        setNewIssue({ title: '', category: 'Network/Equipment', threat: 'Mild', details: '' });
        setIssuesModal({ open: false, ship: null, tab: 'add' });
    };

    const resolveIssue = (issue) => {
        setIssues(prev => prev.map(i => i.id === issue.id ? { ...i, resolved: true, resolvedAt: new Date().toISOString(), resolvedBy: currentUser?.displayName } : i));
        const remainingIssues = issues.filter(i => i.shipId === issue.shipId && !i.resolved && i.id !== issue.id);
        if (remainingIssues.length === 0) {
            setShips(prev => prev.map(s => s.id === issue.shipId ? { ...s, threat: 'NoIssue' } : s));
        }
        logActivity(`Resolved issue "${issue.title}" for ${issue.shipName}`);
        toast('Issue resolved', 'success');
    };

    const addManualLog = (ship) => {
        if (!manualLogText.trim()) { toast('Please enter log text', 'error'); return; }
        logActivity(`${ship.name}: ${manualLogText}`, { type: 'manual', ship: ship.name });
        toast('Log entry added', 'success');
        setManualLogText('');
        setEmailModal({ open: false, ship: null, tab: 'history' });
    };

    const generateWeeklyReport = () => {
        const lines = ['WEEKLY SHIP STATUS REPORT', `Generated: ${new Date().toLocaleString()}`, '', '---', ''];
        ships.sort(sortHull).forEach(s => {
            const status = getCombinedStatus(s, issues);
            const shipIssues = issues.filter(i => i.shipId === s.id && !i.resolved);
            lines.push(`${s.name} (${s.type}) - ${status.label}`);
            lines.push(`  Location: ${s.location || 'Unknown'}`);
            lines.push(`  Last Contact: ${s.lastContact ? fmtDate(s.lastContact) : 'Never'}`);
            if (shipIssues.length > 0) {
                lines.push(`  Open Issues: ${shipIssues.length}`);
                shipIssues.forEach(i => lines.push(`    - ${i.title} (${i.threat})`));
            }
            lines.push('');
        });
        return lines.join('\n');
    };

    const copyReport = () => {
        navigator.clipboard.writeText(generateWeeklyReport());
        toast('Report copied to clipboard', 'success');
    };

    const downloadReport = () => {
        const blob = new Blob([generateWeeklyReport()], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `Weekly_Report_${toDateString(new Date())}.txt`; a.click();
        toast('Report downloaded', 'success');
    };

    const printReport = () => { window.print(); };

    const updateShip = (field, value) => {
        if (!selectedShip) return;
        setShips(prev => prev.map(s => s.id === selectedShip.id ? { ...s, [field]: value } : s));
        setSelectedShip(prev => ({ ...prev, [field]: value }));
    };

    // Dashboard Page Component
    const DashboardPage = () => {
        const shipIssues = selectedShip ? issues.filter(i => i.shipId === selectedShip.id && !i.resolved) : [];
        const shipActivity = selectedShip ? activityLog.filter(a => a.text.includes(selectedShip.name)).slice(0, 10) : [];

        return (
            <div className="page active">
                <div className="page-header">
                    <div className="page-header-left">
                        <h1 className="page-title">Dashboard</h1>
                        <p className="page-sub">Fleet overview and ship management</p>
                    </div>
                    <div style={{display:'flex',gap:'12px',alignItems:'center'}}>
                        <div className="search-box">
                            <Icon name="search"/>
                            <input ref={searchRef} placeholder="Search ships..." value={globalSearch} onChange={e => setGlobalSearch(e.target.value)}/>
                            <span className="shortcut">/</span>
                        </div>
                        <ReportsDropdown onCopy={copyReport} onDownload={downloadReport} onPrint={printReport}/>
                    </div>
                </div>

                {/* Smart Cards */}
                <div className="smart-cards">
                    <SmartCard
                        type="fleet" title="Fleet Status"
                        value={`${fleetStats.online}/${fleetStats.total}`}
                        subtitle="Ships Online"
                        progress={(fleetStats.online / fleetStats.total) * 100}
                        onClick={() => setFilter('all')}
                    />
                    <SmartCard
                        type="issues" title="Issues"
                        value={issueStats.total}
                        subtitle={issueStats.urgent > 0 ? `${issueStats.urgent} Urgent` : 'Open Issues'}
                        pieData={[issueStats.urgent, issueStats.mild]}
                        pieColors={['var(--red)', 'var(--amber)']}
                        onClick={() => setFilter('issues')}
                    />
                    <SmartCard
                        type="email" title="Email Status"
                        value={emailStats.overdue}
                        subtitle="Overdue Contacts"
                        pieData={[emailStats.overdue, emailStats.due, emailStats.ok]}
                        pieColors={['var(--red)', 'var(--amber)', 'var(--green)']}
                        onClick={() => setFilter('overdue')}
                    />
                    <SmartCard
                        type="docs" title="Documentation"
                        value={`${docStats.complete}/${docStats.total}`}
                        subtitle="Complete"
                        progress={(docStats.complete / docStats.total) * 100}
                    />
                </div>

                {/* Filters */}
                <div className="filters">
                    {[{id:'all',label:'All Ships'},{id:'issues',label:'Has Issues'},{id:'overdue',label:'Overdue'},{id:'waiting',label:'Waiting Reply'},{id:'inport',label:'In Port'}].map(f => (
                        <button key={f.id} className={`filter-btn ${filter === f.id ? 'active' : ''}`} onClick={() => setFilter(f.id)}>{f.label}</button>
                    ))}
                </div>

                {/* Main Grid */}
                <div className="dash-grid">
                    {/* Ship List */}
                    <div className="card">
                        <div className="card-title">Ships ({filteredShips.length})</div>
                        <div className="ship-list-simple">
                            {filteredShips.map(ship => {
                                const status = getCombinedStatus(ship, issues);
                                return (
                                    <div key={ship.id} className={`ship-row ${selectedShip?.id === ship.id ? 'selected' : ''}`} onClick={() => setSelectedShip(ship)}>
                                        <div>
                                            <div className="ship-row-name">{ship.name}</div>
                                            <div className="ship-row-type">{ship.type} - {ship.location}</div>
                                        </div>
                                        <span className={`combined-badge ${status.type}`}>
                                            {status.label}
                                            {status.count && ` (${status.count})`}
                                        </span>
                                        <button className="view-btn" onClick={e => { e.stopPropagation(); setSelectedShip(ship); }}>
                                            View
                                        </button>
                                    </div>
                                );
                            })}
                            {filteredShips.length === 0 && <div className="empty">No ships match filter</div>}
                        </div>
                    </div>

                    {/* Detail Panel */}
                    <div>
                        {selectedShip ? (
                            <>
                                <CollapsibleSection title="Ship Information" defaultOpen={true} storageKey="shipInfo">
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Ship Name</label>
                                            <input className="form-input" value={selectedShip.name} onChange={e => updateShip('name', e.target.value)}/>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Type</label>
                                            <select className="form-select" value={selectedShip.type} onChange={e => updateShip('type', e.target.value)}>
                                                <option>Full REAP</option>
                                                <option>Mini REAP</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Homeport</label>
                                            <input className="form-input" value={selectedShip.location || ''} onChange={e => updateShip('location', e.target.value)}/>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">POC</label>
                                            <input className="form-input" value={selectedShip.poc || ''} onChange={e => updateShip('poc', e.target.value)}/>
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Notes</label>
                                        <textarea className="form-textarea" value={selectedShip.notes || ''} onChange={e => updateShip('notes', e.target.value)} style={{minHeight:'60px'}}/>
                                    </div>
                                    <div className="quick-actions">
                                        <button className="btn btn-primary btn-sm" onClick={() => setStatusModal({ open: true, ship: selectedShip, tab: 'email' })}>Update Status</button>
                                        <button className="btn btn-warning btn-sm" onClick={() => setIssuesModal({ open: true, ship: selectedShip, tab: 'add' })}>Manage Issues</button>
                                        <button className="btn btn-secondary btn-sm" onClick={() => setEmailModal({ open: true, ship: selectedShip, tab: 'history' })}>Email Log</button>
                                    </div>
                                </CollapsibleSection>

                                <CollapsibleSection title="Open Issues" badge={shipIssues.length} defaultOpen={shipIssues.length > 0} storageKey="issues">
                                    {shipIssues.length > 0 ? (
                                        <div>
                                            {shipIssues.map(issue => (
                                                <div key={issue.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:'1px solid var(--border)'}}>
                                                    <div>
                                                        <div style={{fontWeight:600,fontSize:'13px'}}>{issue.title}</div>
                                                        <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{issue.category} - {fmtTime(issue.created)}</div>
                                                    </div>
                                                    <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                                        <span className={`badge badge-${issue.threat.toLowerCase()}`}>{issue.threat}</span>
                                                        <button className="btn btn-success btn-sm" onClick={() => resolveIssue(issue)}>Resolve</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="empty" style={{padding:'16px'}}>No open issues</div>
                                    )}
                                </CollapsibleSection>

                                <CollapsibleSection title="Asset Identifiers" defaultOpen={false} storageKey="assets">
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Cisco Router</label>
                                            <input className="form-input" value={selectedShip.ciscoRouter || ''} onChange={e => updateShip('ciscoRouter', e.target.value)}/>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">HDD</label>
                                            <input className="form-input" value={selectedShip.hdd || ''} onChange={e => updateShip('hdd', e.target.value)}/>
                                        </div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">CRNA 1</label>
                                            <input className="form-input" value={selectedShip.crna1 || ''} onChange={e => updateShip('crna1', e.target.value)}/>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">CRNA 2</label>
                                            <input className="form-input" value={selectedShip.crna2 || ''} onChange={e => updateShip('crna2', e.target.value)}/>
                                        </div>
                                    </div>
                                </CollapsibleSection>

                                <CollapsibleSection title="Activity Log" badge={shipActivity.length} defaultOpen={false} storageKey="activity">
                                    <div className="activity-log">
                                        {shipActivity.length > 0 ? shipActivity.map(a => (
                                            <div key={a.id} className="activity-item">
                                                <span className="activity-time">{fmtTime(a.time)}</span>
                                                <span className="activity-text">{a.text}</span>
                                            </div>
                                        )) : (
                                            <div className="empty" style={{padding:'16px'}}>No recent activity</div>
                                        )}
                                    </div>
                                </CollapsibleSection>
                            </>
                        ) : (
                            <div className="card">
                                <div className="empty" style={{padding:'60px 20px'}}>
                                    <Icon name="ship"/>
                                    <div style={{marginTop:'12px'}}>Select a ship to view details</div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // Placeholder for other pages
    const PagePlaceholder = ({ title }) => (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left">
                    <h1 className="page-title">{title}</h1>
                    <p className="page-sub">Page content</p>
                </div>
            </div>
            <div className="card">
                <p style={{color:'var(--text-dim)'}}>This page is available in the full version.</p>
            </div>
        </div>
    );

    return (
        <div className="app">
            <nav className="sidebar">
                <div className="sidebar-header">
                    <div className="logo" style={{display:'flex',alignItems:'center',gap:'8px'}}>
                        <svg width="24" height="14" viewBox="0 0 120 60" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M10 40l8-5h84l8 5H10z"/><path d="M18 35h84l4-10H14l4 10z"/><path d="M22 25V18h76v7"/><path d="M50 18V8h10v10"/><path d="M35 40v8h50v-8"/>
                        </svg>
                        SHIP TRACKER
                    </div>
                    <div className="logo-sub">Secure Edition</div>
                </div>

                {sections.map(s => (
                    <div key={s.title} className="nav-section">
                        <div className="nav-title">{s.title}</div>
                        {s.items.map(id => {
                            const item = navItems.find(n => n.id === id);
                            return (
                                <button key={id} className={`nav-btn ${page === id ? 'active' : ''}`} onClick={() => setPage(id)}>
                                    <Icon name={item.icon}/>
                                    <span>{item.label}</span>
                                    {item.badge > 0 && <span className="badge-count">{item.badge}</span>}
                                </button>
                            );
                        })}
                    </div>
                ))}

                <div className="sidebar-footer">
                    <div style={{marginBottom:'8px',padding:'8px',background:'var(--bg-input)',borderRadius:'6px'}}>
                        <div style={{fontSize:'10px',color:'var(--text-muted)'}}>LOGGED IN AS</div>
                        <div style={{fontSize:'12px',fontWeight:600,display:'flex',alignItems:'center',gap:'6px'}}>
                            {currentUser?.displayName}
                            {isAdmin && <span style={{background:'var(--primary)',color:'#000',padding:'1px 4px',borderRadius:'3px',fontSize:'8px',fontWeight:700}}>ADMIN</span>}
                        </div>
                        <div style={{fontSize:'9px',color:'var(--text-muted)',marginTop:'2px'}}>{currentUser?.email}</div>
                    </div>

                    {isAdmin && (
                        <button onClick={onOpenAdminPanel} style={{width:'100%',padding:'8px',marginBottom:'8px',background: pendingCount > 0 ? 'var(--amber-glow)' : 'var(--bg-input)',border: pendingCount > 0 ? '1px solid var(--amber)' : '1px solid var(--border)',borderRadius:'6px',color: pendingCount > 0 ? 'var(--amber)' : 'var(--text-dim)',fontSize:'11px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:'6px'}}>
                            Admin Panel {pendingCount > 0 && <span style={{background:'var(--amber)',color:'#000',padding:'1px 6px',borderRadius:'8px',fontSize:'10px',fontWeight:600}}>{pendingCount}</span>}
                        </button>
                    )}

                    <div className="sync-status" style={{fontSize:'10px',color:'var(--primary)',marginBottom:'8px',display:'flex',alignItems:'center',gap:'6px'}}>
                        <span style={{width:'8px',height:'8px',borderRadius:'50%',background:'var(--primary)',display:'inline-block',animation:'pulse 2s infinite'}}></span>
                        <span>Live Sync</span>
                        <span style={{marginLeft:'auto',background:'var(--primary-glow)',padding:'2px 6px',borderRadius:'10px',fontSize:'9px'}}>{activeUsers.length} online</span>
                    </div>
                    <style>{`@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>

                    <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                        <div className="theme-toggle" style={{flex:1}}>
                            <button className={darkMode ? 'active' : ''} onClick={() => setDarkMode(true)}>Dark</button>
                            <button className={!darkMode ? 'active' : ''} onClick={() => setDarkMode(false)}>Light</button>
                        </div>
                        <button onClick={onLogout} style={{padding:'6px 10px',background:'var(--red-glow)',border:'1px solid var(--red)',borderRadius:'6px',color:'var(--red)',fontSize:'10px',cursor:'pointer'}}>Logout</button>
                    </div>
                    <div className="version">v3.3.0 Secure</div>
                </div>
            </nav>

            {(urgentIssues > 0 || overdueShips > 0) && showBanner && (
                <div className={`notif-banner ${urgentIssues > 0 ? '' : 'warning'}`}>
                    {overdueShips > 0 && <span className="notif-item warning" onClick={() => setPage(7)}>{overdueShips} ship{overdueShips > 1 ? 's' : ''} overdue for contact</span>}
                    <button className="notif-close" onClick={() => setShowBanner(false)}>x</button>
                </div>
            )}

            <main className={`main ${(urgentIssues > 0 || overdueShips > 0) && showBanner ? 'has-banner' : ''}`}>
                <div style={{display:'flex',justifyContent:'flex-end',marginBottom:'16px'}}>
                    <button onClick={() => setFeedbackModal(true)} style={{padding:'10px 16px',background:'var(--primary)',border:'none',borderRadius:'8px',color:'#000',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>
                        Suggest Improvement
                    </button>
                </div>

                {/* Page Content */}
                {page === 0 && <DashboardPage />}
                {page !== 0 && <PagePlaceholder title={navItems.find(n => n.id === page)?.label || 'Page'} />}
            </main>

            <Toast toasts={toasts} remove={id => setToasts(t => t.filter(x => x.id !== id))}/>

            {/* Update Status Modal */}
            <TabbedModal
                open={statusModal.open}
                onClose={() => setStatusModal({ open: false, ship: null, tab: 'email' })}
                title={`Update Status - ${statusModal.ship?.name || ''}`}
                tabs={[
                    { id: 'email', label: 'Mark Emailed' },
                    { id: 'inport', label: 'In Port' },
                    { id: 'clear', label: 'Clear Status' }
                ]}
                activeTab={statusModal.tab}
                setActiveTab={(tab) => setStatusModal(prev => ({ ...prev, tab }))}
            >
                {statusModal.tab === 'email' && (
                    <div>
                        <p style={{color:'var(--text-dim)',marginBottom:'16px'}}>Mark this ship as contacted. This will update the last contact date and clear any waiting status.</p>
                        <div className="btn-group">
                            <button className="btn btn-primary" onClick={() => markContacted(statusModal.ship)}>Mark as Contacted</button>
                            <button className="btn btn-secondary" onClick={() => {
                                setShips(prev => prev.map(s => s.id === statusModal.ship?.id ? { ...s, waitingReply: true } : s));
                                logActivity(`Marked ${statusModal.ship?.name} as waiting on reply`);
                                toast('Marked as waiting', 'success');
                                setStatusModal({ open: false, ship: null, tab: 'email' });
                            }}>Mark Waiting Reply</button>
                        </div>
                    </div>
                )}
                {statusModal.tab === 'inport' && (
                    <div>
                        <p style={{color:'var(--text-dim)',marginBottom:'16px'}}>Set this ship as in port. Email reminders will be paused until the specified date.</p>
                        <div className="form-group">
                            <label className="form-label">In Port Until</label>
                            <input type="date" className="form-input" value={inPortDate} onChange={e => setInPortDate(e.target.value)}/>
                        </div>
                        <button className="btn btn-primary" onClick={() => setInPort(statusModal.ship)}>Set In Port</button>
                    </div>
                )}
                {statusModal.tab === 'clear' && (
                    <div>
                        <p style={{color:'var(--text-dim)',marginBottom:'16px'}}>Clear the waiting/in-port status for this ship.</p>
                        <button className="btn btn-danger" onClick={() => clearStatus(statusModal.ship)}>Clear All Status</button>
                    </div>
                )}
            </TabbedModal>

            {/* Manage Issues Modal */}
            <TabbedModal
                open={issuesModal.open}
                onClose={() => setIssuesModal({ open: false, ship: null, tab: 'add' })}
                title={`Manage Issues - ${issuesModal.ship?.name || ''}`}
                tabs={[
                    { id: 'add', label: 'Add Issue' },
                    { id: 'resolve', label: 'Resolve Issues' }
                ]}
                activeTab={issuesModal.tab}
                setActiveTab={(tab) => setIssuesModal(prev => ({ ...prev, tab }))}
            >
                {issuesModal.tab === 'add' && (
                    <div>
                        <div className="form-group">
                            <label className="form-label">Issue Title</label>
                            <input className="form-input" value={newIssue.title} onChange={e => setNewIssue(prev => ({ ...prev, title: e.target.value }))} placeholder="Brief description of the issue"/>
                        </div>
                        <div className="form-row">
                            <div className="form-group">
                                <label className="form-label">Category</label>
                                <select className="form-select" value={newIssue.category} onChange={e => setNewIssue(prev => ({ ...prev, category: e.target.value }))}>
                                    <option>Network/Equipment</option>
                                    <option>Ship Maintenance</option>
                                    <option>Personnel</option>
                                    <option>Documentation</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Severity</label>
                                <div className="radio-group">
                                    <label className="radio urgent"><input type="radio" checked={newIssue.threat === 'Urgent'} onChange={() => setNewIssue(prev => ({ ...prev, threat: 'Urgent' }))}/> Urgent</label>
                                    <label className="radio mild"><input type="radio" checked={newIssue.threat === 'Mild'} onChange={() => setNewIssue(prev => ({ ...prev, threat: 'Mild' }))}/> Mild</label>
                                </div>
                            </div>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Details</label>
                            <textarea className="form-textarea" value={newIssue.details} onChange={e => setNewIssue(prev => ({ ...prev, details: e.target.value }))} placeholder="Additional details..."/>
                        </div>
                        <button className="btn btn-primary" onClick={() => addIssue(issuesModal.ship)}>Add Issue</button>
                    </div>
                )}
                {issuesModal.tab === 'resolve' && (
                    <div>
                        {issues.filter(i => i.shipId === issuesModal.ship?.id && !i.resolved).length > 0 ? (
                            issues.filter(i => i.shipId === issuesModal.ship?.id && !i.resolved).map(issue => (
                                <div key={issue.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'8px'}}>
                                    <div>
                                        <div style={{fontWeight:600}}>{issue.title}</div>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{issue.category} - Created {fmtTime(issue.created)}</div>
                                        {issue.details && <div style={{fontSize:'12px',color:'var(--text-dim)',marginTop:'4px'}}>{issue.details}</div>}
                                    </div>
                                    <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                        <span className={`badge badge-${issue.threat.toLowerCase()}`}>{issue.threat}</span>
                                        <button className="btn btn-success btn-sm" onClick={() => resolveIssue(issue)}>Resolve</button>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="empty">No open issues for this ship</div>
                        )}
                    </div>
                )}
            </TabbedModal>

            {/* Email Log Modal */}
            <TabbedModal
                open={emailModal.open}
                onClose={() => setEmailModal({ open: false, ship: null, tab: 'history' })}
                title={`Email Log - ${emailModal.ship?.name || ''}`}
                tabs={[
                    { id: 'history', label: 'History' },
                    { id: 'manual', label: 'Manual Entry' }
                ]}
                activeTab={emailModal.tab}
                setActiveTab={(tab) => setEmailModal(prev => ({ ...prev, tab }))}
            >
                {emailModal.tab === 'history' && (
                    <div>
                        <div className="activity-log" style={{maxHeight:'300px'}}>
                            {activityLog.filter(a => a.text.includes(emailModal.ship?.name)).slice(0, 20).length > 0 ? (
                                activityLog.filter(a => a.text.includes(emailModal.ship?.name)).slice(0, 20).map(a => (
                                    <div key={a.id} className="activity-item">
                                        <span className="activity-time">{fmtTime(a.time)}</span>
                                        <span className="activity-text">{a.text}</span>
                                    </div>
                                ))
                            ) : (
                                <div className="empty">No activity history for this ship</div>
                            )}
                        </div>
                    </div>
                )}
                {emailModal.tab === 'manual' && (
                    <div>
                        <p style={{color:'var(--text-dim)',marginBottom:'16px'}}>Add a manual log entry for this ship.</p>
                        <div className="form-group">
                            <label className="form-label">Log Entry</label>
                            <textarea className="form-textarea" value={manualLogText} onChange={e => setManualLogText(e.target.value)} placeholder="Enter log details..."/>
                        </div>
                        <button className="btn btn-primary" onClick={() => addManualLog(emailModal.ship)}>Add Entry</button>
                    </div>
                )}
            </TabbedModal>

            <Modal open={feedbackModal} onClose={() => setFeedbackModal(false)} title="Suggest Improvement">
                <p style={{color:'var(--text-dim)',marginBottom:'16px',fontSize:'13px'}}>Share your ideas or report issues.</p>
                <div className="form-group">
                    <label className="form-label">Type</label>
                    <div style={{display:'flex',gap:'8px'}}>
                        {[{v:'idea',l:'Idea'},{v:'bug',l:'Bug'},{v:'workflow',l:'Workflow'}].map(t => (
                            <button key={t.v} onClick={() => setFeedbackType(t.v)} style={{flex:1,padding:'10px',background: feedbackType === t.v ? 'var(--primary-glow)' : 'var(--bg-input)',border: `1px solid ${feedbackType === t.v ? 'var(--primary)' : 'var(--border)'}`,borderRadius:'6px',color: feedbackType === t.v ? 'var(--primary)' : 'var(--text-dim)',cursor:'pointer',fontSize:'12px'}}>{t.l}</button>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">Your Suggestion</label>
                    <textarea className="form-textarea" style={{minHeight:'120px'}} placeholder="Describe your idea or issue..." value={feedbackText} onChange={e => setFeedbackText(e.target.value)}/>
                </div>
                <div className="btn-group">
                    <button className="btn btn-primary" onClick={submitFeedback}>Submit</button>
                    <button className="btn btn-secondary" onClick={() => setFeedbackModal(false)}>Cancel</button>
                </div>
            </Modal>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<AuthWrapper/>);
</script>
</body>
</html>
