<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Tracker Pro</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2310b981'/%3E%3Cpath d='M4 20l4-3h16l4 3H4z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M8 17h16l2-5H6l2 5z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M10 12V9h12v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M14 9V6h4v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 20v3h14v-3' fill='none' stroke='white' stroke-width='1.5'/%3E%3C/svg%3E"/>
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%2310b981'/%3E%3Cpath d='M4 20l4-3h16l4 3H4z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M8 17h16l2-5H6l2 5z' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M10 12V9h12v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M14 9V6h4v3' fill='none' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 20v3h14v-3' fill='none' stroke='white' stroke-width='1.5'/%3E%3C/svg%3E"/>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-deep: #0a0d12; --bg-main: #0f1419; --bg-card: #161d27; --bg-card-hover: #1c2532;
            --bg-input: #1a222e; --border: #2a3544; --border-focus: #3d4f66;
            --text: #e8edf5; --text-dim: #8b98a9; --text-muted: #5a6778;
            --primary: #19a974; --primary-glow: rgba(25, 169, 116, 0.2); --sidebar: #0c1015;
            --red: #ff5252; --red-glow: rgba(255, 82, 82, 0.15);
            --amber: #ffb300; --amber-glow: rgba(255, 179, 0, 0.15);
            --green: #4caf50; --green-glow: rgba(76, 175, 80, 0.15);
            --blue: #4fc3f7; --blue-glow: rgba(79, 195, 247, 0.15);
        }
        .light-mode {
            --bg-deep: #f0f2f5; --bg-main: #ffffff; --bg-card: #ffffff; --bg-card-hover: #f5f7fa;
            --bg-input: #f0f2f5; --border: #d1d9e6; --border-focus: #a0aec0;
            --text: #1a202c; --text-dim: #4a5568; --text-muted: #718096;
            --sidebar: #f7fafc;
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-deep); color: var(--text); min-height: 100vh; transition: all 0.3s; }
        .app { display: flex; min-height: 100vh; }
        
        /* Notification Banner */
        .notif-banner { background: var(--red-glow); border-bottom: 1px solid var(--red); padding: 10px 24px; display: flex; align-items: center; gap: 16px; font-size: 13px; position: fixed; top: 0; left: 200px; right: 0; z-index: 100; }
        .notif-banner.warning { background: var(--amber-glow); border-color: var(--amber); }
        .notif-banner.ok { background: var(--green-glow); border-color: var(--green); display: none; }
        .notif-item { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .notif-item.urgent { color: var(--red); }
        .notif-item.warning { color: var(--amber); }
        .notif-close { margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; }
        
        /* Sidebar */
        .sidebar { width: 200px; background: var(--sidebar); border-right: 1px solid var(--border); position: fixed; height: 100vh; overflow-y: auto; z-index: 101; }
        .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; color: var(--primary); letter-spacing: 1.5px; }
        .logo-sub { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
        .nav-section { padding: 12px 8px 4px; }
        .nav-title { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 1.2px; text-transform: uppercase; padding: 0 8px; margin-bottom: 6px; }
        .nav-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: transparent; border: none; border-radius: 6px; color: var(--text-dim); font-family: inherit; font-size: 12px; cursor: pointer; transition: all 0.15s; margin-bottom: 2px; text-align: left; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .nav-btn.active { background: var(--primary); color: #000; font-weight: 600; }
        .nav-btn svg { width: 16px; height: 16px; flex-shrink: 0; }
        .nav-btn .badge-count { margin-left: auto; background: var(--red); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); position: absolute; bottom: 0; width: 100%; background: var(--sidebar); }
        .version { font-size: 10px; color: var(--text-muted); text-align: center; font-family: 'JetBrains Mono', monospace; }
        .theme-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .theme-toggle button { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; }
        .theme-toggle button:hover { background: var(--bg-card-hover); }
        .theme-toggle button.active { background: var(--primary); color: #000; }
        
        /* Main */
        .main { flex: 1; margin-left: 200px; background: var(--bg-main); min-height: 100vh; padding: 24px; padding-top: 24px; }
        .main.has-banner { padding-top: 60px; }
        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        .page-header-left { }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .page-sub { font-size: 13px; color: var(--text-muted); }
        
        /* Search Box */
        .search-box { position: relative; }
        .search-box input { width: 250px; padding: 10px 12px 10px 36px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; font-size: 13px; }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box input::placeholder { color: var(--text-muted); }
        .search-box svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }
        .search-box .shortcut { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 10px; color: var(--text-muted); background: var(--bg-card); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); }
        
        /* Cards */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        .card-title { font-size: 10px; font-weight: 600; color: var(--primary); letter-spacing: 1.2px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; position: relative; overflow: hidden; cursor: pointer; transition: transform 0.15s; }
        .stat:hover { transform: translateY(-2px); }
        .stat::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
        .stat.urgent::before { background: var(--red); } .stat.urgent { box-shadow: inset 0 0 20px var(--red-glow); }
        .stat.due::before { background: var(--amber); } .stat.due { box-shadow: inset 0 0 20px var(--amber-glow); }
        .stat.total::before { background: var(--green); } .stat.total { box-shadow: inset 0 0 20px var(--green-glow); }
        .stat.missing::before { background: var(--blue); } .stat.missing { box-shadow: inset 0 0 20px var(--blue-glow); }
        .stat-label { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 6px; }
        .stat-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        
        /* Charts */
        .charts-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .chart-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
        .chart-card .card-title { justify-content: center; }
        .pie-chart { position: relative; width: 120px; height: 120px; margin: 0 auto 12px; }
        .pie-chart svg { transform: rotate(-90deg); }
        .pie-chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .pie-chart-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .pie-chart-label { font-size: 10px; color: var(--text-muted); }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; font-size: 11px; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .bar-chart { display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 80px; margin-bottom: 12px; }
        .bar { width: 32px; border-radius: 4px 4px 0 0; transition: height 0.3s; position: relative; }
        .bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-muted); white-space: nowrap; }
        .bar-value { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; }
        
        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 10px; font-weight: 600; color: var(--text-dim); letter-spacing: 0.4px; text-transform: uppercase; margin-bottom: 4px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 13px; transition: all 0.15s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-input.warning { border-color: var(--amber); background: var(--amber-glow); }
        .form-input.danger { border-color: var(--red); background: var(--red-glow); }
        .form-select { cursor: pointer; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border: none; border-radius: 6px; font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-card-hover); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--red); color: #fff; }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-success { background: var(--green); color: #fff; }
        .btn-warning { background: var(--amber); color: #000; }
        .btn-sm { padding: 6px 10px; font-size: 11px; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* Tables */
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 10px 12px; font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.8px; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--bg-input); }
        .table td { padding: 12px; font-size: 12px; border-bottom: 1px solid var(--border); }
        .table tr:hover td { background: var(--bg-card-hover); }
        .table tr.selected td { background: var(--primary-glow); }
        
        /* Badges */
        .badge { display: inline-flex; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-urgent { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .badge-mild, .badge-due { background: var(--amber-glow); color: var(--amber); border: 1px solid var(--amber); }
        .badge-ok, .badge-complete, .badge-resolved { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }
        .badge-overdue, .badge-missing { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .badge-info { background: var(--blue-glow); color: var(--blue); border: 1px solid var(--blue); }
        
        /* Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-2-wide-left { display: grid; grid-template-columns: 350px 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .flex { display: flex; align-items: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }
        .gap-sm { gap: 6px; } .gap-md { gap: 12px; }
        .mt-sm { margin-top: 6px; } .mt-md { margin-top: 12px; } .mb-md { margin-bottom: 12px; }
        
        /* Ship List */
        .ship-list { }
        .ship-list::-webkit-scrollbar { width: 6px; }
        .ship-list::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
        .ship-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .ship-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.1s; font-size: 12px; }
        .ship-item:hover { background: var(--bg-card-hover); }
        .ship-item.selected { background: var(--primary-glow); border-left: 3px solid var(--primary); }
        .ship-item > span { padding: 0 4px; }
        .ship-item > span:nth-child(1) { width: 55px; flex-shrink: 0; }
        .ship-item > span:nth-child(2) { width: 70px; flex-shrink: 0; margin-left: 8px; }
        .ship-item > span:nth-child(3) { width: 75px; flex-shrink: 0; }
        .ship-item > span:nth-child(4) { width: 90px; flex-shrink: 0; }
        .ship-item > span:nth-child(5) { flex: 1; min-width: 0; text-align: right; }
        .ship-name { font-weight: 600; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .ship-type { font-size: 10px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ship-list-header { display: flex; align-items: center; padding: 8px 12px; background: var(--bg-input); border-bottom: 1px solid var(--border); font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.6px; text-transform: uppercase; position: sticky; top: 0; z-index: 1; }
        .ship-list-header > span { padding: 0 4px; }
        .ship-list-header > span:nth-child(1) { width: 55px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(2) { width: 70px; flex-shrink: 0; margin-left: 8px; }
        .ship-list-header > span:nth-child(3) { width: 75px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(4) { width: 90px; flex-shrink: 0; }
        .ship-list-header > span:nth-child(5) { flex: 1; min-width: 0; text-align: right; }
        
        /* Dashboard Grid */
        .dash-grid { display: grid; grid-template-columns: 555px 1fr; gap: 20px; }
        .detail-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
        .section-title { font-size: 10px; font-weight: 600; color: var(--primary); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        
        /* Quick Actions */
        .quick-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
        
        /* Filters */
        .filters { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-dim); font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .filter-btn:hover { background: var(--bg-card-hover); }
        .filter-btn.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: 600; }
        
        /* Check rows */
        .check-row { display: grid; grid-template-columns: 70px 80px 70px 70px 70px 80px 80px; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); gap: 8px; font-size: 12px; }
        .check-row:nth-child(even) { background: var(--bg-input); }
        .check-row .form-input { padding: 6px 8px; font-size: 12px; }
        .check-header { font-size: 9px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.6px; text-transform: uppercase; }
        
        /* Sparkline */
        .sparkline { display: flex; align-items: flex-end; gap: 2px; height: 24px; }
        .sparkline-bar { width: 4px; background: var(--primary); border-radius: 1px; min-height: 2px; }
        .sparkline-bar.warning { background: var(--amber); }
        .sparkline-bar.danger { background: var(--red); }
        
        /* Checkbox & Radio */
        .checkbox { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; }
        .checkbox input { width: 14px; height: 14px; accent-color: var(--primary); }
        .radio-group { display: flex; gap: 12px; }
        .radio { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; }
        .radio input { width: 14px; height: 14px; accent-color: var(--primary); }
        .radio.urgent { color: var(--red); } .radio.mild { color: var(--amber); } .radio.none { color: var(--green); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .modal-wide { max-width: 700px; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text); }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1001; }
        .toast { padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-top: 8px; animation: slideIn 0.2s ease; font-size: 13px; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--green); }
        .toast.error { border-left: 3px solid var(--red); }
        .toast.info { border-left: 3px solid var(--blue); }
        
        /* Empty & Status */
        .empty { text-align: center; padding: 40px 16px; color: var(--text-muted); font-size: 13px; }
        .status { display: inline-flex; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .status-urgent { background: var(--red-glow); color: var(--red); border: 1px solid var(--red); }
        .status-mild { background: var(--amber-glow); color: var(--amber); border: 1px solid var(--amber); }
        .status-ok { background: var(--green-glow); color: var(--green); border: 1px solid var(--green); }
        
        /* Activity Log */
        .activity-log { max-height: 300px; overflow-y: auto; }
        .activity-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .activity-item:last-child { border-bottom: none; }
        .activity-time { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 10px; white-space: nowrap; }
        .activity-text { flex: 1; }
        
        /* Calendar */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-header { text-align: center; font-size: 10px; font-weight: 600; color: var(--text-muted); padding: 8px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: 6px; cursor: pointer; background: var(--bg-input); }
        .calendar-day:hover { background: var(--bg-card-hover); }
        .calendar-day.other-month { color: var(--text-muted); }
        .calendar-day.today { border: 2px solid var(--primary); }
        .calendar-day.has-event { background: var(--primary-glow); color: var(--primary); font-weight: 600; }
        
        /* Tags */
        .tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; font-size: 11px; margin-right: 4px; margin-bottom: 4px; }
        .tag-remove { cursor: pointer; color: var(--text-muted); }
        .tag-remove:hover { color: var(--red); }
        
        /* Drop Zone */
        .drop-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 40px; text-align: center; color: var(--text-muted); transition: all 0.2s; }
        .drop-zone.active { border-color: var(--primary); background: var(--primary-glow); color: var(--primary); }
        
        /* Print Styles */
        @media print {
            .sidebar, .notif-banner, .btn, .nav-btn, .toast-container { display: none !important; }
            .main { margin-left: 0 !important; padding: 20px !important; }
            .card { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; }
            body { background: #fff; color: #000; }
            .badge, .status { border: 1px solid #999; }
        }
        
        /* Responsive */
        @media (max-width: 1400px) { .dash-grid { grid-template-columns: 520px 1fr; } .grid-2-wide-left { grid-template-columns: 300px 1fr; } .charts-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1200px) { .stats { grid-template-columns: repeat(2, 1fr); } .dash-grid { grid-template-columns: 1fr; } .grid-2 { grid-template-columns: 1fr; } .grid-2-wide-left { grid-template-columns: 1fr; } .charts-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { width: 60px; } .sidebar .logo, .sidebar .logo-sub, .sidebar .nav-title, .sidebar .nav-btn span, .sidebar .version, .theme-toggle { display: none; } .sidebar .nav-btn { justify-content: center; padding: 12px; } .main { margin-left: 60px; padding: 16px; } .notif-banner { left: 60px; } .stats { grid-template-columns: 1fr; } .search-box input { width: 150px; } .search-box .shortcut { display: none; } .charts-row { grid-template-columns: 1fr; } }
        
        input[type="date"] { color-scheme: dark; }
        .light-mode input[type="date"] { color-scheme: light; }
    </style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = JSON.parse(atob("eyJhcGlLZXkiOiJBSXphU3lBMkhTZnRvZFRIRHEzQ0piZU43TzRpMHU0Y0FEYXdKd0kiLCJhdXRoRG9tYWluIjoic2hpcC1jaGVja2VyLmZpcmViYXNlYXBwLmNvbSIsInByb2plY3RJZCI6InNoaXAtY2hlY2tlciIsInN0b3JhZ2VCdWNrZXQiOiJzaGlwLWNoZWNrZXIuZmlyZWJhc2VzdG9yYWdlLmFwcCIsIm1lc3NhZ2luZ1NlbmRlcklkIjoiNjIzODEwMDI3OTkiLCJhcHBJZCI6IjE6NjIzODEwMDI3OTk6d2ViOjc1MTFmYWVlM2UzMDFmYWJlYjM2ZGEiLCJtZWFzdXJlbWVudElkIjoiRy1UN1g0VDBFR1pLIn0="));

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Simple hash function for passwords
const hashPassword = (password) => {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return 'h' + Math.abs(hash).toString(16);
};
</script>

<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// Firebase real-time hook - loads instantly from localStorage, syncs with Firestore
const useFirestore = (collectionName, initialData = []) => {
    const [data, setData] = useState(() => {
        try {
            const saved = localStorage.getItem('fb_' + collectionName);
            if (saved) return JSON.parse(saved);
        } catch {}
        if (initialData.length > 0) {
            localStorage.setItem('fb_' + collectionName, JSON.stringify(initialData));
        }
        return initialData;
    });
    const [loading, setLoading] = useState(false);
    const initialized = useRef(false);
    const dataRef = useRef(data);
    const pendingWrite = useRef(false);
    const pendingData = useRef(null);
    
    // Keep ref in sync with state
    useEffect(() => {
        dataRef.current = data;
    }, [data]);

    useEffect(() => {
        const unsubscribe = db.collection(collectionName).onSnapshot((snapshot) => {
            // If we have a pending write, don't overwrite with stale Firebase data
            if (pendingWrite.current) return;
            
            if (!snapshot.empty) {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setData(items);
                dataRef.current = items;
                localStorage.setItem('fb_' + collectionName, JSON.stringify(items));
            } else if (initialData.length > 0 && !initialized.current) {
                initialized.current = true;
                const batch = db.batch();
                initialData.forEach(item => {
                    const ref = db.collection(collectionName).doc(item.id);
                    batch.set(ref, item);
                });
                batch.commit();
            }
            setLoading(false);
        }, (error) => {
            console.error('Firestore error:', error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [collectionName]);

    const setDataWithSync = useCallback((newDataOrFn) => {
        // Use ref to get fresh data for functional updates
        const currentData = dataRef.current;
        const newData = typeof newDataOrFn === 'function' ? newDataOrFn(currentData) : newDataOrFn;
        
        // Set pending flag to prevent snapshot from overwriting
        pendingWrite.current = true;
        pendingData.current = newData;
        
        setData(newData);
        dataRef.current = newData;
        localStorage.setItem('fb_' + collectionName, JSON.stringify(newData));
        
        const batch = db.batch();
        newData.forEach(item => {
            if (item && item.id) {
                const ref = db.collection(collectionName).doc(item.id);
                batch.set(ref, item);
            }
        });
        const newIds = new Set(newData.map(item => item.id));
        currentData.forEach(item => {
            if (item && item.id && !newIds.has(item.id)) {
                const ref = db.collection(collectionName).doc(item.id);
                batch.delete(ref);
            }
        });
        batch.commit()
            .then(() => {
                // Clear pending flag after write completes
                setTimeout(() => {
                    pendingWrite.current = false;
                    pendingData.current = null;
                }, 500);
            })
            .catch(err => {
                console.error('Batch write error:', err);
                pendingWrite.current = false;
                pendingData.current = null;
            });
    }, [collectionName]);

    return [data, setDataWithSync, loading];
};

const useStorage = (key, init) => {
    const [val, setVal] = useState(() => { try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : init; } catch { return init; } });
    useEffect(() => { localStorage.setItem(key, JSON.stringify(val)); }, [key, val]);
    return [val, setVal];
};

// ===== AUTHENTICATION =====
function LoginPage({ onLogin, users, loginAttempts, setLoginAttempts }) {
    const [mode, setMode] = useState('login');
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [confirmPassword, setConfirmPassword] = useState('');
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        setError('');
        if (!username.trim() || !password.trim()) { setError('Please enter username and password'); return; }
        
        // Check for lockout
        const attemptKey = username.toLowerCase();
        const attempts = loginAttempts[attemptKey] || { count: 0, lockedUntil: null };
        if (attempts.lockedUntil && new Date() < new Date(attempts.lockedUntil)) {
            const mins = Math.ceil((new Date(attempts.lockedUntil) - new Date()) / 60000);
            setError(`Account locked. Try again in ${mins} minute${mins > 1 ? 's' : ''}.`);
            return;
        }
        
        const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (!user) { 
            // Track failed attempt
            const newAttempts = { ...loginAttempts, [attemptKey]: { count: (attempts.count || 0) + 1, lockedUntil: null } };
            if (newAttempts[attemptKey].count >= 5) {
                newAttempts[attemptKey].lockedUntil = new Date(Date.now() + 15 * 60000).toISOString(); // 15 min lockout
                setError('Too many failed attempts. Account locked for 15 minutes.');
            } else {
                setError(`User not found. ${5 - newAttempts[attemptKey].count} attempts remaining.`);
            }
            setLoginAttempts(newAttempts);
            localStorage.setItem('loginAttempts', JSON.stringify(newAttempts));
            return; 
        }
        if (user.status === 'pending') { setError('Your account is pending approval.'); return; }
        if (user.status === 'denied') { setError('Your access was denied. Contact admin.'); return; }
        
        const newHash = hashPassword(password);
        if (user.passwordHash !== newHash) {
            // Track failed attempt
            const newAttempts = { ...loginAttempts, [attemptKey]: { count: (attempts.count || 0) + 1, lockedUntil: null } };
            if (newAttempts[attemptKey].count >= 5) {
                newAttempts[attemptKey].lockedUntil = new Date(Date.now() + 15 * 60000).toISOString();
                setError('Too many failed attempts. Account locked for 15 minutes.');
            } else {
                setError(`Invalid password. ${5 - newAttempts[attemptKey].count} attempts remaining.`);
            }
            setLoginAttempts(newAttempts);
            localStorage.setItem('loginAttempts', JSON.stringify(newAttempts));
            return;
        }
        
        // Successful login - clear attempts and record login
        const newAttempts = { ...loginAttempts };
        delete newAttempts[attemptKey];
        setLoginAttempts(newAttempts);
        localStorage.setItem('loginAttempts', JSON.stringify(newAttempts));
        
        // Record last login
        const lastLogin = user.lastLogin || null;
        const loginRecord = { timestamp: new Date().toISOString(), sessionStart: Date.now() };
        db.collection('users').doc(user.id).update({ lastLogin: loginRecord });
        
        localStorage.setItem('shipTrackerUser', JSON.stringify({ username: user.username, isAdmin: user.isAdmin, lastLogin, sessionStart: loginRecord.sessionStart }));
        onLogin(user, lastLogin);
    };

    const handleRegister = (e) => {
        e.preventDefault();
        setError(''); setSuccess('');
        if (!username.trim() || !password.trim()) { setError('Please fill in all fields'); return; }
        if (password !== confirmPassword) { setError('Passwords do not match'); return; }
        if (password.length < 4) { setError('Password must be at least 4 characters'); return; }
        if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) { setError('Username already exists'); return; }
        const newUser = { id: 'U' + Date.now(), username: username.trim(), passwordHash: hashPassword(password), status: 'pending', isAdmin: false, requestedAt: new Date().toISOString() };
        db.collection('users').doc(newUser.id).set(newUser);
        setSuccess('Access request submitted! Please wait for admin approval.');
        setUsername(''); setPassword(''); setConfirmPassword(''); setMode('login');
    };

    return (
        <div style={{minHeight:'100vh',background:'var(--bg-deep)',display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
            <div style={{width:'100%',maxWidth:'400px'}}>
                <div style={{textAlign:'center',marginBottom:'32px'}}>
                    <svg width="80" height="40" viewBox="0 0 120 60" fill="none" stroke="var(--primary)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{marginBottom:'16px'}}>
                        {/* Hull - sleek destroyer shape */}
                        <path d="M5 42 L15 38 L105 38 L115 42 L108 45 L12 45 Z" fill="var(--primary)" fillOpacity="0.1"/>
                        <path d="M5 42 L15 38 L105 38 L115 42"/>
                        {/* Bow - pointed */}
                        <path d="M15 38 L8 35 L5 42"/>
                        {/* Stern */}
                        <path d="M105 38 L112 35 L115 42"/>
                        {/* Main deck */}
                        <path d="M18 38 L18 35 L102 35 L102 38"/>
                        {/* Forward gun turret (5 inch) */}
                        <circle cx="28" cy="33" r="4" fill="var(--primary)" fillOpacity="0.2"/>
                        <path d="M28 33 L28 25"/>
                        <path d="M26 25 L30 25"/>
                        {/* VLS cells forward */}
                        <rect x="36" y="31" width="12" height="6" rx="1" fill="var(--primary)" fillOpacity="0.15"/>
                        <path d="M39 31 L39 37 M42 31 L42 37 M45 31 L45 37"/>
                        {/* Bridge/superstructure */}
                        <path d="M52 35 L52 22 L72 22 L72 35" fill="var(--primary)" fillOpacity="0.2"/>
                        <path d="M54 22 L54 18 L70 18 L70 22"/>
                        {/* Bridge windows */}
                        <path d="M56 20 L68 20"/>
                        {/* Radar mast with SPY panels */}
                        <path d="M62 18 L62 8"/>
                        <path d="M58 12 L66 12"/>
                        <rect x="59" y="13" width="6" height="4" fill="var(--primary)" fillOpacity="0.3"/>
                        {/* Aft superstructure */}
                        <path d="M76 35 L76 26 L88 26 L88 35" fill="var(--primary)" fillOpacity="0.15"/>
                        {/* Aft mast */}
                        <path d="M82 26 L82 16"/>
                        <path d="M79 19 L85 19"/>
                        {/* CIWS mount */}
                        <circle cx="94" cy="33" r="3" fill="var(--primary)" fillOpacity="0.2"/>
                        <path d="M94 33 L94 29 L96 27"/>
                        {/* Helo deck markings */}
                        <circle cx="98" cy="37" r="2" strokeDasharray="1 1"/>
                        {/* Waterline */}
                        <path d="M12 45 L108 45" strokeOpacity="0.5"/>
                        {/* Wake */}
                        <path d="M108 43 Q112 43 116 44" strokeOpacity="0.3"/>
                        <path d="M108 44 Q113 44 118 46" strokeOpacity="0.2"/>
                    </svg>
                    <div style={{fontFamily:'JetBrains Mono',fontSize:'18px',fontWeight:700,color:'var(--primary)',letterSpacing:'2px'}}>SHIP TRACKER PRO</div>
                    <div style={{fontSize:'12px',color:'var(--text-muted)',marginTop:'4px'}}>Pro Edition</div>
                </div>
                <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'12px',padding:'24px'}}>
                    <div style={{display:'flex',marginBottom:'24px',borderBottom:'1px solid var(--border)'}}>
                        <button onClick={() => { setMode('login'); setError(''); setSuccess(''); }} style={{flex:1,padding:'12px',background:'none',border:'none',color: mode === 'login' ? 'var(--primary)' : 'var(--text-muted)',fontWeight: mode === 'login' ? 600 : 400,cursor:'pointer',borderBottom: mode === 'login' ? '2px solid var(--primary)' : 'none',marginBottom:'-1px'}}>Login</button>
                        <button onClick={() => { setMode('register'); setError(''); setSuccess(''); }} style={{flex:1,padding:'12px',background:'none',border:'none',color: mode === 'register' ? 'var(--primary)' : 'var(--text-muted)',fontWeight: mode === 'register' ? 600 : 400,cursor:'pointer',borderBottom: mode === 'register' ? '2px solid var(--primary)' : 'none',marginBottom:'-1px'}}>Request Access</button>
                    </div>
                    {error && <div style={{background:'var(--red-glow)',border:'1px solid var(--red)',color:'var(--red)',padding:'12px',borderRadius:'8px',marginBottom:'16px',fontSize:'13px'}}>{error}</div>}
                    {success && <div style={{background:'var(--green-glow)',border:'1px solid var(--green)',color:'var(--green)',padding:'12px',borderRadius:'8px',marginBottom:'16px',fontSize:'13px'}}>{success}</div>}
                    {mode === 'login' ? (
                        <form onSubmit={handleLogin}>
                            <div style={{marginBottom:'16px'}}><label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Username</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Enter username"/></div>
                            <div style={{marginBottom:'24px'}}><label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Enter password"/></div>
                            <button type="submit" style={{width:'100%',padding:'14px',background:'var(--primary)',color:'#000',border:'none',borderRadius:'8px',fontSize:'14px',fontWeight:600,cursor:'pointer'}}>Login</button>
                        </form>
                    ) : (
                        <form onSubmit={handleRegister}>
                            <div style={{marginBottom:'16px'}}><label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Username</label><input type="text" value={username} onChange={e => setUsername(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Choose username"/></div>
                            <div style={{marginBottom:'16px'}}><label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Create password"/></div>
                            <div style={{marginBottom:'24px'}}><label style={{display:'block',fontSize:'12px',color:'var(--text-dim)',marginBottom:'6px'}}>Confirm Password</label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} style={{width:'100%',padding:'12px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',color:'var(--text)',fontSize:'14px'}} placeholder="Confirm password"/></div>
                            <button type="submit" style={{width:'100%',padding:'14px',background:'var(--primary)',color:'#000',border:'none',borderRadius:'8px',fontSize:'14px',fontWeight:600,cursor:'pointer'}}>Request Access</button>
                            <p style={{fontSize:'11px',color:'var(--text-muted)',textAlign:'center',marginTop:'12px'}}>Your request will be sent to admin for approval</p>
                        </form>
                    )}
                </div>
            </div>
        </div>
    );
}

function AdminPanel({ users, onClose }) {
    const pending = users.filter(u => u.status === 'pending');
    const approved = users.filter(u => u.status === 'approved');
    const denied = users.filter(u => u.status === 'denied');
    const approve = (u) => db.collection('users').doc(u.id).update({ status: 'approved', approvedAt: new Date().toISOString() });
    const deny = (u) => db.collection('users').doc(u.id).update({ status: 'denied', deniedAt: new Date().toISOString() });
    const del = (u) => { if (!u.isAdmin && confirm(`Delete ${u.username}?`)) db.collection('users').doc(u.id).delete(); };
    const resetPw = (u) => { const p = prompt(`New password for ${u.username}:`); if (p && p.length >= 4) { db.collection('users').doc(u.id).update({ passwordHash: hashPassword(p) }); alert('Password reset!'); } };

    return (
        <div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px'}}>
            <div style={{background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'12px',width:'100%',maxWidth:'600px',maxHeight:'80vh',overflow:'auto'}}>
                <div style={{padding:'20px',borderBottom:'1px solid var(--border)',display:'flex',justifyContent:'space-between',alignItems:'center'}}><h2 style={{fontSize:'18px',fontWeight:600}}>ðŸ‘‘ Admin Panel</h2><button onClick={onClose} style={{background:'none',border:'none',color:'var(--text-muted)',fontSize:'24px',cursor:'pointer'}}>Ã—</button></div>
                <div style={{padding:'20px'}}>
                    {pending.length > 0 && <div style={{marginBottom:'24px'}}><h3 style={{fontSize:'14px',color:'var(--amber)',marginBottom:'12px'}}><span style={{background:'var(--amber)',color:'#000',padding:'2px 8px',borderRadius:'10px',fontSize:'12px',marginRight:'8px'}}>{pending.length}</span>Pending</h3>{pending.map(u => <div key={u.id} style={{background:'var(--amber-glow)',border:'1px solid var(--amber)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center'}}><div><div style={{fontWeight:600}}>{u.username}</div><div style={{fontSize:'11px',color:'var(--text-muted)'}}>{new Date(u.requestedAt).toLocaleString()}</div></div><div style={{display:'flex',gap:'8px'}}><button onClick={() => approve(u)} style={{padding:'6px 12px',background:'var(--green)',color:'#000',border:'none',borderRadius:'6px',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>âœ“</button><button onClick={() => deny(u)} style={{padding:'6px 12px',background:'var(--red)',color:'#fff',border:'none',borderRadius:'6px',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>âœ•</button></div></div>)}</div>}
                    <div style={{marginBottom:'24px'}}><h3 style={{fontSize:'14px',color:'var(--green)',marginBottom:'12px'}}>âœ“ Approved ({approved.length})</h3>{approved.map(u => <div key={u.id} style={{background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center'}}><div><div style={{fontWeight:600,display:'flex',alignItems:'center',gap:'8px'}}>{u.username}{u.isAdmin && <span style={{background:'var(--primary)',color:'#000',padding:'2px 6px',borderRadius:'4px',fontSize:'10px'}}>ADMIN</span>}</div>{u.lastLogin?.timestamp && <div style={{fontSize:'10px',color:'var(--text-muted)',marginTop:'4px'}}>Last login: {new Date(u.lastLogin.timestamp).toLocaleDateString()} {new Date(u.lastLogin.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>}</div>{!u.isAdmin && <div style={{display:'flex',gap:'8px'}}><button onClick={() => resetPw(u)} style={{padding:'6px 12px',background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Reset PW</button><button onClick={() => del(u)} style={{padding:'6px 12px',background:'var(--red-glow)',color:'var(--red)',border:'1px solid var(--red)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Delete</button></div>}</div>)}</div>
                    {denied.length > 0 && <div><h3 style={{fontSize:'14px',color:'var(--red)',marginBottom:'12px'}}>âœ• Denied ({denied.length})</h3>{denied.map(u => <div key={u.id} style={{background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'8px',padding:'12px',marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center',opacity:0.7}}><div style={{fontWeight:600}}>{u.username}</div><div style={{display:'flex',gap:'8px'}}><button onClick={() => approve(u)} style={{padding:'6px 12px',background:'var(--green-glow)',color:'var(--green)',border:'1px solid var(--green)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Approve</button><button onClick={() => del(u)} style={{padding:'6px 12px',background:'var(--red-glow)',color:'var(--red)',border:'1px solid var(--red)',borderRadius:'6px',fontSize:'11px',cursor:'pointer'}}>Delete</button></div></div>)}</div>}
                </div>
            </div>
        </div>
    );
}

function AuthWrapper() {
    const [currentUser, setCurrentUser] = useState(() => { try { return JSON.parse(localStorage.getItem('shipTrackerUser')); } catch { return null; } });
    const [users, setUsers] = useState(() => {
        try { const s = localStorage.getItem('fb_users'); if (s) return JSON.parse(s); } catch {}
        const admin = { id: 'UADMIN001', username: 'DBrown', passwordHash: hashPassword('admin123'), status: 'approved', isAdmin: true, createdAt: new Date().toISOString() };
        localStorage.setItem('fb_users', JSON.stringify([admin]));
        return [admin];
    });
    const [showAdmin, setShowAdmin] = useState(false);
    const [loginAttempts, setLoginAttempts] = useState(() => {
        try { return JSON.parse(localStorage.getItem('loginAttempts') || '{}'); } catch { return {}; }
    });
    const [sessionWarning, setSessionWarning] = useState(false);
    const init = useRef(false);
    const lastActivity = useRef(Date.now());
    
    // Session timeout: 8 hours
    const SESSION_TIMEOUT = 8 * 60 * 60 * 1000;
    const WARNING_BEFORE = 5 * 60 * 1000; // 5 min warning
    
    // Track user activity
    useEffect(() => {
        if (!currentUser) return;
        const updateActivity = () => { lastActivity.current = Date.now(); setSessionWarning(false); };
        window.addEventListener('mousemove', updateActivity);
        window.addEventListener('keypress', updateActivity);
        window.addEventListener('click', updateActivity);
        return () => {
            window.removeEventListener('mousemove', updateActivity);
            window.removeEventListener('keypress', updateActivity);
            window.removeEventListener('click', updateActivity);
        };
    }, [currentUser]);
    
    // Check session timeout
    useEffect(() => {
        if (!currentUser) return;
        const checkSession = () => {
            const sessionStart = currentUser.sessionStart || Date.now();
            const elapsed = Date.now() - sessionStart;
            const inactive = Date.now() - lastActivity.current;
            
            // Auto-logout after 8 hours total session OR 2 hours inactivity
            if (elapsed > SESSION_TIMEOUT || inactive > 2 * 60 * 60 * 1000) {
                logout('Session expired');
                return;
            }
            
            // Show warning 5 min before timeout
            if (elapsed > SESSION_TIMEOUT - WARNING_BEFORE || inactive > 2 * 60 * 60 * 1000 - WARNING_BEFORE) {
                setSessionWarning(true);
            }
        };
        const interval = setInterval(checkSession, 30000); // Check every 30 sec
        return () => clearInterval(interval);
    }, [currentUser]);

    useEffect(() => {
        const correctAdminHash = hashPassword('admin123');
        const unsub = db.collection('users').onSnapshot((snap) => {
            if (!snap.empty) {
                const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Ensure admin user has correct password hash
                const adminUser = list.find(u => u.username.toLowerCase() === 'dbrown');
                if (adminUser && adminUser.passwordHash !== correctAdminHash) {
                    console.log('Fixing admin password hash...');
                    db.collection('users').doc(adminUser.id).update({ passwordHash: correctAdminHash });
                }
                setUsers(list);
                localStorage.setItem('fb_users', JSON.stringify(list));
            } else if (!init.current) {
                init.current = true;
                const admin = { id: 'UADMIN001', username: 'DBrown', passwordHash: correctAdminHash, status: 'approved', isAdmin: true, createdAt: new Date().toISOString() };
                db.collection('users').doc(admin.id).set(admin);
            }
        });
        return () => unsub();
    }, []);

    const logout = (reason) => { 
        // Clean up presence document
        if (currentUser?.username) {
            db.collection('presence').doc(currentUser.username).delete().catch(() => {});
        }
        localStorage.removeItem('shipTrackerUser'); 
        setCurrentUser(null); 
        setSessionWarning(false);
        if (reason) console.log('Logout:', reason);
    };
    const pending = users.filter(u => u.status === 'pending').length;

    if (currentUser) return (
        <>
            <App currentUser={currentUser} onLogout={() => logout('User logout')} isAdmin={currentUser.isAdmin} pendingCount={pending} onOpenAdminPanel={() => setShowAdmin(true)}/>
            {showAdmin && currentUser.isAdmin && <AdminPanel users={users} onClose={() => setShowAdmin(false)}/>}
            {sessionWarning && (
                <div style={{position:'fixed',bottom:'20px',right:'20px',padding:'16px 20px',background:'var(--amber-glow)',border:'2px solid var(--amber)',borderRadius:'12px',zIndex:10000,boxShadow:'0 4px 20px rgba(0,0,0,0.3)'}}>
                    <div style={{fontWeight:600,color:'var(--amber)',marginBottom:'8px'}}>âš ï¸ Session Expiring Soon</div>
                    <div style={{fontSize:'12px',color:'var(--text-dim)',marginBottom:'12px'}}>Your session will expire due to inactivity.</div>
                    <button onClick={() => { lastActivity.current = Date.now(); setSessionWarning(false); }} style={{padding:'8px 16px',background:'var(--amber)',color:'#000',border:'none',borderRadius:'6px',fontWeight:600,cursor:'pointer'}}>Stay Logged In</button>
                </div>
            )}
        </>
    );
    return <LoginPage onLogin={(u, lastLogin) => setCurrentUser({ username: u.username, isAdmin: u.isAdmin, lastLogin, sessionStart: Date.now() })} users={users} loginAttempts={loginAttempts} setLoginAttempts={setLoginAttempts}/>;
}


const defaultShips = [
    { id: 'S001', name: 'CG67', type: 'Full REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:39.997Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S002', name: 'CG70', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T18:00:02.820Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S003', name: 'DDG54', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T00:00:00.000Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '', waitingReply: true },
    { id: 'S004', name: 'DDG56', type: 'Full REAP', location: 'Everett, WA', poc: '', email: '', threat: 'NoIssue', lastContact: null, nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S005', name: 'DDG62', type: 'Full REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:54:46.945Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S006', name: 'DDG63', type: 'Full REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:58:57.236Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S007', name: 'DDG55', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:22.669Z', nextCheck: '2026-01-21', lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S008', name: 'DDG57', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: null, nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S009', name: 'DDG72', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:56:38.578Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S011', name: 'DDG96', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:50.621Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S012', name: 'DDG98', type: 'Mini REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:20:57.277Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S013', name: 'DDG101', type: 'Mini REAP', location: 'Pearl Harbor, HI', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:21:03.773Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S014', name: 'DDG103', type: 'Mini REAP', location: 'Mayport, FL', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:54:54.225Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S015', name: 'DDG109', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:59:37.220Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
    { id: 'S016', name: 'DDG111', type: 'Mini REAP', location: 'San Diego, CA', poc: '', email: '', threat: 'NoIssue', lastContact: '2026-01-20T17:55:24.866Z', nextCheck: null, lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', contactedBy: '' },
];

const defaultIssues = [
    { id: 'I1768930451445', shipId: 'S007', shipName: 'DDG55', threat: 'Mild', title: 'Systems Offline', category: 'Network/Equipment', details: 'We noticed that both systems have been offline since yesterday. Is SF currently experiencing a power outage or SIPR outage in CSER2?', created: '2026-01-20T17:34:11.445Z', resolved: false, responsibility: 'Ship' },
    { id: 'I1768930471981', shipId: 'S003', shipName: 'DDG54', threat: 'Mild', title: 'CNO till May', category: 'Ship Maintenance', details: 'I am reaching out regarding the (STAR & DATA) Reap PCs. Both systems have appeared to go offline since 12/16.', created: '2026-01-20T17:34:31.981Z', resolved: false, responsibility: 'Ship' },
    { id: 'I1768931474446', shipId: 'S005', shipName: 'DDG62', threat: 'Mild', title: 'REAP PCs Offline', category: 'Network/Equipment', details: 'We have noticed that the REAP STAR & DATA PCs are offline at this time.', created: '2026-01-20T17:51:14.446Z', resolved: false, responsibility: 'Ship' },
    { id: 'I1768931502710', shipId: 'S014', shipName: 'DDG103', threat: 'Mild', title: 'Intermittent Connection', category: 'Network/Equipment', details: 'We are currently experiencing intermittent SHF/EHF which is causing issues seeing the system online.', created: '2026-01-20T17:51:42.710Z', resolved: false, responsibility: 'Ship' },
];

const defaultDailyChecks = [
    { id: 'DC001', shipId: 'S001', date: '2026-01-20', pingAM: '237', pingPM: '237', hdSpace: '1779', statusAM: true, statusPM: true },
    { id: 'DC002', shipId: 'S002', date: '2026-01-20', pingAM: '202', pingPM: '287', hdSpace: '545', statusAM: true, statusPM: true },
    { id: 'DC003', shipId: 'S003', date: '2026-01-20', pingAM: '', pingPM: '', hdSpace: '', statusAM: false, statusPM: false },
    { id: 'DC006', shipId: 'S006', date: '2026-01-20', pingAM: '358', pingPM: '356', hdSpace: '1760', statusAM: true, statusPM: true },
    { id: 'DC009', shipId: 'S009', date: '2026-01-20', pingAM: '195', pingPM: '195', hdSpace: '', statusAM: true, statusPM: true },
    { id: 'DC012', shipId: 'S013', date: '2026-01-20', pingAM: '275', pingPM: '', hdSpace: '', statusAM: true, statusPM: false },
];

const defaultActivityLog = [
    { id: 'A1768932835636', text: 'Marked DDG54 as waiting on reply', time: '2026-01-20T18:13:55.636Z' },
    { id: 'A1768932002820', text: 'Marked CG70 as contacted', time: '2026-01-20T18:00:02.820Z' },
    { id: 'A1768931977220', text: 'Marked DDG109 as contacted', time: '2026-01-20T17:59:37.220Z' },
];

const hullNum = (name) => { const m = name.match(/\d+/); return m ? parseInt(m[0]) : 9999; };
const sortHull = (a, b) => hullNum(a.name) - hullNum(b.name);
const fmtDate = (d) => {
    if (!d) return '';
    // Handle date strings (YYYY-MM-DD) to avoid timezone shift
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [y, m, day] = d.split('-').map(Number);
        return new Date(y, m - 1, day).toLocaleDateString('en-US');
    }
    // Handle ISO strings (YYYY-MM-DDTHH:mm:ss) - extract date part and treat as local
    if (typeof d === 'string' && d.includes('T')) {
        const datePart = d.split('T')[0];
        const [y, m, day] = datePart.split('-').map(Number);
        return new Date(y, m - 1, day).toLocaleDateString('en-US');
    }
    // Fallback for Date objects
    const date = new Date(d);
    return date.toLocaleDateString('en-US');
};
const fmtDateInput = (d) => {
    if (!d) return '';
    // Handle date strings (YYYY-MM-DD) - return as-is
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return d;
    }
    // Handle ISO strings - extract date part
    if (typeof d === 'string' && d.includes('T')) {
        return d.split('T')[0];
    }
    // Handle Date objects - use local time
    const date = new Date(d);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
};
// Parse date string in local time (avoids UTC timezone shift)
const parseLocalDate = (d) => {
    if (!d) return new Date();
    if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [y, m, day] = d.split('-').map(Number);
        return new Date(y, m - 1, day);
    }
    // Handle ISO strings - extract date part and treat as local
    if (typeof d === 'string' && d.includes('T')) {
        const datePart = d.split('T')[0];
        const [y, m, day] = datePart.split('-').map(Number);
        return new Date(y, m - 1, day);
    }
    return new Date(d);
};
// Get date string in YYYY-MM-DD format from Date object (local time)
const toDateString = (d) => {
    const date = d instanceof Date ? d : new Date(d);
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
};
const fmtTime = (d) => { const now = new Date(), then = new Date(d), diff = (now - then) / 1000; if (diff < 60) return 'Just now'; if (diff < 3600) return `${Math.floor(diff/60)}m ago`; if (diff < 86400) return `${Math.floor(diff/3600)}h ago`; return `${Math.floor(diff/86400)}d ago`; };
const genId = (p) => `${p}${Date.now()}`;

const getEmailStatus = (ship, issues) => {
    // If ship is in port with future return date, email status is paused
    if (ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0))) {
        return { status: 'IN PORT', days: 0 };
    }
    if (ship.waitingReply) return { status: 'WAITING', days: 0 };
    const si = issues.filter(i => i.shipId === ship.id && !i.resolved);
    const urg = si.some(i => i.threat === 'Urgent') ? 2 : si.some(i => i.threat === 'Mild') ? 1 : 0;
    if (!ship.lastContact) return { status: 'OVERDUE', days: 999 };
    const lc = new Date(ship.lastContact), due = new Date(lc);
    if (urg === 2) due.setDate(due.getDate() + 1);
    else if (urg === 1) due.setDate(due.getDate() + 3);
    else due.setDate(due.getDate() + 14);
    const today = new Date(); today.setHours(0,0,0,0); due.setHours(0,0,0,0);
    const diff = Math.floor((today - due) / 86400000);
    if (diff > 0) return { status: 'OVERDUE', days: diff };
    if (diff === 0) return { status: 'DUE', days: 0 };
    return { status: 'OK', days: diff };
};

const Icon = ({ name, style }) => {
    const paths = {
        dashboard: <><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></>,
        checks: <><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></>,
        add: <><circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/></>,
        issues: <><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4M12 17h.01"/></>,
        inventory: <><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></>,
        installs: <><path d="M22 2L11 13"/><path d="M22 2L15 22l-4-9-9-4 22-7z"/></>,
        parts: <><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></>,
        email: <><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></>,
        settings: <><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></>,
        search: <><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></>,
        close: <><path d="M18 6L6 18M6 6l12 12"/></>,
        check: <><path d="M20 6L9 17l-5-5"/></>,
        edit: <><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
        trash: <><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></>,
        plus: <><path d="M12 5v14M5 12h14"/></>,
        download: <><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></>,
        upload: <><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></>,
        calendar: <><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></>,
        user: <><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        ship: <><path d="M1 17l2-1h18l2 1H1z"/><path d="M3 16h18l1-3H2l1 3z"/><path d="M4 13h16v-2H4v2z"/><circle cx="6" cy="12" r="1.5"/><path d="M6 12V9"/><path d="M5 9h2"/><rect x="8" y="10" width="4" height="3" rx="0.5"/><path d="M9 10v-3h2v3"/><path d="M12 13v-4h4v4"/><path d="M14 9V5"/><path d="M13 7h2"/><rect x="13" y="7.5" width="2" height="1.5" rx="0.3"/><path d="M17 13v-2h2v2"/><path d="M18 11V8"/><path d="M17 9h2"/><circle cx="20" cy="12" r="1"/><path d="M20 12V10l1-1"/><path d="M3 17v1h18v-1"/><path d="M21 16q1 0 2 1" strokeOpacity="0.5"/></>,
        destroyer: <><path d="M1 17l2-1h18l2 1H1z"/><path d="M3 16h18l1-3H2l1 3z"/><path d="M4 13h16v-2H4v2z"/><circle cx="6" cy="12" r="1.5"/><path d="M6 12V9"/><path d="M5 9h2"/><rect x="8" y="10" width="4" height="3" rx="0.5"/><path d="M9 10v-3h2v3"/><path d="M12 13v-4h4v4"/><path d="M14 9V5"/><path d="M13 7h2"/><rect x="13" y="7.5" width="2" height="1.5" rx="0.3"/><path d="M17 13v-2h2v2"/><path d="M18 11V8"/><path d="M17 9h2"/><circle cx="20" cy="12" r="1"/><path d="M20 12V10l1-1"/><path d="M3 17v1h18v-1"/><path d="M21 16q1 0 2 1" strokeOpacity="0.5"/></>,
        alert: <><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></>,
        info: <><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></>,
        copy: <><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></>,
        print: <><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>,
        report: <><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8M16 17H8M10 9H8"/></>,
    };
    return <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={style}>{paths[name]}</svg>;
};

const Toast = ({ toasts, remove }) => (
    <div className="toast-container">
        {toasts.map(t => (
            <div key={t.id} className={`toast toast-${t.type}`} onClick={() => remove(t.id)}>
                {t.message}
            </div>
        ))}
    </div>
);

const DonutChart = ({ value, total, max, color, label, sublabel }) => {
    const maxVal = total || max || 1;
    const pct = maxVal > 0 ? (value / maxVal) * 100 : 0;
    const circumference = 2 * Math.PI * 45;
    const offset = circumference - (pct / 100) * circumference;
    return (
        <div className="pie-chart">
            <svg width="120" height="120" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" strokeWidth="10"/>
                <circle cx="50" cy="50" r="45" fill="none" stroke={color} strokeWidth="10" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round"/>
            </svg>
            <div className="pie-chart-center">
                <div className="pie-chart-value">{value}</div>
                <div className="pie-chart-label">{label}</div>
                {sublabel && <div style={{fontSize:'10px',color:'var(--text-muted)'}}>{sublabel}</div>}
            </div>
        </div>
    );
};

const PieChart = ({ data, colors, value, max, color, label }) => {
    // If called with data array, render multi-segment pie
    if (data && Array.isArray(data)) {
        const total = data.reduce((a, b) => a + b, 0) || 1;
        const circumference = 2 * Math.PI * 45;
        let offset = 0;
        return (
            <div className="pie-chart">
                <svg width="120" height="120" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border)" strokeWidth="10"/>
                    {data.map((val, i) => {
                        const pct = (val / total) * circumference;
                        const segment = (
                            <circle key={i} cx="50" cy="50" r="45" fill="none" stroke={colors?.[i] || 'var(--primary)'} strokeWidth="10" 
                                strokeDasharray={`${pct} ${circumference - pct}`} 
                                strokeDashoffset={-offset}
                                style={{transform: 'rotate(-90deg)', transformOrigin: 'center'}}/>
                        );
                        offset += pct;
                        return segment;
                    })}
                </svg>
                <div className="pie-chart-center">
                    <div className="pie-chart-value">{total}</div>
                    <div className="pie-chart-label">Total</div>
                </div>
            </div>
        );
    }
    // Otherwise use DonutChart style
    return <DonutChart value={value} max={max} color={color} label={label} />;
};

const Sparkline = ({ data, color = 'var(--primary)', height = 30, max: maxProp }) => {
    if (!data || data.length === 0) return <div style={{height, opacity: 0.3}}>No data</div>;
    const max = maxProp || Math.max(...data, 1);
    const min = Math.min(...data, 0);
    const range = max - min || 1;
    const points = data.map((v, i) => `${(i / (data.length - 1 || 1)) * 100},${100 - ((v - min) / range) * 100}`).join(' ');
    return (
        <svg width="100%" height={height} viewBox="0 0 100 100" preserveAspectRatio="none">
            <polyline fill="none" stroke={color} strokeWidth="2" points={points}/>
        </svg>
    );
};

const Modal = ({ title, onClose, children, wide, open }) => {
    useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
        if (open) window.addEventListener('keydown', handleEsc);
        return () => window.removeEventListener('keydown', handleEsc);
    }, [open, onClose]);
    
    if (!open) return null;
    
    return (
        <div className="modal-overlay" onClick={onClose}>
            <div className={`modal ${wide ? 'modal-wide' : ''}`} onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                    <div className="modal-title">{title}</div>
                    <button className="modal-close" onClick={onClose}><Icon name="close"/></button>
                </div>
                <div className="modal-body">{children}</div>
            </div>
        </div>
    );
};

function App({ currentUser, onLogout, isAdmin, pendingCount, onOpenAdminPanel }) {
    const [page, setPage] = useState(() => {
        const saved = localStorage.getItem('currentPage');
        return saved ? parseInt(saved) : 0;
    });
    
    // Persist page to localStorage
    useEffect(() => {
        localStorage.setItem('currentPage', page.toString());
    }, [page]);
    // Shared data - syncs across all users via Firebase
    const [ships, setShips, shipsLoading] = useFirestore('ships', defaultShips);
    const [issues, setIssues] = useFirestore('issues', defaultIssues);
    const [dailyChecks, setDailyChecks] = useFirestore('dailyChecks', defaultDailyChecks);
    const [installs, setInstalls] = useFirestore('installs', []);
    const [parts, setParts] = useFirestore('parts', []);
    const [activityLog, setActivityLog] = useFirestore('activityLog', defaultActivityLog);
    const [suggestions, setSuggestions] = useFirestore('suggestions', []);
    const [onlineUsers, setOnlineUsers] = useState([]);
    // Local-only settings (not shared)
    const [toasts, setToasts] = useState([]);
    const [editingShip, setEditingShip] = useState(null);
    const [darkMode, setDarkMode] = useStorage('darkMode', true);
    const [backupSettings, setBackupSettings] = useStorage('backupSettings', { lastBackup: null, reminderDays: 3, autoBackupEnabled: true });
    const [globalSearch, setGlobalSearch] = useState('');
    const [showBanner, setShowBanner] = useState(true);
    const [feedbackModal, setFeedbackModal] = useState(false);
    const [feedbackText, setFeedbackText] = useState('');
    const [feedbackType, setFeedbackType] = useState('idea');
    const [showOnlineTooltip, setShowOnlineTooltip] = useState(false);
    const searchRef = useRef(null);
    
    // Update online presence - each user writes their own document
    useEffect(() => {
        if (!currentUser) return;
        
        const presenceRef = db.collection('presence').doc(currentUser.username);
        
        const updatePresence = () => {
            presenceRef.set({ 
                username: currentUser.username, 
                lastSeen: Date.now(),
                isAdmin: currentUser.isAdmin || false
            }).catch(() => {});
        };
        
        // Update immediately and every 20 seconds
        updatePresence();
        const interval = setInterval(updatePresence, 20000);
        
        // Listen for ALL presence docs
        const unsubscribe = db.collection('presence').onSnapshot((snapshot) => {
            const now = Date.now();
            const users = snapshot.docs
                .map(doc => doc.data())
                .filter(u => now - u.lastSeen < 120000); // active in last 2 min
            setOnlineUsers(users);
        });
        
        // Cleanup: remove self on logout/close
        const cleanup = () => {
            presenceRef.delete().catch(() => {});
        };
        window.addEventListener('beforeunload', cleanup);
        
        return () => {
            clearInterval(interval);
            window.removeEventListener('beforeunload', cleanup);
            cleanup();
            unsubscribe();
        };
    }, [currentUser]);
    
    // Get currently online users (already filtered in snapshot listener)
    const activeUsers = onlineUsers;

    const toast = (msg, type = 'info') => { const id = Date.now(); setToasts(t => [...t, { id, message: msg, type }]); setTimeout(() => setToasts(t => t.filter(x => x.id !== id)), 3000); };
    const logActivity = (text, details = null) => { 
        const newEntry = { id: genId('A'), text, details, user: currentUser?.username || 'Unknown', time: new Date().toISOString() };
        setActivityLog(prev => [newEntry, ...prev.slice(0, 199)]); 
    };
    
    const submitFeedback = () => {
        if (!feedbackText.trim()) { toast('Please enter your suggestion', 'error'); return; }
        setSuggestions(prev => [...prev, { 
            id: genId('FB'), 
            type: feedbackType, 
            text: feedbackText, 
            user: currentUser?.username || 'Anonymous',
            created: new Date().toISOString(),
            status: 'new'
        }]);
        toast('Thanks for your feedback!', 'success');
        setFeedbackText('');
        setFeedbackModal(false);
    };

    const downloadBackup = useCallback((silent = false) => {
        const data = { ships, issues, dailyChecks, installs, parts, activityLog, exportDate: new Date().toISOString(), version: '3.1' };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `ShipTracker_Backup_${toDateString(new Date())}.json`; a.click();
        setBackupSettings(prev => ({ ...prev, lastBackup: new Date().toISOString() }));
        if (!silent) toast('Backup downloaded!', 'success');
    }, [ships, issues, dailyChecks, installs, parts, activityLog]);

    useEffect(() => {
        if (!backupSettings.autoBackupEnabled) return;
        const lastBackup = backupSettings.lastBackup ? new Date(backupSettings.lastBackup) : null;
        const daysSince = lastBackup ? (new Date() - lastBackup) / (1000 * 60 * 60 * 24) : 999;
        if (daysSince >= backupSettings.reminderDays) {
            setTimeout(() => { downloadBackup(true); toast('Auto-backup saved to Downloads', 'info'); }, 1500);
        }
    }, []);

    useEffect(() => {
        const handler = (e) => {
            if (e.key === '/' && !e.ctrlKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault(); searchRef.current?.focus();
            }
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); toast('Data auto-saves to browser', 'info'); }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
    }, []);

    useEffect(() => { document.body.classList.toggle('light-mode', !darkMode); }, [darkMode]);

    const urgentIssues = useMemo(() => issues.filter(i => i.threat === 'Urgent' && !i.resolved).length, [issues]);
    const overdueShips = useMemo(() => ships.filter(s => getEmailStatus(s, issues).status === 'OVERDUE').length, [ships, issues]);

    const navItems = [
        { id: 0, label: 'Dashboard', icon: 'dashboard' }, { id: 1, label: 'Daily Checks', icon: 'checks' },
        { id: 2, label: 'Add Ship', icon: 'add' },
        { id: 4, label: 'Inventory', icon: 'inventory' }, { id: 5, label: 'Trips', icon: 'installs' },
        { id: 6, label: 'Parts', icon: 'parts' }, { id: 7, label: 'Email Status', icon: 'email', badge: overdueShips },
        { id: 8, label: 'Data / Import', icon: 'settings' },
        ...(isAdmin ? [{ id: 10, label: 'Suggestions', icon: 'issues', badge: suggestions.filter(s => s.status === 'new').length }] : []),
    ];
    const sections = [{ title: 'Overview', items: [0, 1] }, { title: 'Ships', items: [2] }, { title: 'Equipment', items: [4, 5, 6] }, { title: 'Comms', items: [7] }, { title: 'System', items: isAdmin ? [8, 10] : [8] }];

    return (
        <div className="app">
            <nav className="sidebar">
                <div className="sidebar-header"><div className="logo" style={{display:'flex',alignItems:'center',gap:'8px'}}><svg width="28" height="16" viewBox="0 0 120 60" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M5 42 L15 38 L105 38 L115 42 L108 45 L12 45 Z" fill="currentColor" fillOpacity="0.15"/><path d="M5 42 L15 38 L105 38 L115 42"/><path d="M15 38 L8 35 L5 42"/><path d="M105 38 L112 35 L115 42"/><path d="M18 38 L18 35 L102 35 L102 38"/><circle cx="28" cy="33" r="4"/><path d="M28 33 L28 26"/><path d="M52 35 L52 22 L72 22 L72 35"/><path d="M62 22 L62 10"/><path d="M76 35 L76 26 L88 26 L88 35"/><path d="M82 26 L82 18"/></svg>SHIP TRACKER</div><div className="logo-sub">Pro Edition</div></div>
                <div style={{padding:'16px 12px',borderBottom:'1px solid var(--border)'}}>
                    <a href="https://app.mil.powerbigov.us/groups/723e47dd-9fb2-45ba-9c59-fb38242cbc66/reports/ef93b590-8da1-4e3c-a3ef-80a577f44e1c?ctid=e3333e00-c877-4b87-b6ad-45e942de1750&pbi_source=linkShare" target="_blank" rel="noopener noreferrer" style={{display:'block',width:'100%',padding:'12px',background:'var(--green)',border:'none',borderRadius:'8px',color:'#fff',fontSize:'13px',fontWeight:700,cursor:'pointer',textAlign:'center',textDecoration:'none'}}>
                        ðŸ“Š BI Dashboard
                    </a>
                </div>
                {sections.map(s => (<div key={s.title} className="nav-section"><div className="nav-title">{s.title}</div>{s.items.map(id => { const item = navItems.find(n => n.id === id); return (<button key={id} className={`nav-btn ${page === id ? 'active' : ''}`} onClick={() => setPage(id)}><Icon name={item.icon}/><span>{item.label}</span>{item.badge > 0 && <span className="badge-count">{item.badge}</span>}</button>); })}</div>))}
                <div className="sidebar-footer">
                    <div style={{marginBottom:'8px',padding:'8px',background:'var(--bg-input)',borderRadius:'6px'}}>
                        <div style={{fontSize:'10px',color:'var(--text-muted)'}}>LOGGED IN AS</div>
                        <div style={{fontSize:'12px',fontWeight:600,display:'flex',alignItems:'center',gap:'6px'}}>
                            {currentUser?.username}
                            {isAdmin && <span style={{background:'var(--primary)',color:'#000',padding:'1px 4px',borderRadius:'3px',fontSize:'8px',fontWeight:700}}>ADMIN</span>}
                        </div>
                        {currentUser?.lastLogin?.timestamp && (
                            <div style={{fontSize:'9px',color:'var(--text-muted)',marginTop:'4px'}}>
                                Last login: {new Date(currentUser.lastLogin.timestamp).toLocaleDateString()} {new Date(currentUser.lastLogin.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
                            </div>
                        )}
                    </div>
                    {isAdmin && (
                        <button onClick={onOpenAdminPanel} style={{width:'100%',padding:'8px',marginBottom:'8px',background: pendingCount > 0 ? 'var(--amber-glow)' : 'var(--bg-input)',border: pendingCount > 0 ? '1px solid var(--amber)' : '1px solid var(--border)',borderRadius:'6px',color: pendingCount > 0 ? 'var(--amber)' : 'var(--text-dim)',fontSize:'11px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:'6px'}}>
                            ðŸ‘‘ Admin Panel {pendingCount > 0 && <span style={{background:'var(--amber)',color:'#000',padding:'1px 6px',borderRadius:'8px',fontSize:'10px',fontWeight:600}}>{pendingCount}</span>}
                        </button>
                    )}
                    <div className="sync-status" style={{fontSize:'10px',color:'var(--primary)',marginBottom:'8px',display:'flex',alignItems:'center',gap:'6px',position:'relative'}} onMouseEnter={() => setShowOnlineTooltip(true)} onMouseLeave={() => setShowOnlineTooltip(false)}>
                        <span style={{width:'8px',height:'8px',borderRadius:'50%',background:'var(--primary)',display:'inline-block',animation:'pulse 2s infinite'}}></span>
                        <span>Live Sync</span>
                        <span style={{marginLeft:'auto',background:'var(--primary-glow)',padding:'2px 6px',borderRadius:'10px',fontSize:'9px',cursor:'default'}}>ðŸ‘¤ {activeUsers.length} online</span>
                        {showOnlineTooltip && activeUsers.length > 0 && (
                            <div style={{position:'absolute',bottom:'100%',left:'0',marginBottom:'8px',background:'var(--bg-card)',border:'1px solid var(--border)',borderRadius:'8px',padding:'8px 12px',boxShadow:'0 4px 12px rgba(0,0,0,0.3)',zIndex:100,minWidth:'120px'}}>
                                <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'6px',fontWeight:600}}>Users Online</div>
                                {activeUsers.map(u => (
                                    <div key={u.username} style={{display:'flex',alignItems:'center',gap:'6px',fontSize:'11px',color:'var(--text)',marginBottom:'4px'}}>
                                        <span style={{width:'6px',height:'6px',borderRadius:'50%',background:'var(--green)'}}></span>
                                        {u.username}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <style>{`@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`}</style>
                    <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                        <div className="theme-toggle" style={{flex:1}}><button className={darkMode ? 'active' : ''} onClick={() => setDarkMode(true)}>ðŸŒ™</button><button className={!darkMode ? 'active' : ''} onClick={() => setDarkMode(false)}>â˜€ï¸</button></div>
                        <button onClick={onLogout} style={{padding:'6px 10px',background:'var(--red-glow)',border:'1px solid var(--red)',borderRadius:'6px',color:'var(--red)',fontSize:'10px',cursor:'pointer'}}>Logout</button>
                    </div>
                    <div className="version">v3.3.0 Firebase</div>
                </div>
            </nav>
            
            {(urgentIssues > 0 || overdueShips > 0) && showBanner && (
                <div className={`notif-banner ${urgentIssues > 0 ? '' : 'warning'}`}>
                    
                    {overdueShips > 0 && <span className="notif-item warning" onClick={() => setPage(7)}>ðŸ“§ {overdueShips} ship{overdueShips > 1 ? 's' : ''} overdue for contact</span>}
                    <button className="notif-close" onClick={() => setShowBanner(false)}>Ã—</button>
                </div>
            )}
            
            <main className={`main ${(urgentIssues > 0 || overdueShips > 0) && showBanner ? 'has-banner' : ''}`}>
                {isAdmin && new Date().getDay() === 5 && (
                    <div style={{background:'linear-gradient(135deg, var(--primary-glow) 0%, var(--bg-card) 100%)',border:'2px solid var(--primary)',borderRadius:'12px',padding:'16px 20px',marginBottom:'16px',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                        <div style={{display:'flex',alignItems:'center',gap:'12px'}}>
                            <span style={{fontSize:'24px'}}>ðŸ“‹</span>
                            <div>
                                <div style={{fontWeight:700,color:'var(--primary)',fontSize:'14px'}}>It's Friday!</div>
                                <div style={{color:'var(--text-dim)',fontSize:'12px'}}>Don't forget to send the weekly status report</div>
                            </div>
                        </div>
                        <button onClick={() => setPage(0)} className="btn btn-primary" style={{whiteSpace:'nowrap'}}>Go to Dashboard</button>
                    </div>
                )}
                <div style={{display:'flex',justifyContent:'flex-end',marginBottom:'16px'}}>
                    <button onClick={() => setFeedbackModal(true)} style={{padding:'10px 16px',background:'var(--primary)',border:'none',borderRadius:'8px',color:'#000',fontSize:'12px',fontWeight:600,cursor:'pointer',display:'flex',alignItems:'center',gap:'6px',boxShadow:'0 2px 8px rgba(25, 169, 116, 0.3)'}}>
                        ðŸ’¡ Suggest Improvement
                    </button>
                </div>
                {page === 0 && <Dashboard ships={ships} setShips={setShips} issues={issues} setIssues={setIssues} dailyChecks={dailyChecks} parts={parts} installs={installs} toast={toast} setPage={setPage} setEditingShip={setEditingShip} globalSearch={globalSearch} setGlobalSearch={setGlobalSearch} searchRef={searchRef} logActivity={logActivity} activityLog={activityLog}/>}
                {page === 1 && <DailyChecks ships={ships} checks={dailyChecks} setChecks={setDailyChecks} toast={toast} logActivity={logActivity}/>}
                {page === 2 && <AddShip ships={ships} setShips={setShips} toast={toast} editing={editingShip} setEditing={setEditingShip} setPage={setPage} logActivity={logActivity}/>}
                {page === 4 && <Inventory ships={ships} setShips={setShips} toast={toast} logActivity={logActivity}/>}
                {page === 5 && <Installs ships={ships} installs={installs} setInstalls={setInstalls} toast={toast} logActivity={logActivity}/>}
                {page === 6 && <Parts parts={parts} setParts={setParts} toast={toast} logActivity={logActivity}/>}
                {page === 7 && <EmailStatus ships={ships} setShips={setShips} issues={issues} toast={toast} logActivity={logActivity}/>}
                {page === 8 && <DataSettings ships={ships} setShips={setShips} issues={issues} setIssues={setIssues} dailyChecks={dailyChecks} setDailyChecks={setDailyChecks} installs={installs} setInstalls={setInstalls} parts={parts} setParts={setParts} activityLog={activityLog} setActivityLog={setActivityLog} toast={toast} backupSettings={backupSettings} setBackupSettings={setBackupSettings} downloadBackup={downloadBackup}/>}
                {page === 10 && isAdmin && <Suggestions suggestions={suggestions} setSuggestions={setSuggestions} toast={toast}/>}
            </main>
            <Toast toasts={toasts} remove={id => setToasts(t => t.filter(x => x.id !== id))}/>
            
            {/* Feedback Modal */}
            <Modal open={feedbackModal} onClose={() => setFeedbackModal(false)} title="ðŸ’¡ Suggest Improvement">
                <p style={{color:'var(--text-dim)',marginBottom:'16px',fontSize:'13px'}}>Help us improve Ship Tracker! Share your ideas, report bugs, or suggest workflow improvements.</p>
                <div className="form-group">
                    <label className="form-label">Type</label>
                    <div style={{display:'flex',gap:'8px'}}>
                        {[{v:'idea',l:'ðŸ’¡ Idea'},{v:'bug',l:'ðŸ› Bug'},{v:'workflow',l:'âš¡ Workflow'}].map(t => (
                            <button key={t.v} onClick={() => setFeedbackType(t.v)} style={{flex:1,padding:'10px',background: feedbackType === t.v ? 'var(--primary-glow)' : 'var(--bg-input)',border: `1px solid ${feedbackType === t.v ? 'var(--primary)' : 'var(--border)'}`,borderRadius:'6px',color: feedbackType === t.v ? 'var(--primary)' : 'var(--text-dim)',cursor:'pointer',fontSize:'12px'}}>{t.l}</button>
                        ))}
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">Your Suggestion</label>
                    <textarea className="form-textarea" style={{minHeight:'120px'}} placeholder="Describe your idea or issue..." value={feedbackText} onChange={e => setFeedbackText(e.target.value)}/>
                </div>
                <div style={{fontSize:'11px',color:'var(--text-muted)',marginBottom:'16px'}}>Submitting as: {currentUser?.username}</div>
                <div className="btn-group">
                    <button className="btn btn-primary" onClick={submitFeedback}>Submit Feedback</button>
                    <button className="btn btn-secondary" onClick={() => setFeedbackModal(false)}>Cancel</button>
                </div>
            </Modal>
        </div>
    );
}

function Dashboard({ ships, setShips, issues, setIssues, dailyChecks, parts, installs, toast, setPage, setEditingShip, globalSearch, setGlobalSearch, searchRef, logActivity, activityLog }) {
    const [sel, setSel] = useState(null);
    const [detailTab, setDetailTab] = useState('info');
    const [modal, setModal] = useState(false);
    const [quickIssueModal, setQuickIssueModal] = useState(false);
    const [quickIssue, setQuickIssue] = useState({ threat: 'Mild', details: '', responsibility: 'Ship' });
    const [typeFilter, setTypeFilter] = useState('all');
    const [contactModal, setContactModal] = useState(false);
    const [contactForm, setContactForm] = useState({ name: '', date: toDateString(new Date()), notes: '', waitingReply: false });
    const [activityDetailModal, setActivityDetailModal] = useState(null);
    const [showAllActivity, setShowAllActivity] = useState(false);
    const [inPortModal, setInPortModal] = useState(false);
    const [inPortDate, setInPortDate] = useState('');
    const [clearWaitingModal, setClearWaitingModal] = useState(false);
    const [clearWaitingForm, setClearWaitingForm] = useState({ reply: '', resolution: 'received' });
    const [resolveIssueModal, setResolveIssueModal] = useState(null);
    const [resolveNotes, setResolveNotes] = useState('');
    const [aiEmailModal, setAiEmailModal] = useState(false);
    const [aiEmailText, setAiEmailText] = useState('');
    const [aiParsing, setAiParsing] = useState(false);
    const [aiResult, setAiResult] = useState(null);
    const [emailHistory, setEmailHistory] = useState(() => {
        try { return JSON.parse(localStorage.getItem('emailParseHistory') || '[]'); } catch { return []; }
    });
    const [emailHistoryImported, setEmailHistoryImported] = useState(false);
    const [emailHistoryModal, setEmailHistoryModal] = useState(false);
    const [viewingHistoryItem, setViewingHistoryItem] = useState(null);
    const [clearEmailWaitingModal, setClearEmailWaitingModal] = useState(null);
    const [clearEmailWaitingForm, setClearEmailWaitingForm] = useState({ resolution: 'received', notes: '', name: '', followupEmail: '', date: '' });
    const [editEmailEntry, setEditEmailEntry] = useState(null);
    const [editEmailForm, setEditEmailForm] = useState({ date: '', time: '', summary: '', emailText: '', contactedBy: '' });
    const [manualLogModal, setManualLogModal] = useState(false);
    const [directManualModal, setDirectManualModal] = useState(false);
    const [manualLogForm, setManualLogForm] = useState({ notes: '', inPort: false, inPortUntil: '', hasIssue: false, issueThreat: 'Mild', issueDetails: '', issueResponsibility: 'Ship', waitingReply: false });
    const today = toDateString(new Date());
    
    // Auto-import existing ship emails into history on first load
    useEffect(() => {
        if (emailHistoryImported || ships.length === 0) return;
        
        const existingHistory = JSON.parse(localStorage.getItem('emailParseHistory') || '[]');
        const shipsWithEmails = ships.filter(s => s.lastSaid && s.lastContact);
        const newEntries = [];
        
        shipsWithEmails.forEach(ship => {
            // Check if this ship's last contact already has an entry
            const hasEntry = existingHistory.some(h => h.shipId === ship.id && h.timestamp === ship.lastContact);
            if (!hasEntry && ship.lastSaid.trim()) {
                newEntries.push({
                    id: genId('EH'),
                    type: 'manual',
                    shipId: ship.id,
                    shipName: ship.name,
                    timestamp: ship.lastContact,
                    emailText: ship.lastSaid,
                    result: {
                        inPort: ship.inPort || false,
                        issue: { hasIssue: false },
                        emailSummary: ship.lastSaid,
                        waitingReply: ship.waitingReply || false
                    },
                    changes: ['Imported from existing records']
                });
            }
        });
        
        if (newEntries.length > 0) {
            const combined = [...newEntries, ...existingHistory].slice(0, 100);
            setEmailHistory(combined);
            localStorage.setItem('emailParseHistory', JSON.stringify(combined));
        }
        setEmailHistoryImported(true);
    }, [ships, emailHistoryImported]);
    
    // Generate Weekly Management Report
    const generateReport = () => {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const monday = new Date(now);
        monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        
        const weekDates = [];
        for (let i = 0; i < 5; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            weekDates.push(toDateString(d));
        }
        
        const weekStart = monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const friday = new Date(monday);
        friday.setDate(monday.getDate() + 4);
        const weekEnd = friday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        // Find ships that are currently down (most recent check shows offline)
        const downShips = [];
        const partialShips = [];
        ships.forEach(ship => {
            const latestCheck = dailyChecks.filter(c => c.shipId === ship.id).sort((a,b) => b.date.localeCompare(a.date))[0];
            const shipIssues = issues.filter(i => i.shipId === ship.id && !i.resolved);
            const isInPort = ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0));
            
            if (isInPort) return; // Skip in-port ships
            
            if (latestCheck && !latestCheck.statusAM && !latestCheck.statusPM) {
                downShips.push({ ship, check: latestCheck, issues: shipIssues });
            } else if (latestCheck && (!latestCheck.statusAM || !latestCheck.statusPM)) {
                partialShips.push({ ship, check: latestCheck, issues: shipIssues });
            }
        });
        
        // All open issues grouped by ship
        const openIssues = issues.filter(i => !i.resolved).map(i => ({
            ...i,
            shipName: ships.find(s => s.id === i.shipId)?.name || 'Unknown'
        }));
        const urgentIssues = openIssues.filter(i => i.threat === 'Urgent');
        const mildIssues = openIssues.filter(i => i.threat === 'Mild');
        
        // Ships waiting on reply
        const waitingShips = ships.filter(s => s.waitingReply);
        
        // Ships in port
        const inPortShips = ships.filter(s => s.inPort && parseLocalDate(s.inPortUntil) >= new Date(new Date().setHours(0,0,0,0)));
        
        // Build report
        let report = '';
        const dateRange = `${weekStart} - ${weekEnd}`;
        const headerTitle = 'REAP WEEKLY STATUS REPORT';
        const headerW = Math.max(headerTitle.length, dateRange.length) + 4;
        report += `\n`;
        report += `  ${'â•'.repeat(headerW)}\n`;
        report += `  ${' '.repeat(Math.floor((headerW - headerTitle.length) / 2))}${headerTitle}\n`;
        report += `  ${' '.repeat(Math.floor((headerW - dateRange.length) / 2))}${dateRange}\n`;
        report += `  ${'â•'.repeat(headerW)}\n\n`;
        
        // SHIPS DOWN
        if (downShips.length > 0) {
            report += `  ðŸ”´ SHIPS DOWN (${downShips.length})\n`;
            report += `  ${'â”€'.repeat(40)}\n`;
            downShips.forEach(({ ship, check, issues: si }) => {
                report += `\n  ${ship.name} (${ship.type})\n`;
                report += `    Last checked: ${fmtDate(check.date)}\n`;
                if (ship.lastContact) report += `    Last contact: ${fmtDate(ship.lastContact)}${ship.contactedBy ? ` by ${ship.contactedBy}` : ''}\n`;
                if (si.length > 0) {
                    si.forEach(issue => {
                        const label = issue.threat === 'Urgent' ? 'ðŸš¨ URGENT' : 'âš ï¸  MILD';
                        report += `    ${label}: ${issue.details}\n`;
                        if (issue.responsibility) report += `      Responsibility: ${issue.responsibility === 'REAP' ? 'REAP (Us)' : 'Ship (Them)'}\n`;
                    });
                } else {
                    report += `    No issues logged\n`;
                }
            });
            report += `\n`;
        }
        
        // SHIPS PARTIAL
        if (partialShips.length > 0) {
            report += `  ðŸŸ¡ SHIPS PARTIAL (${partialShips.length})\n`;
            report += `  ${'â”€'.repeat(40)}\n`;
            partialShips.forEach(({ ship, check, issues: si }) => {
                const status = check.statusAM && !check.statusPM ? 'AM up / PM down' : 'AM down / PM up';
                report += `\n  ${ship.name} (${ship.type}) - ${status}\n`;
                report += `    Last checked: ${fmtDate(check.date)}\n`;
                if (si.length > 0) {
                    si.forEach(issue => {
                        const label = issue.threat === 'Urgent' ? 'ðŸš¨ URGENT' : 'âš ï¸  MILD';
                        report += `    ${label}: ${issue.details}\n`;
                    });
                }
            });
            report += `\n`;
        }
        
        // OPEN ISSUES (for ships that are online but have issues)
        const onlineShipIssues = openIssues.filter(oi => {
            const isDown = downShips.some(d => d.ship.id === oi.shipId);
            const isPartial = partialShips.some(p => p.ship.id === oi.shipId);
            return !isDown && !isPartial;
        });
        if (onlineShipIssues.length > 0) {
            report += `  âš ï¸  OPEN ISSUES ON ONLINE SHIPS (${onlineShipIssues.length})\n`;
            report += `  ${'â”€'.repeat(40)}\n`;
            // Group by ship
            const grouped = {};
            onlineShipIssues.forEach(i => {
                if (!grouped[i.shipName]) grouped[i.shipName] = [];
                grouped[i.shipName].push(i);
            });
            Object.entries(grouped).forEach(([shipName, iss]) => {
                report += `\n  ${shipName}\n`;
                iss.forEach(i => {
                    const label = i.threat === 'Urgent' ? 'ðŸš¨' : 'âš ï¸';
                    report += `    ${label} [${i.threat}] ${i.details}\n`;
                    if (i.responsibility) report += `      Responsibility: ${i.responsibility === 'REAP' ? 'REAP (Us)' : 'Ship (Them)'}\n`;
                });
            });
            report += `\n`;
        }
        
        // WAITING ON REPLY
        if (waitingShips.length > 0) {
            report += `  â³ WAITING ON REPLY (${waitingShips.length})\n`;
            report += `  ${'â”€'.repeat(40)}\n`;
            waitingShips.forEach(s => {
                const days = s.lastContact ? Math.floor((new Date() - parseLocalDate(s.lastContact)) / (1000*60*60*24)) : 0;
                report += `  ${s.name.padEnd(8)} - ${days}d since last contact`;
                if (s.contactedBy) report += ` (${s.contactedBy})`;
                report += `\n`;
            });
            report += `\n`;
        }
        
        // IN PORT
        if (inPortShips.length > 0) {
            report += `  âš“ IN PORT (${inPortShips.length})\n`;
            report += `  ${'â”€'.repeat(40)}\n`;
            inPortShips.forEach(s => {
                report += `  ${s.name.padEnd(8)} - Back: ${fmtDate(s.inPortUntil)}\n`;
            });
            report += `\n`;
        }
        
        // NO ISSUES
        if (downShips.length === 0 && partialShips.length === 0 && openIssues.length === 0) {
            report += `  âœ… All ships operational. No open issues.\n\n`;
        }
        
        // Footer
        const genDate = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const genTime = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const footer = `Generated: ${genDate} ${genTime}`;
        report += `  ${'â•'.repeat(footer.length + 2)}\n`;
        report += `  ${footer}\n`;
        report += `  ${'â•'.repeat(footer.length + 2)}\n\n`;
        
        return report;
    };
    
    const copyReport = () => {
        const report = generateReport();
        navigator.clipboard.writeText(report);
        logActivity('Copied weekly report to clipboard');
        toast('Report copied to clipboard!', 'success');
    };
    
    const downloadReport = () => {
        const report = generateReport();
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const weekNum = Math.ceil((new Date().getDate()) / 7);
        a.download = `REAP_Weekly_Report_Week${weekNum}_${toDateString(new Date())}.txt`;
        a.click();
        logActivity('Downloaded weekly report');
        toast('Report downloaded!', 'success');
    };

    // Power BI Export
    const exportPowerBI = () => {
        const esc = (s) => {
            if (s === null || s === undefined || s === '') return '';
            const str = String(s).replace(/"/g, '""');
            return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
        };
        const fmtD = (d) => d ? new Date(d).toLocaleDateString('en-US') : '';
        const getStatus = (ship) => {
            const latest = dailyChecks.filter(c => c.shipId === ship.id).sort((a,b) => b.date.localeCompare(a.date))[0];
            if (!latest) return 'Offline';
            if (latest.statusAM || latest.statusPM) return 'Up';
            return 'Offline';
        };
        const headers = ['ShipHull#','ShipType','Location','Status','Priority','IssueTitle','IssueCategory','IssueDetails','IssueOpenedDate','DateResolved','LastResponseDate','LastShipResponse','ResolutionSummary','Notes','AssignedTo'];
        let rows = [headers.join(',')];
        
        // Sort ships to match Power BI Excel order
        const pbiOrder = [67, 70, 54, 56, 62, 63, 55, 57, 72, 96, 98, 101, 103, 109, 111];
        const hn = (name) => parseInt(name.replace(/\D/g, '')) || 0;
        const sortedShips = [...ships].sort((a, b) => {
            const ai = pbiOrder.indexOf(hn(a.name)), bi = pbiOrder.indexOf(hn(b.name));
            if (ai !== -1 && bi !== -1) return ai - bi;
            if (ai !== -1) return -1;
            if (bi !== -1) return 1;
            return hn(a.name) - hn(b.name);
        });
        
        // Build a concise status summary for LastShipResponse
        const buildSummary = (ship, status, openIssue, allOpen) => {
            const parts = [];
            const isInPort = ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0));
            if (isInPort) parts.push(`In port until ${fmtD(ship.inPortUntil)}`);
            if (openIssue) {
                const prefix = openIssue.threat === 'Urgent' ? 'URGENT: ' : '';
                parts.push(`${prefix}${openIssue.title || openIssue.details}`.substring(0, 80));
                if (allOpen.length > 1) parts.push(`+${allOpen.length - 1} more issue${allOpen.length > 2 ? 's' : ''}`);
            }
            if (ship.waitingReply) parts.push('Awaiting ship reply');
            if (parts.length === 0) {
                if (status === 'Up') return 'Up - No issues';
                if (status === 'Offline') return 'Offline - No contact';
                return status;
            }
            return parts.join(' | ');
        };
        
        ships.forEach(ship => {
            const status = getStatus(ship);
            const openIssues = issues.filter(i => i.shipId === ship.id && !i.resolved).sort((a,b) => new Date(b.created) - new Date(a.created));
            const resolvedIssues = issues.filter(i => i.shipId === ship.id && i.resolved).sort((a,b) => new Date(b.resolvedDate || b.created) - new Date(a.resolvedDate || a.created));
            const open = openIssues[0] || null;
            const resolved = resolvedIssues[0] || null;
            const summary = buildSummary(ship, status, open, openIssues);
            
            if (open) {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    open.threat||'', esc(open.title||''), esc(open.category||''), esc(open.details||''),
                    fmtD(open.created),
                    '',
                    fmtD(ship.lastContact), esc(summary),
                    '',
                    esc(ship.notes||''),
                    open.responsibility||'Ship'
                ].join(','));
            } else if (resolved) {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    '', '', '', '',
                    '',
                    fmtD(resolved.resolvedDate),
                    fmtD(ship.lastContact), esc(summary),
                    esc(resolved.resolveNotes||''),
                    esc(ship.notes||''),
                    ''
                ].join(','));
            } else {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    '', '', '', '',
                    '',
                    '',
                    fmtD(ship.lastContact), esc(summary),
                    '',
                    esc(ship.notes||''),
                    ''
                ].join(','));
            }
        });
        const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `PowerBI_REAP_Export_${toDateString(new Date())}.csv`;
        a.click();
        logActivity('Exported Power BI data', { rows: rows.length - 1 });
        toast(`Power BI export downloaded! (${rows.length - 1} rows)`, 'success');
    };
    
    // Stats calculations
    const stats = useMemo(() => ({ 
        urgent: issues.filter(i => i.threat === 'Urgent' && !i.resolved).length, 
        due: ships.filter(s => s.nextCheck && new Date(s.nextCheck) <= new Date(Date.now() + 7*86400000)).length, 
        total: ships.length, 
        missing: ships.filter(s => !s.ciscoRouter || !s.hdd || (!s.crna1 && !s.crna2)).length 
    }), [ships, issues]);
    
    // Chart data calculations
    const chartData = useMemo(() => {
        // Online/Offline from today's daily checks
        const todayChecks = dailyChecks.filter(c => c.date === today);
        let online = 0, offline = 0, noData = 0;
        ships.forEach(ship => {
            const check = todayChecks.find(c => c.shipId === ship.id);
            if (!check) noData++;
            else if (check.statusAM && check.statusPM) online++;
            else offline++;
        });
        
        // Issue severity
        const openIssues = issues.filter(i => !i.resolved);
        const urgentCount = openIssues.filter(i => i.threat === 'Urgent').length;
        const mildCount = openIssues.filter(i => i.threat === 'Mild').length;
        const noIssueCount = ships.length - new Set(openIssues.map(i => i.shipId)).size;
        
        // Email status
        let emailOk = 0, emailDue = 0, emailOverdue = 0, emailWaiting = 0, emailInPort = 0;
        ships.forEach(s => {
            if (s.waitingReply) { emailWaiting++; return; }
            const es = getEmailStatus(s, issues);
            if (es.status === 'IN PORT') emailInPort++;
            else if (es.status === 'OK') emailOk++;
            else if (es.status === 'DUE') emailDue++;
            else if (es.status === 'OVERDUE') emailOverdue++;
        });
        
        // Ship types
        const fullReap = ships.filter(s => s.type === 'Full REAP').length;
        const miniReap = ships.filter(s => s.type === 'Mini REAP').length;
        
        // Documentation completeness
        const complete = ships.filter(s => s.ciscoRouter && s.hdd && (s.crna1 || s.crna2)).length;
        const incomplete = ships.length - complete;
        
        return { 
            online, offline, noData,
            urgentCount, mildCount, noIssueCount,
            emailOk, emailDue, emailOverdue, emailWaiting, emailInPort,
            fullReap, miniReap,
            complete, incomplete
        };
    }, [ships, issues, dailyChecks, today]);
    
    const sorted = useMemo(() => {
        let result = [...ships];
        if (globalSearch) {
            const search = globalSearch.toLowerCase();
            result = result.filter(s => s.name.toLowerCase().includes(search) || s.type.toLowerCase().includes(search) || s.location?.toLowerCase().includes(search) || s.tags?.some(t => t.toLowerCase().includes(search)));
        }
        if (typeFilter === 'updated') {
            result = result.filter(s => s.lastContact && fmtDateInput(s.lastContact) === today);
        } else if (typeFilter !== 'all') {
            result = result.filter(s => s.type === typeFilter);
        }
        return result.sort((a, b) => {
            const ai = issues.filter(i => i.shipId === a.id && !i.resolved), bi = issues.filter(i => i.shipId === b.id && !i.resolved);
            const au = ai.some(i => i.threat === 'Urgent') ? 2 : ai.some(i => i.threat === 'Mild') ? 1 : 0;
            const bu = bi.some(i => i.threat === 'Urgent') ? 2 : bi.some(i => i.threat === 'Mild') ? 1 : 0;
            if (bu !== au) return bu - au;
            const ae = getEmailStatus(a, issues), be = getEmailStatus(b, issues);
            if (be.days !== ae.days) return be.days - ae.days;
            return hullNum(a.name) - hullNum(b.name);
        });
    }, [ships, issues, globalSearch, typeFilter, today]);
    
    const selIssues = useMemo(() => sel ? issues.filter(i => i.shipId === sel.id && !i.resolved) : [], [sel, issues]);
    
    const getSparklineData = (shipId) => {
        const last7 = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dateStr = toDateString(d);
            const check = dailyChecks.find(c => c.shipId === shipId && c.date === dateStr);
            last7.push(check ? parseInt(check.pingAM) || 0 : 0);
        }
        return last7;
    };
    
    const save = () => { if (!sel) return; setShips(p => p.map(s => s.id === sel.id ? sel : s)); logActivity(`Updated ship ${sel.name}`, { ship: sel.name, location: sel.location, notes: sel.notes }); toast('Ship saved!', 'success'); };
    const del = () => { if (!sel || !confirm(`Delete ${sel.name}?`)) return; setShips(p => p.filter(s => s.id !== sel.id)); setIssues(p => p.filter(i => i.shipId !== sel.id)); logActivity(`Deleted ship ${sel.name}`); setSel(null); toast('Ship deleted', 'info'); };
    const edit = () => { if (!sel) return; setEditingShip(sel); setPage(2); };
    
    const openContactModal = () => {
        if (!sel) return;
        setContactForm({ name: '', date: toDateString(new Date()), notes: '', waitingReply: sel.waitingReply || false });
        setContactModal(true);
    };
    
    const submitContact = () => {
        if (!sel || !contactForm.name.trim()) { toast('Enter your name', 'error'); return; }
        // Use local noon to avoid UTC timezone shift issues
        const contactDate = contactForm.date + 'T12:00:00';
        const updatedShip = { ...sel, lastContact: contactDate, contactedBy: contactForm.name, lastSaid: contactForm.notes || sel.lastSaid, waitingReply: contactForm.waitingReply };
        setSel(updatedShip);
        setShips(p => p.map(s => s.id === sel.id ? updatedShip : s));
        
        // Add to email history
        const historyEntry = {
            id: genId('EH'),
            type: 'manual',
            shipId: sel.id,
            shipName: sel.name,
            timestamp: contactDate,
            emailText: contactForm.notes || 'Marked as contacted',
            result: {
                inPort: false,
                issue: { hasIssue: false },
                emailSummary: contactForm.notes || `Contacted by ${contactForm.name}`,
                waitingReply: contactForm.waitingReply
            },
            changes: [contactForm.waitingReply ? 'Waiting on reply' : 'Marked as contacted', `By: ${contactForm.name}`]
        };
        const newHistory = [historyEntry, ...emailHistory].slice(0, 100);
        setEmailHistory(newHistory);
        localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));
        
        logActivity(`${contactForm.name} marked ${sel.name} as ${contactForm.waitingReply ? 'waiting on reply' : 'contacted'} on ${fmtDate(contactDate)}`, { ship: sel.name, contactedBy: contactForm.name, notes: contactForm.notes, waitingReply: contactForm.waitingReply });
        toast(`${sel.name} marked as ${contactForm.waitingReply ? 'waiting on reply' : 'contacted'}`, 'success');
        setContactModal(false);
    };
    
    const addQuickIssue = () => {
        if (!sel || !quickIssue.details.trim()) { toast('Enter issue details', 'error'); return; }
        setIssues(p => [...p, { id: genId('I'), shipId: sel.id, shipName: sel.name, ...quickIssue, created: new Date().toISOString(), resolved: false }]);
        logActivity(`Added ${quickIssue.threat} issue to ${sel.name}`, { ship: sel.name, threat: quickIssue.threat, details: quickIssue.details });
        setQuickIssue({ threat: 'Mild', details: '', responsibility: 'Ship' });
        setQuickIssueModal(false);
        toast('Issue added!', 'success');
    };
    
    // Redact PII from email before sending to AI
    const redactPII = (text) => {
        let redacted = text;
        // Email addresses
        redacted = redacted.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, '[EMAIL]');
        // Phone numbers (various formats including DSN)
        redacted = redacted.replace(/(\+?1[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}/g, '[PHONE]');
        redacted = redacted.replace(/DSN[:\s]*\d{3}[-.\s]?\d{4}/gi, '[DSN PHONE]');
        // SSN
        redacted = redacted.replace(/\b\d{3}[-.\s]?\d{2}[-.\s]?\d{4}\b/g, '[SSN]');
        // IP addresses
        redacted = redacted.replace(/\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/g, '[IP]');
        // Credit card numbers
        redacted = redacted.replace(/\b\d{4}[-.\s]?\d{4}[-.\s]?\d{4}[-.\s]?\d{4}\b/g, '[CC]');
        // Military ID / DoD ID / EDIPI numbers (10 digits)
        redacted = redacted.replace(/\b\d{10}\b/g, '[ID]');
        // Serial numbers (common formats)
        redacted = redacted.replace(/\b[A-Z]{2,3}\d{6,12}[A-Z]?\b/g, '[SERIAL]');
        // Names after common titles
        redacted = redacted.replace(/(Mr\.|Mrs\.|Ms\.|Dr\.|Chief|Capt\.|Captain|Lt\.|Lieutenant|Commander|CDR|LCDR|LT|ENS|PO1|PO2|PO3|IT1|IT2|IT3|FC1|FC2|FC3|ET1|ET2|ET3|OS1|OS2|OS3|BM1|BM2|BM3|GM1|GM2|GM3|QM1|QM2|QM3|YN1|YN2|YN3|LS1|LS2|LS3|CS1|CS2|CS3|MA1|MA2|MA3|HM1|HM2|HM3|RP1|RP2|RP3|PS1|PS2|PS3|CTRN|CTI|CTM|CTN|CTR|CTT|USN|USNR)\s+[A-Z][a-zA-Z'-]+(\s+[A-Z][a-zA-Z'-]+)?(\s+[A-Z][a-zA-Z'-]+)?/g, '$1 [NAME]');
        // "From:", "To:", "Cc:" lines with names/emails
        redacted = redacted.replace(/(From|To|Cc|Bcc|Sent by|Reply to):\s*[^\n<]+/gi, '$1: [REDACTED]');
        // Signatures (common patterns)
        redacted = redacted.replace(/V\/[rR],?\s*\n?[A-Z][a-zA-Z'-]+(\s+[A-Z][a-zA-Z'-]+)?(\s+[A-Z][a-zA-Z'-]+)?/g, 'V/R, [NAME]');
        redacted = redacted.replace(/(Regards|Thanks|Best|Sincerely|Respectfully),?\s*\n?[A-Z][a-zA-Z'-]+(\s+[A-Z][a-zA-Z'-]+)?/gi, '$1, [NAME]');
        // Name, Rank patterns (Last, First RANK)
        redacted = redacted.replace(/[A-Z][a-zA-Z'-]+,\s*[A-Z][a-zA-Z'-]+(\s+[A-Z]{2,4}\d?\s+USN)?/g, '[NAME]');
        // Classification markings - keep but note
        redacted = redacted.replace(/(UNCLASSIFIED|CLASSIFIED|SECRET|TOP SECRET|FOUO|CUI|NOFORN|REL TO)/gi, '[$1]');
        // MAC addresses
        redacted = redacted.replace(/([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})/g, '[MAC]');
        // Hostnames/server names
        redacted = redacted.replace(/\b[a-zA-Z]+-[a-zA-Z0-9]+-[a-zA-Z0-9]+\.[a-z]+\.[a-z]+\b/g, '[HOSTNAME]');
        return redacted;
    };
    
    const parseEmailWithAI = async () => {
        if (!sel) { toast('Select a ship first', 'error'); return; }
        if (!aiEmailText.trim()) { toast('Paste email content first', 'error'); return; }

        setAiParsing(true);
        setAiResult(null);

        const text = aiEmailText;
        const textLower = text.toLowerCase();

        // Initialize comprehensive result object
        const result = {
            inPort: null,
            inPortDays: null,
            inPortUntil: null,
            issue: { hasIssue: false, threat: null, details: null, category: null, title: null },
            emailSummary: '',
            waitingReply: false,
            confidence: 'medium',
            // New fields
            sender: { name: null, email: null, phone: null, title: null },
            subject: null,
            shipMentions: [],
            equipment: [],
            status: null, // underway, in-port, maintenance, CNO, CMAV, etc.
            timeline: [],
            actionItems: [],
            classification: null,
            tone: 'neutral', // urgent, concerned, routine, positive
            isResponse: false,
            isFYI: false,
            extractedDates: [],
            keywords: []
        };

        // ===== SENDER EXTRACTION =====
        // From header
        const fromMatch = text.match(/^From:\s*(.+?)(?:\n|$)/im);
        if (fromMatch) {
            const fromLine = fromMatch[1];
            const emailMatch = fromLine.match(/[\w.-]+@[\w.-]+\.\w+/);
            const nameMatch = fromLine.match(/^([^<@]+)/);
            if (emailMatch) result.sender.email = emailMatch[0];
            if (nameMatch) result.sender.name = nameMatch[1].replace(/['"]/g, '').trim();
        }

        // Try signature block for contact info
        const sigPatterns = [
            /(?:v\/r|very respectfully|regards|thanks|best)[,\s]*\n+([A-Z][a-z]+(?:\s+[A-Z]\.?\s*)?[A-Z][a-z]+)/i,
            /(?:â€”|--|___)\s*\n+([A-Z][a-z]+\s+[A-Z][a-z]+)/,
        ];
        for (const pat of sigPatterns) {
            const match = text.match(pat);
            if (match && !result.sender.name) {
                result.sender.name = match[1].trim();
                break;
            }
        }

        // Phone number extraction
        const phoneMatch = text.match(/(?:phone|cell|mobile|tel|c:|o:)?\s*[\(]?(\d{3})[\)\s.-]*(\d{3})[\s.-]*(\d{4})/i);
        if (phoneMatch) result.sender.phone = `(${phoneMatch[1]}) ${phoneMatch[2]}-${phoneMatch[3]}`;

        // Title/rank extraction
        const rankMatch = text.match(/\b(IT[123C]|ET[123C]|FC[123C]|OS[123C]|CTT[123C]|CTR[123C]|CTM[123C]|STG[123C]|LCDR|CDR|CAPT|LT|LTJG|ENS|CWO[2-5]|WO1|CMDCM|FORCM|FLTCM|MCPO|SCPO|CPO|PO[123]|SN|SA|SR)\b/i);
        if (rankMatch) result.sender.title = rankMatch[1].toUpperCase();

        // ===== SUBJECT EXTRACTION =====
        const subjectMatch = text.match(/^Subject:\s*(.+?)(?:\n|$)/im);
        if (subjectMatch) result.subject = subjectMatch[1].trim();

        // ===== CLASSIFICATION DETECTION =====
        const classPatterns = /\b(UNCLASSIFIED|FOUO|CUI|CONFIDENTIAL|SECRET|TOP SECRET|NOFORN|REL TO)\b/i;
        const classMatch = text.match(classPatterns);
        if (classMatch) result.classification = classMatch[1].toUpperCase();

        // ===== SHIP MENTIONS =====
        const shipPatterns = /\b((?:USS\s+)?(?:DDG|CG|CVN|LCS|LPD|LHA|LHD|FFG|MCM|PC|AS|ARS|ATF|LCAC)[\s-]?\d{1,3})\b/gi;
        const shipMatches = text.match(shipPatterns);
        if (shipMatches) result.shipMentions = [...new Set(shipMatches.map(s => s.toUpperCase().replace(/\s+/g, '')))];

        // ===== EQUIPMENT DETECTION =====
        const equipmentPatterns = {
            'REAP System': /\b(reap|reap pc|reap system|reap star|reap data)\b/i,
            'STAR Terminal': /\b(star terminal|star system|star pc)\b/i,
            'DATA Terminal': /\b(data terminal|data system|data pc)\b/i,
            'SHF/EHF': /\b(shf|ehf|shf\/ehf|satcom)\b/i,
            'SIPR': /\b(sipr|siprnet|secret network)\b/i,
            'NIPR': /\b(nipr|niprnet|unclass network)\b/i,
            'Router': /\b(router|cisco|taclane|kg-\d+)\b/i,
            'LTO/Tape': /\b(lto|tape drive|tape reader|backup)\b/i,
            'Network': /\b(network|lan|wan|ethernet|switch)\b/i,
            'Power Supply': /\b(power supply|psu|ups|power issue)\b/i,
            'Hard Drive': /\b(hard drive|hdd|ssd|disk|storage)\b/i,
            'Monitor': /\b(monitor|display|screen)\b/i,
        };
        for (const [name, pattern] of Object.entries(equipmentPatterns)) {
            if (pattern.test(text)) result.equipment.push(name);
        }

        // ===== STATUS DETECTION =====
        const statusPatterns = {
            'underway': /\b(underway|at sea|deployed|out to sea|sailing|transit)\b/i,
            'in-port': /\b(in port|inport|pier ?side|moored|homeport|returned to port)\b/i,
            'maintenance': /\b(maintenance|maintenance period|sra|pma|cmav|dpia|selected restricted availability)\b/i,
            'CNO': /\b(cno|chief of naval operations availability|cno availability)\b/i,
            'dry-dock': /\b(dry ?dock|drydock)\b/i,
            'returning': /\b(return(?:ing)?|coming back|heading back|inbound)\b/i,
            'deploying': /\b(deploy(?:ing)?|heading out|getting underway)\b/i,
        };
        for (const [status, pattern] of Object.entries(statusPatterns)) {
            if (pattern.test(text)) {
                result.status = status;
                if (['in-port', 'maintenance', 'CNO', 'dry-dock'].includes(status)) {
                    result.inPort = true;
                }
                break;
            }
        }

        // ===== ADVANCED DATE PARSING =====
        const months = {january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11,jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};

        const datePatterns = [
            // MM/DD/YYYY or MM-DD-YYYY
            { regex: /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/g, parse: m => new Date(parseInt(m[3]), parseInt(m[1])-1, parseInt(m[2])) },
            // Month DD, YYYY
            { regex: /(\w+)\s+(\d{1,2})(?:st|nd|rd|th)?,?\s*(\d{4})/gi, parse: m => { const mo = months[m[1].toLowerCase()]; return mo !== undefined ? new Date(parseInt(m[3]), mo, parseInt(m[2])) : null; }},
            // DD Month YYYY
            { regex: /(\d{1,2})(?:st|nd|rd|th)?\s+(\w+),?\s*(\d{4})/gi, parse: m => { const mo = months[m[2].toLowerCase()]; return mo !== undefined ? new Date(parseInt(m[3]), mo, parseInt(m[1])) : null; }},
            // Month DD (assume current/next year)
            { regex: /(\w+)\s+(\d{1,2})(?:st|nd|rd|th)?(?!\d)/gi, parse: m => { const mo = months[m[1].toLowerCase()]; if (mo === undefined) return null; const yr = new Date().getFullYear(); const d = new Date(yr, mo, parseInt(m[2])); return d < new Date() ? new Date(yr+1, mo, parseInt(m[2])) : d; }},
        ];

        const extractedDates = [];
        for (const {regex, parse} of datePatterns) {
            let match;
            const re = new RegExp(regex.source, regex.flags);
            while ((match = re.exec(text)) !== null) {
                const date = parse(match);
                if (date && !isNaN(date.getTime())) {
                    const context = text.substring(Math.max(0, match.index - 50), match.index + match[0].length + 50);
                    extractedDates.push({ date: toDateString(date), context: context.trim(), isReturn: /return|back|until|through|end/i.test(context) });
                }
            }
        }
        result.extractedDates = extractedDates;

        // Find the most likely return/end date
        const returnDate = extractedDates.find(d => d.isReturn);
        if (returnDate) {
            result.inPortUntil = returnDate.date;
            result.inPort = true;
        }

        // Duration extraction
        const durationPatterns = [
            /(?:for|approximately|about|around|roughly)\s*(\d+)\s*(day|week|month)s?/i,
            /(\d+)\s*(day|week|month)s?\s*(?:of|for)?\s*(?:maintenance|availability|port)/i,
        ];
        for (const pattern of durationPatterns) {
            const match = text.match(pattern);
            if (match) {
                let days = parseInt(match[1]);
                const unit = match[2].toLowerCase();
                if (unit === 'week') days *= 7;
                if (unit === 'month') days *= 30;
                result.inPortDays = days;
                result.inPort = true;
                break;
            }
        }

        // ===== ISSUE DETECTION & CATEGORIZATION =====
        const issueCategories = {
            'Network/Connectivity': /\b(network|connection|connectivity|disconnect|drops|dropping|intermittent|latency|bandwidth|timeout|unreachable|no comms)\b/i,
            'Hardware Failure': /\b(hardware|failed|failure|broken|damaged|burnt|dead|replacement|swap|rma)\b/i,
            'Software/System': /\b(software|system|crash|freeze|frozen|reboot|restart|error|bug|update|patch)\b/i,
            'Power Issue': /\b(power|outage|ups|surge|electrical|no power|power supply)\b/i,
            'Configuration': /\b(config|configuration|settings|misconfigured|setup)\b/i,
            'Maintenance Required': /\b(maintenance|pm|preventive|scheduled|routine)\b/i,
            'Security': /\b(security|virus|malware|unauthorized|breach|certificate|crypto)\b/i,
        };

        const issueIndicators = /\b(issue|problem|error|fail|not working|broken|down|malfunction|dropping|intermittent|unable|cannot|can't|won't|doesn't work|offline|outage|degraded|impact|trouble)\b/i;
        const urgentIndicators = /\b(urgent|critical|emergency|severe|major|asap|immediately|priority|mission[- ]?(?:critical|essential|impact)|completely (?:down|offline)|total failure|no (?:connection|comms|connectivity)|degraded operations)\b/i;
        const mildIndicators = /\b(minor|slight|occasional|sometimes|intermittent|when possible|low priority|fyi|non[- ]?urgent)\b/i;

        if (issueIndicators.test(text)) {
            result.issue.hasIssue = true;

            // Determine threat level
            if (urgentIndicators.test(text)) {
                result.issue.threat = 'Urgent';
                result.tone = 'urgent';
            } else if (mildIndicators.test(text)) {
                result.issue.threat = 'Mild';
            } else {
                result.issue.threat = 'Mild';
            }

            // Categorize issue
            for (const [category, pattern] of Object.entries(issueCategories)) {
                if (pattern.test(text)) {
                    result.issue.category = category;
                    break;
                }
            }

            // Extract issue title (short description)
            const sentences = text.split(/[.!?\n]+/).filter(s => s.trim().length > 10);
            const issueSentences = sentences.filter(s => issueIndicators.test(s));
            if (issueSentences.length > 0) {
                // Get the most relevant sentence
                let bestSentence = issueSentences[0];
                for (const s of issueSentences) {
                    if (result.equipment.some(eq => s.toLowerCase().includes(eq.toLowerCase().split(' ')[0]))) {
                        bestSentence = s;
                        break;
                    }
                }
                result.issue.details = bestSentence.trim().substring(0, 150);
                // Generate short title
                const words = bestSentence.trim().split(/\s+/).slice(0, 6);
                result.issue.title = words.join(' ').substring(0, 50) + (words.length > 6 ? '...' : '');
            }
        }

        // ===== ACTION ITEMS EXTRACTION =====
        const actionPatterns = [
            /(?:please|kindly|can you|could you|need you to|requesting|request that you)\s+([^.!?\n]{10,80})/gi,
            /(?:action required|todo|task|need to)\s*:?\s*([^.!?\n]{10,80})/gi,
        ];
        for (const pattern of actionPatterns) {
            let match;
            while ((match = pattern.exec(text)) !== null) {
                result.actionItems.push(match[1].trim());
            }
        }

        // ===== WAITING FOR REPLY DETECTION =====
        const replyPatterns = /\b(please (?:advise|respond|confirm|let me know|reply)|awaiting (?:your|a) (?:response|reply)|any (?:guidance|thoughts|updates)|can you (?:confirm|check|verify)|need (?:your |a )?(?:response|answer|input)|what should (?:we|i)|how (?:should|do) (?:we|i)|is there (?:anything|something)|when can (?:we|you)|requesting (?:guidance|assistance|support))\b/i;
        const questionCount = (text.match(/\?/g) || []).length;

        if (replyPatterns.test(text) || questionCount >= 2) {
            result.waitingReply = true;
        }

        // Detect FYI only (no response needed)
        const fyiPatterns = /\b(fyi|for your (?:information|awareness|records)|no (?:response|action|reply) (?:needed|required|necessary)|just (?:a )?heads up|informational only)\b/i;
        if (fyiPatterns.test(text)) {
            result.isFYI = true;
            result.waitingReply = false;
        }

        // ===== TONE ANALYSIS =====
        if (!result.tone || result.tone === 'neutral') {
            const concernedPatterns = /\b(concerned|worried|issue|problem|trouble|unfortunately|regret|apologize)\b/i;
            const positivePatterns = /\b(resolved|fixed|working|operational|back online|good news|successful|completed)\b/i;
            const routinePatterns = /\b(update|status|routine|scheduled|planned|weekly|daily)\b/i;

            if (urgentIndicators.test(text)) result.tone = 'urgent';
            else if (concernedPatterns.test(text)) result.tone = 'concerned';
            else if (positivePatterns.test(text)) result.tone = 'positive';
            else if (routinePatterns.test(text)) result.tone = 'routine';
        }

        // ===== KEYWORD EXTRACTION =====
        const keywordPatterns = /\b(CASREP|OPREP|LOGREQ|TYCOM|ISIC|NCTAMS|SPAWAR|PMS|COMMS|SATCOM|IBS|WSC-6|USC-38|AN\/[A-Z]{3}-\d+)\b/gi;
        const keywordMatches = text.match(keywordPatterns);
        if (keywordMatches) result.keywords = [...new Set(keywordMatches.map(k => k.toUpperCase()))];

        // ===== GENERATE SMART SUMMARY =====
        const summaryParts = [];

        // Status
        if (result.status) {
            const statusLabels = { 'underway': 'Ship is underway', 'in-port': 'Ship is in port', 'maintenance': 'In maintenance period', 'CNO': 'In CNO availability', 'dry-dock': 'In dry dock', 'returning': 'Returning to port', 'deploying': 'Deploying' };
            let statusText = statusLabels[result.status] || result.status;
            if (result.inPortUntil) statusText += ` until ${result.inPortUntil}`;
            else if (result.inPortDays) statusText += ` for ${result.inPortDays} days`;
            summaryParts.push(statusText);
        } else if (result.inPort) {
            let portText = 'Ship entering port';
            if (result.inPortUntil) portText += ` until ${result.inPortUntil}`;
            else if (result.inPortDays) portText += ` for ${result.inPortDays} days`;
            summaryParts.push(portText);
        }

        // Issue
        if (result.issue.hasIssue) {
            let issueText = result.issue.threat === 'Urgent' ? 'âš ï¸ URGENT: ' : '';
            if (result.issue.category) issueText += `${result.issue.category} - `;
            issueText += result.issue.title || result.issue.details?.substring(0, 50) || 'Issue reported';
            if (result.equipment.length > 0) issueText += ` (${result.equipment.slice(0, 2).join(', ')})`;
            summaryParts.push(issueText);
        }

        // Equipment mentioned (if no issue)
        if (!result.issue.hasIssue && result.equipment.length > 0) {
            summaryParts.push(`Re: ${result.equipment.slice(0, 3).join(', ')}`);
        }

        // Action/Response needed
        if (result.waitingReply) summaryParts.push('Response requested');
        if (result.isFYI) summaryParts.push('FYI only');
        if (result.actionItems.length > 0) summaryParts.push(`${result.actionItems.length} action item(s)`);

        // Sender
        if (result.sender.name) {
            const senderInfo = result.sender.title ? `${result.sender.title} ${result.sender.name}` : result.sender.name;
            summaryParts.push(`From: ${senderInfo}`);
        }

        result.emailSummary = summaryParts.join(' | ') || 'General status update';

        // ===== CALCULATE CONFIDENCE =====
        let confidenceScore = 0;
        if (result.status || result.inPort) confidenceScore += 2;
        if (result.inPortUntil || result.inPortDays) confidenceScore += 2;
        if (result.issue.hasIssue && result.issue.details) confidenceScore += 2;
        if (result.issue.category) confidenceScore += 1;
        if (result.sender.name) confidenceScore += 1;
        if (result.equipment.length > 0) confidenceScore += 1;
        if (result.extractedDates.length > 0) confidenceScore += 1;

        result.confidence = confidenceScore >= 6 ? 'high' : confidenceScore >= 3 ? 'medium' : 'low';

        // Processing animation
        await new Promise(resolve => setTimeout(resolve, 800));

        setAiResult(result);
        setAiParsing(false);
        toast('Email parsed successfully!', 'success');
    };
    
    const applyAiResult = () => {
        if (!aiResult || !sel) return;

        let updated = {...sel};
        const changes = [];

        // Apply in port status
        if (aiResult.inPort) {
            let returnDate = aiResult.inPortUntil;
            if (!returnDate && aiResult.inPortDays) {
                const d = new Date();
                d.setDate(d.getDate() + aiResult.inPortDays);
                returnDate = toDateString(d);
            }
            if (returnDate) {
                updated.inPort = true;
                updated.inPortUntil = returnDate;
                changes.push(`In Port until ${fmtDate(returnDate)}`);
            }
        }

        // Apply email summary
        if (aiResult.emailSummary) {
            updated.lastSaid = aiResult.emailSummary;
            updated.lastContact = toDateString(new Date());
            changes.push('Updated last email');
        }

        // Apply waiting reply (but not if FYI)
        if (aiResult.waitingReply && !aiResult.isFYI) {
            updated.waitingReply = true;
            changes.push('Marked as waiting on reply');
        }

        // Apply sender info as POC
        if (aiResult.sender?.name && !updated.poc) {
            const pocName = aiResult.sender.title ? `${aiResult.sender.title} ${aiResult.sender.name}` : aiResult.sender.name;
            updated.poc = pocName;
            changes.push(`POC: ${pocName}`);
        }
        if (aiResult.sender?.email && !updated.email) {
            updated.email = aiResult.sender.email;
        }

        // Apply contacted by
        if (aiResult.sender?.name) {
            updated.contactedBy = aiResult.sender.name;
        }

        // Update ship
        setSel(updated);
        setShips(p => p.map(s => s.id === sel.id ? updated : s));

        // Add issue if detected
        if (aiResult.issue?.hasIssue && aiResult.issue.details) {
            const issueTitle = aiResult.issue.title || (aiResult.issue.category ? `${aiResult.issue.category} Issue` : 'Technical Issue');
            setIssues(p => [...p, {
                id: genId('I'),
                shipId: sel.id,
                shipName: sel.name,
                threat: aiResult.issue.threat || 'Mild',
                title: issueTitle,
                category: aiResult.issue.category || 'General',
                details: aiResult.issue.details,
                equipment: aiResult.equipment || [],
                created: new Date().toISOString(),
                resolved: false
            }]);
            changes.push(`Added ${aiResult.issue.threat || 'Mild'} issue: ${issueTitle}`);
        }

        logActivity(`Parsed email for ${sel.name}: ${changes.join(', ')}`, { ship: sel.name, aiResult, sender: aiResult.sender });
        
        // Save to email history
        const historyEntry = {
            id: genId('EH'),
            type: 'parsed',
            shipId: sel.id,
            shipName: sel.name,
            timestamp: new Date().toISOString(),
            emailText: aiEmailText,
            result: aiResult,
            changes: changes
        };
        const newHistory = [historyEntry, ...emailHistory].slice(0, 50); // Keep last 50
        setEmailHistory(newHistory);
        localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));
        
        toast(`Applied: ${changes.join(', ')}`, 'success');
        setAiEmailModal(false);
        setAiEmailText('');
        setAiResult(null);
    };

    return (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left"><h1 className="page-title">Dashboard</h1><p className="page-sub">Fleet overview â€¢ {today}</p></div>
                <div className="flex gap-md">
                    <div className="search-box">
                        <Icon name="search"/>
                        <input ref={searchRef} placeholder="Search ships..." value={globalSearch} onChange={e => setGlobalSearch(e.target.value)}/>
                        <span className="shortcut">/</span>
                    </div>
                    <button className="btn btn-primary" onClick={copyReport}>ðŸ“‹ Weekly Report</button>
                    <button className="btn btn-secondary" onClick={downloadReport}>â¬‡ï¸ Download</button>
                    <button className="btn btn-secondary" onClick={exportPowerBI} style={{background:'var(--primary-glow)',border:'1px solid var(--primary)',color:'var(--primary)'}}>ðŸ“Š Power BI Export</button>
                    <button className="btn btn-secondary" onClick={() => window.print()}><Icon name="print"/> Print</button>
                </div>
            </div>
            
            {/* Visual Charts Row */}
            <div className="charts-row">
                <div className="chart-card">
                    <div className="card-title">Fleet Status (Today)</div>
                    <DonutChart value={chartData.online} total={ships.length} color="var(--green)" label="Online" sublabel={`of ${ships.length}`}/>
                    <div className="chart-legend">
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--green)'}}></span> Online: {chartData.online}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--red)'}}></span> Offline: {chartData.offline}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--text-muted)'}}></span> No Data: {chartData.noData}</span>
                    </div>
                </div>
                
                <div className="chart-card">
                    <div className="card-title">Issue Severity</div>
                    <PieChart data={[chartData.urgentCount, chartData.mildCount, chartData.noIssueCount]} colors={['var(--red)', 'var(--amber)', 'var(--green)']}/>
                    <div className="chart-legend">
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--red)'}}></span> Urgent: {chartData.urgentCount}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--amber)'}}></span> Mild: {chartData.mildCount}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--green)'}}></span> None: {chartData.noIssueCount}</span>
                    </div>
                </div>
                
                <div className="chart-card">
                    <div className="card-title">Email Status</div>
                    <PieChart data={[chartData.emailOverdue, chartData.emailDue, chartData.emailWaiting, chartData.emailInPort, chartData.emailOk]} colors={['var(--red)', 'var(--amber)', 'var(--blue)', '#06b6d4', 'var(--green)']}/>
                    <div className="chart-legend">
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--red)'}}></span> Overdue: {chartData.emailOverdue}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--amber)'}}></span> Due: {chartData.emailDue}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--blue)'}}></span> Waiting: {chartData.emailWaiting}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'#06b6d4'}}></span> In Port: {chartData.emailInPort}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--green)'}}></span> OK: {chartData.emailOk}</span>
                    </div>
                </div>
                
                <div className="chart-card">
                    <div className="card-title">Documentation</div>
                    <DonutChart value={chartData.complete} total={ships.length} color="var(--primary)" label="Complete" sublabel={`of ${ships.length}`}/>
                    <div className="chart-legend">
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--primary)'}}></span> Complete: {chartData.complete}</span>
                        <span className="legend-item"><span className="legend-dot" style={{background:'var(--red)'}}></span> Missing: {chartData.incomplete}</span>
                    </div>
                </div>
            </div>
            
            {/* Stats Row */}
            <div className="stats">
                <div className="stat urgent"><div className="stat-label">Urgent Issues</div><div className="stat-value">{stats.urgent}</div></div>
                <div className="stat due"><div className="stat-label">Check-ins Due</div><div className="stat-value">{stats.due}</div></div>
                <div className="stat total"><div className="stat-label">Total Ships</div><div className="stat-value">{stats.total}</div></div>
                <div className="stat missing" onClick={() => setPage(4)}><div className="stat-label">Incomplete Docs</div><div className="stat-value">{stats.missing}</div></div>
            </div>
            
            <div className="filters">
                <button className={`filter-btn ${typeFilter === 'all' ? 'active' : ''}`} onClick={() => setTypeFilter('all')}>All Ships</button>
                <button className={`filter-btn ${typeFilter === 'Full REAP' ? 'active' : ''}`} onClick={() => setTypeFilter('Full REAP')}>Full REAP ({chartData.fullReap})</button>
                <button className={`filter-btn ${typeFilter === 'Mini REAP' ? 'active' : ''}`} onClick={() => setTypeFilter('Mini REAP')}>Mini REAP ({chartData.miniReap})</button>
                <button className={`filter-btn ${typeFilter === 'updated' ? 'active' : ''}`} style={{background: typeFilter === 'updated' ? 'var(--green)' : 'transparent', borderColor: 'var(--green)', color: typeFilter === 'updated' ? '#fff' : 'var(--green)'}} onClick={() => setTypeFilter(typeFilter === 'updated' ? 'all' : 'updated')}>âœ“ Updated Today ({ships.filter(s => s.lastContact && fmtDateInput(s.lastContact) === today).length})</button>
            </div>
            
            <div className="dash-grid">
                <div className="card">
                    <div className="card-title" style={{display:'flex',alignItems:'center',gap:'12px'}}>Select Ship <span style={{marginLeft:'auto',fontWeight:'normal',color:'var(--text-muted)',fontSize:'11px'}}>{sorted.length} shown</span>{ships.filter(s => s.lastContact && fmtDateInput(s.lastContact) === today).length > 0 && <span style={{fontSize:'10px',color:'var(--green)',fontWeight:500,display:'flex',alignItems:'center',gap:'4px'}}><span style={{width:'8px',height:'8px',borderRadius:'2px',background:'var(--green)'}}></span>{ships.filter(s => s.lastContact && fmtDateInput(s.lastContact) === today).length} updated today</span>}</div>
                    <div className="ship-list">
                        <div className="ship-list-header"><span>STATUS</span><span>SHIP</span><span>TYPE</span><span>COMMS</span><span>HOMEPORT</span></div>
                        {sorted.map(ship => {
                            const si = issues.filter(i => i.shipId === ship.id && !i.resolved);
                            const hasU = si.some(i => i.threat === 'Urgent'), hasM = si.some(i => i.threat === 'Mild');
                            const es = getEmailStatus(ship, issues);
                            const todayCheck = dailyChecks.find(c => c.shipId === ship.id && c.date === today);
                            const isOnline = todayCheck ? (todayCheck.statusAM && todayCheck.statusPM) : null;
                            const isInPort = ship.inPort && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0));
                            const topIssue = si.length > 0 ? si.sort((a,b) => a.threat === 'Urgent' ? -1 : 1)[0] : null;
                            const updatedToday = ship.lastContact && fmtDateInput(ship.lastContact) === today;
                            return (<div key={ship.id} onClick={() => setSel(ship)} style={{cursor:'pointer'}}><div className={`ship-item ${sel?.id === ship.id ? 'selected' : ''}`} style={{...topIssue ? {borderBottom:'none'} : {}, ...(updatedToday && sel?.id !== ship.id ? {background:'rgba(16, 185, 129, 0.08)', borderLeft:'3px solid var(--green)'} : {})}}><span>{hasU ? <span className="badge badge-urgent">!</span> : hasM ? <span className="badge badge-mild">!</span> : isInPort ? <span className="badge" style={{background:'var(--blue)',color:'#fff'}}>âš“</span> : isOnline === false ? <span className="badge badge-missing">DOWN</span> : <span className="badge badge-ok">{isOnline ? 'UP' : 'â€”'}</span>}</span><span className="ship-name">{ship.name}{updatedToday && <span style={{marginLeft:'6px',fontSize:'9px',color:'var(--green)',fontWeight:500}}>âœ“ Today</span>}</span><span className="ship-type">{ship.type}</span><span>{ship.waitingReply ? <span style={{fontSize:'9px',color:'var(--blue)',fontWeight:500}}>Waiting on reply</span> : <span style={{color:'var(--text-muted)',fontSize:'10px'}}>â€”</span>}</span><span style={{fontSize:'11px',color: isInPort ? 'var(--blue)' : 'var(--text-muted)'}}>{isInPort ? `Back ${fmtDate(ship.inPortUntil)}` : (ship.location || 'â€”')}</span></div>{topIssue && <div style={{padding:'4px 12px 8px 67px',fontSize:'11px',color: topIssue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)',borderBottom:'1px solid var(--border)',background: sel?.id === ship.id ? 'var(--primary-glow)' : updatedToday ? 'rgba(16, 185, 129, 0.08)' : 'transparent'}}>â†³ {topIssue.details.substring(0, 50)}{topIssue.details.length > 50 ? '...' : ''}{si.length > 1 && <span style={{color:'var(--text-muted)',marginLeft:'8px'}}>+{si.length - 1} more</span>}</div>}</div>);
                        })}
                    </div>
                </div>
                <div>
                    {sel ? (<>
                        {/* Ship Header */}
                        <div className="detail-section" style={{paddingBottom:'0'}}>
                            <div className="flex-between mb-md">
                                <div style={{display:'flex',alignItems:'center',gap:'12px'}}>
                                    <div style={{width:'48px',height:'48px',borderRadius:'8px',background:'var(--primary-glow)',border:'2px solid var(--primary)',display:'flex',alignItems:'center',justifyContent:'center'}}><Icon name="ship" style={{width:'24px',height:'24px',color:'var(--primary)'}}/></div>
                                    <div>
                                        <div style={{fontSize:'20px',fontWeight:700}}>{sel.name}</div>
                                        <div style={{fontSize:'12px',color:'var(--text-muted)',display:'flex',alignItems:'center',gap:'8px'}}>
                                            <span>{sel.type}</span>
                                            <span>â€¢</span>
                                            <span>{sel.location || 'No location'}</span>
                                            {sel.inPort && parseLocalDate(sel.inPortUntil) >= new Date(new Date().setHours(0,0,0,0)) && <span className="badge" style={{background:'var(--blue)',color:'#fff',fontSize:'9px'}}>âš“ IN PORT</span>}
                                        </div>
                                    </div>
                                </div>
                                <div className="btn-group">
                                    <button className="btn btn-sm btn-primary" onClick={save}>ðŸ’¾ Save</button>
                                    <button className="btn btn-sm btn-danger" onClick={del}>Delete</button>
                                </div>
                            </div>

                            {/* Status Badges Row */}
                            <div style={{display:'flex',gap:'8px',marginBottom:'16px',flexWrap:'wrap'}}>
                                <div className={`status status-${selIssues.some(i => i.threat === 'Urgent') ? 'urgent' : selIssues.some(i => i.threat === 'Mild') ? 'mild' : 'ok'}`} style={{fontSize:'11px'}}>{selIssues.some(i => i.threat === 'Urgent') ? `ðŸš¨ ${selIssues.length} URGENT` : selIssues.some(i => i.threat === 'Mild') ? `âš ï¸ ${selIssues.length} ISSUE${selIssues.length > 1 ? 'S' : ''}` : 'âœ“ NO ISSUES'}</div>
                                {getEmailStatus(sel, issues).status !== 'OK' && <span className={`badge badge-${getEmailStatus(sel, issues).status.toLowerCase()}`} style={{padding:'4px 10px'}}>{getEmailStatus(sel, issues).status === 'IN PORT' ? 'âš“ IN PORT' : getEmailStatus(sel, issues).status}</span>}
                                {sel.waitingReply && <span className="badge" style={{background:'var(--blue)',color:'#fff',padding:'4px 10px'}}>â³ Waiting Reply</span>}
                            </div>

                            {/* Tabs */}
                            <div style={{display:'flex',borderBottom:'1px solid var(--border)',marginLeft:'-16px',marginRight:'-16px',paddingLeft:'16px'}}>
                                {[
                                    { id: 'info', label: 'Ship Info', iconName: 'ship' },
                                    { id: 'email', label: 'Email', iconName: 'email', badge: emailHistory.filter(h => h.shipId === sel.id).length },
                                    { id: 'issues', label: 'Issues', icon: 'âš ï¸', badge: selIssues.length, badgeColor: selIssues.some(i => i.threat === 'Urgent') ? 'var(--red)' : 'var(--amber)' },
                                    { id: 'assets', label: 'Assets', iconName: 'parts' },
                                    { id: 'activity', label: 'Activity', iconName: 'clock' },
                                ].map(tab => (
                                    <button key={tab.id} onClick={() => setDetailTab(tab.id)} style={{padding:'12px 16px',background:'none',border:'none',borderBottom: detailTab === tab.id ? '2px solid var(--primary)' : '2px solid transparent',color: detailTab === tab.id ? 'var(--primary)' : 'var(--text-muted)',fontWeight: detailTab === tab.id ? 600 : 400,cursor:'pointer',fontSize:'12px',display:'flex',alignItems:'center',gap:'6px',marginBottom:'-1px'}}>
                                        {tab.iconName ? <Icon name={tab.iconName} style={{width:'14px',height:'14px'}}/> : <span>{tab.icon}</span>}
                                        <span>{tab.label}</span>
                                        {tab.badge > 0 && <span style={{background: tab.badgeColor || 'var(--primary)',color:'#fff',padding:'1px 6px',borderRadius:'10px',fontSize:'10px'}}>{tab.badge}</span>}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Tab Content */}
                        <div className="detail-section" style={{paddingTop:'16px'}}>
                            {/* INFO TAB */}
                            {detailTab === 'info' && (
                                <div>
                                    <div className="form-row">
                                        <div className="form-group"><label className="form-label">Hull Number</label><input className="form-input" value={sel.name} onChange={e => setSel({...sel, name: e.target.value})}/></div>
                                        <div className="form-group"><label className="form-label">Ship Type</label><select className="form-select" value={sel.type} onChange={e => setSel({...sel, type: e.target.value})}><option>Full REAP</option><option>Mini REAP</option></select></div>
                                        <div className="form-group"><label className="form-label">Homeport</label><select className="form-select" value={sel.location || ''} onChange={e => setSel({...sel, location: e.target.value})}><option value="">Select...</option><option>San Diego, CA</option><option>Norfolk, VA</option><option>Mayport, FL</option><option>Pearl Harbor, HI</option><option>Yokosuka, Japan</option><option>Rota, Spain</option><option>Everett, WA</option><option>Deployed</option><option>In Port</option><option>Other</option></select></div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group"><label className="form-label">POC Name</label><input className="form-input" placeholder="Point of contact..." value={sel.poc || ''} onChange={e => setSel({...sel, poc: e.target.value})}/></div>
                                        <div className="form-group"><label className="form-label">Email</label><input className="form-input" placeholder="ship@navy.mil" value={sel.email || ''} onChange={e => setSel({...sel, email: e.target.value})}/></div>
                                        <div className="form-group"><label className="form-label">Next Check-in</label><input type="date" className="form-input" value={fmtDateInput(sel.nextCheck)} onChange={e => setSel({...sel, nextCheck: e.target.value})}/></div>
                                    </div>
                                    <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" style={{minHeight:'60px'}} placeholder="Additional notes about this ship..." value={sel.notes || ''} onChange={e => setSel({...sel, notes: e.target.value})}/></div>

                                    {/* In Port Status */}
                                    {sel.inPort && parseLocalDate(sel.inPortUntil) >= new Date(new Date().setHours(0,0,0,0)) && (
                                        <div style={{padding:'12px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)',marginTop:'12px'}}>
                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                                <div><span style={{color:'var(--blue)',fontWeight:600}}>âš“ IN PORT - Expected Offline</span><div style={{fontSize:'11px',color:'var(--text-muted)',marginTop:'4px'}}>Back online: {fmtDate(sel.inPortUntil)}</div></div>
                                                <button className="btn btn-sm btn-secondary" onClick={() => { const updated = {...sel, inPort: false, inPortUntil: null}; setSel(updated); setShips(p => p.map(s => s.id === sel.id ? updated : s)); logActivity(`Cleared In Port status for ${sel.name}`); toast('In Port status cleared', 'info'); }}>Clear Status</button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="btn-group mt-md">
                                        <button className="btn btn-sm" style={{background:'var(--blue)',color:'#fff'}} onClick={() => { setInPortDate(''); setInPortModal(true); }}>âš“ Set In Port</button>
                                    </div>
                                </div>
                            )}

                            {/* EMAIL TAB */}
                            {detailTab === 'email' && (
                                <div>
                                    {/* Quick Actions Bar */}
                                    <div style={{display:'flex',gap:'8px',marginBottom:'16px',flexWrap:'wrap',padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <button className="btn btn-success btn-sm" onClick={openContactModal}>âœ‰ï¸ Log New Email</button>
                                    </div>

                                    {/* Status Header */}
                                    <div style={{display:'flex',gap:'12px',marginBottom:'16px',flexWrap:'wrap',alignItems:'center'}}>
                                        <div style={{padding:'8px 12px',background:'var(--bg-card)',borderRadius:'6px',border:'1px solid var(--border)',fontSize:'12px'}}>
                                            <span style={{color:'var(--text-muted)'}}>Last Contact:</span> <strong>{sel.lastContact ? fmtDate(sel.lastContact) : 'Never'}</strong>
                                        </div>
                                        <div style={{padding:'8px 12px',background:'var(--bg-card)',borderRadius:'6px',border:'1px solid var(--border)',fontSize:'12px'}}>
                                            <span style={{color:'var(--text-muted)'}}>POC:</span> <strong>{sel.poc || 'â€”'}</strong> {sel.email && <span style={{color:'var(--text-muted)'}}>({sel.email})</span>}
                                        </div>
                                        <span className={`badge badge-${getEmailStatus(sel, issues).status.toLowerCase()}`}>{getEmailStatus(sel, issues).status === 'IN PORT' ? 'âš“ IN PORT' : getEmailStatus(sel, issues).status}</span>
                                        {sel.waitingReply && <span className="badge badge-info">â³ Waiting Reply</span>}
                                    </div>

                                    {/* Email Conversation Log */}
                                    <div style={{marginBottom:'16px'}}>
                                        <div style={{fontSize:'12px',fontWeight:600,color:'var(--text-muted)',marginBottom:'12px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                            <span>ðŸ“§ EMAIL CONVERSATION LOG ({emailHistory.filter(h => h.shipId === sel.id).length} entries)</span>
                                        </div>

                                        {emailHistory.filter(h => h.shipId === sel.id).length === 0 ? (
                                            <div style={{padding:'40px',textAlign:'center',color:'var(--text-muted)',background:'var(--bg-input)',borderRadius:'8px',border:'1px dashed var(--border)'}}>
                                                <div style={{fontSize:'24px',marginBottom:'8px'}}>ðŸ“­</div>
                                                <div>No emails logged yet</div>
                                                <div style={{fontSize:'11px',marginTop:'4px'}}>Click "Log New Email" to record contact</div>
                                            </div>
                                        ) : (
                                            <div style={{maxHeight:'500px',overflow:'auto',position:'relative'}}>
                                                {/* Timeline line */}
                                                <div style={{position:'absolute',left:'15px',top:'8px',bottom:'8px',width:'2px',background:'var(--border)'}}/>
                                                
                                                <div style={{display:'flex',flexDirection:'column',gap:'4px'}}>
                                                    {emailHistory.filter(h => h.shipId === sel.id).map((h, idx) => {
                                                        const isFollowup = h.changes?.some(c => c.includes('Follow-up'));
                                                        const isReply = h.changes?.some(c => c.includes('Reply received') || c.includes('Waiting on our'));
                                                        const isIssue = h.result?.issue?.hasIssue;
                                                        const dotColor = isIssue ? (h.result.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)') 
                                                            : h.result?.waitingReply ? 'var(--blue)' 
                                                            : isReply ? 'var(--green)' 
                                                            : isFollowup ? 'var(--blue)' 
                                                            : 'var(--green)';
                                                        const senderName = h.result?.sender?.name;
                                                        
                                                        return (
                                                        <div key={h.id} style={{display:'flex',gap:'12px',paddingLeft:'0',position:'relative'}}>
                                                            {/* Timeline dot */}
                                                            <div style={{width:'32px',flexShrink:0,display:'flex',justifyContent:'center',paddingTop:'14px',zIndex:1}}>
                                                                <div style={{width:'10px',height:'10px',borderRadius:'50%',background:dotColor,border:'2px solid var(--bg)',boxShadow:`0 0 0 2px ${dotColor}`}}/>
                                                            </div>
                                                            
                                                            {/* Content card */}
                                                            <div style={{flex:1,padding:'12px 14px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)',marginBottom:'4px',
                                                                ...(isIssue ? {borderLeft: `3px solid ${h.result.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)'}`} : {})
                                                            }}>
                                                                {/* Top row: date + actions */}
                                                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}>
                                                                    <div style={{display:'flex',alignItems:'center',gap:'8px',flexWrap:'wrap'}}>
                                                                        <span style={{fontSize:'12px',fontWeight:600,color:'var(--text)'}}>
                                                                            {fmtDate(h.timestamp)}
                                                                        </span>
                                                                        <span style={{fontSize:'10px',color:'var(--text-muted)'}}>
                                                                            {new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
                                                                        </span>
                                                                        {senderName && (
                                                                            <span style={{fontSize:'11px',color:'var(--text-dim)',background:'var(--bg-input)',padding:'1px 8px',borderRadius:'10px',border:'1px solid var(--border)'}}>
                                                                                {senderName}
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div style={{display:'flex',gap:'2px',alignItems:'center'}}>
                                                                        {h.result?.waitingReply && (
                                                                            <button className="btn btn-sm" style={{padding:'2px 8px',fontSize:'9px',background:'var(--blue)',color:'#fff',borderRadius:'4px'}} onClick={(e) => { e.stopPropagation(); setClearEmailWaitingModal(h); }}>Clear</button>
                                                                        )}
                                                                        <button className="btn btn-sm" style={{padding:'2px 5px',fontSize:'10px',background:'transparent',color:'var(--text-muted)',minWidth:'auto'}} title="Edit" onClick={() => { 
                                                                            const d = new Date(h.timestamp); 
                                                                            setEditEmailForm({ 
                                                                                date: toDateString(d), 
                                                                                time: d.toTimeString().slice(0,5), 
                                                                                summary: h.result?.emailSummary || '', 
                                                                                emailText: h.emailText || '', 
                                                                                contactedBy: h.result?.sender?.name || '' 
                                                                            }); 
                                                                            setEditEmailEntry(h); 
                                                                        }}>âœï¸</button>
                                                                        <button className="btn btn-sm" style={{padding:'2px 5px',fontSize:'10px',background:'transparent',color:'var(--text-muted)',minWidth:'auto'}} title="Delete" onClick={() => { if(confirm('Delete this entry?')) { const filtered = emailHistory.filter(x => x.id !== h.id); setEmailHistory(filtered); localStorage.setItem('emailParseHistory', JSON.stringify(filtered)); toast('Entry deleted', 'info'); } }}>âœ•</button>
                                                                    </div>
                                                                </div>

                                                                {/* Status badges row */}
                                                                {(h.result?.waitingReply || h.result?.inPort || isIssue) && (
                                                                    <div style={{display:'flex',gap:'6px',marginBottom:'8px',flexWrap:'wrap'}}>
                                                                        {h.result?.waitingReply && <span className="badge badge-info" style={{fontSize:'9px'}}>â³ Awaiting Reply</span>}
                                                                        {h.result?.inPort && <span className="badge" style={{background:'var(--blue)',color:'#fff',fontSize:'9px'}}>âš“ In Port</span>}
                                                                        {isIssue && <span className={`badge badge-${(h.result.issue.threat || 'mild').toLowerCase()}`} style={{fontSize:'9px'}}>âš ï¸ {h.result.issue.threat || 'Issue'}</span>}
                                                                    </div>
                                                                )}

                                                                {/* Issue details callout */}
                                                                {isIssue && h.result.issue.details && (
                                                                    <div style={{padding:'8px 10px',marginBottom:'8px',borderRadius:'6px',background: h.result.issue.threat === 'Urgent' ? 'var(--red-glow)' : 'var(--amber-glow)',border: `1px solid ${h.result.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)'}`,fontSize:'12px',lineHeight:'1.4'}}>
                                                                        {h.result.issue.details}
                                                                    </div>
                                                                )}

                                                                {/* Summary / main content */}
                                                                {h.result?.emailSummary && (
                                                                    <div style={{fontSize:'13px',color:'var(--text)',lineHeight:'1.5'}}>
                                                                        {h.result.emailSummary}
                                                                    </div>
                                                                )}

                                                                {/* Full email - collapsible */}
                                                                {h.emailText && (
                                                                    <details style={{marginTop:'8px'}}>
                                                                        <summary style={{fontSize:'10px',color:'var(--primary)',cursor:'pointer',userSelect:'none',fontWeight:500}}>ðŸ“„ View full email</summary>
                                                                        <div style={{padding:'10px',marginTop:'6px',background:'var(--bg-input)',borderRadius:'6px',fontSize:'11px',fontFamily:'JetBrains Mono',whiteSpace:'pre-wrap',maxHeight:'200px',overflow:'auto',border:'1px solid var(--border)',lineHeight:'1.5'}}>{h.emailText}</div>
                                                                    </details>
                                                                )}

                                                                {/* Changes footer */}
                                                                {h.changes?.length > 0 && (
                                                                    <div style={{marginTop:'8px',paddingTop:'6px',borderTop:'1px solid var(--border)',fontSize:'10px',color:'var(--green)'}}>
                                                                        âœ“ {h.changes.join(' â€¢ ')}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Current Notes (editable) */}
                                    <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}>
                                            <div style={{fontSize:'10px',color:'var(--text-muted)',fontWeight:600}}>CURRENT STATUS NOTES</div>
                                            <button className="btn btn-sm btn-secondary" onClick={() => setModal(true)}>âœï¸ Edit</button>
                                        </div>
                                        <div style={{fontSize:'12px',color: sel.lastSaid ? 'var(--text)' : 'var(--text-muted)',whiteSpace:'pre-wrap'}}>{sel.lastSaid || 'No notes. Click Edit to add current status notes.'}</div>
                                    </div>
                                </div>
                            )}

                            {/* ISSUES TAB */}
                            {detailTab === 'issues' && (
                                <div>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                                        <div style={{fontSize:'14px',fontWeight:600}}>Open Issues ({selIssues.length})</div>
                                        <button className="btn btn-warning" onClick={() => setQuickIssueModal(true)}>+ Add Issue</button>
                                    </div>

                                    {selIssues.length === 0 ? (
                                        <div style={{padding:'40px',textAlign:'center',color:'var(--text-muted)',background:'var(--bg-input)',borderRadius:'8px'}}>
                                            <div style={{fontSize:'32px',marginBottom:'8px'}}>âœ“</div>
                                            <div>No open issues for this ship</div>
                                        </div>
                                    ) : (
                                        <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                                            {selIssues.map(issue => (
                                                <div key={issue.id} style={{padding:'12px',background: issue.threat === 'Urgent' ? 'var(--red-glow)' : 'var(--amber-glow)',borderRadius:'8px',border: `1px solid ${issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)'}`}}>
                                                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                                                        <div style={{flex:1}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:'8px',marginBottom:'4px',flexWrap:'wrap'}}>
                                                                <span className={`badge badge-${issue.threat.toLowerCase()}`}>{issue.threat}</span>
                                                                <span style={{fontSize:'9px',padding:'2px 6px',borderRadius:'4px',fontWeight:600,background: issue.responsibility === 'REAP' ? 'var(--primary-glow)' : 'var(--bg-input)',color: issue.responsibility === 'REAP' ? 'var(--primary)' : 'var(--text-muted)',border: `1px solid ${issue.responsibility === 'REAP' ? 'var(--primary)' : 'var(--border)'}`}}>{issue.responsibility === 'REAP' ? 'ðŸ› ï¸ REAP' : 'ðŸš¢ Ship'}</span>
                                                                {issue.category && <span style={{fontSize:'10px',color:'var(--text-muted)'}}>{issue.category}</span>}
                                                                <span style={{fontSize:'10px',color:'var(--text-muted)'}}>â€¢ {fmtDate(issue.created)}</span>
                                                            </div>
                                                            <div style={{fontSize:'13px'}}>{issue.title || issue.details}</div>
                                                            {issue.title && issue.details && issue.title !== issue.details && <div style={{fontSize:'11px',color:'var(--text-muted)',marginTop:'4px'}}>{issue.details}</div>}
                                                        </div>
                                                        <div style={{display:'flex',gap:'4px',alignItems:'center'}}>
                                                            <button className="btn btn-sm" style={{padding:'2px 6px',fontSize:'9px',background: issue.responsibility === 'REAP' ? 'var(--amber-glow)' : 'var(--primary-glow)',color: issue.responsibility === 'REAP' ? 'var(--amber)' : 'var(--primary)',border: `1px solid ${issue.responsibility === 'REAP' ? 'var(--amber)' : 'var(--primary)'}`}} title={`Switch to ${issue.responsibility === 'REAP' ? 'Ship' : 'REAP'}`} onClick={() => setIssues(p => p.map(x => x.id === issue.id ? {...x, responsibility: x.responsibility === 'REAP' ? 'Ship' : 'REAP'} : x))}>{issue.responsibility === 'REAP' ? 'â†’ Ship' : 'â†’ REAP'}</button>
                                                            <button className="btn btn-sm btn-success" onClick={() => { setResolveIssueModal(issue); setResolveNotes(''); }}>âœ“ Resolve</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* ASSETS TAB */}
                            {detailTab === 'assets' && (
                                <div>
                                    <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'16px',letterSpacing:'0.5px'}}>ASSET SERIAL NUMBERS & IDENTIFIERS</div>
                                    <div className="form-row">
                                        <div className="form-group"><label className="form-label">Cisco Router</label><input className="form-input" placeholder="Serial number..." value={sel.ciscoRouter || ''} onChange={e => setSel({...sel, ciscoRouter: e.target.value})}/></div>
                                        <div className="form-group"><label className="form-label">HDD</label><input className="form-input" placeholder="Serial number..." value={sel.hdd || ''} onChange={e => setSel({...sel, hdd: e.target.value})}/></div>
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group"><label className="form-label">Star CRNA</label><input className="form-input" placeholder="Serial number..." value={sel.crna1 || ''} onChange={e => setSel({...sel, crna1: e.target.value})}/></div>
                                        <div className="form-group"><label className="form-label">Data CRNA</label><input className="form-input" placeholder="Serial number..." value={sel.crna2 || ''} onChange={e => setSel({...sel, crna2: e.target.value})}/></div>
                                    </div>

                                    {/* Asset Summary */}
                                    <div style={{marginTop:'16px',padding:'12px',background:'var(--bg-input)',borderRadius:'8px'}}>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)',marginBottom:'8px'}}>Asset Completion</div>
                                        <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
                                            {[
                                                { label: 'Router', value: sel.ciscoRouter },
                                                { label: 'HDD', value: sel.hdd },
                                                { label: 'Star CRNA', value: sel.crna1 },
                                                { label: 'Data CRNA', value: sel.crna2 },
                                            ].map(asset => (
                                                <span key={asset.label} style={{padding:'4px 10px',borderRadius:'4px',fontSize:'11px',background: asset.value ? 'var(--green-glow)' : 'var(--bg-card)',border: `1px solid ${asset.value ? 'var(--green)' : 'var(--border)'}`,color: asset.value ? 'var(--green)' : 'var(--text-muted)'}}>{asset.value ? 'âœ“' : 'â—‹'} {asset.label}</span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* ACTIVITY TAB */}
                            {detailTab === 'activity' && (
                                <div>
                                    <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'16px',letterSpacing:'0.5px'}}>RECENT ACTIVITY FOR {sel.name}</div>
                                    <div className="activity-log">
                                        {activityLog.filter(a => a.text.includes(sel.name)).slice(0, 10).map(a => (
                                            <div key={a.id} className="activity-item" style={{flexDirection:'column',gap:'4px'}}>
                                                <div style={{display:'flex',gap:'12px'}}>
                                                    <span className="activity-time">{fmtTime(a.time)}</span>
                                                    <span className="activity-text">{a.text}</span>
                                                </div>
                                                {a.details && (
                                                    <div style={{marginLeft:'70px',padding:'8px',background:'var(--bg-input)',borderRadius:'6px',fontSize:'11px',color:'var(--text-dim)'}}>
                                                        {a.details.resolution && <div style={{marginBottom:'4px'}}>â†³ <strong>Resolution:</strong> {a.details.resolution}</div>}
                                                        {a.details.reply && <div style={{marginBottom:'4px'}}>â†³ <strong>Their Reply:</strong> "{a.details.reply}"</div>}
                                                        {a.details.details && <div style={{marginBottom:'4px'}}>â†³ <strong>Issue:</strong> {a.details.details}</div>}
                                                        {a.details.threat && <div style={{marginBottom:'4px'}}>â†³ <strong>Threat:</strong> <span className={`badge badge-${a.details.threat.toLowerCase()}`}>{a.details.threat}</span></div>}
                                                        {a.details.notes && <div style={{marginBottom:'4px'}}>â†³ <strong>Notes:</strong> {a.details.notes}</div>}
                                                        {a.details.contactedBy && <div style={{marginBottom:'4px'}}>â†³ <strong>By:</strong> {a.details.contactedBy}</div>}
                                                        {a.details.waitingReply && <div style={{marginBottom:'4px'}}>â†³ <strong>Status:</strong> Waiting on reply</div>}
                                                        {a.details.inPortUntil && <div>â†³ <strong>Back online:</strong> {fmtDate(a.details.inPortUntil)}</div>}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        {activityLog.filter(a => a.text.includes(sel.name)).length === 0 && <div className="empty">No recent activity for this ship</div>}
                                    </div>
                                </div>
                            )}
                        </div>
                    </>) : <div className="detail-section"><div className="empty" style={{padding:'60px 20px'}}><svg width="140" height="70" viewBox="0 0 120 60" fill="none" stroke="var(--text-muted)" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" style={{opacity:0.5}}>
                            <path d="M5 42 L15 38 L105 38 L115 42 L108 45 L12 45 Z" fill="var(--text-muted)" fillOpacity="0.05"/>
                            <path d="M5 42 L15 38 L105 38 L115 42"/>
                            <path d="M15 38 L8 35 L5 42"/>
                            <path d="M105 38 L112 35 L115 42"/>
                            <path d="M18 38 L18 35 L102 35 L102 38"/>
                            <circle cx="28" cy="33" r="4" fill="var(--text-muted)" fillOpacity="0.1"/>
                            <path d="M28 33 L28 25"/>
                            <path d="M26 25 L30 25"/>
                            <rect x="36" y="31" width="12" height="6" rx="1" fill="var(--text-muted)" fillOpacity="0.08"/>
                            <path d="M39 31 L39 37 M42 31 L42 37 M45 31 L45 37"/>
                            <path d="M52 35 L52 22 L72 22 L72 35" fill="var(--text-muted)" fillOpacity="0.1"/>
                            <path d="M54 22 L54 18 L70 18 L70 22"/>
                            <path d="M56 20 L68 20"/>
                            <path d="M62 18 L62 8"/>
                            <path d="M58 12 L66 12"/>
                            <rect x="59" y="13" width="6" height="4" fill="var(--text-muted)" fillOpacity="0.15"/>
                            <path d="M76 35 L76 26 L88 26 L88 35" fill="var(--text-muted)" fillOpacity="0.08"/>
                            <path d="M82 26 L82 16"/>
                            <path d="M79 19 L85 19"/>
                            <circle cx="94" cy="33" r="3" fill="var(--text-muted)" fillOpacity="0.1"/>
                            <path d="M94 33 L94 29 L96 27"/>
                            <circle cx="98" cy="37" r="2" strokeDasharray="1 1"/>
                            <path d="M12 45 L108 45" strokeOpacity="0.4"/>
                            <path d="M108 43 Q112 43 116 44" strokeOpacity="0.2"/>
                            <path d="M108 44 Q113 44 118 46" strokeOpacity="0.15"/>
                        </svg><p className="mt-md">Select a ship to view details</p></div></div>}
                </div>
            </div>
            
            <Modal open={modal} onClose={() => setModal(false)} title="Edit Email Response">{sel && <><p className="mb-md" style={{color:'var(--text-dim)',fontSize:'13px'}}>Ship: {sel.name}</p><div className="form-group"><label className="form-label">Email Content</label><textarea className="form-textarea" style={{minHeight:'150px'}} value={sel.lastSaid} onChange={e => setSel({...sel, lastSaid: e.target.value})}/></div><div className="btn-group mt-md"><button className="btn btn-primary" onClick={() => { save(); setModal(false); }}>Save</button><button className="btn btn-secondary" onClick={() => setModal(false)}>Close</button></div></>}</Modal>
            
            <Modal open={quickIssueModal} onClose={() => setQuickIssueModal(false)} title="Quick Add Issue">{sel && <><p className="mb-md" style={{color:'var(--text-dim)',fontSize:'13px'}}>Ship: {sel.name}</p><div className="form-group"><label className="form-label">Threat Level</label><div className="radio-group"><label className="radio urgent"><input type="radio" checked={quickIssue.threat==='Urgent'} onChange={() => setQuickIssue({...quickIssue, threat:'Urgent'})}/>Urgent</label><label className="radio mild"><input type="radio" checked={quickIssue.threat==='Mild'} onChange={() => setQuickIssue({...quickIssue, threat:'Mild'})}/>Mild</label></div></div><div className="form-group"><label className="form-label">Responsibility</label><div style={{display:'flex',gap:'8px'}}><button type="button" onClick={() => setQuickIssue({...quickIssue, responsibility:'REAP'})} style={{flex:1,padding:'8px',borderRadius:'6px',border: quickIssue.responsibility==='REAP' ? '2px solid var(--primary)' : '1px solid var(--border)',background: quickIssue.responsibility==='REAP' ? 'var(--primary-glow)' : 'var(--bg-input)',color: quickIssue.responsibility==='REAP' ? 'var(--primary)' : 'var(--text-muted)',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>ðŸ› ï¸ REAP (Us)</button><button type="button" onClick={() => setQuickIssue({...quickIssue, responsibility:'Ship'})} style={{flex:1,padding:'8px',borderRadius:'6px',border: quickIssue.responsibility==='Ship' ? '2px solid var(--amber)' : '1px solid var(--border)',background: quickIssue.responsibility==='Ship' ? 'var(--amber-glow)' : 'var(--bg-input)',color: quickIssue.responsibility==='Ship' ? 'var(--amber)' : 'var(--text-muted)',fontSize:'12px',fontWeight:600,cursor:'pointer'}}>ðŸš¢ Ship (Them)</button></div></div><div className="form-group"><label className="form-label">Details</label><textarea className="form-textarea" value={quickIssue.details} onChange={e => setQuickIssue({...quickIssue, details: e.target.value})} placeholder="Describe the issue..."/></div><div className="btn-group mt-md"><button className="btn btn-primary" onClick={addQuickIssue}>Add Issue</button><button className="btn btn-secondary" onClick={() => setQuickIssueModal(false)}>Cancel</button></div></>}</Modal>
            
            <Modal open={contactModal} onClose={() => setContactModal(false)} title="âœ‰ï¸ Mark Ship as Emailed">
                {sel && <>
                    <p style={{color:'var(--text-dim)',fontSize:'13px',marginBottom:'16px'}}>Record email contact for <strong style={{color:'var(--primary)'}}>{sel.name}</strong></p>
                    <div className="form-group">
                        <label className="form-label">Your Name *</label>
                        <input className="form-input" placeholder="Enter your name" value={contactForm.name} onChange={e => setContactForm({...contactForm, name: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Date of Contact</label>
                        <input type="date" className="form-input" value={contactForm.date} onChange={e => setContactForm({...contactForm, date: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="checkbox" style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                            <input type="checkbox" checked={contactForm.waitingReply || false} onChange={e => setContactForm({...contactForm, waitingReply: e.target.checked})}/>
                            <span style={{fontSize:'13px'}}>â³ Waiting on Reply</span>
                        </label>
                        <p style={{fontSize:'11px',color:'var(--text-muted)',marginTop:'4px'}}>Check this if you sent an email and are waiting for their response</p>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Notes / Email Summary (Optional)</label>
                        <textarea className="form-textarea" placeholder="What was discussed? Any follow-up needed?" value={contactForm.notes} onChange={e => setContactForm({...contactForm, notes: e.target.value})}/>
                    </div>
                    <div className="btn-group mt-md">
                        <button className="btn btn-primary" onClick={submitContact}>âœ“ Save Contact</button>
                        <button className="btn btn-secondary" onClick={() => setContactModal(false)}>Cancel</button>
                    </div>
                </>}
            </Modal>
            
            {/* Recent Activity Section */}
            <div className="card" style={{marginTop:'16px'}}>
                <div className="flex-between mb-md">
                    <span className="card-title">ðŸ“ Recent Activity</span>
                    <button className="btn btn-sm btn-secondary" onClick={() => setShowAllActivity(true)}>View All</button>
                </div>
                {activityLog.length === 0 ? (
                    <div className="empty">No recent activity</div>
                ) : (
                    <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                        {activityLog.slice(0, 8).map(a => {
                            const timeAgo = (date) => {
                                const mins = Math.floor((new Date() - new Date(date)) / 60000);
                                if (mins < 1) return 'Just now';
                                if (mins < 60) return `${mins}m ago`;
                                const hours = Math.floor(mins / 60);
                                if (hours < 24) return `${hours}h ago`;
                                const days = Math.floor(hours / 24);
                                return `${days}d ago`;
                            };
                            return (
                                <div key={a.id} onClick={() => setActivityDetailModal(a)} style={{padding:'10px 12px',background:'var(--bg-input)',borderRadius:'6px',cursor:'pointer',border:'1px solid transparent',transition:'all 0.15s'}} onMouseOver={e => e.currentTarget.style.borderColor='var(--primary)'} onMouseOut={e => e.currentTarget.style.borderColor='transparent'}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                                        <div style={{flex:1}}>
                                            <div style={{fontSize:'12px',fontWeight:500,color:'var(--text)',marginBottom:'2px'}}>{a.text}</div>
                                            {a.details && (
                                                <div style={{fontSize:'11px',color:'var(--text-dim)',padding:'4px 8px',background:'var(--bg-card)',borderRadius:'4px',marginTop:'4px'}}>
                                                    {a.details.resolution && <div>â†³ <strong>Resolution:</strong> {a.details.resolution.substring(0, 60)}{a.details.resolution.length > 60 ? '...' : ''}</div>}
                                                    {a.details.reply && <div>â†³ <strong>Reply:</strong> "{a.details.reply.substring(0, 60)}{a.details.reply.length > 60 ? '...' : ''}"</div>}
                                                    {a.details.details && <div>â†³ <strong>Issue:</strong> {a.details.details.substring(0, 60)}{a.details.details.length > 60 ? '...' : ''}</div>}
                                                    {a.details.threat && <span style={{marginRight:'8px'}}>â†³ <strong>Threat:</strong> {a.details.threat}</span>}
                                                    {a.details.notes && <div>â†³ <strong>Notes:</strong> {a.details.notes.substring(0, 60)}{a.details.notes.length > 60 ? '...' : ''}</div>}
                                                    {a.details.contactedBy && <span style={{marginRight:'8px'}}>â†³ <strong>By:</strong> {a.details.contactedBy}</span>}
                                                    {a.details.waitingReply && <span>â†³ Waiting on reply</span>}
                                                    {a.details.inPortUntil && <div>â†³ <strong>Back:</strong> {fmtDate(a.details.inPortUntil)}</div>}
                                                </div>
                                            )}
                                            <div style={{fontSize:'10px',color:'var(--text-muted)',marginTop:'4px'}}>
                                                <span style={{color:'var(--primary)',fontWeight:600}}>{a.user || 'System'}</span>
                                                <span style={{margin:'0 6px'}}>â€¢</span>
                                                {timeAgo(a.time)}
                                            </div>
                                        </div>
                                        <span style={{fontSize:'10px',color:'var(--text-muted)'}}>â†’</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
            
            {/* Activity Detail Modal */}
            <Modal open={!!activityDetailModal} onClose={() => setActivityDetailModal(null)} title="Activity Details">
                {activityDetailModal && (
                    <div>
                        <div style={{padding:'16px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px'}}>
                            <div style={{fontSize:'14px',fontWeight:600,marginBottom:'12px'}}>{activityDetailModal.text}</div>
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',fontSize:'12px'}}>
                                <div>
                                    <div style={{color:'var(--text-muted)',marginBottom:'2px'}}>User</div>
                                    <div style={{color:'var(--primary)',fontWeight:600}}>{activityDetailModal.user || 'System'}</div>
                                </div>
                                <div>
                                    <div style={{color:'var(--text-muted)',marginBottom:'2px'}}>Time</div>
                                    <div>{new Date(activityDetailModal.time).toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        {activityDetailModal.details && (
                            <div style={{display:'flex',flexDirection:'column',gap:'12px'}}>
                                {activityDetailModal.details.resolution && (
                                    <div style={{padding:'12px',background:'var(--green-glow)',borderRadius:'8px',border:'1px solid var(--green)'}}>
                                        <div style={{fontSize:'11px',color:'var(--green)',fontWeight:600,marginBottom:'8px'}}>âœ“ Resolution</div>
                                        <div style={{fontSize:'12px',color:'var(--text)',whiteSpace:'pre-wrap'}}>{activityDetailModal.details.resolution}</div>
                                    </div>
                                )}
                                {activityDetailModal.details.reply && (
                                    <div style={{padding:'12px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)'}}>
                                        <div style={{fontSize:'11px',color:'var(--blue)',fontWeight:600,marginBottom:'8px'}}>âœ‰ï¸ Their Reply</div>
                                        <div style={{fontSize:'12px',color:'var(--text)',whiteSpace:'pre-wrap'}}>{activityDetailModal.details.reply}</div>
                                    </div>
                                )}
                                {activityDetailModal.details.details && (
                                    <div style={{padding:'12px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)',fontWeight:600,marginBottom:'8px'}}>ðŸ“‹ Issue Details</div>
                                        <div style={{fontSize:'12px',color:'var(--text)',whiteSpace:'pre-wrap'}}>{activityDetailModal.details.details}</div>
                                    </div>
                                )}
                                {activityDetailModal.details.threat && (
                                    <div style={{padding:'12px',background: activityDetailModal.details.threat === 'Urgent' ? 'var(--red-glow)' : 'var(--amber-glow)',borderRadius:'8px',border: activityDetailModal.details.threat === 'Urgent' ? '1px solid var(--red)' : '1px solid var(--amber)'}}>
                                        <div style={{fontSize:'11px',color: activityDetailModal.details.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)',fontWeight:600,marginBottom:'8px'}}>âš ï¸ Threat Level</div>
                                        <div style={{fontSize:'12px'}}><span className={`badge badge-${activityDetailModal.details.threat.toLowerCase()}`}>{activityDetailModal.details.threat}</span></div>
                                    </div>
                                )}
                                {activityDetailModal.details.notes && (
                                    <div style={{padding:'12px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)',fontWeight:600,marginBottom:'8px'}}>ðŸ“ Notes</div>
                                        <div style={{fontSize:'12px',color:'var(--text)',whiteSpace:'pre-wrap'}}>{activityDetailModal.details.notes}</div>
                                    </div>
                                )}
                                {activityDetailModal.details.contactedBy && (
                                    <div style={{padding:'12px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{fontSize:'11px',color:'var(--text-muted)',fontWeight:600,marginBottom:'8px'}}>ðŸ‘¤ Contacted By</div>
                                        <div style={{fontSize:'12px',color:'var(--text)'}}>{activityDetailModal.details.contactedBy}</div>
                                    </div>
                                )}
                                {activityDetailModal.details.waitingReply && (
                                    <div style={{padding:'12px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)'}}>
                                        <div style={{fontSize:'12px',color:'var(--blue)',fontWeight:600}}>â³ Waiting on Reply</div>
                                    </div>
                                )}
                                {activityDetailModal.details.inPortUntil && (
                                    <div style={{padding:'12px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)'}}>
                                        <div style={{fontSize:'11px',color:'var(--blue)',fontWeight:600,marginBottom:'8px'}}>âš“ In Port</div>
                                        <div style={{fontSize:'12px',color:'var(--text)'}}>Expected back online: {fmtDate(activityDetailModal.details.inPortUntil)}</div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
            </Modal>
            
            {/* All Activity Modal */}
            <Modal open={showAllActivity} onClose={() => setShowAllActivity(false)} title="All Recent Activity">
                <div style={{maxHeight:'60vh',overflow:'auto'}}>
                    {activityLog.length === 0 ? (
                        <div className="empty">No activity recorded</div>
                    ) : (
                        <div>
                            {Object.entries(activityLog.reduce((acc, a) => {
                                const user = a.user || 'System';
                                if (!acc[user]) acc[user] = [];
                                acc[user].push(a);
                                return acc;
                            }, {})).map(([user, activities]) => (
                                <div key={user} style={{marginBottom:'20px'}}>
                                    <div style={{display:'flex',alignItems:'center',gap:'8px',marginBottom:'12px',paddingBottom:'8px',borderBottom:'1px solid var(--border)'}}>
                                        <span style={{width:'32px',height:'32px',borderRadius:'50%',background:'var(--primary-glow)',border:'2px solid var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'14px',fontWeight:700,color:'var(--primary)'}}>{user.charAt(0).toUpperCase()}</span>
                                        <div>
                                            <div style={{fontWeight:600,fontSize:'13px'}}>{user}</div>
                                            <div style={{fontSize:'10px',color:'var(--text-muted)'}}>{activities.length} actions</div>
                                        </div>
                                    </div>
                                    <div style={{display:'flex',flexDirection:'column',gap:'6px',marginLeft:'40px'}}>
                                        {activities.slice(0, 15).map(a => (
                                            <div key={a.id} onClick={() => { setShowAllActivity(false); setActivityDetailModal(a); }} style={{padding:'8px 12px',background:'var(--bg-input)',borderRadius:'6px',cursor:'pointer',fontSize:'12px',border:'1px solid transparent'}} onMouseOver={e => e.currentTarget.style.borderColor='var(--border)'} onMouseOut={e => e.currentTarget.style.borderColor='transparent'}>
                                                <div style={{marginBottom:'2px'}}>{a.text}</div>
                                                {a.details && (
                                                    <div style={{padding:'6px 8px',background:'var(--bg-card)',borderRadius:'4px',fontSize:'11px',color:'var(--text-dim)',marginTop:'4px'}}>
                                                        {a.details.resolution && <div>â†³ <strong>Resolution:</strong> {a.details.resolution.substring(0, 80)}{a.details.resolution.length > 80 ? '...' : ''}</div>}
                                                        {a.details.reply && <div>â†³ <strong>Reply:</strong> "{a.details.reply.substring(0, 80)}{a.details.reply.length > 80 ? '...' : ''}"</div>}
                                                        {a.details.details && <div>â†³ <strong>Issue:</strong> {a.details.details.substring(0, 80)}{a.details.details.length > 80 ? '...' : ''}</div>}
                                                        {a.details.threat && <span style={{marginRight:'8px'}}>â†³ <strong>Threat:</strong> {a.details.threat}</span>}
                                                        {a.details.notes && <div>â†³ <strong>Notes:</strong> {a.details.notes.substring(0, 80)}{a.details.notes.length > 80 ? '...' : ''}</div>}
                                                        {a.details.contactedBy && <span style={{marginRight:'8px'}}>â†³ <strong>By:</strong> {a.details.contactedBy}</span>}
                                                        {a.details.waitingReply && <span>â†³ Waiting on reply</span>}
                                                        {a.details.inPortUntil && <div>â†³ <strong>Back:</strong> {fmtDate(a.details.inPortUntil)}</div>}
                                                    </div>
                                                )}
                                                <div style={{fontSize:'10px',color:'var(--text-muted)',marginTop:'4px'}}>{new Date(a.time).toLocaleString()}</div>
                                            </div>
                                        ))}
                                        {activities.length > 15 && <div style={{fontSize:'11px',color:'var(--text-muted)',textAlign:'center'}}>... and {activities.length - 15} more</div>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </Modal>
            
            {/* In Port Modal */}
            <Modal open={inPortModal} onClose={() => setInPortModal(false)} title="âš“ Mark Ship In Port">
                {sel && <>
                    <p style={{marginBottom:'16px',color:'var(--text-dim)'}}>Mark <strong>{sel.name}</strong> as in port. This will show the ship as expected offline (green status) until the return date.</p>
                    <div className="form-group">
                        <label className="form-label">Expected Back Online Date *</label>
                        <input type="date" className="form-input" value={inPortDate} onChange={e => setInPortDate(e.target.value)} min={today}/>
                        <p style={{fontSize:'11px',color:'var(--text-muted)',marginTop:'4px'}}>When do you expect the ship to be back online?</p>
                    </div>
                    <div className="btn-group mt-md">
                        <button className="btn btn-primary" style={{background:'var(--blue)'}} onClick={() => {
                            if (!inPortDate) { toast('Please enter a return date', 'error'); return; }
                            const updated = {...sel, inPort: true, inPortUntil: inPortDate};
                            setSel(updated);
                            setShips(p => p.map(s => s.id === sel.id ? updated : s));
                            logActivity(`Marked ${sel.name} as In Port until ${fmtDate(inPortDate)}`, { ship: sel.name, inPortUntil: inPortDate });
                            toast(`${sel.name} marked as In Port`, 'success');
                            setInPortModal(false);
                        }}>âš“ Mark In Port</button>
                        <button className="btn btn-secondary" onClick={() => setInPortModal(false)}>Cancel</button>
                    </div>
                </>}
            </Modal>
            
            <Modal open={clearWaitingModal} onClose={() => setClearWaitingModal(false)} title="Clear Waiting Status">
                {sel && <>
                    <p style={{marginBottom:'16px',color:'var(--text-dim)'}}>Clear waiting status for <strong>{sel.name}</strong></p>
                    <div className="form-group">
                        <label className="form-label">Resolution *</label>
                        <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                            <label style={{display:'flex',alignItems:'center',gap:'8px',cursor:'pointer'}}>
                                <input type="radio" checked={clearWaitingForm.resolution === 'received'} onChange={() => setClearWaitingForm({...clearWaitingForm, resolution: 'received'})}/>
                                <span>Received reply from ship</span>
                            </label>
                            <label style={{display:'flex',alignItems:'center',gap:'8px',cursor:'pointer'}}>
                                <input type="radio" checked={clearWaitingForm.resolution === 'sent_new'} onChange={() => setClearWaitingForm({...clearWaitingForm, resolution: 'sent_new'})}/>
                                <span>Sent new email (no reply yet)</span>
                            </label>
                            <label style={{display:'flex',alignItems:'center',gap:'8px',cursor:'pointer'}}>
                                <input type="radio" checked={clearWaitingForm.resolution === 'not_needed'} onChange={() => setClearWaitingForm({...clearWaitingForm, resolution: 'not_needed'})}/>
                                <span>No response needed</span>
                            </label>
                        </div>
                    </div>
                    {clearWaitingForm.resolution === 'received' && (
                        <div className="form-group">
                            <label className="form-label">Their Reply</label>
                            <textarea className="form-textarea" style={{minHeight:'100px'}} placeholder="Paste or summarize their response..." value={clearWaitingForm.reply} onChange={e => setClearWaitingForm({...clearWaitingForm, reply: e.target.value})}/>
                        </div>
                    )}
                    <div className="btn-group mt-md">
                        <button className="btn btn-primary" onClick={() => {
                            const resolutionText = clearWaitingForm.resolution === 'received' ? 'Reply received' : clearWaitingForm.resolution === 'sent_new' ? 'Sent new email' : 'No response needed';
                            const updated = {...sel, waitingReply: false, lastSaid: clearWaitingForm.resolution === 'received' && clearWaitingForm.reply ? clearWaitingForm.reply : sel.lastSaid};
                            setSel(updated);
                            setShips(p => p.map(s => s.id === sel.id ? updated : s));
                            const details = { ship: sel.name, resolution: resolutionText };
                            if (clearWaitingForm.resolution === 'received' && clearWaitingForm.reply) {
                                details.reply = clearWaitingForm.reply;
                            }
                            logActivity(`Cleared waiting status for ${sel.name} - ${resolutionText}`, details);
                            toast('Waiting status cleared', 'success');
                            setClearWaitingModal(false);
                        }}>Clear Status</button>
                        <button className="btn btn-secondary" onClick={() => setClearWaitingModal(false)}>Cancel</button>
                    </div>
                </>}
            </Modal>
            
            {/* Clear Email Waiting Status Modal */}
            <Modal open={!!clearEmailWaitingModal} onClose={() => setClearEmailWaitingModal(null)} title="ðŸ“‹ Update Email Status">
                {clearEmailWaitingModal && (() => {
                    const f = clearEmailWaitingForm;
                    const setF = (updates) => setClearEmailWaitingForm(prev => ({...prev, ...updates}));
                    const colors = { received: 'var(--green)', waiting_ours: 'var(--amber)', second_email: 'var(--blue)' };
                    const activeColor = colors[f.resolution];
                    return (
                    <>
                        <div style={{padding:'10px 12px',background:'var(--bg-input)',borderRadius:'6px',marginBottom:'16px',display:'flex',justifyContent:'space-between',alignItems:'center',fontSize:'12px'}}>
                            <span><strong>{clearEmailWaitingModal.shipName}</strong></span>
                            <span style={{color:'var(--text-muted)'}}>Original: {new Date(clearEmailWaitingModal.timestamp).toLocaleDateString()}</span>
                        </div>
                        
                        {/* Resolution options - compact tabs */}
                        <div style={{display:'flex',gap:'4px',marginBottom:'16px'}}>
                            {[
                                { key: 'received', icon: 'âœ…', label: 'They Replied' },
                                { key: 'waiting_ours', icon: 'â³', label: 'On Our End' },
                                { key: 'second_email', icon: 'ðŸ“§', label: 'Follow-up Sent' }
                            ].map(opt => (
                                <button key={opt.key} onClick={() => setF({ resolution: opt.key })} style={{
                                    flex:1, padding:'10px 8px', borderRadius:'6px', cursor:'pointer', textAlign:'center',
                                    background: f.resolution === opt.key ? colors[opt.key] + '22' : 'var(--bg-input)',
                                    border: f.resolution === opt.key ? `2px solid ${colors[opt.key]}` : '1px solid var(--border)',
                                    color: f.resolution === opt.key ? colors[opt.key] : 'var(--text-muted)', fontSize:'11px', fontWeight:600, transition:'all 0.15s'
                                }}>
                                    <div style={{fontSize:'16px',marginBottom:'4px'}}>{opt.icon}</div>
                                    {opt.label}
                                </button>
                            ))}
                        </div>

                        {/* Date field - shown for all options */}
                        <div style={{display:'grid',gridTemplateColumns: f.resolution === 'second_email' ? '1fr' : '1fr 1fr',gap:'12px',marginBottom:'12px'}}>
                            <div className="form-group" style={{margin:0}}>
                                <label className="form-label" style={{fontSize:'11px'}}>{f.resolution === 'second_email' ? 'Date Sent' : f.resolution === 'received' ? 'Date Received' : 'Date of Reply'}</label>
                                <input type="date" className="form-input" value={f.date} onChange={e => setF({ date: e.target.value })}/>
                            </div>
                            {f.resolution !== 'second_email' && (
                                <div className="form-group" style={{margin:0}}>
                                    <label className="form-label" style={{fontSize:'11px'}}>Your Name</label>
                                    <input className="form-input" placeholder="Who updated this" value={f.name} onChange={e => setF({ name: e.target.value })}/>
                                </div>
                            )}
                        </div>

                        {/* Follow-up specific fields */}
                        {f.resolution === 'second_email' && (
                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'12px'}}>
                                <div className="form-group" style={{margin:0}}>
                                    <label className="form-label" style={{fontSize:'11px'}}>Your Name *</label>
                                    <input className="form-input" placeholder="Enter your name" value={f.name} onChange={e => setF({ name: e.target.value })}/>
                                </div>
                                <div className="form-group" style={{margin:0}}>
                                    <label className="form-label" style={{fontSize:'11px'}}>&nbsp;</label>
                                    <div style={{padding:'8px 12px',background:'var(--blue-glow)',borderRadius:'6px',fontSize:'11px',color:'var(--blue)',border:'1px solid var(--blue)'}}>â³ Keeps waiting active</div>
                                </div>
                            </div>
                        )}

                        {/* Notes / Email content */}
                        <div className="form-group" style={{margin:'0 0 16px 0'}}>
                            <label className="form-label" style={{fontSize:'11px'}}>{f.resolution === 'second_email' ? 'Follow-up Email Content *' : 'Notes / Reply Summary'}</label>
                            <textarea className="form-textarea" style={{minHeight: f.resolution === 'second_email' ? '100px' : '70px'}} 
                                placeholder={f.resolution === 'second_email' ? 'Paste or summarize the follow-up email...' : f.resolution === 'received' ? 'What did they say?' : 'What needs to happen on our end?'} 
                                value={f.resolution === 'second_email' ? f.followupEmail : f.notes} 
                                onChange={e => f.resolution === 'second_email' ? setF({ followupEmail: e.target.value }) : setF({ notes: e.target.value })}/>
                        </div>

                        <div style={{display:'flex',gap:'8px',justifyContent:'flex-end'}}>
                            <button className="btn btn-secondary" onClick={() => setClearEmailWaitingModal(null)}>Cancel</button>
                            <button className="btn" style={{background: activeColor, color:'#fff'}} onClick={() => {
                                const item = clearEmailWaitingModal;
                                
                                if (f.resolution === 'second_email') {
                                    if (!f.name.trim()) { toast('Please enter your name', 'error'); return; }
                                    if (!f.followupEmail.trim()) { toast('Please enter the follow-up email content', 'error'); return; }
                                }
                                
                                const resText = f.resolution === 'received' ? 'Reply received' 
                                    : f.resolution === 'waiting_ours' ? 'Waiting on our reply'
                                    : `Follow-up sent by ${f.name}`;
                                
                                const entryDate = f.date ? f.date + 'T12:00:00' : new Date().toISOString();
                                
                                const historyEntry = {
                                    id: 'EH' + Date.now(),
                                    shipId: item.shipId,
                                    shipName: item.shipName,
                                    timestamp: entryDate,
                                    type: 'manual',
                                    emailText: f.resolution === 'second_email' ? f.followupEmail : '',
                                    result: {
                                        emailSummary: f.resolution === 'second_email' 
                                            ? `Follow-up email sent by ${f.name}`
                                            : `${resText}${f.notes ? ': ' + f.notes : ''}`,
                                        waitingReply: f.resolution === 'second_email',
                                        sender: f.name ? { name: f.name } : null
                                    },
                                    changes: [resText]
                                };
                                
                                const updatedHistory = emailHistory.map(h => 
                                    h.id === item.id ? { ...h, result: { ...h.result, waitingReply: false } } : h
                                );
                                const newHistory = [historyEntry, ...updatedHistory].slice(0, 100);
                                setEmailHistory(newHistory);
                                localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));
                                
                                if (item.shipId) {
                                    const shouldStillWait = f.resolution === 'second_email';
                                    const shipUpdate = { 
                                        waitingReply: shouldStillWait, 
                                        lastContact: entryDate,
                                        ...(f.name ? { contactedBy: f.name } : {}),
                                        ...(f.resolution === 'second_email' ? { 
                                            lastSaid: `Follow-up sent: ${f.followupEmail.substring(0, 200)}${f.followupEmail.length > 200 ? '...' : ''}`
                                        } : f.notes ? { lastSaid: f.notes.substring(0, 200) } : {})
                                    };
                                    setShips(p => p.map(s => s.id === item.shipId ? { ...s, ...shipUpdate } : s));
                                    if (sel && sel.id === item.shipId) setSel(prev => ({ ...prev, ...shipUpdate }));
                                }
                                
                                logActivity(`Updated ${item.shipName}: ${resText}`, { ship: item.shipName, resolution: resText, notes: f.notes, contactedBy: f.name || null });
                                toast('Status updated', 'success');
                                setClearEmailWaitingModal(null);
                                setClearEmailWaitingForm({ resolution: 'received', notes: '', name: '', followupEmail: '', date: '' });
                            }}>Update Status</button>
                        </div>
                    </>
                    );
                })()}
            </Modal>

            {/* Edit Email Entry Modal */}
            <Modal open={!!editEmailEntry} onClose={() => setEditEmailEntry(null)} title="âœï¸ Edit Email Entry">
                {editEmailEntry && (
                    <>
                        <div style={{padding:'10px 12px',background:'var(--bg-input)',borderRadius:'6px',marginBottom:'16px',fontSize:'12px'}}>
                            <strong>{editEmailEntry.shipName}</strong>
                        </div>
                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'12px'}}>
                            <div className="form-group" style={{margin:0}}>
                                <label className="form-label" style={{fontSize:'11px'}}>Date</label>
                                <input type="date" className="form-input" value={editEmailForm.date} onChange={e => setEditEmailForm({...editEmailForm, date: e.target.value})}/>
                            </div>
                            <div className="form-group" style={{margin:0}}>
                                <label className="form-label" style={{fontSize:'11px'}}>Time</label>
                                <input type="time" className="form-input" value={editEmailForm.time} onChange={e => setEditEmailForm({...editEmailForm, time: e.target.value})}/>
                            </div>
                        </div>
                        <div className="form-group" style={{margin:'0 0 12px 0'}}>
                            <label className="form-label" style={{fontSize:'11px'}}>Contacted By</label>
                            <input className="form-input" placeholder="Name" value={editEmailForm.contactedBy} onChange={e => setEditEmailForm({...editEmailForm, contactedBy: e.target.value})}/>
                        </div>
                        <div className="form-group" style={{margin:'0 0 12px 0'}}>
                            <label className="form-label" style={{fontSize:'11px'}}>Summary</label>
                            <textarea className="form-textarea" style={{minHeight:'70px'}} placeholder="Email summary..." value={editEmailForm.summary} onChange={e => setEditEmailForm({...editEmailForm, summary: e.target.value})}/>
                        </div>
                        <div className="form-group" style={{margin:'0 0 16px 0'}}>
                            <label className="form-label" style={{fontSize:'11px'}}>Full Email Content</label>
                            <textarea className="form-textarea" style={{minHeight:'100px',fontFamily:'JetBrains Mono',fontSize:'11px'}} placeholder="Full email text..." value={editEmailForm.emailText} onChange={e => setEditEmailForm({...editEmailForm, emailText: e.target.value})}/>
                        </div>
                        <div style={{display:'flex',gap:'8px',justifyContent:'flex-end'}}>
                            <button className="btn btn-secondary" onClick={() => setEditEmailEntry(null)}>Cancel</button>
                            <button className="btn btn-primary" onClick={() => {
                                const ts = editEmailForm.date 
                                    ? (editEmailForm.time ? `${editEmailForm.date}T${editEmailForm.time}:00` : `${editEmailForm.date}T12:00:00`)
                                    : editEmailEntry.timestamp;
                                
                                const updated = emailHistory.map(h => h.id === editEmailEntry.id ? {
                                    ...h,
                                    timestamp: ts,
                                    emailText: editEmailForm.emailText,
                                    result: {
                                        ...h.result,
                                        emailSummary: editEmailForm.summary,
                                        sender: editEmailForm.contactedBy ? { name: editEmailForm.contactedBy } : h.result?.sender
                                    }
                                } : h);
                                setEmailHistory(updated);
                                localStorage.setItem('emailParseHistory', JSON.stringify(updated));
                                
                                // Update ship lastContact if this is the most recent entry for this ship
                                const shipEntries = updated.filter(e => e.shipId === editEmailEntry.shipId).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                                if (shipEntries.length > 0 && shipEntries[0].id === editEmailEntry.id) {
                                    const shipUpdate = { 
                                        lastContact: ts,
                                        ...(editEmailForm.contactedBy ? { contactedBy: editEmailForm.contactedBy } : {}),
                                        ...(editEmailForm.summary ? { lastSaid: editEmailForm.summary.substring(0, 200) } : {})
                                    };
                                    setShips(p => p.map(s => s.id === editEmailEntry.shipId ? { ...s, ...shipUpdate } : s));
                                    if (sel && sel.id === editEmailEntry.shipId) setSel(prev => ({ ...prev, ...shipUpdate }));
                                }
                                
                                toast('Entry updated', 'success');
                                setEditEmailEntry(null);
                            }}>Save Changes</button>
                        </div>
                    </>
                )}
            </Modal>
            
            <Modal open={!!resolveIssueModal} onClose={() => setResolveIssueModal(null)} title="Resolve Issue">
                {resolveIssueModal && sel && <>
                    <p style={{marginBottom:'8px',color:'var(--text-dim)'}}>Ship: <strong>{sel.name}</strong></p>
                    <div style={{padding:'10px',background:'var(--bg-input)',borderRadius:'6px',border:'1px solid var(--border)',marginBottom:'16px'}}>
                        <div style={{fontSize:'12px',fontWeight:600,marginBottom:'4px'}}>Issue Details</div>
                        <div style={{fontSize:'12px',color:'var(--text)'}}>{resolveIssueModal.details}</div>
                        <div style={{marginTop:'8px',display:'flex',gap:'6px',alignItems:'center'}}><span className={`badge badge-${resolveIssueModal.threat.toLowerCase()}`}>{resolveIssueModal.threat}</span><span style={{fontSize:'10px',padding:'2px 6px',borderRadius:'4px',fontWeight:600,background: resolveIssueModal.responsibility === 'REAP' ? 'var(--primary-glow)' : 'var(--bg-input)',color: resolveIssueModal.responsibility === 'REAP' ? 'var(--primary)' : 'var(--text-muted)',border: `1px solid ${resolveIssueModal.responsibility === 'REAP' ? 'var(--primary)' : 'var(--border)'}`}}>{resolveIssueModal.responsibility === 'REAP' ? 'ðŸ› ï¸ REAP' : 'ðŸš¢ Ship'}</span></div>
                    </div>
                    <div className="form-group">
                        <label className="form-label">How was this resolved? *</label>
                        <textarea className="form-textarea" style={{minHeight:'100px'}} placeholder="Describe the resolution..." value={resolveNotes} onChange={e => setResolveNotes(e.target.value)}/>
                    </div>
                    <div className="btn-group mt-md">
                        <button className="btn btn-success" onClick={() => {
                            if (!resolveNotes.trim()) { toast('Please describe how the issue was resolved', 'error'); return; }
                            setIssues(p => p.map(x => x.id === resolveIssueModal.id ? {...x, resolved: true, resolvedDate: new Date().toISOString(), resolveNotes: resolveNotes} : x));
                            logActivity(`Resolved issue on ${sel.name}: ${resolveNotes.substring(0, 50)}`, { ship: sel.name, issue: resolveIssueModal.details, resolution: resolveNotes });
                            toast('Issue resolved!', 'success');
                            setResolveIssueModal(null);
                        }}>Mark Resolved</button>
                        <button className="btn btn-secondary" onClick={() => setResolveIssueModal(null)}>Cancel</button>
                    </div>
                </>}
            </Modal>
            
            <Modal open={aiEmailModal} onClose={() => setAiEmailModal(false)} title="ðŸ“§ Smart Email Parser" wide>
                {sel && <>
                    <p style={{marginBottom:'16px',color:'var(--text-dim)'}}>Paste an email about <strong style={{color:'var(--primary)'}}>{sel.name}</strong> and AI will extract status updates automatically.</p>
                    
                    <div className="form-group">
                        <label className="form-label">Email Content *</label>
                        <textarea 
                            className="form-textarea" 
                            style={{minHeight:'150px',fontFamily:'JetBrains Mono',fontSize:'11px'}} 
                            placeholder="Paste the email content here..." 
                            value={aiEmailText} 
                            onChange={e => setAiEmailText(e.target.value)}
                            disabled={aiParsing}
                        />
                    </div>
                    
                    <div style={{padding:'10px',background:'var(--green-glow)',borderRadius:'6px',border:'1px solid var(--green)',marginBottom:'16px'}}>
                        <div style={{display:'flex',alignItems:'center',gap:'8px',marginBottom:'6px'}}>
                            <span style={{fontSize:'14px'}}>ðŸ”’</span>
                            <span style={{fontSize:'11px',fontWeight:600,color:'var(--green)'}}>Local Processing - No Data Sent Externally</span>
                        </div>
                        <div style={{fontSize:'10px',color:'var(--text-muted)'}}>
                            Email parsing happens entirely in your browser. No data is sent to external servers.
                        </div>
                    </div>
                    
                    {!aiResult && (
                        <div className="btn-group">
                            <button className="btn btn-primary" onClick={parseEmailWithAI} disabled={aiParsing || !aiEmailText.trim()} style={{background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
                                {aiParsing ? 'ðŸ”„ Analyzing...' : 'ðŸ“§ Parse Email'}
                            </button>
                            <button className="btn btn-secondary" onClick={() => setAiEmailModal(false)}>Cancel</button>
                        </div>
                    )}
                    
                    {aiResult && (
                        <div style={{marginTop:'16px'}}>
                            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'16px'}}>
                                <div style={{fontSize:'14px',fontWeight:600,color:'var(--primary)'}}>âœ¨ Analysis Results</div>
                                <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                    <span style={{fontSize:'10px',color:'var(--text-muted)'}}>Confidence:</span>
                                    <span style={{padding:'2px 8px',borderRadius:'4px',fontSize:'10px',fontWeight:600,background: aiResult.confidence === 'high' ? 'var(--green)' : aiResult.confidence === 'medium' ? 'var(--amber)' : 'var(--red)',color:'#000'}}>{aiResult.confidence.toUpperCase()}</span>
                                </div>
                            </div>

                            {/* Sender Info */}
                            {(aiResult.sender?.name || aiResult.sender?.email) && (
                                <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'12px',display:'flex',alignItems:'center',gap:'12px'}}>
                                    <div style={{width:'40px',height:'40px',borderRadius:'50%',background:'var(--primary-glow)',border:'2px solid var(--primary)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'16px',fontWeight:700,color:'var(--primary)'}}>{(aiResult.sender.name || 'U').charAt(0).toUpperCase()}</div>
                                    <div style={{flex:1}}>
                                        <div style={{fontWeight:600,fontSize:'13px'}}>{aiResult.sender.title ? `${aiResult.sender.title} ` : ''}{aiResult.sender.name || 'Unknown Sender'}</div>
                                        {aiResult.sender.email && <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{aiResult.sender.email}</div>}
                                        {aiResult.sender.phone && <div style={{fontSize:'11px',color:'var(--primary)'}}>ðŸ“ž {aiResult.sender.phone}</div>}
                                    </div>
                                    {aiResult.tone && (
                                        <span style={{padding:'4px 8px',borderRadius:'4px',fontSize:'10px',background: aiResult.tone === 'urgent' ? 'var(--red)' : aiResult.tone === 'concerned' ? 'var(--amber)' : aiResult.tone === 'positive' ? 'var(--green)' : 'var(--bg-card)',color: aiResult.tone === 'routine' ? 'var(--text-muted)' : '#000'}}>{aiResult.tone.toUpperCase()}</span>
                                    )}
                                </div>
                            )}

                            {/* Subject */}
                            {aiResult.subject && (
                                <div style={{padding:'8px 12px',background:'var(--bg-card)',borderRadius:'6px',marginBottom:'12px',fontSize:'12px'}}>
                                    <span style={{color:'var(--text-muted)'}}>Subject:</span> <strong>{aiResult.subject}</strong>
                                </div>
                            )}

                            <div style={{display:'grid',gap:'10px'}}>
                                {/* Status / In Port */}
                                {(aiResult.status || aiResult.inPort) && (
                                    <div style={{padding:'12px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)'}}>
                                        <div style={{display:'flex',alignItems:'center',gap:'10px'}}>
                                            <span style={{fontSize:'20px'}}>âš“</span>
                                            <div style={{flex:1}}>
                                                <div style={{fontWeight:600,color:'var(--blue)',fontSize:'13px'}}>
                                                    {aiResult.status ? aiResult.status.charAt(0).toUpperCase() + aiResult.status.slice(1).replace('-', ' ') : 'In Port'} Detected
                                                </div>
                                                <div style={{fontSize:'11px',color:'var(--text-muted)'}}>
                                                    {aiResult.inPortUntil ? `Return: ${fmtDate(aiResult.inPortUntil)}` : aiResult.inPortDays ? `Duration: ~${aiResult.inPortDays} days` : 'Duration not specified'}
                                                </div>
                                            </div>
                                            {aiResult.inPortUntil && <div style={{fontSize:'18px',fontWeight:700,color:'var(--blue)',fontFamily:'JetBrains Mono'}}>{fmtDate(aiResult.inPortUntil)}</div>}
                                        </div>
                                    </div>
                                )}

                                {/* Issue */}
                                {aiResult.issue?.hasIssue && (
                                    <div style={{padding:'12px',background: aiResult.issue.threat === 'Urgent' ? 'var(--red-glow)' : 'var(--amber-glow)',borderRadius:'8px',border: `1px solid ${aiResult.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)'}`}}>
                                        <div style={{display:'flex',alignItems:'flex-start',gap:'10px'}}>
                                            <span style={{fontSize:'20px'}}>{aiResult.issue.threat === 'Urgent' ? 'ðŸš¨' : 'âš ï¸'}</span>
                                            <div style={{flex:1}}>
                                                <div style={{display:'flex',alignItems:'center',gap:'8px',marginBottom:'4px'}}>
                                                    <span style={{fontWeight:600,color: aiResult.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)',fontSize:'13px'}}>{aiResult.issue.threat} Issue</span>
                                                    {aiResult.issue.category && <span style={{padding:'2px 6px',borderRadius:'4px',fontSize:'9px',background:'rgba(0,0,0,0.2)',color:'var(--text)'}}>{aiResult.issue.category}</span>}
                                                </div>
                                                {aiResult.issue.title && <div style={{fontWeight:500,fontSize:'12px',marginBottom:'4px'}}>{aiResult.issue.title}</div>}
                                                <div style={{fontSize:'11px',color:'var(--text-dim)'}}>{aiResult.issue.details}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Equipment Mentioned */}
                                {aiResult.equipment?.length > 0 && (
                                    <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'6px',letterSpacing:'0.5px'}}>EQUIPMENT MENTIONED</div>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:'6px'}}>
                                            {aiResult.equipment.map((eq, i) => (
                                                <span key={i} style={{padding:'4px 10px',background:'var(--bg-card)',borderRadius:'4px',fontSize:'11px',fontWeight:500,border:'1px solid var(--border)'}}>{eq}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Response/FYI Status */}
                                <div style={{display:'flex',gap:'10px'}}>
                                    {aiResult.waitingReply && (
                                        <div style={{flex:1,padding:'12px',background:'var(--primary-glow)',borderRadius:'8px',border:'1px solid var(--primary)'}}>
                                            <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                                <span style={{fontSize:'16px'}}>â³</span>
                                                <div>
                                                    <div style={{fontWeight:600,color:'var(--primary)',fontSize:'12px'}}>Response Needed</div>
                                                    <div style={{fontSize:'10px',color:'var(--text-muted)'}}>Contains questions/requests</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {aiResult.isFYI && (
                                        <div style={{flex:1,padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                            <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                                <span style={{fontSize:'16px'}}>ðŸ“‹</span>
                                                <div>
                                                    <div style={{fontWeight:600,fontSize:'12px'}}>FYI Only</div>
                                                    <div style={{fontSize:'10px',color:'var(--text-muted)'}}>No response required</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Action Items */}
                                {aiResult.actionItems?.length > 0 && (
                                    <div style={{padding:'12px',background:'var(--amber-glow)',borderRadius:'8px',border:'1px solid var(--amber)'}}>
                                        <div style={{fontSize:'10px',color:'var(--amber)',marginBottom:'8px',fontWeight:600,letterSpacing:'0.5px'}}>ðŸ“‹ ACTION ITEMS ({aiResult.actionItems.length})</div>
                                        {aiResult.actionItems.slice(0, 3).map((item, i) => (
                                            <div key={i} style={{fontSize:'11px',padding:'6px 0',borderBottom: i < Math.min(2, aiResult.actionItems.length - 1) ? '1px solid var(--border)' : 'none'}}>â€¢ {item}</div>
                                        ))}
                                    </div>
                                )}

                                {/* Dates Found */}
                                {aiResult.extractedDates?.length > 0 && (
                                    <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                                        <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'6px',letterSpacing:'0.5px'}}>ðŸ“… DATES EXTRACTED</div>
                                        <div style={{display:'flex',flexWrap:'wrap',gap:'6px'}}>
                                            {aiResult.extractedDates.slice(0, 4).map((d, i) => (
                                                <span key={i} style={{padding:'4px 10px',background: d.isReturn ? 'var(--blue-glow)' : 'var(--bg-card)',borderRadius:'4px',fontSize:'11px',fontFamily:'JetBrains Mono',border: d.isReturn ? '1px solid var(--blue)' : '1px solid var(--border)'}}>{fmtDate(d.date)}{d.isReturn && ' â†'}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Keywords */}
                                {aiResult.keywords?.length > 0 && (
                                    <div style={{display:'flex',flexWrap:'wrap',gap:'6px',padding:'8px 0'}}>
                                        {aiResult.keywords.map((kw, i) => (
                                            <span key={i} style={{padding:'2px 8px',background:'var(--primary-glow)',borderRadius:'4px',fontSize:'10px',color:'var(--primary)',fontFamily:'JetBrains Mono'}}>{kw}</span>
                                        ))}
                                    </div>
                                )}

                                {/* Summary */}
                                {aiResult.emailSummary && (
                                    <div style={{padding:'12px',background:'linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%)',borderRadius:'8px',border:'1px solid rgba(102,126,234,0.3)'}}>
                                        <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'6px',letterSpacing:'0.5px'}}>ðŸ“ SMART SUMMARY</div>
                                        <div style={{fontSize:'12px',fontWeight:500,lineHeight:'1.5'}}>{aiResult.emailSummary}</div>
                                    </div>
                                )}

                                {/* Classification */}
                                {aiResult.classification && (
                                    <div style={{textAlign:'center',padding:'6px',background:'var(--bg-card)',borderRadius:'4px',fontSize:'10px',fontWeight:700,color:'var(--text-muted)',letterSpacing:'1px'}}>{aiResult.classification}</div>
                                )}
                            </div>

                            <div className="btn-group mt-md">
                                <button className="btn btn-success" onClick={applyAiResult} style={{background:'linear-gradient(135deg, #10b981 0%, #059669 100%)'}}>âœ“ Apply Changes</button>
                                <button className="btn btn-secondary" onClick={() => setAiResult(null)}>ðŸ”„ Re-analyze</button>
                                <button className="btn btn-secondary" onClick={() => setAiEmailModal(false)}>Cancel</button>
                            </div>
                        </div>
                    )}
                </>}
            </Modal>
            
            <Modal open={emailHistoryModal} onClose={() => { setEmailHistoryModal(false); setViewingHistoryItem(null); setManualLogModal(false); }} title={`ðŸ“‹ Email Log - ${sel?.name || 'Ship'}`} wide>
                {!viewingHistoryItem && !manualLogModal ? (
                    <div>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                            <div style={{fontSize:'12px',color:'var(--text-muted)'}}>{emailHistory.filter(h => h.shipId === sel?.id).length} entries for {sel?.name}</div>
                            <button className="btn btn-sm btn-primary" onClick={() => setManualLogModal(true)}>+ Add Manual Entry</button>
                        </div>
                        {emailHistory.filter(h => h.shipId === sel?.id).length === 0 ? (
                            <div className="empty" style={{padding:'40px'}}>No email logs for {sel?.name} yet. Use "ðŸ“§ Parse Email" to auto-analyze or click "Add Manual Entry" above.</div>
                        ) : (
                            <div style={{maxHeight:'400px',overflow:'auto'}}>
                                {emailHistory.filter(h => h.shipId === sel?.id).map(h => (
                                    <div key={h.id} style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'8px',border:'1px solid transparent',transition:'all 0.15s'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
                                            <div onClick={() => setViewingHistoryItem(h)} style={{cursor:'pointer',flex:1}}>
                                                <div style={{fontWeight:600,fontSize:'13px',marginBottom:'4px'}}>
                                                    {new Date(h.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                                    <span className="badge" style={{marginLeft:'8px',background: h.type === 'manual' ? 'var(--text-muted)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'#fff',fontSize:'9px'}}>{h.type === 'manual' ? 'Manual' : 'Parsed'}</span>
                                                </div>
                                                <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{new Date(h.timestamp).toLocaleTimeString()}</div>
                                            </div>
                                            <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                                {h.result?.inPort && <span className="badge" style={{background:'var(--blue)',color:'#fff'}}>âš“ In Port</span>}
                                                {h.result?.issue?.hasIssue && <span className={`badge badge-${(h.result.issue.threat || 'mild').toLowerCase()}`}>Issue</span>}
                                                {h.result?.waitingReply && <span className="badge badge-info">Waiting</span>}
                                                <button className="btn btn-sm btn-danger" style={{padding:'2px 6px',fontSize:'10px'}} onClick={(e) => { e.stopPropagation(); if(confirm('Delete this log entry?')) { const filtered = emailHistory.filter(x => x.id !== h.id); setEmailHistory(filtered); localStorage.setItem('emailParseHistory', JSON.stringify(filtered)); logActivity(`Deleted email log for ${sel?.name || 'Unknown'} from ${fmtDate(h.timestamp)}`); toast('Entry deleted', 'info'); } }}>âœ•</button>
                                            </div>
                                        </div>
                                        {h.result?.emailSummary && <div onClick={() => setViewingHistoryItem(h)} style={{cursor:'pointer',fontSize:'11px',color:'var(--text-dim)',marginTop:'8px',padding:'8px',background:'var(--bg-card)',borderRadius:'4px'}}>{h.result.emailSummary}</div>}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                ) : manualLogModal ? (
                    <div>
                        <button className="btn btn-sm btn-secondary mb-md" onClick={() => setManualLogModal(false)}>â† Back to Log</button>
                        
                        <p style={{marginBottom:'16px',color:'var(--text-dim)'}}>Manually log email info for <strong style={{color:'var(--primary)'}}>{sel?.name || 'selected ship'}</strong></p>
                        
                        <div className="form-group">
                            <label className="form-label">Email Notes / Summary *</label>
                            <textarea className="form-textarea" style={{minHeight:'100px'}} placeholder="What did the email say?" value={manualLogForm.notes} onChange={e => setManualLogForm({...manualLogForm, notes: e.target.value})}/>
                        </div>
                        
                        <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px'}}>
                            <label className="checkbox" style={{marginBottom:'12px'}}>
                                <input type="checkbox" checked={manualLogForm.inPort} onChange={e => setManualLogForm({...manualLogForm, inPort: e.target.checked})}/>
                                âš“ Ship going In Port / Maintenance
                            </label>
                            {manualLogForm.inPort && (
                                <div className="form-group" style={{marginLeft:'24px',marginTop:'8px'}}>
                                    <label className="form-label">Expected Return Date</label>
                                    <input type="date" className="form-input" value={manualLogForm.inPortUntil} onChange={e => setManualLogForm({...manualLogForm, inPortUntil: e.target.value})} min={today}/>
                                </div>
                            )}
                        </div>
                        
                        <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px'}}>
                            <label className="checkbox" style={{marginBottom:'12px'}}>
                                <input type="checkbox" checked={manualLogForm.hasIssue} onChange={e => setManualLogForm({...manualLogForm, hasIssue: e.target.checked})}/>
                                âš ï¸ Issue Reported
                            </label>
                            {manualLogForm.hasIssue && (
                                <div style={{marginLeft:'24px',marginTop:'8px'}}>
                                    <div className="form-group">
                                        <label className="form-label">Threat Level</label>
                                        <div className="radio-group">
                                            <label className="radio urgent"><input type="radio" checked={manualLogForm.issueThreat==='Urgent'} onChange={() => setManualLogForm({...manualLogForm, issueThreat:'Urgent'})}/>Urgent</label>
                                            <label className="radio mild"><input type="radio" checked={manualLogForm.issueThreat==='Mild'} onChange={() => setManualLogForm({...manualLogForm, issueThreat:'Mild'})}/>Mild</label>
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Responsibility</label>
                                        <div style={{display:'flex',gap:'8px'}}>
                                            <button type="button" onClick={() => setManualLogForm({...manualLogForm, issueResponsibility:'REAP'})} style={{flex:1,padding:'6px',borderRadius:'6px',border: manualLogForm.issueResponsibility==='REAP' ? '2px solid var(--primary)' : '1px solid var(--border)',background: manualLogForm.issueResponsibility==='REAP' ? 'var(--primary-glow)' : 'var(--bg-input)',color: manualLogForm.issueResponsibility==='REAP' ? 'var(--primary)' : 'var(--text-muted)',fontSize:'11px',fontWeight:600,cursor:'pointer'}}>ðŸ› ï¸ REAP</button>
                                            <button type="button" onClick={() => setManualLogForm({...manualLogForm, issueResponsibility:'Ship'})} style={{flex:1,padding:'6px',borderRadius:'6px',border: manualLogForm.issueResponsibility==='Ship' ? '2px solid var(--amber)' : '1px solid var(--border)',background: manualLogForm.issueResponsibility==='Ship' ? 'var(--amber-glow)' : 'var(--bg-input)',color: manualLogForm.issueResponsibility==='Ship' ? 'var(--amber)' : 'var(--text-muted)',fontSize:'11px',fontWeight:600,cursor:'pointer'}}>ðŸš¢ Ship</button>
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Issue Details</label>
                                        <input className="form-input" placeholder="Brief description..." value={manualLogForm.issueDetails} onChange={e => setManualLogForm({...manualLogForm, issueDetails: e.target.value})}/>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <label className="checkbox" style={{marginBottom:'16px'}}>
                            <input type="checkbox" checked={manualLogForm.waitingReply} onChange={e => setManualLogForm({...manualLogForm, waitingReply: e.target.checked})}/>
                            â³ Waiting on reply from us
                        </label>
                        
                        <div className="btn-group">
                            <button className="btn btn-primary" onClick={() => {
                                if (!sel) { toast('Select a ship first', 'error'); return; }
                                if (!manualLogForm.notes.trim()) { toast('Please enter email notes', 'error'); return; }
                                
                                let updated = {...sel};
                                const changes = [];
                                
                                updated.lastSaid = manualLogForm.notes;
                                updated.lastContact = toDateString(new Date());
                                changes.push('Updated email notes');
                                
                                if (manualLogForm.inPort && manualLogForm.inPortUntil) {
                                    updated.inPort = true;
                                    updated.inPortUntil = manualLogForm.inPortUntil;
                                    changes.push(`In Port until ${fmtDate(manualLogForm.inPortUntil)}`);
                                }
                                
                                if (manualLogForm.waitingReply) {
                                    updated.waitingReply = true;
                                    changes.push('Waiting on reply');
                                }
                                
                                setSel(updated);
                                setShips(p => p.map(s => s.id === sel.id ? updated : s));
                                
                                if (manualLogForm.hasIssue && manualLogForm.issueDetails) {
                                    setIssues(p => [...p, {
                                        id: genId('I'),
                                        shipId: sel.id,
                                        shipName: sel.name,
                                        threat: manualLogForm.issueThreat,
                                        details: manualLogForm.issueDetails,
                                        responsibility: manualLogForm.issueResponsibility,
                                        created: new Date().toISOString(),
                                        resolved: false
                                    }]);
                                    changes.push(`Added ${manualLogForm.issueThreat} issue`);
                                }
                                
                                // Save to unified history
                                const historyEntry = {
                                    id: genId('EH'),
                                    type: 'manual',
                                    shipId: sel.id,
                                    shipName: sel.name,
                                    timestamp: new Date().toISOString(),
                                    emailText: manualLogForm.notes,
                                    result: {
                                        inPort: manualLogForm.inPort,
                                        inPortUntil: manualLogForm.inPortUntil,
                                        issue: manualLogForm.hasIssue ? { hasIssue: true, threat: manualLogForm.issueThreat, details: manualLogForm.issueDetails, responsibility: manualLogForm.issueResponsibility } : { hasIssue: false },
                                        emailSummary: manualLogForm.notes,
                                        waitingReply: manualLogForm.waitingReply
                                    },
                                    changes: changes
                                };
                                const newHistory = [historyEntry, ...emailHistory].slice(0, 50);
                                setEmailHistory(newHistory);
                                localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));
                                
                                logActivity(`Manual log for ${sel.name}: ${changes.join(', ')}`, { ship: sel.name, notes: manualLogForm.notes });
                                toast(`Logged: ${changes.join(', ')}`, 'success');
                                setManualLogModal(false);
                                setManualLogForm({ notes: '', inPort: false, inPortUntil: '', hasIssue: false, issueThreat: 'Mild', issueDetails: '', issueResponsibility: 'Ship', waitingReply: false });
                            }}>ðŸ’¾ Save Entry</button>
                            <button className="btn btn-secondary" onClick={() => setManualLogModal(false)}>Cancel</button>
                        </div>
                    </div>
                ) : (
                    <div>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                            <button className="btn btn-sm btn-secondary" onClick={() => setViewingHistoryItem(null)}>â† Back to Log</button>
                        </div>
                        
                        <div style={{padding:'16px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px',position:'relative'}}>
                            <button className="btn btn-sm btn-danger" style={{position:'absolute',top:'12px',right:'12px',padding:'4px 8px',fontSize:'10px'}} onClick={() => { if(confirm('Delete this log entry?')) { const filtered = emailHistory.filter(x => x.id !== viewingHistoryItem.id); setEmailHistory(filtered); localStorage.setItem('emailParseHistory', JSON.stringify(filtered)); logActivity(`Deleted email log for ${sel?.name || 'Unknown'} from ${fmtDate(viewingHistoryItem.timestamp)}`); setViewingHistoryItem(null); toast('Entry deleted', 'info'); } }}>ðŸ—‘ï¸ Delete</button>
                            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px',paddingRight:'80px'}}>
                                <div>
                                    <div style={{fontWeight:600,fontSize:'14px'}}>{new Date(viewingHistoryItem.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</div>
                                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{new Date(viewingHistoryItem.timestamp).toLocaleTimeString()}</div>
                                </div>
                                <div>
                                    <span className="badge" style={{background: viewingHistoryItem.type === 'manual' ? 'var(--text-muted)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'#fff',marginRight:'4px'}}>{viewingHistoryItem.type === 'manual' ? 'Manual' : 'Parsed'}</span>
                                    {viewingHistoryItem.result?.inPort && <span className="badge" style={{background:'var(--blue)',color:'#fff',marginRight:'4px'}}>âš“ In Port</span>}
                                    {viewingHistoryItem.result?.issue?.hasIssue && <span className={`badge badge-${(viewingHistoryItem.result.issue.threat || 'mild').toLowerCase()}`}>{viewingHistoryItem.result.issue.threat}</span>}
                                    {viewingHistoryItem.result?.waitingReply && <span className="badge badge-info" style={{marginLeft:'4px'}}>Waiting</span>}
                                </div>
                            </div>
                            {viewingHistoryItem.changes?.length > 0 && (
                                <div style={{fontSize:'11px',color:'var(--green)'}}>Changes applied: {viewingHistoryItem.changes.join(', ')}</div>
                            )}
                        </div>
                        
                        <div style={{marginBottom:'16px'}}>
                            <div style={{fontSize:'11px',fontWeight:600,color:'var(--text-muted)',marginBottom:'8px'}}>ORIGINAL EMAIL</div>
                            <div style={{padding:'12px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)',fontSize:'11px',fontFamily:'JetBrains Mono',whiteSpace:'pre-wrap',maxHeight:'200px',overflow:'auto'}}>{viewingHistoryItem.emailText}</div>
                        </div>
                        
                        {viewingHistoryItem.result?.emailSummary && (
                            <div style={{marginBottom:'16px'}}>
                                <div style={{fontSize:'11px',fontWeight:600,color:'var(--text-muted)',marginBottom:'8px'}}>PARSED SUMMARY</div>
                                <div style={{padding:'12px',background:'var(--primary-glow)',borderRadius:'8px',border:'1px solid var(--primary)',fontSize:'12px'}}>{viewingHistoryItem.result.emailSummary}</div>
                            </div>
                        )}
                        
                        {viewingHistoryItem.result?.issue?.details && (
                            <div>
                                <div style={{fontSize:'11px',fontWeight:600,color:'var(--text-muted)',marginBottom:'8px'}}>DETECTED ISSUE</div>
                                <div style={{padding:'12px',background: viewingHistoryItem.result.issue.threat === 'Urgent' ? 'var(--red-glow)' : 'var(--amber-glow)',borderRadius:'8px',border: `1px solid ${viewingHistoryItem.result.issue.threat === 'Urgent' ? 'var(--red)' : 'var(--amber)'}`,fontSize:'12px'}}>{viewingHistoryItem.result.issue.details}</div>
                            </div>
                        )}
                    </div>
                )}
            </Modal>

            {/* Direct Manual Email Entry Modal */}
            <Modal open={directManualModal} onClose={() => setDirectManualModal(false)} title={`ðŸ“ Log Email - ${sel?.name || 'Ship'}`}>
                {sel && (
                    <div>
                        <p style={{marginBottom:'16px',color:'var(--text-dim)'}}>Log email info for <strong style={{color:'var(--primary)'}}>{sel.name}</strong></p>

                        <div className="form-group">
                            <label className="form-label">Full Email Content *</label>
                            <textarea className="form-textarea" style={{minHeight:'150px',fontFamily:'JetBrains Mono',fontSize:'11px'}} placeholder="Paste the full email content here..." value={manualLogForm.notes} onChange={e => setManualLogForm({...manualLogForm, notes: e.target.value})}/>
                        </div>

                        <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px'}}>
                            <label className="checkbox" style={{marginBottom:'12px'}}>
                                <input type="checkbox" checked={manualLogForm.inPort} onChange={e => setManualLogForm({...manualLogForm, inPort: e.target.checked})}/>
                                âš“ Ship going In Port / Maintenance
                            </label>
                            {manualLogForm.inPort && (
                                <div className="form-group" style={{marginLeft:'24px',marginTop:'8px'}}>
                                    <label className="form-label">Expected Return Date</label>
                                    <input type="date" className="form-input" value={manualLogForm.inPortUntil} onChange={e => setManualLogForm({...manualLogForm, inPortUntil: e.target.value})} min={today}/>
                                </div>
                            )}
                        </div>

                        <div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'16px'}}>
                            <label className="checkbox" style={{marginBottom:'12px'}}>
                                <input type="checkbox" checked={manualLogForm.hasIssue} onChange={e => setManualLogForm({...manualLogForm, hasIssue: e.target.checked})}/>
                                âš ï¸ Issue Reported
                            </label>
                            {manualLogForm.hasIssue && (
                                <div style={{marginLeft:'24px',marginTop:'8px'}}>
                                    <div className="form-group">
                                        <label className="form-label">Threat Level</label>
                                        <div className="radio-group">
                                            <label className="radio urgent"><input type="radio" checked={manualLogForm.issueThreat==='Urgent'} onChange={() => setManualLogForm({...manualLogForm, issueThreat:'Urgent'})}/>Urgent</label>
                                            <label className="radio mild"><input type="radio" checked={manualLogForm.issueThreat==='Mild'} onChange={() => setManualLogForm({...manualLogForm, issueThreat:'Mild'})}/>Mild</label>
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Responsibility</label>
                                        <div style={{display:'flex',gap:'8px'}}>
                                            <button type="button" onClick={() => setManualLogForm({...manualLogForm, issueResponsibility:'REAP'})} style={{flex:1,padding:'6px',borderRadius:'6px',border: manualLogForm.issueResponsibility==='REAP' ? '2px solid var(--primary)' : '1px solid var(--border)',background: manualLogForm.issueResponsibility==='REAP' ? 'var(--primary-glow)' : 'var(--bg-input)',color: manualLogForm.issueResponsibility==='REAP' ? 'var(--primary)' : 'var(--text-muted)',fontSize:'11px',fontWeight:600,cursor:'pointer'}}>ðŸ› ï¸ REAP</button>
                                            <button type="button" onClick={() => setManualLogForm({...manualLogForm, issueResponsibility:'Ship'})} style={{flex:1,padding:'6px',borderRadius:'6px',border: manualLogForm.issueResponsibility==='Ship' ? '2px solid var(--amber)' : '1px solid var(--border)',background: manualLogForm.issueResponsibility==='Ship' ? 'var(--amber-glow)' : 'var(--bg-input)',color: manualLogForm.issueResponsibility==='Ship' ? 'var(--amber)' : 'var(--text-muted)',fontSize:'11px',fontWeight:600,cursor:'pointer'}}>ðŸš¢ Ship</button>
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Issue Details</label>
                                        <input className="form-input" placeholder="Brief description..." value={manualLogForm.issueDetails} onChange={e => setManualLogForm({...manualLogForm, issueDetails: e.target.value})}/>
                                    </div>
                                </div>
                            )}
                        </div>

                        <label className="checkbox" style={{marginBottom:'16px'}}>
                            <input type="checkbox" checked={manualLogForm.waitingReply} onChange={e => setManualLogForm({...manualLogForm, waitingReply: e.target.checked})}/>
                            â³ Waiting on reply from ship
                        </label>

                        <div className="btn-group">
                            <button className="btn btn-primary" onClick={() => {
                                if (!sel) { toast('Select a ship first', 'error'); return; }
                                if (!manualLogForm.notes.trim()) { toast('Please enter email content', 'error'); return; }

                                let updated = {...sel};
                                const changes = [];

                                updated.lastSaid = manualLogForm.notes;
                                updated.lastContact = toDateString(new Date());
                                changes.push('Logged email');

                                if (manualLogForm.inPort && manualLogForm.inPortUntil) {
                                    updated.inPort = true;
                                    updated.inPortUntil = manualLogForm.inPortUntil;
                                    changes.push(`In port until ${fmtDate(manualLogForm.inPortUntil)}`);
                                }

                                if (manualLogForm.hasIssue && manualLogForm.issueDetails) {
                                    const newIssue = { id: genId('I'), shipId: sel.id, threat: manualLogForm.issueThreat, details: manualLogForm.issueDetails, responsibility: manualLogForm.issueResponsibility, created: toDateString(new Date()), resolved: false };
                                    setIssues(p => [...p, newIssue]);
                                    changes.push(`Added ${manualLogForm.issueThreat} issue`);
                                }

                                if (manualLogForm.waitingReply) {
                                    updated.waitingReply = true;
                                    changes.push('Waiting on reply');
                                }

                                setSel(updated);
                                setShips(p => p.map(s => s.id === updated.id ? updated : s));

                                const historyEntry = {
                                    id: genId('EH'),
                                    shipId: sel.id,
                                    shipName: sel.name,
                                    timestamp: new Date().toISOString(),
                                    type: 'manual',
                                    emailText: manualLogForm.notes,
                                    result: {
                                        emailSummary: manualLogForm.notes.substring(0, 200) + (manualLogForm.notes.length > 200 ? '...' : ''),
                                        inPort: manualLogForm.inPort,
                                        inPortUntil: manualLogForm.inPortUntil,
                                        issue: manualLogForm.hasIssue ? { hasIssue: true, threat: manualLogForm.issueThreat, details: manualLogForm.issueDetails, responsibility: manualLogForm.issueResponsibility } : { hasIssue: false },
                                        waitingReply: manualLogForm.waitingReply
                                    },
                                    changes: changes
                                };
                                const newHistory = [historyEntry, ...emailHistory].slice(0, 100);
                                setEmailHistory(newHistory);
                                localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));

                                logActivity(`Logged email for ${sel.name}`, { ship: sel.name, changes });
                                toast('Email logged successfully', 'success');
                                setManualLogForm({ notes: '', inPort: false, inPortUntil: '', hasIssue: false, issueThreat: 'Mild', issueDetails: '', issueResponsibility: 'Ship', waitingReply: false });
                                setDirectManualModal(false);
                            }}>Save Email Log</button>
                            <button className="btn btn-secondary" onClick={() => setDirectManualModal(false)}>Cancel</button>
                        </div>
                    </div>
                )}
            </Modal>
        </div>
    );
}

function DailyChecks({ ships, checks, setChecks, toast, logActivity }) {
    const [date, setDate] = useState(toDateString(new Date()));
    const [bulkPasteModal, setBulkPasteModal] = useState(false);
    const [bulkPasteText, setBulkPasteText] = useState('');
    const [bulkPasteType, setBulkPasteType] = useState('am');
    const [viewMode, setViewMode] = useState('table'); // 'table' or 'cards'
    const inputRefs = useRef({});

    const customOrder = [67, 70, 54, 56, 62, 63, 55, 57, 72, 77, 96, 98, 101, 103, 109, 111];
    const sorted = useMemo(() => [...ships].sort((a, b) => {
        const aNum = hullNum(a.name), bNum = hullNum(b.name);
        const aIdx = customOrder.indexOf(aNum), bIdx = customOrder.indexOf(bNum);
        if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
        if (aIdx !== -1) return -1;
        if (bIdx !== -1) return 1;
        return aNum - bNum;
    }), [ships]);

    const getCheck = (id, d = date) => checks.find(c => c.shipId === id && c.date === d) || { id: genId('DC'), shipId: id, date: d, pingAM: '', pingPM: '', hdSpace: '', statusAM: true, statusPM: true, notes: '' };

    // Get yesterday's check for comparison
    const getYesterdayCheck = (id) => {
        const yesterday = parseLocalDate(date); yesterday.setDate(yesterday.getDate() - 1);
        return checks.find(c => c.shipId === id && c.date === toDateString(yesterday));
    };

    const update = (id, field, val) => {
        const ship = ships.find(s => s.id === id);
        const shipName = ship?.name || 'Unknown';

        if (field === 'statusAM' || field === 'statusPM') {
            const period = field === 'statusAM' ? 'Primary' : 'Alternate';
            logActivity(`${shipName} ${period} marked ${val ? 'Online' : 'Offline'}`, { ship: shipName, date, field, value: val });
        }

        setChecks(p => {
            const ex = p.find(c => c.shipId === id && c.date === date);
            if (ex) return p.map(c => (c.shipId === id && c.date === date) ? {...c, [field]: val} : c);
            return [...p, { id: genId('DC'), shipId: id, date, pingAM: '', pingPM: '', hdSpace: '', statusAM: true, statusPM: true, notes: '', [field]: val }];
        });
    };

    // Bulk mark all online/offline
    const bulkMark = (field, value) => {
        sorted.forEach(s => update(s.id, field, value));
        const period = field === 'statusAM' ? 'AM' : 'PM';
        logActivity(`Bulk marked all ships ${period} ${value ? 'Online' : 'Offline'}`);
        toast(`All ships marked ${value ? 'Online' : 'Offline'} for ${period}`, 'success');
    };

    // Parse bulk paste input
    const parseBulkPaste = () => {
        const lines = bulkPasteText.trim().split('\n');
        let matched = 0;

        lines.forEach(line => {
            // Try to match patterns like "DDG67: 245ms" or "67 - 245" or just "245"
            const pingMatch = line.match(/(\d+)\s*(?:ms)?/);
            const hullMatch = line.match(/(?:DDG|CG)?(\d{2,3})/i);

            if (pingMatch) {
                const pingVal = pingMatch[1];
                let shipId = null;

                if (hullMatch) {
                    const ship = ships.find(s => s.name.includes(hullMatch[1]));
                    if (ship) shipId = ship.id;
                } else {
                    // If no hull found, assign to ships in order
                    const idx = matched;
                    if (sorted[idx]) shipId = sorted[idx].id;
                }

                if (shipId) {
                    const field = bulkPasteType === 'am' ? 'pingAM' : bulkPasteType === 'pm' ? 'pingPM' : 'hdSpace';
                    update(shipId, field, pingVal);
                    matched++;
                }
            }
        });

        logActivity(`Bulk pasted ${matched} ${bulkPasteType.toUpperCase()} values`);
        toast(`Updated ${matched} ships`, 'success');
        setBulkPasteModal(false);
        setBulkPasteText('');
    };

    const copyYesterday = () => {
        const yesterday = parseLocalDate(date); yesterday.setDate(yesterday.getDate() - 1);
        const ydStr = toDateString(yesterday);
        const ydChecks = checks.filter(c => c.date === ydStr);
        if (ydChecks.length === 0) { toast('No data from yesterday', 'error'); return; }
        let copied = 0;
        ydChecks.forEach(yc => {
            const exists = checks.find(c => c.shipId === yc.shipId && c.date === date);
            if (!exists) {
                setChecks(p => [...p, { ...yc, id: genId('DC'), date }]);
                copied++;
            }
        });
        logActivity(`Copied ${copied} checks from ${ydStr}`);
        toast(`Copied ${copied} entries from yesterday`, 'success');
    };

    const exportStatus = () => {
        let r = `REAP Status Report - ${parseLocalDate(date).toLocaleDateString('en-US', {weekday:'short',month:'short',day:'numeric',year:'numeric'})}\n${'â”€'.repeat(40)}\n\n`;
        sorted.forEach(s => { const c = getCheck(s.id); let st = 'Up'; if (!c.statusAM && !c.statusPM) st = 'Down'; else if (c.statusAM && !c.statusPM) st = 'Up / Down'; else if (!c.statusAM && c.statusPM) st = 'Down / Up'; r += `${s.name} - ${st}\n`; });
        navigator.clipboard.writeText(r);
        logActivity(`Exported daily status report for ${date}`);
        toast('Status report copied!', 'success');
    };

    const exportForExcel = () => {
        const fullReapOrder = [67, 70, 54, 56, 62, 63];
        const miniReapOrder = [55, 57, 72, 77, 96, 98, 101, 103, 109, 111];
        const getRow = (hullNum) => {
            const ship = ships.find(s => s.name.includes(hullNum.toString()));
            if (!ship) return '0\t0\t0';
            const c = getCheck(ship.id);
            return `${c.pingAM || '0'}\t${c.pingPM || '0'}\t${c.hdSpace || '0'}`;
        };
        let fullReap = fullReapOrder.map(h => getRow(h)).join('\n');
        const headerRow1 = '\t\t', headerRow2 = '\t\t', headerRow3 = 'AM\tPM\tDaily';
        let miniReap = miniReapOrder.map(h => getRow(h)).join('\n');
        const output = `${fullReap}\n${headerRow1}\n${headerRow2}\n${headerRow3}\n${miniReap}`;
        navigator.clipboard.writeText(output);
        logActivity(`Exported daily checks for Excel on ${date}`);
        toast('Copied! Paste at CG67 AM column', 'success');
    };

    const isAbnormal = (val, type) => {
        const num = parseInt(val);
        if (isNaN(num)) return '';
        if (type === 'ping' && num > 500) return 'danger';
        if (type === 'ping' && num > 300) return 'warning';
        if (type === 'hd' && num < 100) return 'danger';
        if (type === 'hd' && num < 200) return 'warning';
        return '';
    };

    // Get trend indicator compared to yesterday
    const getTrend = (current, yesterday, type) => {
        const curr = parseInt(current), yest = parseInt(yesterday);
        if (isNaN(curr) || isNaN(yest)) return null;
        const diff = curr - yest;
        if (type === 'ping') {
            if (diff > 50) return { dir: 'up', bad: true, diff };
            if (diff < -50) return { dir: 'down', bad: false, diff };
        } else {
            if (diff < -20) return { dir: 'down', bad: true, diff };
            if (diff > 20) return { dir: 'up', bad: false, diff };
        }
        return null;
    };

    // Mini sparkline component
    const Sparkline = ({ data, type }) => {
        const values = data.map(d => parseInt(d) || 0).filter(v => v > 0);
        if (values.length < 2) return null;
        const max = Math.max(...values), min = Math.min(...values);
        const range = max - min || 1;
        const width = 50, height = 16;
        const points = values.map((v, i) => `${(i / (values.length - 1)) * width},${height - ((v - min) / range) * height}`).join(' ');
        const color = type === 'ping' ? (values[values.length-1] > 300 ? 'var(--red)' : 'var(--green)') : (values[values.length-1] < 200 ? 'var(--amber)' : 'var(--green)');
        return <svg width={width} height={height} style={{marginLeft:'4px'}}><polyline points={points} fill="none" stroke={color} strokeWidth="1.5"/></svg>;
    };

    // Calculate stats
    const stats = useMemo(() => {
        const todayChecks = checks.filter(c => c.date === date);
        const online = todayChecks.filter(c => c.statusAM && c.statusPM).length;
        const partial = todayChecks.filter(c => (c.statusAM && !c.statusPM) || (!c.statusAM && c.statusPM)).length;
        const offline = todayChecks.filter(c => !c.statusAM && !c.statusPM).length;
        const noData = ships.length - todayChecks.length;
        const inPort = ships.filter(s => s.inPort && parseLocalDate(s.inPortUntil) >= new Date(new Date().setHours(0,0,0,0))).length;

        const pingsAM = todayChecks.map(c => parseInt(c.pingAM)).filter(n => !isNaN(n) && n > 0);
        const pingsPM = todayChecks.map(c => parseInt(c.pingPM)).filter(n => !isNaN(n) && n > 0);
        const avgPingAM = pingsAM.length ? Math.round(pingsAM.reduce((a,b) => a+b, 0) / pingsAM.length) : 0;
        const avgPingPM = pingsPM.length ? Math.round(pingsPM.reduce((a,b) => a+b, 0) / pingsPM.length) : 0;

        const highPing = todayChecks.filter(c => parseInt(c.pingAM) > 300 || parseInt(c.pingPM) > 300).length;
        const lowDisk = todayChecks.filter(c => parseInt(c.hdSpace) < 200).length;

        return { online, partial, offline, noData, inPort, avgPingAM, avgPingPM, highPing, lowDisk, total: todayChecks.length };
    }, [checks, date, ships]);

    // Get row status for coloring
    const getRowStatus = (ship, check) => {
        const isInPort = ship.inPort && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0));
        if (isInPort) return 'inport';
        if (!check.statusAM && !check.statusPM) return 'offline';
        if (!check.statusAM || !check.statusPM) return 'partial';
        if (parseInt(check.pingAM) > 500 || parseInt(check.pingPM) > 500 || parseInt(check.hdSpace) < 100) return 'alert';
        return 'online';
    };

    // Keyboard navigation
    const handleKeyDown = (e, shipId, field, shipIndex) => {
        if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            const fields = ['pingAM', 'pingPM', 'hdSpace'];
            const fieldIndex = fields.indexOf(field);
            let nextShipIndex = shipIndex;
            let nextFieldIndex = fieldIndex + 1;

            if (nextFieldIndex >= fields.length) {
                nextFieldIndex = 0;
                nextShipIndex = shipIndex + 1;
            }

            if (nextShipIndex < sorted.length) {
                const nextShip = sorted[nextShipIndex];
                const nextField = fields[nextFieldIndex];
                const refKey = `${nextShip.id}-${nextField}`;
                if (inputRefs.current[refKey]) {
                    inputRefs.current[refKey].focus();
                    inputRefs.current[refKey].select();
                }
            }
        }
    };

    return (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left">
                    <h1 className="page-title">Daily Checks</h1>
                    <p className="page-sub">Fleet status monitoring â€¢ {parseLocalDate(date).toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'})}</p>
                </div>
                <div className="btn-group">
                    <button className={`btn btn-sm ${viewMode === 'table' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('table')}>Table</button>
                    <button className={`btn btn-sm ${viewMode === 'cards' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setViewMode('cards')}>Cards</button>
                    <button className="btn btn-secondary" onClick={() => window.print()}><Icon name="print"/></button>
                </div>
            </div>

            {/* Status Dashboard Cards */}
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(140px, 1fr))',gap:'12px',marginBottom:'16px'}}>
                <div style={{padding:'16px',background:'var(--green-glow)',borderRadius:'8px',border:'1px solid var(--green)',textAlign:'center'}}>
                    <div style={{fontSize:'28px',fontWeight:700,color:'var(--green)'}}>{stats.online}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>ONLINE</div>
                </div>
                <div style={{padding:'16px',background: stats.partial > 0 ? 'var(--amber-glow)' : 'var(--bg-card)',borderRadius:'8px',border:`1px solid ${stats.partial > 0 ? 'var(--amber)' : 'var(--border)'}`,textAlign:'center'}}>
                    <div style={{fontSize:'28px',fontWeight:700,color: stats.partial > 0 ? 'var(--amber)' : 'var(--text-muted)'}}>{stats.partial}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>PARTIAL</div>
                </div>
                <div style={{padding:'16px',background: stats.offline > 0 ? 'var(--red-glow)' : 'var(--bg-card)',borderRadius:'8px',border:`1px solid ${stats.offline > 0 ? 'var(--red)' : 'var(--border)'}`,textAlign:'center'}}>
                    <div style={{fontSize:'28px',fontWeight:700,color: stats.offline > 0 ? 'var(--red)' : 'var(--text-muted)'}}>{stats.offline}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>OFFLINE</div>
                </div>
                <div style={{padding:'16px',background:'var(--blue-glow)',borderRadius:'8px',border:'1px solid var(--blue)',textAlign:'center'}}>
                    <div style={{fontSize:'28px',fontWeight:700,color:'var(--blue)'}}>{stats.inPort}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>IN PORT</div>
                </div>
                <div style={{padding:'16px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)',textAlign:'center'}}>
                    <div style={{fontSize:'20px',fontWeight:700,color:'var(--text)'}}>{stats.avgPingAM}<span style={{fontSize:'11px',color:'var(--text-muted)'}}> / </span>{stats.avgPingPM}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>AVG PING (AM/PM)</div>
                </div>
                <div style={{padding:'16px',background: stats.highPing > 0 || stats.lowDisk > 0 ? 'var(--amber-glow)' : 'var(--bg-card)',borderRadius:'8px',border:`1px solid ${stats.highPing > 0 || stats.lowDisk > 0 ? 'var(--amber)' : 'var(--border)'}`,textAlign:'center'}}>
                    <div style={{fontSize:'20px',fontWeight:700,color: stats.highPing > 0 || stats.lowDisk > 0 ? 'var(--amber)' : 'var(--text-muted)'}}>{stats.highPing + stats.lowDisk}</div>
                    <div style={{fontSize:'11px',color:'var(--text-muted)'}}>ALERTS</div>
                </div>
            </div>

            {/* Alerts Panel */}
            {(stats.highPing > 0 || stats.lowDisk > 0) && (
                <div style={{padding:'12px',background:'var(--amber-glow)',borderRadius:'8px',border:'1px solid var(--amber)',marginBottom:'16px'}}>
                    <div style={{fontWeight:600,color:'var(--amber)',marginBottom:'8px'}}>âš ï¸ Alerts</div>
                    <div style={{display:'flex',gap:'16px',flexWrap:'wrap',fontSize:'12px'}}>
                        {sorted.filter(s => { const c = getCheck(s.id); return parseInt(c.pingAM) > 300 || parseInt(c.pingPM) > 300; }).map(s => {
                            const c = getCheck(s.id);
                            return <span key={s.id} style={{color:'var(--text)'}}><strong>{s.name}</strong>: High ping ({c.pingAM || c.pingPM}ms)</span>;
                        })}
                        {sorted.filter(s => { const c = getCheck(s.id); return parseInt(c.hdSpace) < 200 && parseInt(c.hdSpace) > 0; }).map(s => {
                            const c = getCheck(s.id);
                            return <span key={s.id} style={{color:'var(--text)'}}><strong>{s.name}</strong>: Low disk ({c.hdSpace}GB)</span>;
                        })}
                    </div>
                </div>
            )}

            {/* Controls */}
            <div className="card">
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'12px'}}>
                    <div style={{display:'flex',gap:'8px',alignItems:'center',flexWrap:'wrap'}}>
                        <span style={{fontWeight:600,color:'var(--primary)',fontSize:'12px'}}>DATE:</span>
                        <input type="date" className="form-input" style={{width:'auto'}} value={date} onChange={e => setDate(e.target.value)}/>
                        <button className="btn btn-sm btn-secondary" onClick={() => { const d = parseLocalDate(date); d.setDate(d.getDate()-1); setDate(toDateString(d)); }}>â†</button>
                        <button className="btn btn-sm btn-secondary" onClick={() => { const d = parseLocalDate(date); d.setDate(d.getDate()+1); setDate(toDateString(d)); }}>â†’</button>
                        <button className="btn btn-sm btn-primary" onClick={() => setDate(toDateString(new Date()))}>Today</button>
                    </div>
                    <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
                        <button className="btn btn-sm btn-secondary" onClick={() => setBulkPasteModal(true)}>ðŸ“‹ Bulk Paste</button>
                        <button className="btn btn-sm btn-warning" onClick={copyYesterday}>Copy Yesterday</button>
                        <button className="btn btn-sm btn-success" onClick={exportForExcel}>ðŸ“Š Excel</button>
                        <button className="btn btn-sm btn-secondary" onClick={exportStatus}>Report</button>
                    </div>
                </div>

                {/* Quick Mark Buttons */}
                <div style={{display:'flex',gap:'8px',marginTop:'12px',paddingTop:'12px',borderTop:'1px solid var(--border)',flexWrap:'wrap'}}>
                    <span style={{fontSize:'11px',color:'var(--text-muted)',alignSelf:'center'}}>Quick Mark:</span>
                    <button className="btn btn-sm" style={{background:'var(--green)',color:'#fff'}} onClick={() => bulkMark('statusAM', true)}>All AM Online</button>
                    <button className="btn btn-sm" style={{background:'var(--red)',color:'#fff'}} onClick={() => bulkMark('statusAM', false)}>All AM Offline</button>
                    <button className="btn btn-sm" style={{background:'var(--green)',color:'#fff'}} onClick={() => bulkMark('statusPM', true)}>All PM Online</button>
                    <button className="btn btn-sm" style={{background:'var(--red)',color:'#fff'}} onClick={() => bulkMark('statusPM', false)}>All PM Offline</button>
                </div>
            </div>

            {/* Table View */}
            {viewMode === 'table' && (
                <div className="card mt-md">
                    <div className="check-row" style={{background:'var(--bg-input)',fontWeight:600}}>
                        <span className="check-header">Hull #</span>
                        <span className="check-header">Port</span>
                        <span className="check-header">AM Ping</span>
                        <span className="check-header">PM Ping</span>
                        <span className="check-header">HD Space</span>
                        <span className="check-header">Primary</span>
                        <span className="check-header">Alternate</span>
                    </div>
                    <div>{sorted.map((s, idx) => {
                        const c = getCheck(s.id);
                        const yc = getYesterdayCheck(s.id);
                        const status = getRowStatus(s, c);
                        const rowBg = status === 'inport' ? 'var(--blue-glow)' : status === 'offline' ? 'var(--red-glow)' : status === 'partial' ? 'var(--amber-glow)' : status === 'alert' ? 'rgba(251, 191, 36, 0.1)' : 'transparent';
                        const trendAM = yc ? getTrend(c.pingAM, yc.pingAM, 'ping') : null;
                        const trendPM = yc ? getTrend(c.pingPM, yc.pingPM, 'ping') : null;
                        const trendHD = yc ? getTrend(c.hdSpace, yc.hdSpace, 'hd') : null;

                        return (
                            <div key={s.id} className="check-row" style={{background: rowBg, borderLeft: status === 'offline' ? '3px solid var(--red)' : status === 'partial' ? '3px solid var(--amber)' : status === 'inport' ? '3px solid var(--blue)' : '3px solid transparent'}}>
                                <span style={{fontWeight:600,fontFamily:'JetBrains Mono',fontSize:'12px'}}>{s.name}</span>
                                <span style={{fontSize:'11px',color: status === 'inport' ? 'var(--blue)' : 'var(--text-dim)'}}>{status === 'inport' ? 'âš“' : ''} {s.location || 'â€”'}</span>
                                <div style={{display:'flex',alignItems:'center'}}>
                                    <input
                                        ref={el => inputRefs.current[`${s.id}-pingAM`] = el}
                                        className={`form-input ${isAbnormal(c.pingAM, 'ping')}`}
                                        placeholder="ms"
                                        value={c.pingAM}
                                        onChange={e => update(s.id, 'pingAM', e.target.value)}
                                        onKeyDown={e => handleKeyDown(e, s.id, 'pingAM', idx)}
                                    />
                                    {trendAM && <span style={{marginLeft:'4px',color: trendAM.bad ? 'var(--red)' : 'var(--green)',fontSize:'10px'}}>{trendAM.dir === 'up' ? 'â†‘' : 'â†“'}</span>}
                                </div>
                                <div style={{display:'flex',alignItems:'center'}}>
                                    <input
                                        ref={el => inputRefs.current[`${s.id}-pingPM`] = el}
                                        className={`form-input ${isAbnormal(c.pingPM, 'ping')}`}
                                        placeholder="ms"
                                        value={c.pingPM}
                                        onChange={e => update(s.id, 'pingPM', e.target.value)}
                                        onKeyDown={e => handleKeyDown(e, s.id, 'pingPM', idx)}
                                    />
                                    {trendPM && <span style={{marginLeft:'4px',color: trendPM.bad ? 'var(--red)' : 'var(--green)',fontSize:'10px'}}>{trendPM.dir === 'up' ? 'â†‘' : 'â†“'}</span>}
                                </div>
                                <div style={{display:'flex',alignItems:'center'}}>
                                    <input
                                        ref={el => inputRefs.current[`${s.id}-hdSpace`] = el}
                                        className={`form-input ${isAbnormal(c.hdSpace, 'hd')}`}
                                        placeholder="GB"
                                        value={c.hdSpace}
                                        onChange={e => update(s.id, 'hdSpace', e.target.value)}
                                        onKeyDown={e => handleKeyDown(e, s.id, 'hdSpace', idx)}
                                    />
                                    {trendHD && <span style={{marginLeft:'4px',color: trendHD.bad ? 'var(--red)' : 'var(--green)',fontSize:'10px'}}>{trendHD.dir === 'up' ? 'â†‘' : 'â†“'}</span>}
                                </div>
                                <label className="checkbox"><input type="checkbox" checked={c.statusAM} onChange={e => update(s.id, 'statusAM', e.target.checked)}/>Online</label>
                                <label className="checkbox"><input type="checkbox" checked={c.statusPM} onChange={e => update(s.id, 'statusPM', e.target.checked)}/>Online</label>
                            </div>
                        );
                    })}</div>
                </div>
            )}

            {/* Cards View */}
            {viewMode === 'cards' && (
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))',gap:'12px',marginTop:'16px'}}>
                    {sorted.map(s => {
                        const c = getCheck(s.id);
                        const status = getRowStatus(s, c);

                        return (
                            <div key={s.id} style={{padding:'16px',background:'var(--bg-card)',borderRadius:'8px',border:'1px solid var(--border)',borderLeft: `4px solid ${status === 'online' ? 'var(--green)' : status === 'offline' ? 'var(--red)' : status === 'partial' ? 'var(--amber)' : 'var(--blue)'}`}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}>
                                    <div style={{fontWeight:700,fontSize:'16px',fontFamily:'JetBrains Mono'}}>{s.name}</div>
                                    <span className={`badge badge-${status === 'online' ? 'ok' : status === 'offline' ? 'urgent' : status === 'partial' ? 'mild' : 'info'}`}>
                                        {status === 'online' ? 'âœ“ Online' : status === 'offline' ? 'âœ• Offline' : status === 'partial' ? 'âš  Partial' : 'âš“ In Port'}
                                    </span>
                                </div>
                                <div style={{fontSize:'11px',color:'var(--text-muted)',marginBottom:'12px'}}>{s.location || 'No location'}</div>

                                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'8px',marginBottom:'12px'}}>
                                    <div>
                                        <div style={{fontSize:'9px',color:'var(--text-muted)'}}>AM PING</div>
                                        <input className={`form-input ${isAbnormal(c.pingAM, 'ping')}`} style={{fontSize:'12px'}} placeholder="ms" value={c.pingAM} onChange={e => update(s.id, 'pingAM', e.target.value)}/>
                                    </div>
                                    <div>
                                        <div style={{fontSize:'9px',color:'var(--text-muted)'}}>PM PING</div>
                                        <input className={`form-input ${isAbnormal(c.pingPM, 'ping')}`} style={{fontSize:'12px'}} placeholder="ms" value={c.pingPM} onChange={e => update(s.id, 'pingPM', e.target.value)}/>
                                    </div>
                                    <div>
                                        <div style={{fontSize:'9px',color:'var(--text-muted)'}}>HD SPACE</div>
                                        <input className={`form-input ${isAbnormal(c.hdSpace, 'hd')}`} style={{fontSize:'12px'}} placeholder="GB" value={c.hdSpace} onChange={e => update(s.id, 'hdSpace', e.target.value)}/>
                                    </div>
                                </div>

                                <div style={{display:'flex',gap:'12px'}}>
                                    <label className="checkbox" style={{fontSize:'11px'}}><input type="checkbox" checked={c.statusAM} onChange={e => update(s.id, 'statusAM', e.target.checked)}/>AM</label>
                                    <label className="checkbox" style={{fontSize:'11px'}}><input type="checkbox" checked={c.statusPM} onChange={e => update(s.id, 'statusPM', e.target.checked)}/>PM</label>
                                </div>
                            </div>
                        );
                    })}
                </div>
            )}

            {/* Bulk Paste Modal */}
            {bulkPasteModal && (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}} onClick={() => setBulkPasteModal(false)}>
                    <div style={{background:'var(--bg-card)',borderRadius:'12px',padding:'24px',maxWidth:'500px',width:'90%'}} onClick={e => e.stopPropagation()}>
                        <h3 style={{marginTop:0}}>ðŸ“‹ Bulk Paste Values</h3>
                        <p style={{fontSize:'12px',color:'var(--text-muted)'}}>Paste ping results or values (one per line). Will match to ships in order or by hull number if found.</p>

                        <div className="form-group">
                            <label className="form-label">Value Type</label>
                            <div style={{display:'flex',gap:'8px'}}>
                                <button className={`btn btn-sm ${bulkPasteType === 'am' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setBulkPasteType('am')}>AM Ping</button>
                                <button className={`btn btn-sm ${bulkPasteType === 'pm' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setBulkPasteType('pm')}>PM Ping</button>
                                <button className={`btn btn-sm ${bulkPasteType === 'hd' ? 'btn-primary' : 'btn-secondary'}`} onClick={() => setBulkPasteType('hd')}>HD Space</button>
                            </div>
                        </div>

                        <div className="form-group">
                            <label className="form-label">Paste Values</label>
                            <textarea
                                className="form-textarea"
                                style={{minHeight:'150px',fontFamily:'JetBrains Mono',fontSize:'11px'}}
                                placeholder="245&#10;312&#10;198&#10;...&#10;&#10;Or with hull numbers:&#10;DDG67: 245ms&#10;DDG70: 312ms"
                                value={bulkPasteText}
                                onChange={e => setBulkPasteText(e.target.value)}
                            />
                        </div>

                        <div className="btn-group">
                            <button className="btn btn-primary" onClick={parseBulkPaste}>Apply Values</button>
                            <button className="btn btn-secondary" onClick={() => setBulkPasteModal(false)}>Cancel</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

function AddShip({ ships, setShips, toast, editing, setEditing, setPage, logActivity }) {
    const [form, setForm] = useState({ name: '', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', reminder: '7', lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', tags: [] });
    const [tagInput, setTagInput] = useState('');
    const locations = ['San Diego, CA', 'Norfolk, VA', 'Mayport, FL', 'Pearl Harbor, HI', 'Yokosuka, Japan', 'Rota, Spain', 'Everett, WA', 'Deployed', 'In Port', 'Other'];
    
    useEffect(() => { if (editing) setForm({ name: editing.name, type: editing.type, location: editing.location || 'San Diego, CA', poc: editing.poc, email: editing.email, reminder: '7', lastSaid: editing.lastSaid, ciscoRouter: editing.ciscoRouter, hdd: editing.hdd, crna1: editing.crna1, crna2: editing.crna2, notes: editing.notes, tags: editing.tags || [] }); }, [editing]);
    
    const addTag = () => { if (tagInput.trim() && !form.tags.includes(tagInput.trim())) { setForm({...form, tags: [...form.tags, tagInput.trim()]}); setTagInput(''); } };
    const removeTag = (t) => setForm({...form, tags: form.tags.filter(x => x !== t)});
    
    const submit = () => { 
        if (!form.name.trim()) { toast('Ship name required', 'error'); return; } 
        const next = new Date(); next.setDate(next.getDate() + parseInt(form.reminder)); 
        if (editing) { 
            setShips(p => p.map(s => s.id === editing.id ? { ...s, ...form, nextCheck: next.toISOString() } : s)); 
            logActivity(`Updated ship ${form.name}`);
            toast('Ship updated!', 'success'); 
            setEditing(null); 
        } else { 
            setShips(p => [...p, { id: genId('S'), ...form, threat: 'NoIssue', lastContact: new Date().toISOString(), nextCheck: next.toISOString(), contactedBy: '' }]); 
            logActivity(`Added new ship ${form.name}`);
            toast('Ship added!', 'success'); 
        } 
        setForm({ name: '', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', reminder: '7', lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', tags: [] }); 
        setPage(0); 
    };
    const clear = () => { setForm({ name: '', type: 'Full REAP', location: 'San Diego, CA', poc: '', email: '', reminder: '7', lastSaid: '', ciscoRouter: '', hdd: '', crna1: '', crna2: '', notes: '', tags: [] }); setEditing(null); };

    return (
        <div className="page active">
            <div className="page-header"><div className="page-header-left"><h1 className="page-title">{editing ? 'Edit Ship' : 'Add Ship'}</h1><p className="page-sub">Enter ship details and asset identifiers</p></div></div>
            {editing && <div className="card" style={{background:'var(--primary-glow)',borderColor:'var(--primary)'}}><span style={{color:'var(--primary)',fontWeight:600}}>Editing: {editing.name}</span></div>}
            <div className="card"><span className="card-title">Ship Information</span><div className="form-row mt-md"><div className="form-group"><label className="form-label">Ship Name *</label><input className="form-input" placeholder="e.g., DDG54" value={form.name} onChange={e => setForm({...form, name: e.target.value})}/></div><div className="form-group"><label className="form-label">Email</label><input className="form-input" placeholder="STO@ship.navy.mil" value={form.email} onChange={e => setForm({...form, email: e.target.value})}/></div><div className="form-group"><label className="form-label">Ship Type</label><select className="form-select" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option>Full REAP</option><option>Mini REAP</option></select></div></div><div className="form-row"><div className="form-group"><label className="form-label">Homeport</label><select className="form-select" value={form.location} onChange={e => setForm({...form, location: e.target.value})}>{locations.map(l => <option key={l}>{l}</option>)}</select></div><div className="form-group"><label className="form-label">Next Check-in</label><select className="form-select" value={form.reminder} onChange={e => setForm({...form, reminder: e.target.value})}><option value="7">7 Days</option><option value="14">14 Days</option><option value="30">30 Days</option></select></div><div className="form-group"><label className="form-label">Notes</label><input className="form-input" placeholder="Additional info..." value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}/></div></div>
            <div className="form-group"><label className="form-label">Tags / Groups</label><div className="flex gap-sm mb-md">{form.tags.map(t => <span key={t} className="tag">{t}<span className="tag-remove" onClick={() => removeTag(t)}>Ã—</span></span>)}</div><div className="flex gap-sm"><input className="form-input" style={{flex:1}} placeholder="Add tag..." value={tagInput} onChange={e => setTagInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && addTag()}/><button className="btn btn-secondary" onClick={addTag}>Add</button></div></div>
            <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}/></div></div>
            <div className="card"><span className="card-title">Asset Identifiers</span><div className="form-row mt-md"><div className="form-group"><label className="form-label">Cisco Router</label><input className="form-input" value={form.ciscoRouter} onChange={e => setForm({...form, ciscoRouter: e.target.value})}/></div><div className="form-group"><label className="form-label">HDD</label><input className="form-input" value={form.hdd} onChange={e => setForm({...form, hdd: e.target.value})}/></div><div className="form-group"><label className="form-label">Star CRNA</label><input className="form-input" value={form.crna1} onChange={e => setForm({...form, crna1: e.target.value})}/></div></div><div className="form-row"><div className="form-group"><label className="form-label">Data CRNA</label><input className="form-input" value={form.crna2} onChange={e => setForm({...form, crna2: e.target.value})}/></div></div></div>
            <div className="btn-group mt-md"><button className="btn btn-primary" onClick={submit}>{editing ? 'Update Ship' : 'Save Ship'}</button><button className="btn btn-secondary" onClick={clear}>Clear Form</button>{editing && <button className="btn btn-danger" onClick={() => { setEditing(null); clear(); }}>Cancel Edit</button>}</div>
        </div>
    );
}

// ===== PASTE PART 3 BELOW THIS LINE =====

// ===== PART 3 - Remaining Pages =====

function Inventory({ ships, setShips, toast, logActivity }) {
    const [filter, setFilter] = useState('missing');
    const [sel, setSel] = useState(null);
    const [form, setForm] = useState({ ciscoRouter: '', hdd: '', crna1: '', crna2: '' });
    const filtered = useMemo(() => { let r = [...ships].sort(sortHull); if (filter === 'missing') r = r.filter(s => !s.ciscoRouter || !s.hdd || (!s.crna1 && !s.crna2)); else if (filter === 'complete') r = r.filter(s => s.ciscoRouter && s.hdd && (s.crna1 || s.crna2)); return r; }, [ships, filter]);
    const select = (s) => { setSel(s); setForm({ ciscoRouter: s.ciscoRouter, hdd: s.hdd, crna1: s.crna1, crna2: s.crna2 }); };
    const update = () => { 
        if (!sel) return; 
        const changes = [];
        if (form.ciscoRouter !== (sel.ciscoRouter || '')) changes.push(`Cisco: ${form.ciscoRouter || '(cleared)'}`);
        if (form.hdd !== (sel.hdd || '')) changes.push(`HDD: ${form.hdd || '(cleared)'}`);
        if (form.crna1 !== (sel.crna1 || '')) changes.push(`Star CRNA: ${form.crna1 || '(cleared)'}`);
        if (form.crna2 !== (sel.crna2 || '')) changes.push(`Data CRNA: ${form.crna2 || '(cleared)'}`);
        setShips(p => p.map(s => s.id === sel.id ? {...s, ...form} : s)); 
        logActivity(`${sel.name} inventory: ${changes.length > 0 ? changes.join(', ') : 'no changes'}`, { ship: sel.name, ...form }); 
        toast('Assets updated!', 'success'); 
    };
    const getStatus = (s) => { const m = []; if (!s.ciscoRouter) m.push('Cisco'); if (!s.hdd) m.push('HDD'); if (!s.crna1 && !s.crna2) m.push('CRNA'); return m.length === 0 ? 'Complete' : `${m.length} Missing`; };
    
    const exportCSV = () => { 
        let csv = 'Hull,Type,Cisco,HDD,CRNA1,CRNA2,Status\n'; 
        ships.sort(sortHull).forEach(s => csv += `${s.name},${s.type},${s.ciscoRouter||'---'},${s.hdd||'---'},${s.crna1||'---'},${s.crna2||'---'},${getStatus(s)}\n`); 
        const blob = new Blob([csv], { type: 'text/csv' }), url = URL.createObjectURL(blob), a = document.createElement('a'); 
        a.href = url; a.download = `Inventory_${toDateString(new Date())}.csv`; a.click(); 
        logActivity('Exported inventory to CSV');
        toast('CSV exported!', 'success'); 
    };
    
    const exportExcel = () => {
        // Create Excel XML format
        let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="Inventory"><Table>';
        xml += '<Row><Cell><Data ss:Type="String">Hull</Data></Cell><Cell><Data ss:Type="String">Type</Data></Cell><Cell><Data ss:Type="String">Cisco</Data></Cell><Cell><Data ss:Type="String">HDD</Data></Cell><Cell><Data ss:Type="String">CRNA1</Data></Cell><Cell><Data ss:Type="String">CRNA2</Data></Cell><Cell><Data ss:Type="String">Status</Data></Cell></Row>';
        ships.sort(sortHull).forEach(s => {
            xml += `<Row><Cell><Data ss:Type="String">${s.name}</Data></Cell><Cell><Data ss:Type="String">${s.type}</Data></Cell><Cell><Data ss:Type="String">${s.ciscoRouter||'---'}</Data></Cell><Cell><Data ss:Type="String">${s.hdd||'---'}</Data></Cell><Cell><Data ss:Type="String">${s.crna1||'---'}</Data></Cell><Cell><Data ss:Type="String">${s.crna2||'---'}</Data></Cell><Cell><Data ss:Type="String">${getStatus(s)}</Data></Cell></Row>`;
        });
        xml += '</Table></Worksheet></Workbook>';
        const blob = new Blob([xml], { type: 'application/vnd.ms-excel' }), url = URL.createObjectURL(blob), a = document.createElement('a');
        a.href = url; a.download = `Inventory_${toDateString(new Date())}.xls`; a.click();
        logActivity('Exported inventory to Excel');
        toast('Excel exported!', 'success');
    };

    return (
        <div className="page active">
            <div className="page-header"><div className="page-header-left"><h1 className="page-title">Inventory</h1><p className="page-sub">Track asset documentation status</p></div><div className="btn-group"><button className="btn btn-secondary" onClick={exportCSV}>Export CSV</button><button className="btn btn-primary" onClick={exportExcel}>Export Excel</button></div></div>
            <div className="filters"><button className={`filter-btn ${filter==='all'?'active':''}`} onClick={() => setFilter('all')}>All Ships</button><button className={`filter-btn ${filter==='missing'?'active':''}`} onClick={() => setFilter('missing')}>Missing Docs</button><button className={`filter-btn ${filter==='complete'?'active':''}`} onClick={() => setFilter('complete')}>Complete</button></div>
            
            {/* Edit Form at Top */}
            <div className="card" style={{background: sel ? 'var(--primary-glow)' : 'var(--bg-card)', borderColor: sel ? 'var(--primary)' : 'var(--border)'}}>
                <span className="card-title">{sel ? `âœï¸ Editing: ${sel.name}` : 'Select a ship below to edit'}</span>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">Cisco Router</label><input className="form-input" placeholder={sel ? 'Enter Cisco Router' : 'Select a ship...'} value={form.ciscoRouter} onChange={e => setForm({...form, ciscoRouter: e.target.value})} disabled={!sel}/></div>
                    <div className="form-group"><label className="form-label">HDD</label><input className="form-input" placeholder={sel ? 'Enter HDD' : 'Select a ship...'} value={form.hdd} onChange={e => setForm({...form, hdd: e.target.value})} disabled={!sel}/></div>
                    <div className="form-group"><label className="form-label">Star CRNA</label><input className="form-input" placeholder={sel ? 'Enter Star CRNA' : 'Select a ship...'} value={form.crna1} onChange={e => setForm({...form, crna1: e.target.value})} disabled={!sel}/></div>
                    <div className="form-group"><label className="form-label">Data CRNA</label><input className="form-input" placeholder={sel ? 'Enter Data CRNA' : 'Select a ship...'} value={form.crna2} onChange={e => setForm({...form, crna2: e.target.value})} disabled={!sel}/></div>
                    <div className="form-group" style={{display:'flex',alignItems:'flex-end',gap:'8px'}}>
                        <button className="btn btn-primary" onClick={update} disabled={!sel}>Save</button>
                        <button className="btn btn-secondary" onClick={() => { setSel(null); setForm({ciscoRouter:'',hdd:'',crna1:'',crna2:''}); }}>Clear</button>
                    </div>
                </div>
            </div>
            
            {/* Ship Table */}
            <div className="card"><span className="card-title">Ship Documentation Status <span style={{fontWeight:'normal',color:'var(--text-muted)',marginLeft:'8px'}}>({filtered.length} ships)</span></span><table className="table mt-md"><thead><tr><th>Ship</th><th>Type</th><th>Cisco</th><th>HDD</th><th>CRNA</th><th>Status</th></tr></thead><tbody>{filtered.map(s => { const st = getStatus(s); return (<tr key={s.id} className={sel?.id === s.id ? 'selected' : ''} onClick={() => select(s)} style={{cursor:'pointer'}}><td style={{fontWeight:600,fontFamily:'JetBrains Mono'}}>{s.name}</td><td>{s.type}</td><td style={{color:s.ciscoRouter?'var(--text)':'var(--red)'}}>{s.ciscoRouter||'---'}</td><td style={{color:s.hdd?'var(--text)':'var(--red)'}}>{s.hdd||'---'}</td><td style={{color:(s.crna1||s.crna2)?'var(--text)':'var(--red)'}}>{s.crna1&&s.crna2?`${s.crna1}/${s.crna2}`:s.crna1||s.crna2||'---'}</td><td><span className={`badge ${st==='Complete'?'badge-complete':'badge-missing'}`}>{st}</span></td></tr>); })}</tbody></table></div>
        </div>
    );
}

function Installs({ ships, installs, setInstalls, toast, logActivity }) {
    const sorted = useMemo(() => [...ships].sort(sortHull), [ships]);
    const [form, setForm] = useState({ ship: '', start: '', end: '', location: 'Mayport, FL', purpose: '', notes: '', status: 'Scheduled' });
    const [viewMode, setViewMode] = useState('list');
    const [calMonth, setCalMonth] = useState(new Date());
    const [selectedDate, setSelectedDate] = useState(null);
    const locations = ['San Diego, CA', 'Norfolk, VA', 'Mayport, FL', 'Pearl Harbor, HI', 'Yokosuka, Japan', 'Rota, Spain', 'Everett, WA', 'Washington D.C.', 'Other'];
    const statuses = ['Scheduled', 'In Progress', 'Completed', 'Delayed', 'Cancelled'];
    
    const add = () => { 
        if (!form.ship) { toast('Select a ship', 'error'); return; } 
        if (!form.start) { toast('Select a start date', 'error'); return; }
        setInstalls(p => [...p, { id: genId('T'), ...form }]); 
        logActivity(`Scheduled trip: ${form.ship} to ${form.location} on ${fmtDate(form.start)}`, { ship: form.ship, location: form.location, start: form.start, end: form.end });
        setForm({ ship: '', start: '', end: '', location: 'Mayport, FL', purpose: '', notes: '', status: 'Scheduled' }); 
        toast('Trip added!', 'success'); 
    };
    const del = (id) => { 
        const trip = installs.find(i => i.id === id);
        if (confirm('Delete trip?')) { 
            setInstalls(p => p.filter(i => i.id !== id)); 
            logActivity(`Deleted trip: ${trip?.ship || 'Unknown'} to ${trip?.location || 'Unknown'}`, { ship: trip?.ship, location: trip?.location });
            toast('Deleted', 'info'); 
        } 
    };
    
    // Calendar helpers
    const getDaysInMonth = (date) => {
        const year = date.getFullYear(), month = date.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const days = [];
        const prevMonthDays = new Date(year, month, 0).getDate();
        for (let i = firstDay - 1; i >= 0; i--) days.push({ day: prevMonthDays - i, otherMonth: true });
        for (let i = 1; i <= daysInMonth; i++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            const tripsOnDay = installs.filter(inst => inst.start <= dateStr && (inst.end >= dateStr || !inst.end));
            days.push({ day: i, date: dateStr, trips: tripsOnDay, otherMonth: false });
        }
        const remaining = 42 - days.length;
        for (let i = 1; i <= remaining; i++) days.push({ day: i, otherMonth: true });
        return days;
    };
    const calDays = useMemo(() => getDaysInMonth(calMonth), [calMonth, installs]);
    const today = toDateString(new Date());
    
    // Trips for selected date or upcoming
    const selectedTrips = selectedDate 
        ? installs.filter(t => t.start <= selectedDate && (t.end >= selectedDate || !t.end))
        : installs.filter(t => t.start >= today).sort((a,b) => parseLocalDate(a.start) - parseLocalDate(b.start)).slice(0, 5);

    return (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left">
                    <h1 className="page-title">Upcoming Trips</h1>
                    <p className="page-sub">Track scheduled travel and site visits</p>
                </div>
                <div className="btn-group">
                    <button className={`btn ${viewMode==='list'?'btn-primary':'btn-secondary'}`} onClick={() => setViewMode('list')}>ðŸ“‹ List</button>
                    <button className={`btn ${viewMode==='calendar'?'btn-primary':'btn-secondary'}`} onClick={() => setViewMode('calendar')}>ðŸ“… Calendar</button>
                </div>
            </div>
            
            {viewMode === 'calendar' ? (
                <div style={{display:'grid',gridTemplateColumns:'1fr 320px',gap:'20px'}}>
                    <div className="card" style={{padding:'16px'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'16px'}}>
                            <button className="btn btn-sm btn-secondary" onClick={() => setCalMonth(new Date(calMonth.getFullYear(), calMonth.getMonth() - 1))}>â€¹</button>
                            <h3 style={{margin:0,fontSize:'16px'}}>{calMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                            <button className="btn btn-sm btn-secondary" onClick={() => setCalMonth(new Date(calMonth.getFullYear(), calMonth.getMonth() + 1))}>â€º</button>
                        </div>
                        <div style={{display:'grid',gridTemplateColumns:'repeat(7, 1fr)',gap:'2px',fontSize:'11px'}}>
                            {['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => (
                                <div key={d} style={{padding:'6px 4px',textAlign:'center',fontWeight:600,color:'var(--text-muted)',fontSize:'10px'}}>{d}</div>
                            ))}
                            {calDays.map((d, i) => (
                                <div 
                                    key={i} 
                                    onClick={() => !d.otherMonth && setSelectedDate(d.date === selectedDate ? null : d.date)}
                                    style={{
                                        padding:'8px 4px',
                                        textAlign:'center',
                                        borderRadius:'6px',
                                        cursor: d.otherMonth ? 'default' : 'pointer',
                                        background: d.date === selectedDate ? 'var(--primary)' : d.date === today ? 'var(--blue-glow)' : d.trips?.length ? 'var(--green-glow)' : 'transparent',
                                        color: d.date === selectedDate ? '#fff' : d.otherMonth ? 'var(--text-muted)' : 'var(--text)',
                                        border: d.date === today ? '1px solid var(--blue)' : '1px solid transparent',
                                        position:'relative',
                                        transition:'all 0.15s'
                                    }}
                                >
                                    {d.day}
                                    {d.trips?.length > 0 && (
                                        <div style={{position:'absolute',bottom:'2px',left:'50%',transform:'translateX(-50%)',display:'flex',gap:'2px'}}>
                                            {d.trips.slice(0,3).map((_,j) => (
                                                <div key={j} style={{width:'4px',height:'4px',borderRadius:'50%',background: d.date === selectedDate ? '#fff' : 'var(--green)'}}/>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        <div style={{marginTop:'12px',display:'flex',gap:'16px',fontSize:'10px',color:'var(--text-muted)'}}>
                            <span><span style={{display:'inline-block',width:'8px',height:'8px',borderRadius:'50%',background:'var(--green)',marginRight:'4px'}}></span>Has trip</span>
                            <span><span style={{display:'inline-block',width:'8px',height:'8px',borderRadius:'4px',background:'var(--blue-glow)',border:'1px solid var(--blue)',marginRight:'4px'}}></span>Today</span>
                        </div>
                    </div>
                    
                    <div className="card" style={{padding:'16px'}}>
                        <div style={{fontSize:'13px',fontWeight:600,marginBottom:'12px',color:'var(--text-dim)'}}>
                            {selectedDate ? `Trips on ${fmtDate(selectedDate)}` : 'Upcoming Trips'}
                        </div>
                        {selectedTrips.length === 0 ? (
                            <div className="empty" style={{padding:'30px 10px',fontSize:'12px'}}>
                                {selectedDate ? 'No trips on this date' : 'No upcoming trips scheduled'}
                            </div>
                        ) : (
                            <div style={{display:'flex',flexDirection:'column',gap:'10px'}}>
                                {selectedTrips.map(trip => (
                                    <div key={trip.id} style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',borderLeft:'3px solid var(--green)'}}>
                                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'6px'}}>
                                            <div style={{fontWeight:600,fontSize:'13px'}}>{trip.ship}</div>
                                            <span className="badge badge-info" style={{fontSize:'9px'}}>{trip.status}</span>
                                        </div>
                                        <div style={{fontSize:'11px',color:'var(--text-dim)',marginBottom:'4px'}}>
                                            ðŸ“ {trip.location}
                                        </div>
                                        <div style={{fontSize:'10px',color:'var(--text-muted)'}}>
                                            {fmtDate(trip.start)}{trip.end ? ` - ${fmtDate(trip.end)}` : ''}
                                        </div>
                                        {trip.purpose && <div style={{fontSize:'10px',color:'var(--text-muted)',marginTop:'4px'}}>ðŸŽ¯ {trip.purpose}</div>}
                                        <button className="btn btn-sm btn-danger" style={{marginTop:'8px',padding:'2px 8px',fontSize:'9px'}} onClick={() => del(trip.id)}>Delete</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            ) : (
                <div className="card">
                    <span className="card-title">All Trips</span>
                    {installs.length === 0 ? (
                        <div className="empty">No trips scheduled</div>
                    ) : (
                        <table className="table mt-md">
                            <thead>
                                <tr>
                                    <th>Ship</th>
                                    <th>Dates</th>
                                    <th>Location</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {installs.sort((a,b) => parseLocalDate(a.start) - parseLocalDate(b.start)).map(i => (
                                    <tr key={i.id}>
                                        <td style={{fontWeight:600}}>{i.ship}</td>
                                        <td style={{fontSize:'12px'}}>{fmtDate(i.start)}{i.end ? ` - ${fmtDate(i.end)}` : ''}</td>
                                        <td>{i.location}</td>
                                        <td style={{fontSize:'12px',color:'var(--text-dim)'}}>{i.purpose || 'â€”'}</td>
                                        <td><span className={`badge ${i.status==='Completed'?'badge-success':i.status==='Cancelled'?'badge-mild':'badge-info'}`}>{i.status}</span></td>
                                        <td><button className="btn btn-sm btn-danger" onClick={() => del(i.id)}>Del</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            )}
            
            <div className="card">
                <span className="card-title">Schedule New Trip</span>
                <div className="form-row mt-md">
                    <div className="form-group">
                        <label className="form-label">Ship *</label>
                        <select className="form-select" value={form.ship} onChange={e => setForm({...form, ship: e.target.value})}>
                            <option value="">Select...</option>
                            {sorted.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                        </select>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Destination</label>
                        <select className="form-select" value={form.location} onChange={e => setForm({...form, location: e.target.value})}>
                            {locations.map(l => <option key={l}>{l}</option>)}
                        </select>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Status</label>
                        <select className="form-select" value={form.status} onChange={e => setForm({...form, status: e.target.value})}>
                            {statuses.map(s => <option key={s}>{s}</option>)}
                        </select>
                    </div>
                </div>
                <div className="form-row">
                    <div className="form-group">
                        <label className="form-label">Start Date *</label>
                        <input type="date" className="form-input" value={form.start} onChange={e => setForm({...form, start: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="form-label">End Date</label>
                        <input type="date" className="form-input" value={form.end} onChange={e => setForm({...form, end: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Purpose</label>
                        <input className="form-input" placeholder="e.g., Install, Maintenance, Training..." value={form.purpose} onChange={e => setForm({...form, purpose: e.target.value})}/>
                    </div>
                </div>
                <div className="form-group">
                    <label className="form-label">Notes</label>
                    <input className="form-input" placeholder="Additional details..." value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}/>
                </div>
                <button className="btn btn-primary mt-md" onClick={add}>+ Add Trip</button>
            </div>
        </div>
    );
}

function Parts({ parts, setParts, toast, logActivity }) {
    const [filter, setFilter] = useState('All');
    const [statusFilter, setStatusFilter] = useState('all');
    const [search, setSearch] = useState('');
    const [builtComputers, setBuiltComputers] = useStorage('builtComputers', 4);
    const [targetSystems, setTargetSystems] = useStorage('targetSystems', 10);
    const [showAddForm, setShowAddForm] = useState(false);
    const [showShoppingList, setShowShoppingList] = useState(false);
    const [viewMode, setViewMode] = useState('table'); // 'table' or 'cards'

    // Default REAP Cabinet PC Parts
    const defaultParts = [
        { id: 'P001', category: 'Motherboard', name: 'Asus ROG STRIX Z590-I Gaming Wifi', inStock: 2, need: 10, perBuild: 1 },
        { id: 'P002', category: 'Motherboard', name: 'Asus Prime H610I-Plus D4', inStock: 3, need: 0, perBuild: 0 },
        { id: 'P003', category: 'RAM', name: 'Corsair Vengeance LPX 2x8GB DDR4 3200MHZ', inStock: 11, need: 1, perBuild: 1 },
        { id: 'P004', category: 'RAM', name: 'Corsair Vengeance LPX 2x8GB DDR4 3600MHZ', inStock: 1, need: 0, perBuild: 0 },
        { id: 'P005', category: 'Cooling', name: 'Noctua NH-L9i L-Type Low Profile Cooler LGA 1200', inStock: 2, need: 10, perBuild: 1 },
        { id: 'P006', category: 'Cable', name: 'M.2 Adaptor Key to PCIE3 0x16 Extension Cable Intel 7260/8260/9260', inStock: 14, need: 0, perBuild: 1 },
        { id: 'P007', category: 'CPU', name: 'Intel i5-11600K LGA 1200 CPU (ROG motherboards)', inStock: 3, need: 9, perBuild: 1 },
        { id: 'P008', category: 'CPU', name: 'Intel i5-13600K LGA 1700 CPU (Prime motherboards)', inStock: 3, need: 0, perBuild: 0 },
        { id: 'P009', category: 'Power Supply', name: 'EVGA Supernova 650 GM Gold SFX Power Supply', inStock: 0, need: 12, perBuild: 1 },
        { id: 'P010', category: 'Power Supply', name: 'Cooler Master MasterWatt 750 Bronze Semi-Fanless Power Supply', inStock: 1, need: 0, perBuild: 0 },
        { id: 'P011', category: 'Peripheral', name: 'Kingqin Powered USB HUB 3.0 w/1 USB-C Port, SD Card Reader', inStock: 6, need: 6, perBuild: 1 },
        { id: 'P012', category: 'Storage', name: 'Kingwin KF-251-BK 2.5in Dual Bay Internal Hot Swap', inStock: 9, need: 4, perBuild: 1 },
        { id: 'P013', category: 'Storage', name: 'StarTech Trayless Dual 2.5in SATA Dual Hot Swap Bay', inStock: 3, need: 0, perBuild: 0 },
        { id: 'P014', category: 'Network Card', name: 'PCIE Host Adapter Card SCSI Card', inStock: 2, need: 10, perBuild: 1 },
        { id: 'P015', category: 'Network Card', name: 'LSI SAS9217-8I Card (Small Black Heat Shield)', inStock: 10, need: 2, perBuild: 1 },
        { id: 'P016', category: 'Cable', name: '68 Pin SCSI Cable', inStock: 8, need: 5, perBuild: 1 },
        { id: 'P017', category: 'Cable', name: 'SCSI Cable Terminator End', inStock: 0, need: 14, perBuild: 1 },
        { id: 'P018', category: 'Tape Drive', name: 'Quantum LTO-6 Internal SAS Tape Drive', inStock: 14, need: 0, perBuild: 1 },
        { id: 'P019', category: 'Tape Drive', name: '4MM Tape Drive Reader Sony SDT-11000 Digital Data Storage', inStock: 6, need: 10, perBuild: 1 },
        { id: 'P020', category: 'Optical', name: 'Compaq 184689-301 184691-301 LF-1094D Optical Drive', inStock: 2, need: 14, perBuild: 1 },
        { id: 'P021', category: 'Cable', name: '68 Pin SCSI Converter/Adapter', inStock: 0, need: 14, perBuild: 1 },
        { id: 'P022', category: 'Cable', name: 'LTO Power Cables 518885-003 RM 536-2210 REV AXS', inStock: 7, need: 0, perBuild: 1 },
        { id: 'P023', category: 'Cable', name: 'SAS Cables 50cm SFF8087 to 4xSFF8482', inStock: 30, need: 0, perBuild: 2 },
        { id: 'P024', category: 'Case', name: 'PC Cases', inStock: 8, need: 0, perBuild: 1 },
        { id: 'P025', category: 'Other', name: 'StarTech Frontbay Mounting Brackets', inStock: 6, need: 16, perBuild: 2 },
        { id: 'P026', category: 'SSD', name: 'Samsung SSD 870 EVO', inStock: 7, need: 7, perBuild: 2 },
        { id: 'P027', category: 'Optical', name: 'DVD Drives External', inStock: 8, need: 6, perBuild: 1 },
        { id: 'P028', category: 'Peripheral', name: 'Monitors', inStock: 10, need: 4, perBuild: 1 },
        { id: 'P029', category: 'Peripheral', name: 'CFAST Readers', inStock: 13, need: 0, perBuild: 1 },
        { id: 'P030', category: 'Network Card', name: 'Routers', inStock: 9, need: 5, perBuild: 1 },
        { id: 'P031', category: 'Peripheral', name: 'Phones (Made Not in China)', inStock: 5, need: 8, perBuild: 1 },
    ];

    useEffect(() => { if (parts.length === 0) setParts(defaultParts); }, []);

    const categories = ['All', 'CPU', 'RAM', 'Motherboard', 'Power Supply', 'SSD', 'Storage', 'Case', 'Cooling', 'Network Card', 'Cable', 'Tape Drive', 'Optical', 'Peripheral', 'Other'];

    const buildCalc = useMemo(() => {
        const criticalParts = parts.filter(p => p.perBuild > 0);
        if (criticalParts.length === 0) return { canBuild: 0, limiting: [], allLimiting: [] };
        let minBuilds = Infinity;
        let limitingParts = [];
        criticalParts.forEach(p => {
            const builds = Math.floor((p.inStock || 0) / (p.perBuild || 1));
            if (builds < minBuilds) { minBuilds = builds; limitingParts = [{ name: p.name, have: p.inStock, need: p.perBuild, builds }]; }
            else if (builds === minBuilds) limitingParts.push({ name: p.name, have: p.inStock, need: p.perBuild, builds });
        });
        return { canBuild: minBuilds === Infinity ? 0 : minBuilds, limiting: limitingParts.slice(0, 3), allLimiting: limitingParts };
    }, [parts]);

    const totals = useMemo(() => {
        const outOfStock = parts.filter(p => (p.inStock || 0) === 0 && (p.need || 0) > 0).length;
        const lowStock = parts.filter(p => (p.inStock || 0) > 0 && (p.inStock || 0) <= (p.need || 0) && (p.need || 0) > 0).length;
        const totalItems = parts.reduce((sum, p) => sum + (p.inStock || 0), 0);
        const totalNeeded = parts.reduce((sum, p) => sum + Math.max(0, (p.need || 0) - (p.inStock || 0)), 0);
        return { outOfStock, lowStock, totalItems, totalNeeded };
    }, [parts]);

    const categoryStats = useMemo(() => {
        const stats = {};
        categories.filter(c => c !== 'All').forEach(cat => {
            const catParts = parts.filter(p => p.category === cat);
            const outOfStock = catParts.filter(p => (p.inStock || 0) === 0 && (p.need || 0) > 0).length;
            const lowStock = catParts.filter(p => (p.inStock || 0) > 0 && (p.inStock || 0) <= (p.need || 0) && (p.need || 0) > 0).length;
            stats[cat] = { total: catParts.length, outOfStock, lowStock };
        });
        return stats;
    }, [parts]);

    const filtered = useMemo(() => {
        let result = filter === 'All' ? parts : parts.filter(p => p.category === filter);
        if (statusFilter === 'outOfStock') result = result.filter(p => (p.inStock || 0) === 0 && (p.need || 0) > 0);
        else if (statusFilter === 'lowStock') result = result.filter(p => (p.inStock || 0) > 0 && (p.inStock || 0) <= (p.need || 0) && (p.need || 0) > 0);
        if (search.trim()) {
            const s = search.toLowerCase();
            result = result.filter(p => p.name.toLowerCase().includes(s) || p.category.toLowerCase().includes(s));
        }
        return result;
    }, [parts, filter, statusFilter, search]);

    const shoppingList = useMemo(() => {
        return parts.filter(p => {
            const inStock = p.inStock || 0;
            const need = p.need || 0;
            return need > inStock;
        }).map(p => ({
            ...p,
            toOrder: (p.need || 0) - (p.inStock || 0)
        })).sort((a, b) => b.toOrder - a.toOrder);
    }, [parts]);

    const quickAdjust = (id, delta) => {
        const part = parts.find(p => p.id === id);
        if (!part) return;
        const newVal = Math.max(0, (part.inStock || 0) + delta);
        updateQty(id, 'inStock', newVal);
    };

    const updateQty = (id, field, value) => {
        const part = parts.find(p => p.id === id);
        const partName = part?.name?.substring(0, 30) || 'Unknown';
        const oldVal = part?.[field] || 0;
        const newVal = parseInt(value) || 0;
        if (oldVal !== newVal) {
            const fieldName = field === 'inStock' ? 'Stock' : field === 'need' ? 'Need' : 'Per Build';
            logActivity(`${partName}: ${fieldName} ${oldVal} â†’ ${newVal}`, { part: partName, field, oldVal, newVal });
        }
        setParts(p => p.map(part => part.id === id ? { ...part, [field]: newVal } : part));
    };

    const del = (id) => {
        const part = parts.find(p => p.id === id);
        if (confirm('Delete part?')) {
            setParts(p => p.filter(x => x.id !== id));
            logActivity(`Deleted part: ${part?.name?.substring(0, 30) || 'Unknown'}`);
            toast('Deleted', 'info');
        }
    };

    const copyShoppingList = () => {
        const text = shoppingList.map(p => `${p.toOrder}x ${p.name}`).join('\n');
        navigator.clipboard.writeText(text);
        toast('Shopping list copied!', 'success');
    };

    const [addForm, setAddForm] = useState({ category: 'CPU', name: '', inStock: 0, need: 0, perBuild: 1 });
    const addPart = () => {
        if (!addForm.name.trim()) { toast('Part name required', 'error'); return; }
        setParts(p => [...p, { id: genId('P'), ...addForm }]);
        logActivity(`Added part: ${addForm.name}`, { category: addForm.category });
        setAddForm({ category: 'CPU', name: '', inStock: 0, need: 0, perBuild: 1 });
        setShowAddForm(false);
        toast('Part added!', 'success');
    };

    const getStockStatus = (p) => {
        const inStock = p.inStock || 0;
        const need = p.need || 0;
        if (inStock === 0 && need > 0) return { status: 'out', color: 'var(--red)', label: 'OUT' };
        if (inStock > 0 && inStock <= need && need > 0) return { status: 'low', color: 'var(--amber)', label: 'LOW' };
        if (inStock > need && need > 0) return { status: 'good', color: 'var(--green)', label: 'OK' };
        return { status: 'na', color: 'var(--text-muted)', label: 'â€”' };
    };

    return (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left">
                    <h1 className="page-title">Parts Inventory</h1>
                    <p className="page-sub">REAP Cabinet PC Build Tracking â€¢ {parts.length} parts</p>
                </div>
                <div className="btn-group">
                    <button className="btn btn-primary" onClick={() => setShowAddForm(!showAddForm)}>{showAddForm ? 'âœ• Cancel' : '+ Add Part'}</button>
                    <button className="btn btn-secondary" onClick={() => setShowShoppingList(!showShoppingList)} style={{color: shoppingList.length > 0 ? 'var(--amber)' : ''}}>
                        Shopping List {shoppingList.length > 0 && `(${shoppingList.length})`}
                    </button>
                    <button className="btn btn-secondary" onClick={() => { if (confirm('Reset to defaults?')) { setParts(defaultParts); logActivity('Reset parts inventory to defaults'); toast('Reset!', 'success'); }}}>Reset</button>
                </div>
            </div>

            {/* Stats Overview */}
            <div className="stats" style={{marginBottom:'16px'}}>
                <div className="stat total" onClick={() => { setFilter('All'); setStatusFilter('all'); }}>
                    <div className="stat-label">Total In Stock</div>
                    <div className="stat-value">{totals.totalItems}</div>
                </div>
                <div className="stat urgent" style={{cursor:'pointer'}} onClick={() => setStatusFilter('outOfStock')}>
                    <div className="stat-label">Out of Stock</div>
                    <div className="stat-value" style={{color:'var(--red)'}}>{totals.outOfStock}</div>
                </div>
                <div className="stat due" style={{cursor:'pointer'}} onClick={() => setStatusFilter('lowStock')}>
                    <div className="stat-label">Low Stock</div>
                    <div className="stat-value" style={{color:'var(--amber)'}}>{totals.lowStock}</div>
                </div>
                <div className="stat missing">
                    <div className="stat-label">Items to Order</div>
                    <div className="stat-value" style={{color:'var(--blue)'}}>{totals.totalNeeded}</div>
                </div>
            </div>

            {/* Build Progress */}
            <div className="card" style={{marginBottom:'16px',padding:'20px'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:'20px'}}>
                    <div style={{display:'flex',alignItems:'center',gap:'24px'}}>
                        <div style={{textAlign:'center'}}>
                            <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'4px',letterSpacing:'1px'}}>SYSTEMS BUILT</div>
                            <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                <button onClick={() => setBuiltComputers(Math.max(0, builtComputers - 1))} className="btn btn-sm" style={{width:'32px',height:'32px',padding:0,fontSize:'18px'}}>âˆ’</button>
                                <span style={{fontSize:'32px',fontWeight:700,color:'var(--primary)',fontFamily:'JetBrains Mono',minWidth:'50px',textAlign:'center'}}>{builtComputers}</span>
                                <button onClick={() => setBuiltComputers(builtComputers + 1)} className="btn btn-sm" style={{width:'32px',height:'32px',padding:0,fontSize:'18px'}}>+</button>
                            </div>
                        </div>
                        <div style={{fontSize:'24px',color:'var(--text-muted)'}}>/</div>
                        <div style={{textAlign:'center'}}>
                            <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'4px',letterSpacing:'1px'}}>TARGET</div>
                            <input type="number" value={targetSystems} onChange={e => setTargetSystems(Math.max(1, parseInt(e.target.value) || 1))} style={{width:'70px',padding:'6px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'6px',color:'var(--text)',textAlign:'center',fontFamily:'JetBrains Mono',fontSize:'28px',fontWeight:700}}/>
                        </div>
                    </div>
                    <div style={{flex:1,minWidth:'200px',maxWidth:'400px'}}>
                        <div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px',fontSize:'11px',color:'var(--text-muted)'}}>
                            <span>Progress</span>
                            <span>{Math.round((builtComputers / targetSystems) * 100)}%</span>
                        </div>
                        <div style={{height:'12px',background:'var(--bg-input)',borderRadius:'6px',overflow:'hidden'}}>
                            <div style={{height:'100%',width:`${Math.min(100, (builtComputers / targetSystems) * 100)}%`,background:'linear-gradient(90deg, var(--primary), var(--green))',borderRadius:'6px',transition:'width 0.3s'}}></div>
                        </div>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:'20px'}}>
                        <div style={{textAlign:'center',padding:'12px 20px',background:'var(--green-glow)',border:'1px solid var(--green)',borderRadius:'8px'}}>
                            <div style={{fontSize:'10px',color:'var(--green)',marginBottom:'2px',letterSpacing:'1px'}}>CAN BUILD</div>
                            <div style={{fontSize:'28px',fontWeight:700,color:'var(--green)',fontFamily:'JetBrains Mono'}}>{buildCalc.canBuild}</div>
                        </div>
                        {buildCalc.limiting.length > 0 && (
                            <div style={{maxWidth:'200px'}}>
                                <div style={{fontSize:'10px',color:'var(--text-muted)',marginBottom:'4px'}}>BOTTLENECK</div>
                                {buildCalc.limiting.slice(0, 2).map((p, i) => (
                                    <div key={i} style={{fontSize:'11px',color:'var(--amber)',marginBottom:'2px',display:'flex',alignItems:'center',gap:'4px'}}>
                                        <span style={{color:'var(--red)'}}>â€¢</span> {p.name.substring(0, 25)}{p.name.length > 25 ? '...' : ''}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Shopping List Modal */}
            {showShoppingList && (
                <div className="card" style={{marginBottom:'16px',border:'1px solid var(--amber)'}}>
                    <div className="card-title" style={{color:'var(--amber)'}}>
                        Shopping List - {shoppingList.length} items to order
                        <button className="btn btn-sm" onClick={copyShoppingList}>Copy List</button>
                    </div>
                    {shoppingList.length === 0 ? (
                        <p style={{color:'var(--text-muted)',textAlign:'center',padding:'20px'}}>All parts are fully stocked!</p>
                    ) : (
                        <div style={{maxHeight:'300px',overflowY:'auto'}}>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Part</th>
                                        <th style={{textAlign:'center',width:'80px'}}>Have</th>
                                        <th style={{textAlign:'center',width:'80px'}}>Need</th>
                                        <th style={{textAlign:'center',width:'80px'}}>Order</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {shoppingList.map(p => (
                                        <tr key={p.id}>
                                            <td>
                                                <div style={{fontSize:'12px',fontWeight:500}}>{p.name}</div>
                                                <div style={{fontSize:'10px',color:'var(--text-muted)'}}>{p.category}</div>
                                            </td>
                                            <td style={{textAlign:'center',color:'var(--red)',fontFamily:'JetBrains Mono'}}>{p.inStock || 0}</td>
                                            <td style={{textAlign:'center',fontFamily:'JetBrains Mono'}}>{p.need}</td>
                                            <td style={{textAlign:'center',fontWeight:700,color:'var(--amber)',fontFamily:'JetBrains Mono'}}>{p.toOrder}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            )}

            {/* Add Part Form */}
            {showAddForm && (
                <div className="card" style={{marginBottom:'16px',border:'1px solid var(--primary)'}}>
                    <div className="card-title">Add New Part</div>
                    <div className="form-row">
                        <div className="form-group">
                            <label className="form-label">Category</label>
                            <select className="form-select" value={addForm.category} onChange={e => setAddForm({...addForm, category: e.target.value})}>
                                {categories.filter(c => c !== 'All').map(c => <option key={c}>{c}</option>)}
                            </select>
                        </div>
                        <div className="form-group" style={{flex:2}}>
                            <label className="form-label">Part Name</label>
                            <input className="form-input" value={addForm.name} onChange={e => setAddForm({...addForm, name: e.target.value})} placeholder="Enter part name..."/>
                        </div>
                        <div className="form-group">
                            <label className="form-label">In Stock</label>
                            <input type="number" className="form-input" value={addForm.inStock} onChange={e => setAddForm({...addForm, inStock: parseInt(e.target.value) || 0})}/>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Need Total</label>
                            <input type="number" className="form-input" value={addForm.need} onChange={e => setAddForm({...addForm, need: parseInt(e.target.value) || 0})}/>
                        </div>
                        <div className="form-group">
                            <label className="form-label">Per Build</label>
                            <input type="number" className="form-input" value={addForm.perBuild} onChange={e => setAddForm({...addForm, perBuild: parseInt(e.target.value) || 0})}/>
                        </div>
                        <div className="form-group" style={{alignSelf:'flex-end'}}>
                            <button className="btn btn-primary" onClick={addPart}>Add Part</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Search and Filters */}
            <div className="card">
                <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'16px',flexWrap:'wrap'}}>
                    <div className="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        <input type="text" placeholder="Search parts..." value={search} onChange={e => setSearch(e.target.value)} style={{width:'200px'}}/>
                        {search && <button onClick={() => setSearch('')} style={{position:'absolute',right:'8px',top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'var(--text-muted)',cursor:'pointer',fontSize:'14px'}}>âœ•</button>}
                    </div>
                    <select className="form-select" style={{width:'auto'}} value={filter} onChange={e => setFilter(e.target.value)}>
                        {categories.map(c => {
                            const stat = categoryStats[c];
                            const badge = stat ? (stat.outOfStock > 0 ? ` (${stat.outOfStock} out)` : stat.lowStock > 0 ? ` (${stat.lowStock} low)` : ` (${stat.total})`) : ` (${parts.length})`;
                            return <option key={c} value={c}>{c}{badge}</option>;
                        })}
                    </select>
                    <div className="btn-group">
                        <button className={`btn btn-sm ${statusFilter === 'all' ? 'btn-primary' : ''}`} onClick={() => setStatusFilter('all')}>All</button>
                        <button className={`btn btn-sm ${statusFilter === 'outOfStock' ? 'btn-primary' : ''}`} style={{color: statusFilter !== 'outOfStock' ? 'var(--red)' : ''}} onClick={() => setStatusFilter('outOfStock')}>Out ({totals.outOfStock})</button>
                        <button className={`btn btn-sm ${statusFilter === 'lowStock' ? 'btn-primary' : ''}`} style={{color: statusFilter !== 'lowStock' ? 'var(--amber)' : ''}} onClick={() => setStatusFilter('lowStock')}>Low ({totals.lowStock})</button>
                    </div>
                    <div className="btn-group" style={{marginLeft:'auto'}}>
                        <button className={`btn btn-sm ${viewMode === 'table' ? 'btn-primary' : ''}`} onClick={() => setViewMode('table')}>Table</button>
                        <button className={`btn btn-sm ${viewMode === 'cards' ? 'btn-primary' : ''}`} onClick={() => setViewMode('cards')}>Cards</button>
                    </div>
                    <span style={{fontSize:'12px',color:'var(--text-muted)'}}>{filtered.length} parts</span>
                </div>

                {viewMode === 'table' ? (
                    <table className="table">
                        <thead>
                            <tr>
                                <th style={{width:'50px'}}>Status</th>
                                <th style={{width:'100px'}}>Category</th>
                                <th>Part Name</th>
                                <th style={{textAlign:'center',width:'140px'}}>Stock</th>
                                <th style={{textAlign:'center',width:'80px'}}>Need</th>
                                <th style={{textAlign:'center',width:'60px'}}>Per Build</th>
                                <th style={{width:'50px'}}></th>
                            </tr>
                        </thead>
                        <tbody>
                            {filtered.length === 0 ? (
                                <tr><td colSpan="7" style={{textAlign:'center',padding:'40px',color:'var(--text-muted)'}}>No parts found</td></tr>
                            ) : filtered.map(p => {
                                const inStock = parseInt(p.inStock) || 0;
                                const need = parseInt(p.need) || 0;
                                const stockStatus = getStockStatus(p);
                                const stockPercent = need > 0 ? Math.min(100, (inStock / need) * 100) : 100;
                                return (
                                    <tr key={p.id} style={{background: stockStatus.status === 'out' ? 'var(--red-glow)' : stockStatus.status === 'low' ? 'var(--amber-glow)' : 'transparent'}}>
                                        <td>
                                            <span style={{display:'inline-block',padding:'2px 8px',borderRadius:'4px',fontSize:'10px',fontWeight:600,background: stockStatus.status === 'out' ? 'var(--red)' : stockStatus.status === 'low' ? 'var(--amber)' : stockStatus.status === 'good' ? 'var(--green)' : 'var(--bg-input)',color: stockStatus.status === 'na' ? 'var(--text-muted)' : '#000'}}>{stockStatus.label}</span>
                                        </td>
                                        <td style={{fontSize:'11px',color:'var(--text-muted)'}}>{p.category}</td>
                                        <td>
                                            <div style={{fontWeight:500,fontSize:'12px'}}>{p.name}</div>
                                            {need > 0 && (
                                                <div style={{marginTop:'4px',height:'4px',background:'var(--bg-input)',borderRadius:'2px',overflow:'hidden',maxWidth:'200px'}}>
                                                    <div style={{height:'100%',width:`${stockPercent}%`,background: stockStatus.color,borderRadius:'2px'}}></div>
                                                </div>
                                            )}
                                        </td>
                                        <td style={{textAlign:'center'}}>
                                            <div style={{display:'flex',alignItems:'center',justifyContent:'center',gap:'4px'}}>
                                                <button onClick={() => quickAdjust(p.id, -1)} className="btn btn-sm" style={{width:'24px',height:'24px',padding:0,fontSize:'14px'}}>âˆ’</button>
                                                <input type="number" min="0" value={p.inStock || 0} onChange={e => updateQty(p.id, 'inStock', e.target.value)} style={{width:'50px',padding:'4px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'4px',color: stockStatus.color,textAlign:'center',fontFamily:'JetBrains Mono',fontWeight:600}}/>
                                                <button onClick={() => quickAdjust(p.id, 1)} className="btn btn-sm" style={{width:'24px',height:'24px',padding:0,fontSize:'14px'}}>+</button>
                                            </div>
                                        </td>
                                        <td style={{textAlign:'center'}}>
                                            <input type="number" min="0" value={p.need || 0} onChange={e => updateQty(p.id, 'need', e.target.value)} style={{width:'50px',padding:'4px',background:'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'4px',color:'var(--text)',textAlign:'center',fontFamily:'JetBrains Mono'}}/>
                                        </td>
                                        <td style={{textAlign:'center',color:'var(--text-muted)',fontSize:'12px',fontFamily:'JetBrains Mono'}}>{p.perBuild || 0}</td>
                                        <td><button className="btn btn-sm" style={{color:'var(--red)',padding:'2px 6px'}} onClick={() => del(p.id)}>âœ•</button></td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                ) : (
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill, minmax(280px, 1fr))',gap:'12px'}}>
                        {filtered.length === 0 ? (
                            <div style={{gridColumn:'1/-1',textAlign:'center',padding:'40px',color:'var(--text-muted)'}}>No parts found</div>
                        ) : filtered.map(p => {
                            const inStock = parseInt(p.inStock) || 0;
                            const need = parseInt(p.need) || 0;
                            const stockStatus = getStockStatus(p);
                            const stockPercent = need > 0 ? Math.min(100, (inStock / need) * 100) : 100;
                            return (
                                <div key={p.id} style={{background:'var(--bg-card)',border:`1px solid ${stockStatus.status === 'out' ? 'var(--red)' : stockStatus.status === 'low' ? 'var(--amber)' : 'var(--border)'}`,borderRadius:'8px',padding:'12px'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'8px'}}>
                                        <span style={{fontSize:'10px',color:'var(--text-muted)',background:'var(--bg-input)',padding:'2px 6px',borderRadius:'4px'}}>{p.category}</span>
                                        <span style={{padding:'2px 8px',borderRadius:'4px',fontSize:'10px',fontWeight:600,background: stockStatus.status === 'out' ? 'var(--red)' : stockStatus.status === 'low' ? 'var(--amber)' : stockStatus.status === 'good' ? 'var(--green)' : 'var(--bg-input)',color: stockStatus.status === 'na' ? 'var(--text-muted)' : '#000'}}>{stockStatus.label}</span>
                                    </div>
                                    <div style={{fontWeight:500,fontSize:'13px',marginBottom:'12px',minHeight:'36px'}}>{p.name}</div>
                                    {need > 0 && (
                                        <div style={{marginBottom:'12px'}}>
                                            <div style={{height:'6px',background:'var(--bg-input)',borderRadius:'3px',overflow:'hidden'}}>
                                                <div style={{height:'100%',width:`${stockPercent}%`,background: stockStatus.color,borderRadius:'3px'}}></div>
                                            </div>
                                        </div>
                                    )}
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                        <div style={{display:'flex',alignItems:'center',gap:'6px'}}>
                                            <button onClick={() => quickAdjust(p.id, -1)} className="btn btn-sm" style={{width:'28px',height:'28px',padding:0}}>âˆ’</button>
                                            <div style={{textAlign:'center'}}>
                                                <div style={{fontSize:'20px',fontWeight:700,fontFamily:'JetBrains Mono',color:stockStatus.color}}>{inStock}</div>
                                                <div style={{fontSize:'9px',color:'var(--text-muted)'}}>IN STOCK</div>
                                            </div>
                                            <button onClick={() => quickAdjust(p.id, 1)} className="btn btn-sm" style={{width:'28px',height:'28px',padding:0}}>+</button>
                                        </div>
                                        <div style={{textAlign:'center'}}>
                                            <div style={{fontSize:'16px',fontWeight:600,fontFamily:'JetBrains Mono'}}>{need}</div>
                                            <div style={{fontSize:'9px',color:'var(--text-muted)'}}>NEED</div>
                                        </div>
                                        <div style={{textAlign:'center'}}>
                                            <div style={{fontSize:'14px',fontFamily:'JetBrains Mono',color:'var(--text-muted)'}}>{p.perBuild || 0}</div>
                                            <div style={{fontSize:'9px',color:'var(--text-muted)'}}>PER BUILD</div>
                                        </div>
                                        <button className="btn btn-sm" style={{color:'var(--red)'}} onClick={() => del(p.id)}>âœ•</button>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </div>
    );
}

function EmailStatus({ ships, setShips, issues, toast, logActivity }) {
    const [contactModal, setContactModal] = useState(false);
    const [selectedShip, setSelectedShip] = useState(null);
    const [contactForm, setContactForm] = useState({ name: '', date: toDateString(new Date()), notes: '', waitingReply: false });
    const [filter, setFilter] = useState('all');
    
    const sorted = useMemo(() => {
        let result = [...ships].map(s => { 
            const es = getEmailStatus(s, issues); 
            const si = issues.filter(i => i.shipId === s.id && !i.resolved); 
            const urg = si.some(i => i.threat === 'Urgent') ? 2 : si.some(i => i.threat === 'Mild') ? 1 : 0; 
            return { ...s, emailStatus: es, urgency: urg }; 
        });
        
        // Apply filter
        if (filter === 'waiting') result = result.filter(s => s.waitingReply);
        else if (filter === 'overdue') result = result.filter(s => s.emailStatus.status === 'OVERDUE');
        else if (filter === 'due') result = result.filter(s => s.emailStatus.status === 'DUE');
        
        return result.sort((a, b) => { 
            // Waiting ships first, then by overdue days
            if (a.waitingReply && !b.waitingReply) return -1;
            if (!a.waitingReply && b.waitingReply) return 1;
            if (b.emailStatus.days !== a.emailStatus.days) return b.emailStatus.days - a.emailStatus.days; 
            if (b.urgency !== a.urgency) return b.urgency - a.urgency; 
            return hullNum(a.name) - hullNum(b.name); 
        });
    }, [ships, issues, filter]);
    
    const waitingCount = ships.filter(s => s.waitingReply).length;
    const overdueCount = ships.filter(s => getEmailStatus(s, issues).status === 'OVERDUE').length;
    const dueCount = ships.filter(s => getEmailStatus(s, issues).status === 'DUE').length;
    
    const openContactModal = (s) => {
        setSelectedShip(s);
        setContactForm({ name: '', date: toDateString(new Date()), notes: '', waitingReply: s.waitingReply || false });
        setContactModal(true);
    };
    
    const submitContact = () => {
        if (!selectedShip || !contactForm.name.trim()) { toast('Enter your name', 'error'); return; }
        // Use local noon to avoid UTC timezone shift issues
        const contactDate = contactForm.date + 'T12:00:00';
        setShips(p => p.map(x => x.id === selectedShip.id ? { ...x, lastContact: contactDate, contactedBy: contactForm.name, lastSaid: contactForm.notes || x.lastSaid, waitingReply: contactForm.waitingReply } : x));
        
        // Add to email history in localStorage
        const historyEntry = {
            id: genId('EH'),
            type: 'manual',
            shipId: selectedShip.id,
            shipName: selectedShip.name,
            timestamp: contactDate,
            emailText: contactForm.notes || 'Marked as contacted',
            result: {
                inPort: false,
                issue: { hasIssue: false },
                emailSummary: contactForm.notes || `Contacted by ${contactForm.name}`,
                waitingReply: contactForm.waitingReply
            },
            changes: [contactForm.waitingReply ? 'Waiting on reply' : 'Marked as emailed', `By: ${contactForm.name}`]
        };
        try {
            const existing = JSON.parse(localStorage.getItem('emailParseHistory') || '[]');
            const newHistory = [historyEntry, ...existing].slice(0, 100);
            localStorage.setItem('emailParseHistory', JSON.stringify(newHistory));
        } catch (e) { console.error('Failed to save email history', e); }
        
        logActivity(`${contactForm.name} marked ${selectedShip.name} as ${contactForm.waitingReply ? 'waiting on reply' : 'emailed'} on ${fmtDate(contactDate)}`);
        toast(`${selectedShip.name} marked as ${contactForm.waitingReply ? 'waiting on reply' : 'emailed'}`, 'success');
        setContactModal(false);
        setSelectedShip(null);
    };
    
    const clearWaiting = (s) => {
        setShips(p => p.map(x => x.id === s.id ? { ...x, waitingReply: false } : x));
        logActivity(`Cleared waiting status for ${s.name}`);
        toast(`${s.name} waiting status cleared`, 'info');
    };

    return (
        <div className="page active">
            <div className="page-header"><div className="page-header-left"><h1 className="page-title">Email Status</h1><p className="page-sub">Track ship contact schedules</p></div><button className="btn btn-secondary" onClick={() => window.print()}><Icon name="print"/> Print</button></div>
            <div className="card"><span className="card-title">Contact Schedule</span><div className="flex gap-md mt-md mb-md" style={{fontSize:'12px'}}><span style={{color:'var(--red)'}}>â— URGENT: Daily</span><span style={{color:'var(--amber)'}}>â— MILD: Every 3 days</span><span style={{color:'var(--green)'}}>â— NONE: Every 2 weeks</span><span style={{color:'var(--blue)'}}>â— WAITING: Pending reply</span></div></div>
            
            <div className="filters">
                <button className={`filter-btn ${filter==='all'?'active':''}`} onClick={() => setFilter('all')}>All Ships ({ships.length})</button>
                <button className={`filter-btn ${filter==='waiting'?'active':''}`} onClick={() => setFilter('waiting')}>â³ Waiting ({waitingCount})</button>
                <button className={`filter-btn ${filter==='overdue'?'active':''}`} onClick={() => setFilter('overdue')}>Overdue ({overdueCount})</button>
                <button className={`filter-btn ${filter==='due'?'active':''}`} onClick={() => setFilter('due')}>Due Today ({dueCount})</button>
            </div>
            
            <div className="card"><span className="card-title">Ships Needing Contact <span style={{fontWeight:'normal',color:'var(--text-muted)',marginLeft:'8px'}}>({sorted.length} shown)</span></span><table className="table mt-md"><thead><tr><th>Status</th><th>Ship</th><th>Level</th><th>Last Contact</th><th>Contacted By</th><th>Time Left</th><th>Actions</th></tr></thead><tbody>{sorted.map(s => (<tr key={s.id} style={{background: s.waitingReply ? 'var(--blue-glow)' : s.emailStatus.status === 'IN PORT' ? 'var(--blue-glow)' : 'transparent'}}><td>{s.waitingReply ? <span className="badge badge-info">WAITING</span> : s.emailStatus.status === 'IN PORT' ? <span className="badge badge-info">âš“ IN PORT</span> : <span className={`badge badge-${s.emailStatus.status.toLowerCase()}`}>{s.emailStatus.status}</span>}</td><td style={{fontWeight:600,fontFamily:'JetBrains Mono'}}>{s.name}</td><td><span className={`badge ${s.urgency===2?'badge-urgent':s.urgency===1?'badge-mild':'badge-ok'}`}>{s.urgency===2?'URGENT':s.urgency===1?'MILD':'NONE'}</span></td><td>{s.lastContact ? fmtDate(s.lastContact) : 'Never'}</td><td>{s.contactedBy || 'â€”'}</td><td>{s.emailStatus.status === 'IN PORT' ? `Back ${fmtDate(s.inPortUntil)}` : s.emailStatus.days === 999 ? 'N/A' : s.emailStatus.days > 0 ? `${s.emailStatus.days}d overdue` : s.emailStatus.days === 0 ? 'Today' : `In ${Math.abs(s.emailStatus.days)}d`}</td><td><div className="btn-group">{s.waitingReply && <button className="btn btn-sm btn-success" onClick={() => clearWaiting(s)}>âœ“ Got Reply</button>}<button className="btn btn-sm btn-primary" onClick={() => openContactModal(s)}>âœ‰ï¸ Email</button></div></td></tr>))}</tbody></table></div>
            
            <Modal open={contactModal} onClose={() => setContactModal(false)} title="âœ‰ï¸ Mark Ship as Emailed">
                {selectedShip && <>
                    <p style={{color:'var(--text-dim)',fontSize:'13px',marginBottom:'16px'}}>Record email contact for <strong style={{color:'var(--primary)'}}>{selectedShip.name}</strong></p>
                    <div className="form-group">
                        <label className="form-label">Your Name *</label>
                        <input className="form-input" placeholder="Enter your name" value={contactForm.name} onChange={e => setContactForm({...contactForm, name: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Date of Contact</label>
                        <input type="date" className="form-input" value={contactForm.date} onChange={e => setContactForm({...contactForm, date: e.target.value})}/>
                    </div>
                    <div className="form-group">
                        <label className="checkbox" style={{padding:'12px',background:'var(--bg-input)',borderRadius:'8px',border:'1px solid var(--border)'}}>
                            <input type="checkbox" checked={contactForm.waitingReply || false} onChange={e => setContactForm({...contactForm, waitingReply: e.target.checked})}/>
                            <span style={{fontSize:'13px'}}>â³ Waiting on Reply</span>
                        </label>
                        <p style={{fontSize:'11px',color:'var(--text-muted)',marginTop:'4px'}}>Check this if you sent an email and are waiting for their response</p>
                    </div>
                    <div className="form-group">
                        <label className="form-label">Notes / Email Summary (Optional)</label>
                        <textarea className="form-textarea" placeholder="What was discussed? Any follow-up needed?" value={contactForm.notes} onChange={e => setContactForm({...contactForm, notes: e.target.value})}/>
                    </div>
                    <div className="btn-group mt-md">
                        <button className="btn btn-primary" onClick={submitContact}>âœ“ Save Contact</button>
                        <button className="btn btn-secondary" onClick={() => setContactModal(false)}>Cancel</button>
                    </div>
                </>}
            </Modal>
        </div>
    );
}

function Suggestions({ suggestions, setSuggestions, toast }) {
    const [filter, setFilter] = useState('all');
    
    const filtered = useMemo(() => {
        if (filter === 'all') return suggestions;
        return suggestions.filter(s => s.status === filter);
    }, [suggestions, filter]);
    
    const updateStatus = (id, status) => {
        setSuggestions(prev => prev.map(s => s.id === id ? { ...s, status } : s));
        toast(`Suggestion marked as ${status}`, 'success');
    };
    
    const deleteSuggestion = (id) => {
        if (confirm('Delete this suggestion?')) {
            setSuggestions(prev => prev.filter(s => s.id !== id));
            toast('Suggestion deleted', 'info');
        }
    };
    
    const typeIcons = { idea: 'ðŸ’¡', bug: 'ðŸ›', workflow: 'âš¡' };
    const statusColors = { new: 'var(--primary)', reviewing: 'var(--amber)', implemented: 'var(--green)', declined: 'var(--red)' };
    
    return (
        <div className="page active">
            <div className="page-header">
                <div className="page-header-left">
                    <h1 className="page-title">Suggestions</h1>
                    <p className="page-sub">User feedback and improvement ideas</p>
                </div>
                <div style={{display:'flex',gap:'8px'}}>
                    {['all','new','reviewing','implemented','declined'].map(f => (
                        <button key={f} onClick={() => setFilter(f)} style={{padding:'6px 12px',background: filter === f ? 'var(--primary)' : 'var(--bg-input)',border:'1px solid var(--border)',borderRadius:'6px',color: filter === f ? '#000' : 'var(--text-dim)',fontSize:'11px',cursor:'pointer',textTransform:'capitalize'}}>{f} {f !== 'all' && `(${suggestions.filter(s => s.status === f).length})`}</button>
                    ))}
                </div>
            </div>
            
            <div className="card">
                <span className="card-title">All Suggestions ({filtered.length})</span>
                {filtered.length === 0 ? (
                    <div className="empty">No suggestions yet</div>
                ) : (
                    <div style={{marginTop:'16px'}}>
                        {filtered.sort((a,b) => new Date(b.created) - new Date(a.created)).map(s => (
                            <div key={s.id} style={{padding:'16px',background:'var(--bg-input)',borderRadius:'8px',marginBottom:'12px',border:'1px solid var(--border)'}}>
                                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'12px'}}>
                                    <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                                        <span style={{fontSize:'20px'}}>{typeIcons[s.type] || 'ðŸ’¡'}</span>
                                        <div>
                                            <div style={{fontWeight:600,fontSize:'13px'}}>{s.user}</div>
                                            <div style={{fontSize:'11px',color:'var(--text-muted)'}}>{new Date(s.created).toLocaleDateString()} â€¢ {s.type}</div>
                                        </div>
                                    </div>
                                    <span style={{padding:'4px 8px',borderRadius:'4px',fontSize:'10px',fontWeight:600,background: statusColors[s.status] + '20',color: statusColors[s.status],textTransform:'uppercase'}}>{s.status}</span>
                                </div>
                                <div style={{fontSize:'13px',color:'var(--text)',marginBottom:'12px',lineHeight:'1.5'}}>{s.text}</div>
                                <div style={{display:'flex',gap:'8px'}}>
                                    {s.status === 'new' && <button className="btn btn-sm" style={{background:'var(--amber-glow)',border:'1px solid var(--amber)',color:'var(--amber)'}} onClick={() => updateStatus(s.id, 'reviewing')}>Mark Reviewing</button>}
                                    {(s.status === 'new' || s.status === 'reviewing') && <button className="btn btn-sm btn-success" onClick={() => updateStatus(s.id, 'implemented')}>Implemented</button>}
                                    {(s.status === 'new' || s.status === 'reviewing') && <button className="btn btn-sm" style={{background:'var(--red-glow)',border:'1px solid var(--red)',color:'var(--red)'}} onClick={() => updateStatus(s.id, 'declined')}>Decline</button>}
                                    <button className="btn btn-sm btn-danger" onClick={() => deleteSuggestion(s.id)}>Delete</button>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}


function DataSettings({ ships, setShips, issues, setIssues, dailyChecks, setDailyChecks, installs, setInstalls, parts, setParts, activityLog, setActivityLog, toast, backupSettings, setBackupSettings, downloadBackup }) {
    const [importText, setImportText] = useState('');
    const [importType, setImportType] = useState('ships');
    const [dragActive, setDragActive] = useState(false);
    const dropRef = useRef(null);

    // Drag and drop handlers
    const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if (e.type === 'dragenter' || e.type === 'dragover') setDragActive(true); else if (e.type === 'dragleave') setDragActive(false); };
    const handleDrop = (e) => {
        e.preventDefault(); e.stopPropagation(); setDragActive(false);
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            const file = e.dataTransfer.files[0];
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (data.ships) setShips(data.ships);
                        if (data.issues) setIssues(data.issues);
                        if (data.dailyChecks) setDailyChecks(data.dailyChecks.map((c, i) => ({ ...c, id: c.id || genId('DC') })));
                        if (data.installs) setInstalls(data.installs);
                        if (data.parts) setParts(data.parts);
                        if (data.activityLog) setActivityLog(data.activityLog.map((a, i) => ({ ...a, id: a.id || genId('A') })));
                        toast('Backup restored successfully!', 'success');
                    } catch (err) { toast('Invalid backup file', 'error'); }
                };
                reader.readAsText(file);
            } else { toast('Please drop a JSON backup file', 'error'); }
        }
    };

    const importAll = () => { try { const data = JSON.parse(importText); if (data.ships) setShips(data.ships); if (data.issues) setIssues(data.issues); if (data.dailyChecks) setDailyChecks(data.dailyChecks.map((c, i) => ({ ...c, id: c.id || genId('DC') }))); if (data.installs) setInstalls(data.installs); if (data.parts) setParts(data.parts); if (data.activityLog) setActivityLog(data.activityLog.map((a, i) => ({ ...a, id: a.id || genId('A') }))); setImportText(''); toast('Data imported!', 'success'); } catch (e) { toast('Invalid JSON', 'error'); } };

    const importCSV = () => {
        try {
            const lines = importText.trim().split('\n'); if (lines.length < 2) { toast('No data rows', 'error'); return; }
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
            const parseCSVLine = (line) => { const result = []; let current = '', inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; } else current += char; } result.push(current.trim()); return result; };
            const getVal = (vals, headers, names) => { for (const name of names) { const idx = headers.indexOf(name); if (idx !== -1 && vals[idx]) return vals[idx]; } return ''; };
            const parseDate = (str) => { if (!str) return null; try { const d = new Date(str); return isNaN(d.getTime()) ? null : d.toISOString(); } catch { return null; } };

            if (importType === 'ships') {
                const newShips = [];
                for (let i = 1; i < lines.length; i++) { const vals = parseCSVLine(lines[i]); if (vals.length < 2) continue; const ship = { id: genId('S'), name: getVal(vals, headers, ['name', 'hull', 'hullnumber', 'shipname']) || vals[0] || '', type: getVal(vals, headers, ['type', 'shiptype']) || vals[1] || 'Full REAP', poc: getVal(vals, headers, ['poc', 'pointofcontact', 'contact']) || '', email: getVal(vals, headers, ['email', 'emailaddress']) || '', threat: 'NoIssue', lastContact: parseDate(getVal(vals, headers, ['lastcontact', 'contacted'])), nextCheck: parseDate(getVal(vals, headers, ['nextcheck', 'checkin'])), lastSaid: getVal(vals, headers, ['lastsaid', 'notes']) || '', ciscoRouter: getVal(vals, headers, ['ciscorouter', 'cisco', 'router']) || '', hdd: getVal(vals, headers, ['hdd', 'harddrive']) || '', crna1: getVal(vals, headers, ['crna1', 'starcrna', 'crna']) || '', crna2: getVal(vals, headers, ['crna2', 'datacrna']) || '', notes: getVal(vals, headers, ['notes', 'shipnotes']) || '', contactedBy: getVal(vals, headers, ['contactedby', 'by']) || '', tags: [] }; if (ship.name) newShips.push(ship); }
                if (newShips.length > 0) { setShips(prev => { const existingNames = prev.map(s => s.name.toLowerCase()); const toAdd = newShips.filter(s => !existingNames.includes(s.name.toLowerCase())); const toUpdate = newShips.filter(s => existingNames.includes(s.name.toLowerCase())); let updated = prev.map(existing => { const match = toUpdate.find(s => s.name.toLowerCase() === existing.name.toLowerCase()); if (match) return { ...existing, ...match, id: existing.id }; return existing; }); return [...updated, ...toAdd]; }); toast(`Imported ${newShips.length} ships!`, 'success'); }
            } else if (importType === 'dailychecks') {
                const newChecks = [];
                for (let i = 1; i < lines.length; i++) { const vals = parseCSVLine(lines[i]); if (vals.length < 4) continue; const shipName = getVal(vals, headers, ['shipname', 'ship', 'hull']) || vals[1] || ''; const matchShip = ships.find(s => s.name.toLowerCase() === shipName.toLowerCase()); const shipId = getVal(vals, headers, ['shipid', 'id']) || (matchShip ? matchShip.id : genId('S')); let dateStr = getVal(vals, headers, ['checkdate', 'date']) || vals[3] || ''; let formattedDate = ''; if (dateStr) { const parts = dateStr.split('/'); if (parts.length === 3) { formattedDate = `${parts[2].length === 2 ? '20' + parts[2] : parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`; } else formattedDate = dateStr; } const check = { id: genId('DC'), shipId, date: formattedDate, pingAM: getVal(vals, headers, ['pingam', 'am']) || vals[4] || '', pingPM: getVal(vals, headers, ['pingpm', 'pm']) || vals[5] || '', hdSpace: getVal(vals, headers, ['hdspace', 'hd', 'space']) || vals[6] || '', statusAM: ['true', '1', 'yes', 'online'].includes((getVal(vals, headers, ['statusam']) || vals[7] || 'true').toLowerCase()), statusPM: ['true', '1', 'yes', 'online'].includes((getVal(vals, headers, ['statuspm']) || vals[8] || 'true').toLowerCase()) }; if (check.date) newChecks.push(check); }
                if (newChecks.length > 0) { setDailyChecks(prev => { const newKeys = newChecks.map(c => `${c.shipId}-${c.date}`); const filtered = prev.filter(c => !newKeys.includes(`${c.shipId}-${c.date}`)); return [...filtered, ...newChecks]; }); toast(`Imported ${newChecks.length} daily checks!`, 'success'); }
            } else if (importType === 'issues') {
                const newIssues = [];
                for (let i = 1; i < lines.length; i++) { const vals = parseCSVLine(lines[i]); if (vals.length < 2) continue; const issue = { id: genId('I'), shipId: '', shipName: getVal(vals, headers, ['shipname', 'ship', 'hull']) || vals[0] || '', threat: getVal(vals, headers, ['threat', 'level']) || vals[1] || 'Mild', responsibility: getVal(vals, headers, ['responsibility', 'assignedto', 'assigned']) || 'Ship', lastSaid: getVal(vals, headers, ['lastsaid']) || '', created: new Date().toISOString(), due: getVal(vals, headers, ['due', 'duedate']) || '', details: getVal(vals, headers, ['details', 'description', 'issue']) || vals[2] || '', resolved: false }; const matchShip = ships.find(s => s.name.toLowerCase() === issue.shipName.toLowerCase()); if (matchShip) issue.shipId = matchShip.id; if (issue.details) newIssues.push(issue); }
                if (newIssues.length > 0) { setIssues(prev => [...prev, ...newIssues]); toast(`Imported ${newIssues.length} issues!`, 'success'); }
            }
            setImportText('');
        } catch (e) { toast('Error parsing CSV: ' + e.message, 'error'); }
    };

    const clearAllData = () => { if (confirm('DELETE ALL DATA?')) { if (confirm('Really delete everything?')) { logActivity('RESET ALL DATA - cleared everything'); setShips(defaultShips); setIssues([]); setDailyChecks([]); setInstalls([]); setParts([]); setActivityLog([]); toast('All data reset', 'info'); } } };

    // Power BI Export function
    const exportPowerBI = () => {
        const today = toDateString(new Date());
        const esc = (s) => {
            if (s === null || s === undefined || s === '') return '';
            const str = String(s).replace(/"/g, '""');
            return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
        };
        const fmtD = (d) => d ? new Date(d).toLocaleDateString('en-US') : '';
        const getStatus = (ship) => {
            const latest = dailyChecks.filter(c => c.shipId === ship.id).sort((a,b) => b.date.localeCompare(a.date))[0];
            if (!latest) return 'Offline';
            if (latest.statusAM || latest.statusPM) return 'Up';
            return 'Offline';
        };
        const headers = ['ShipHull#','ShipType','Location','Status','Priority','IssueTitle','IssueCategory','IssueDetails','IssueOpenedDate','DateResolved','LastResponseDate','LastShipResponse','ResolutionSummary','Notes','AssignedTo'];
        let rows = [headers.join(',')];
        const buildSummary = (ship, status, openIssue, allOpen) => {
            const parts = [];
            const isInPort = ship.inPort && ship.inPortUntil && parseLocalDate(ship.inPortUntil) >= new Date(new Date().setHours(0,0,0,0));
            if (isInPort) parts.push(`In port until ${fmtD(ship.inPortUntil)}`);
            if (openIssue) {
                const prefix = openIssue.threat === 'Urgent' ? 'URGENT: ' : '';
                parts.push(`${prefix}${openIssue.title || openIssue.details}`.substring(0, 80));
                if (allOpen.length > 1) parts.push(`+${allOpen.length - 1} more issue${allOpen.length > 2 ? 's' : ''}`);
            }
            if (ship.waitingReply) parts.push('Awaiting ship reply');
            if (parts.length === 0) {
                if (status === 'Up') return 'Up - No issues';
                if (status === 'Offline') return 'Offline - No contact';
                return status;
            }
            return parts.join(' | ');
        };
        ships.forEach(ship => {
            const status = getStatus(ship);
            const openIssues = issues.filter(i => i.shipId === ship.id && !i.resolved).sort((a,b) => new Date(b.created) - new Date(a.created));
            const resolvedIssues = issues.filter(i => i.shipId === ship.id && i.resolved).sort((a,b) => new Date(b.resolvedDate || b.created) - new Date(a.resolvedDate || a.created));
            const open = openIssues[0] || null;
            const resolved = resolvedIssues[0] || null;
            const summary = buildSummary(ship, status, open, openIssues);
            
            if (open) {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    open.threat||'', esc(open.title||''), esc(open.category||''), esc(open.details||''),
                    fmtD(open.created), '',
                    fmtD(ship.lastContact), esc(summary),
                    '',
                    esc(ship.notes||''), open.responsibility||'Ship'
                ].join(','));
            } else if (resolved) {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    '', '', '', '',
                    '', fmtD(resolved.resolvedDate),
                    fmtD(ship.lastContact), esc(summary),
                    esc(resolved.resolveNotes||''),
                    esc(ship.notes||''), ''
                ].join(','));
            } else {
                rows.push([
                    ship.name, ship.type||'', ship.location||'', status,
                    '', '', '', '',
                    '', '',
                    fmtD(ship.lastContact), esc(summary),
                    '',
                    esc(ship.notes||''), ''
                ].join(','));
            }
        });
        const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `PowerBI_REAP_Export_${today}.csv`;
        a.click();
        logActivity('Exported Power BI data', { rows: rows.length - 1 });
        toast(`Power BI export downloaded! (${rows.length - 1} rows)`, 'success');
    };

    const daysSinceBackup = backupSettings.lastBackup ? Math.floor((new Date() - new Date(backupSettings.lastBackup)) / (1000*60*60*24)) : null;

    return (
        <div className="page active">
            <div className="page-header"><div className="page-header-left"><h1 className="page-title">Data / Import</h1><p className="page-sub">Backup, restore, and manage your data</p></div></div>
            <div className="grid-2">
                <div>
                    <div className="card">
                        <span className="card-title">Backup & Export</span>
                        <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'16px',padding:'12px',background: daysSinceBackup === null || daysSinceBackup >= backupSettings.reminderDays ? 'var(--red-glow)' : 'var(--green-glow)',borderRadius:'8px',border: `1px solid ${daysSinceBackup === null || daysSinceBackup >= backupSettings.reminderDays ? 'var(--red)' : 'var(--green)'}`}}>
                            <div style={{flex:1}}><div style={{fontSize:'11px',color:'var(--text-muted)'}}>LAST BACKUP</div><div style={{fontSize:'16px',fontWeight:600,fontFamily:'JetBrains Mono'}}>{backupSettings.lastBackup ? new Date(backupSettings.lastBackup).toLocaleDateString() : 'Never'}</div>{daysSinceBackup !== null && <div style={{fontSize:'11px',color:'var(--text-dim)'}}>{daysSinceBackup} days ago</div>}</div>
                            <button className="btn btn-primary" onClick={() => downloadBackup()}>Download Backup</button>
                        </div>
                        <div className="card-title" style={{marginTop:'16px'}}>Auto-Backup Settings</div>
                        <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'12px'}}><label className="checkbox"><input type="checkbox" checked={backupSettings.autoBackupEnabled} onChange={e => setBackupSettings(prev => ({...prev, autoBackupEnabled: e.target.checked}))}/><span>Auto-download backup on startup</span></label></div>
                        <div className="form-group"><label className="form-label">Backup every</label><select className="form-select" value={backupSettings.reminderDays} onChange={e => setBackupSettings(prev => ({...prev, reminderDays: parseInt(e.target.value)}))}><option value="1">1 day</option><option value="3">3 days</option><option value="7">7 days</option><option value="14">14 days</option><option value="30">30 days</option></select></div>
                    </div>
                    
                    <div className="card" style={{background:'var(--primary-glow)',borderColor:'var(--primary)'}}>
                        <span className="card-title" style={{color:'var(--primary)'}}>ðŸ“Š Power BI Export</span>
                        <p style={{fontSize:'13px',color:'var(--text-dim)',marginBottom:'16px'}}>Export data in your coworker's Power BI format. Includes ship status, issues, and contact info.</p>
                        <button className="btn btn-primary" onClick={exportPowerBI}>Download Power BI CSV</button>
                    </div>
                    
                    <div className="card" ref={dropRef} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
                        <span className="card-title">Quick Restore</span>
                        <div className={`drop-zone ${dragActive ? 'active' : ''}`}>
                            <p style={{fontSize:'14px',marginBottom:'8px'}}>ðŸ“ Drag & Drop Backup File Here</p>
                            <p style={{fontSize:'12px'}}>Drop a .json backup file to restore</p>
                        </div>
                    </div>
                    
                    <div className="card"><span className="card-title">Current Data</span><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginTop:'12px'}}><div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'6px'}}><div style={{fontSize:'24px',fontWeight:700,fontFamily:'JetBrains Mono'}}>{ships.length}</div><div style={{fontSize:'11px',color:'var(--text-muted)'}}>Ships</div></div><div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'6px'}}><div style={{fontSize:'24px',fontWeight:700,fontFamily:'JetBrains Mono'}}>{issues.length}</div><div style={{fontSize:'11px',color:'var(--text-muted)'}}>Issues</div></div><div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'6px'}}><div style={{fontSize:'24px',fontWeight:700,fontFamily:'JetBrains Mono'}}>{dailyChecks.length}</div><div style={{fontSize:'11px',color:'var(--text-muted)'}}>Daily Checks</div></div><div style={{padding:'12px',background:'var(--bg-input)',borderRadius:'6px'}}><div style={{fontSize:'24px',fontWeight:700,fontFamily:'JetBrains Mono'}}>{installs.length}</div><div style={{fontSize:'11px',color:'var(--text-muted)'}}>Installs</div></div></div></div>
                    
                    <div className="card"><span className="card-title">Activity Log</span><div className="activity-log" style={{maxHeight:'200px'}}>{activityLog.slice(0, 20).map(a => <div key={a.id} className="activity-item" style={{flexDirection:'column',gap:'4px'}}><div style={{display:'flex',gap:'12px'}}><span className="activity-time">{fmtTime(a.time)}</span><span className="activity-text">{a.text}</span></div>{a.details && <div style={{marginLeft:'70px',padding:'6px 8px',background:'var(--bg-card)',borderRadius:'4px',fontSize:'11px',color:'var(--text-dim)'}}>{a.details.resolution && <div>â†³ Resolution: {a.details.resolution.substring(0, 50)}...</div>}{a.details.reply && <div>â†³ Reply: "{a.details.reply.substring(0, 50)}..."</div>}{a.details.details && <div>â†³ Issue: {a.details.details.substring(0, 50)}...</div>}{a.details.threat && <span>â†³ Threat: {a.details.threat} </span>}{a.details.notes && <div>â†³ Notes: {a.details.notes.substring(0, 50)}...</div>}{a.details.contactedBy && <span>â†³ By: {a.details.contactedBy} </span>}</div>}</div>)}{activityLog.length === 0 && <div className="empty">No activity yet</div>}</div></div>
                    
                    <div className="card"><span className="card-title" style={{color:'var(--red)'}}>Danger Zone</span><p style={{fontSize:'13px',color:'var(--text-dim)',marginBottom:'16px'}}>Reset all data back to defaults.</p><button className="btn btn-danger" onClick={clearAllData}>Reset All Data</button></div>
                </div>
                <div>
                    <div className="card"><span className="card-title">Import Data</span><p style={{fontSize:'13px',color:'var(--text-dim)',marginBottom:'16px'}}>Paste JSON backup OR CSV data from Excel.</p><div className="form-group"><label className="form-label">Import Type</label><select className="form-select" value={importType} onChange={e => setImportType(e.target.value)}><option value="ships">Ships (CSV)</option><option value="dailychecks">Daily Checks (CSV)</option><option value="issues">Issues (CSV)</option><option value="json">Full Backup (JSON)</option></select></div><div className="form-group"><label className="form-label">Paste Data Here</label><textarea className="form-textarea" style={{minHeight:'200px',fontFamily:'JetBrains Mono',fontSize:'11px'}} placeholder="Paste data here..." value={importText} onChange={e => setImportText(e.target.value)}/></div><div className="btn-group">{importType === 'json' ? (<button className="btn btn-primary" onClick={importAll}>Import JSON</button>) : (<button className="btn btn-primary" onClick={importCSV}>Import CSV</button>)}<button className="btn btn-secondary" onClick={() => setImportText('')}>Clear</button></div></div>
                    <div className="card"><span className="card-title">CSV Format Guide</span><div style={{background:'var(--bg-input)',padding:'12px',borderRadius:'6px',fontSize:'11px',fontFamily:'JetBrains Mono'}}><strong style={{color:'var(--primary)'}}>Ships:</strong> Name, Type, POC, Email, CiscoRouter, HDD, CRNA1, CRNA2<br/><br/><strong style={{color:'var(--primary)'}}>Daily Checks:</strong> ShipID, ShipName, ShipType, CheckDate, PingAM, PingPM, HDSpace, StatusAM, StatusPM<br/><br/><strong style={{color:'var(--primary)'}}>Issues:</strong> ShipName, Threat, Owner, Details, Due</div></div>
                    <div className="card"><span className="card-title">Keyboard Shortcuts</span><div style={{fontSize:'12px',lineHeight:'2'}}><kbd style={{background:'var(--bg-input)',padding:'2px 8px',borderRadius:'4px',marginRight:'8px'}}>/</kbd> Focus search<br/><kbd style={{background:'var(--bg-input)',padding:'2px 8px',borderRadius:'4px',marginRight:'8px'}}>Ctrl+S</kbd> Save reminder<br/><kbd style={{background:'var(--bg-input)',padding:'2px 8px',borderRadius:'4px',marginRight:'8px'}}>Esc</kbd> Close modals</div></div>
                </div>
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<AuthWrapper/>);
</script>
</body>
</html>